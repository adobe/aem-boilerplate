/*! Copyright 2026 Adobe
All Rights Reserved. */
import{s as r,p as D,d as _,U as S,v as N,e as Q}from"./fetch-graphql.js";import{merge as k,Initializer as z,deepmerge as O}from"@dropins/tools/lib.js";import{events as d}from"@dropins/tools/event-bus.js";import{CHECKOUT_DATA_FRAGMENT as C,NEGOTIABLE_QUOTE_FRAGMENT as G}from"../fragments.js";import{b as P,c as R,d as U,a as L,e as x,f as B,g as $}from"./transform-shipping-methods.js";import{E as p}from"./classifiers.js";const F=async(e=!1)=>{r.authenticated=e},b=e=>{if(!e)return;const{code:t,title:a,...s}=e;return{code:t,title:a,additionalData:s}},I=e=>{if(e)return e.filter(t=>!!t).map(t=>{const{code:a,title:s,...c}=t;return{code:a,title:s,additionalData:c}})},H=e=>{var a,s,c;if(!e)return;const t={type:"cart",availablePaymentMethods:I(e.available_payment_methods),billingAddress:R(e.billing_address),email:e.email??void 0,id:e.id,isEmpty:e.total_quantity===0,isVirtual:e.is_virtual,selectedPaymentMethod:b(e.selected_payment_method),shippingAddresses:P(e.shipping_addresses),isGuest:!r.authenticated};return k(t,(c=(s=(a=te.getConfig().models)==null?void 0:a.CartModel)==null?void 0:s.transformer)==null?void 0:c.call(s,e))},q=e=>{const t=e.street.filter(Boolean);return{city:e.city,company:e.company||void 0,country:$(e.country),customAttributes:B(e.custom_attributes),customerAddressUid:e.customer_address_uid||void 0,fax:e.fax||void 0,firstName:e.firstname,lastName:e.lastname,middleName:e.middlename||void 0,postCode:e.postcode||void 0,prefix:e.prefix||void 0,region:x(e.region),street:t,suffix:e.suffix||void 0,telephone:e.telephone||void 0,uid:e.uid,vatId:e.vat_id||void 0}},K=e=>{if(e)return q(e)},V=e=>e.filter(t=>!!t).map(t=>{const{available_shipping_methods:a,selected_shipping_method:s,...c}=t;return{...q(c),availableShippingMethods:L(a),selectedShippingMethod:U(s)}}),Y=e=>e?{type:"quote",availablePaymentMethods:I(e.available_payment_methods),billingAddress:K(e.billing_address),email:e.email??"",isEmpty:e.total_quantity===0,isVirtual:e.is_virtual,name:e.name,selectedPaymentMethod:b(e.selected_payment_method),shippingAddresses:V(e.shipping_addresses),status:e.status,uid:e.uid}:null,W=`
  query getCart($cartId: String!) {
    cart(cart_id: $cartId) {
      ...CHECKOUT_DATA_FRAGMENT
    }
  }

  ${C}
`,j=`
  query getCustomerCart {
    cart: customerCart {
      ...CHECKOUT_DATA_FRAGMENT
    }
  }

  ${C}
`,A=async()=>{const e=r.cartId,t=r.authenticated===!1,a=t?W:j,s=t?{cartId:e}:{};if(t&&!e)throw new D;return await _({type:"query",query:a,options:{method:"POST",cache:"no-cache",variables:s},path:"cart",transformer:H})},J=`
  query getNegotiableQuote($quoteId: ID!) {
    negotiableQuote(uid: $quoteId) {
      ...NEGOTIABLE_QUOTE_FRAGMENT
    }
  }

  ${G}
`,E=async(e={})=>{const t=e.uid??r.quoteId;if(r.authenticated===!1)throw new S;if(!t)throw new N;return await _({type:"query",query:J,options:{method:"GET",cache:"no-cache",variables:{quoteId:t}},path:"negotiableQuote",transformer:Y})},m={eager:!0},X=e=>{var y,g;const t=((g=(y=e==null?void 0:e.features)==null?void 0:y.b2b)==null?void 0:g.quotes)??!1;return[["authenticated",(u=!1)=>{var o,n,l;if(F(u),!t||u)return;const i=(l=(n=(o=e==null?void 0:e.features)==null?void 0:o.b2b)==null?void 0:n.routeLogin)==null?void 0:l.call(n);i&&window.location.assign(i)},m],...t?[["quote-management/quote-data/initialized",u=>{var i,o,n,l;if(!u.quote.canCheckout){const h=((l=(n=(o=(i=e==null?void 0:e.langDefinitions)==null?void 0:i.default)==null?void 0:o.Checkout)==null?void 0:n.Quote)==null?void 0:l.permissionDenied)||"You do not have permission to checkout with this quote.";d.emit("checkout/error",{message:h,code:p.QUOTE_PERMISSION_DENIED});return}f(u.quote)},m],["quote-management/quote-data/error",()=>{var i,o,n,l;const u=((l=(n=(o=(i=e==null?void 0:e.langDefinitions)==null?void 0:i.default)==null?void 0:o.Checkout)==null?void 0:n.Quote)==null?void 0:l.dataError)||"We were unable to retrieve the quote data. Please try again later.";d.emit("checkout/error",{message:u,code:p.QUOTE_DATA_ERROR})}]]:[["cart/initialized",f,m],["cart/reset",M],["cart/updated",T],["auth/permissions",u=>{var i,o,n,l;if(u.admin!==!0&&!u["Magento_Sales::place_order"]){const h=((l=(n=(o=(i=e==null?void 0:e.langDefinitions)==null?void 0:i.default)==null?void 0:o.Checkout)==null?void 0:n.ServerError)==null?void 0:l.permissionDenied)||"You do not have permission to complete checkout. Please contact your administrator for assistance.";d.emit("checkout/error",{message:h,code:p.PERMISSION_DENIED})}},m]]].map(([u,i,o])=>d.on(u,i,o))},Z=new URL(window.location.href),ee=Z.searchParams.get("quoteId");r.quoteId=ee;const v=new z({init:async(e={})=>{v.config.setConfig(O({defaults:{isBillToShipping:!0,selectedShippingMethod:t=>t.length>0?t[0]:null},features:{b2b:{quotes:!1}}},e))},listeners:X}),te=v.config,w=e=>"id"in e,re=async e=>{try{return w(e)?(r.cartId=e.id,r.quoteId=null,await A()??null):(r.cartId=null,r.quoteId=e.uid,await E()??null)}catch(t){return console.error("Checkout initialization failed:",t),null}},f=async e=>{if(r.initialized){await T(e);return}r.config||(r.config=await Q());const t=e?await re(e):null;r.initialized=!0,d.emit("checkout/initialized",t)},M=()=>{r.initialized&&(r.cartId=null,r.quoteId=null,d.emit("checkout/updated",null))},se=async e=>{try{return w(e)?(r.cartId=e.id,r.quoteId=null,await A()??null):(r.cartId=null,r.quoteId=e.uid,await E()??null)}catch(t){return console.error("Checkout synchronization failed:",t),null}},T=async e=>{if(!r.initialized)return f(e);if(e===null){M();return}const t=await se(e);d.emit("checkout/updated",t)};export{F as a,E as b,te as c,f as d,Y as e,A as g,v as i,M as r,T as s,H as t};
//# sourceMappingURL=synchronizeCheckout.js.map
