/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as n,jsxs as N}from"@dropins/tools/preact-jsx-runtime.js";import{useState as U,useRef as D,useMemo as z,useCallback as u,useEffect as V}from"@dropins/tools/preact-hooks.js";import{Button as L,InLineAlert as j,Picker as Z,Modal as R}from"@dropins/tools/components.js";import{u as H,T as J}from"../chunks/useUserPermissions.js";import{C as $}from"../chunks/CompanyUserForm.js";import{classes as Q}from"@dropins/tools/lib.js";import{u as W}from"../chunks/useCustomerCompanyInfo.js";import"@dropins/tools/event-bus.js";import{u as q}from"../chunks/useInLineAlert.js";import{g as X,u as Y}from"../chunks/updateCompanyUserStatus.js";import{useText as K}from"@dropins/tools/i18n.js";import{d as ee}from"../chunks/updateCompanyUser.js";import{f as ae}from"../chunks/fetchUserPermissions.js";import{u as te}from"../chunks/useCompanyContextListener.js";import{C as ne}from"../chunks/CompanyLoaders.js";import"@dropins/tools/preact.js";import"../chunks/company-permissions.js";import"@dropins/tools/preact-compat.js";import"../chunks/useCompanyRoles.js";import"../chunks/isCompanyRoleNameAvailable.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/fetch-error.js";import"../chunks/getCustomerCompany.js";const se=s=>{try{return atob(s)}catch{return s}},re=s=>!s||typeof s!="string"?s:se(s),oe=(s,i)=>!s||typeof s!="string"?"":s==="ACTIVE"&&i.statusActive?i.statusActive:s==="INACTIVE"&&i.statusInactive?i.statusInactive:s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(),ie=(s,i)=>{const l=(s==null?void 0:s.trim())||"",c=(i==null?void 0:i.trim())||"";return`${l} ${c}`.trim()},le=({filterType:s,onFilterChange:i,translations:l})=>{const c=[{type:"all",label:l.showAllUsers,ariaLabel:l.showAllUsers},{type:"active",label:l.showActiveUsers,ariaLabel:l.showActiveUsers},{type:"inactive",label:l.showInactiveUsers,ariaLabel:l.showInactiveUsers}];return n("div",{className:"filterButtons",role:"group","aria-label":l.ariaFilterOptions,children:c.filter(a=>a.type!==s).map(a=>n(L,{variant:"tertiary",onClick:()=>i(a.type),"aria-label":a.ariaLabel,children:a.label},a.type))})},ce=20,G=1,me=({translations:s})=>{const[i,l]=U([]),[c,a]=U(!1),[o,h]=U(G),[d,k]=U(ce),[P,B]=U("all"),[b,I]=U(0),[m,E]=U(1),[_,M]=U(""),[w,A]=U(null),t=D(s);t.current=s;const f=z(()=>{switch(P){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[P]),C=u(async()=>{a(!0);try{const e=await X({pageSize:d,currentPage:o,filter:f});l(e.users),I(e.totalCount||e.users.length),E(e.pageInfo.totalPages),M(t.current.ariaDataLoaded.replace("{count}",e.users.length.toString()))}catch{l([]),I(0),E(1),M(t.current.ariaDataError)}finally{a(!1)}},[d,o,f]),y=u(async()=>{try{const{allowedIds:e}=await ae();A(e)}catch{A(new Set)}},[]);V(()=>{C()},[C]),V(()=>{y()},[y]);const T=u(e=>{B(e),h(G)},[]),S=u(e=>{let g;if(typeof e=="string")g=e;else if("target"in e&&e.target&&"value"in e.target)g=e.target.value;else return;const v=parseInt(g,10);isNaN(v)||(k(v),h(G))},[]),x=u(()=>{o>1&&h(o-1)},[o]),F=u(()=>{o<m&&h(o+1)},[o,m]),r=(w==null?void 0:w.has("Magento_Company::users_edit"))||!1,p=u(async()=>{await y(),await C()},[y,C]);return{users:i,userPermissions:w,currentPage:o,pageSize:d,totalItems:b,totalPages:m,filterType:P,filter:f,loading:c,announcement:_,canEditUsers:r,handleFilterChange:T,handlePageSizeChange:S,handlePreviousPage:x,handleNextPage:F,refreshUsers:p}},O=s=>{const[i,l]=U(!1),[c,a]=U(null),o=u(d=>{d&&a(d),l(!0)},[]),h=u(()=>{l(!1),a(null),s==null||s()},[s]);return{isOpen:i,selectedId:c,open:o,close:h}},pe=({className:s,userId:i,userStatus:l,onClose:c,isOpen:a=!1,onSuccess:o,...h})=>{const[d,k]=U(!1),[P,B]=U(!1),{inLineAlertProps:b,showError:I,clearAlert:m}=q(),{companyInfo:E}=W(),_=D(null),M=D(null),w=`modal-title-${i}`,A=`modal-desc-${i}`,t=K({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",setActiveSuccess:"Company.CompanyUsers.managementModal.setActiveSuccess",setInactiveSuccess:"Company.CompanyUsers.managementModal.setInactiveSuccess",deleteSuccess:"Company.CompanyUsers.managementModal.deleteSuccess",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),f=u(r=>{const p=(E==null?void 0:E.companyName)||"";return r.replace(/%1/g,p)},[E==null?void 0:E.companyName]),C=u(async()=>{if(P)return;const r=l==="ACTIVE"?"INACTIVE":"ACTIVE",p=r==="ACTIVE";B(!0),m();try{if((await Y({id:i,status:r})).success){const g=p?t.setActiveSuccess:t.setInactiveSuccess;o&&o(g),c()}else{const g=p?t.setActiveErrorSpecific:t.setInactiveErrorSpecific;I(f(g))}}catch(e){const g=e instanceof Error?e.message:p?t.setActiveErrorGeneric:t.setInactiveErrorGeneric;I(f(g))}finally{B(!1)}},[i,l,c,P,m,I,f,t.setActiveErrorSpecific,t.setInactiveErrorSpecific,t.setActiveErrorGeneric,t.setInactiveErrorGeneric,t.setActiveSuccess,t.setInactiveSuccess,o]),y=u(async()=>{if(!d){k(!0),m();try{(await ee({id:i})).success?(o&&o(t.deleteSuccess),c()):I(f(t.deleteErrorSpecific))}catch(r){const p=r instanceof Error?r.message:t.deleteErrorGeneric;I(f(p))}finally{k(!1)}}},[i,c,d,m,I,f,t.deleteErrorSpecific,t.deleteErrorGeneric,t.deleteSuccess,o]),T=u(()=>{m(),c()},[c,m]),S=u(r=>{if(r.key==="Escape"&&(m(),c()),r.key==="Tab"){const p=_.current;if(!p)return;const e=p.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),g=e[0],v=e[e.length-1];r.shiftKey?document.activeElement===g&&(v.focus(),r.preventDefault()):document.activeElement===v&&(g.focus(),r.preventDefault())}},[c,m]),x=u(r=>{r.target===r.currentTarget&&(m(),c())},[c,m]),F=u(()=>{m(),c()},[c,m]);return V(()=>{if(a)return M.current=document.activeElement,document.addEventListener("keydown",S),setTimeout(()=>{const r=_.current;if(r){const p=r.querySelector("button");p?p.focus():r.focus()}},100),()=>{document.removeEventListener("keydown",S)};M.current&&M.current.focus()},[a,S]),a?n("div",{className:Q(["company-management-company-users-management-modal-overlay",s]),onClick:x,...h,children:N("div",{ref:_,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":w,"aria-describedby":A,tabIndex:-1,children:[N("div",{className:"company-management-company-users-management-modal__header",children:[n("h2",{id:w,className:"company-management-company-users-management-modal__title",children:t.title}),n("button",{className:"company-management-company-users-management-modal__close",onClick:F,"aria-label":t.ariaCloseModal,children:"Ã—"})]}),N("div",{id:A,className:"company-management-company-users-management-modal__content",children:[n("p",{className:"company-management-company-users-management-modal__text",children:l==="ACTIVE"?t.setInactiveText:t.setActiveText}),n("p",{className:"company-management-company-users-management-modal__text",children:t.deleteText})]}),(b==null?void 0:b.text)&&n("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:n(j,{type:"error",heading:b.text,icon:b.icon,"data-testid":"companyUsersManagementModalAlert"})}),N("div",{className:"company-management-company-users-management-modal__actions",children:[n(L,{variant:"primary",onClick:C,disabled:P,className:"company-management-company-users-management-modal__button-primary",children:P?l==="ACTIVE"?t.settingInactiveButton:t.settingActiveButton:l==="ACTIVE"?t.setInactiveButton:t.setActiveButton}),n(L,{variant:"tertiary",onClick:y,disabled:d,className:"company-management-company-users-management-modal__button-delete",children:d?t.deletingButton:t.deleteButton}),n(L,{variant:"secondary",onClick:T,className:"company-management-company-users-management-modal__button-cancel",children:t.cancelButton})]})]})}):null},de=[{text:"20",value:"20"},{text:"30",value:"30"},{text:"50",value:"50"},{text:"100",value:"100"},{text:"200",value:"200"}],De=({children:s,className:i,...l})=>{const{permissions:c}=H(),a=K({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsText:"Company.CompanyUsers.pagination.itemsCount",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",perPageLabel:"Company.CompanyUsers.pagination.perPage",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaLoadingUsers:"Company.CompanyUsers.ariaLabels.loadingUsers",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",editUser:"Company.CompanyUsers.actions.edit",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser",ariaEditUser:"Company.CompanyUsers.ariaLabels.editUser",addNewUser:"Company.CompanyUsers.actions.addNewUser"}),{users:o,loading:h,currentPage:d,pageSize:k,filterType:P,totalItems:B,totalPages:b,announcement:I,canEditUsers:m,handleFilterChange:E,handlePageSizeChange:_,handlePreviousPage:M,handleNextPage:w,refreshUsers:A}=me({translations:{ariaDataLoaded:a.ariaDataLoaded,ariaDataError:a.ariaDataError}}),t=D(a);t.current=a;const f=u(()=>{A()},[A]);te(f);const C=O(A),y=O(A),T=O(A),{inLineAlertProps:S,handleSetInLineAlert:x}=q(),F=z(()=>{const e=t.current;return[{key:"id",label:e.idColumn},{key:"name",label:e.nameColumn},{key:"email",label:e.emailColumn},{key:"role",label:e.roleColumn},{key:"team",label:e.teamColumn},{key:"status",label:e.statusColumn},{key:"actions",label:e.actionsColumn}]},[]),r=z(()=>o.map(e=>{const g=ie(e.firstName,e.lastName),v=t.current;return{id:re(e.id),name:g,email:e.email,role:e.role,team:e.team||v.emptyTeam,status:oe(e.status,v),actions:m?N("div",{className:"user-actions",children:[n(L,{variant:"tertiary",onClick:()=>y.open(e.id),"aria-label":v.ariaEditUser.replace("{name}",g),className:"edit-user-button",children:v.editUser}),n(L,{variant:"tertiary",onClick:()=>C.open(e.id),"aria-label":v.ariaManageUser.replace("{name}",g),className:"manage-user-button",children:v.manageUser})]}):n("span",{className:"no-actions",children:v.emptyActions})}}),[o,m,y,C]),p=z(()=>o.find(e=>e.id===C.selectedId),[o,C.selectedId]);return N("section",{className:i,...l,children:[n("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:I}),n(le,{filterType:P,onFilterChange:E,translations:{showAllUsers:a.showAllUsers,showActiveUsers:a.showActiveUsers,showInactiveUsers:a.showInactiveUsers,ariaFilterOptions:a.ariaFilterOptions}}),S&&S.text?n(j,{className:"company-users__alert",type:S.type||"success",variant:"secondary",heading:S.text,icon:S.icon}):null,n("div",{"aria-busy":h,children:h?N("div",{className:"loadingContainer",role:"status","aria-live":"polite",children:[n(ne,{testId:"companyUsersTableLoader"}),n("span",{className:"sr-only",children:a.ariaLoadingUsers})]}):n(J,{className:"companyUsersTable",columns:F,rowData:r,mobileLayout:"stacked","aria-label":a.ariaUsersTable,summary:a.ariaShowingUsers.replace("{count}",o.length.toString())})}),N("nav",{"aria-label":a.ariaPaginationNav,className:"paginationContainer",children:[n("div",{"aria-live":"polite","aria-atomic":"true",children:a.itemsText.replace("{count}",B.toString())}),b>1&&N("div",{className:"paginationButtons",role:"group","aria-label":a.ariaPageNavigation,children:[n(L,{variant:"secondary",onClick:M,disabled:d===1,"aria-label":a.ariaPreviousPageFull.replace("{current}",d.toString()),children:a.previousPage}),n("span",{"aria-current":"page","aria-live":"polite",children:a.pageInfo.replace("{current}",d.toString()).replace("{total}",b.toString())}),n(L,{variant:"secondary",onClick:w,disabled:d===b,"aria-label":a.ariaNextPageFull.replace("{current}",d.toString()),children:a.nextPage})]}),N("div",{className:"pageSizeSelector",children:[n("label",{htmlFor:"page-size-select",id:"page-size-label",children:n("span",{children:a.showLabel})}),n(Z,{id:"page-size-select",name:"pageSize",value:k.toString(),options:de,onChange:_,"aria-labelledby":"page-size-label","aria-describedby":"page-size-description"}),n("span",{id:"page-size-description",children:a.perPageLabel})]})]}),m&&n("div",{className:"addUserButtonContainer",children:n(L,{variant:"primary",onClick:()=>T.open(),"aria-label":a.addNewUser,children:a.addNewUser})}),s,T.isOpen&&m&&n(R,{open:T.isOpen,onClose:T.close,size:"medium",children:n($,{mode:"add",entityId:void 0,parentStructureId:void 0,permissions:c,onSaved:T.close,onCancel:T.close,onError:e=>{x({text:e,type:"error"})},onSuccess:e=>{x({text:e,type:"success"})}})}),y.selectedId&&y.isOpen&&m&&n(R,{open:y.isOpen,onClose:y.close,size:"medium",children:n($,{mode:"edit",entityId:y.selectedId,parentStructureId:void 0,permissions:c,onSaved:y.close,onCancel:y.close,onError:e=>{x({text:e,type:"error"})},onSuccess:e=>{x({text:e,type:"success"})}})}),C.selectedId&&m&&p&&n(pe,{isOpen:C.isOpen,userId:C.selectedId,userStatus:p.status||"ACTIVE",onClose:C.close,onSuccess:e=>{x({text:e,type:"success"})}})]})};export{De as CompanyUsers,De as default};
//# sourceMappingURL=CompanyUsers.js.map
