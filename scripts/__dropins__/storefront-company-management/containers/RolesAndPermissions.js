/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as C,Fragment as Ne}from"@dropins/tools/preact-jsx-runtime.js";import{useMemo as ce,useCallback as K,useState as f,useRef as ie,useEffect as W}from"@dropins/tools/preact-hooks.js";import{classes as be}from"@dropins/tools/lib.js";import{ActionButton as le,Pagination as Be,ProgressSpinner as me,Picker as Oe,Button as X,Card as ue,Header as ne,InLineAlert as re,Field as Ue,Input as Ve,Modal as ze,IllustratedMessage as Ce}from"@dropins/tools/components.js";import{D as te,u as $e}from"../chunks/useCompanyRoles.js";import{T as qe,u as He}from"../chunks/useUserPermissions.js";import{u as Ge}from"../chunks/useInLineAlert.js";import{u as je}from"../chunks/useCompanyContextListener.js";import{T as Xe}from"../chunks/Tree.js";import{f as ve}from"../chunks/company-permissions.js";import{i as Ye}from"../chunks/isCompanyRoleNameAvailable.js";import{useText as oe}from"@dropins/tools/i18n.js";import"@dropins/tools/preact.js";import"../chunks/fetchUserPermissions.js";import"../chunks/fetch-error.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/preact-compat.js";var Je={};const Ke=d=>{try{if(/^\d+$/.test(d))return d;const n=atob(d).match(/(\d+)$/);return n?n[1]:d}catch(a){return console.warn("Failed to decode role ID:",d,a),d}},We=({className:d,roles:a,isLoading:n,canManageRoles:c=!1,onShowCreateForm:s,onShowEditForm:h,onDuplicateRole:b,onDeleteRole:R,totalCount:P=a.length,currentPage:T=1,pageSize:i=te,onPageChange:g,onPageSizeChange:F,onSortChange:I,sortColumn:v,sortDirection:x,children:_,...Z})=>{const u=oe({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",itemsRange:"Company.RoleAndPermissionTable.itemsRange",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage",pageSizeLabel:"Company.RoleAndPermissionTable.pageSizeLabel"}),E=typeof process<"u"&&Je.JEST_WORKER_ID!==void 0,S=!!(I&&x&&v)&&!E,z=ce(()=>[{key:"id",label:u.columnId||"ID",...S&&{sortBy:v==="id"?x:!0}},{key:"name",label:u.columnRole||"Role",...S&&{sortBy:v==="name"?x:!0}},{key:"usersCount",label:u.columnUsers||"Users",...S&&{sortBy:v==="usersCount"?x:!0}},{key:"actions",label:u.columnActions||"Actions"}],[u,v,x,S]),M=K(t=>c&&t.id!=="0",[c]),O=K(t=>c&&t.id!=="0",[c]),A=K(t=>c&&t.id!=="0"&&P>1,[c,P]),U=K(t=>{const y=[];return M(t)&&y.push(e(le,{onClick:()=>h(t.id),className:"role-action-button",children:u.editButton||"Edit"},"edit")),O(t)&&b&&y.push(e(le,{onClick:()=>b(t.id),className:"role-action-button",children:u.duplicateButton||"Duplicate"},"duplicate")),A(t)&&R&&y.push(e(le,{onClick:()=>R(t.id),className:"role-action-button",children:u.deleteButton||"Delete"},"delete")),y.length===0?c?e("span",{className:"no-actions",children:u.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:y.map((B,q)=>e("span",{className:"role-action-wrapper",children:B},q))})},[M,O,A,h,b,R,u,c]),w=ce(()=>a.map(t=>({id:Ke(t.id),name:t.name,usersCount:t.usersCount,actions:e("div",{className:"roles-actions",children:U(t)})})),[a,U]),N=[te,20,50,100].map(t=>({value:t.toString(),label:t.toString(),text:t.toString()})),$=Math.ceil(P/i),L=(T-1)*i,V=L+i;return C("div",{...Z,className:be(["company-management-role-and-permission-table",d]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e(qe,{columns:z,rowData:w,mobileLayout:"stacked",loading:n,skeletonRowCount:10,onSortChange:(t,y)=>{let B;y===!0?v===t&&x?B=x==="asc"?"desc":"asc":B="asc":B=y,I==null||I(t,B)}})}),C("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:e("span",{className:"item-count",children:(u.itemsRange||"Items {start}-{end} of {total}").replace("{start}",String(L+1)).replace("{end}",String(Math.min(V,P))).replace("{total}",String(P))})}),$>1&&e("div",{className:"table-footer-center",children:e(Be,{currentPage:T,totalPages:$,onChange:t=>g==null?void 0:g(t)})}),e("div",{className:"table-footer-right",children:C("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:u.show||"Show"}),n?e("div",{className:"page-size-loading",children:e(me,{size:"small"})}):e(Oe,{value:i.toString(),onChange:t=>{const y=t.target;F==null||F(parseInt(y.value,10))},options:N,className:"page-size-picker","aria-label":u.pageSizeLabel||"Items per page"})]})})]}),c&&e("div",{className:"add-role-section",children:e(X,{variant:"primary",onClick:s,children:u.addNewRole||"Add New Role"})}),_]})},Ze={MAX_LENGTH:40},de=d=>(typeof d=="string"?d:String(d||"")).trim().slice(0,Ze.MAX_LENGTH),Ae=({mode:d,role:a,aclResources:n,existingRoleNames:c=[],loading:s=!1,onSubmit:h,onCancel:b,inLineAlertProps:R,prefillName:P,prefillPermissions:T})=>{const i=oe({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[g,F]=f({name:(a==null?void 0:a.name)||""}),[I,v]=f({}),[x,_]=f({}),[Z,u]=f(!1),[E,S]=f(!1),[z,M]=f([]),[O,A]=f(new Set),[U,w]=f(new Set),N=ie(null),$=ie(""),L=ie(!1);W(()=>{if(!L.current){if(L.current=!0,d==="edit"&&a){if(F({name:a.name}),a.permissions&&a.permissions.length>0){const o=ve(a.permissions);w(new Set(o))}}else if(d==="create")if(F({name:P??""}),T&&T.length>0){const l=ve(T);w(new Set(l))}else w(new Set)}},[d,a,P,T]),W(()=>{if(n.length>0){const o=Qe(n);M(o);const l=o.filter(m=>!m.parentId).map(m=>m.id);A(new Set(l))}},[n]),W(()=>()=>{N.current&&clearTimeout(N.current)},[]);const V=K(o=>{const l=de(o);return l?(d==="edit"&&a?c.filter(j=>j!==a.name):c).includes(l)?i.roleNameExists:null:i.roleNameRequired||"This is a required field."},[d,a,c,i.roleNameRequired,i.roleNameExists]),t=K(async o=>{const l=de(o),m=V(l);if(m)return m;if(d==="edit"&&a&&l===a.name)return null;try{return u(!0),await Ye({name:l})?null:i.roleNameExists}catch(j){return console.error("Role name validation failed:",j),null}finally{u(!1)}},[d,a,i.roleNameExists,V]),y=K(o=>{N.current!==null&&clearTimeout(N.current),o!==$.current&&(N.current=window.setTimeout(async()=>{const l=await t(o);v(l?m=>({...m,name:l}):m=>({...m,name:""})),$.current=o},500))},[t]),B=()=>{const o={};let l=!0;const m=V(g.name);return m&&(o.name=m,l=!1),v(o),l},q=o=>{const l=typeof o=="string"?o:o.target.value;F(m=>({...m,name:l})),I.name&&v(m=>({...m,name:""})),y(l)},ae=()=>{_(o=>({...o,name:!0})),N.current&&(clearTimeout(N.current),N.current=null)},k=()=>{const o=new Set(z.map(l=>l.id));A(o)},Y=()=>{A(new Set)},H=async o=>{if(o.preventDefault(),!E&&(_({name:!0}),!!B()&&!I.name)){S(!0);try{const l={name:de(g.name),permissions:Array.from(U)};h&&await h(l)}catch(l){console.error("Form submission failed:",l)}finally{S(!1)}}},G=d==="create"?i.createTitle:i.editTitle;return C(ue,{variant:"secondary",className:"edit-role-and-permission",children:[e(ne,{level:2,size:"large",title:G,divider:!1,className:"edit-role-and-permission__title"}),(R==null?void 0:R.text)&&e(re,{className:"edit-role-and-permission__notification",type:R.type,variant:"secondary",heading:R.text,"data-testid":"editRoleInLineAlert"}),C("form",{className:"edit-role-and-permission-form",onSubmit:H,children:[C("div",{className:"edit-role-and-permission__section",children:[e(ne,{level:3,size:"medium",title:i.roleInformation||"Role Information",divider:!1,className:"edit-role-and-permission__section-title"}),e(Ue,{label:i.roleName||"Role Name",required:!0,error:x.name&&I.name?I.name:void 0,children:e(Ve,{type:"text",name:"roleName",value:g.name,onChange:q,onBlur:ae,disabled:s||E,"data-testid":"roleNameInput",placeholder:i.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),Z&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(me,{size:"medium"})})]}),C("div",{className:"edit-role-and-permission__section",children:[e(ne,{level:3,size:"medium",title:i.rolePermissions,divider:!1,className:"edit-role-and-permission__section-title"}),e(re,{type:"info",variant:"secondary",heading:i.permissionsDescription,className:"edit-role-and-permission__permissions-description"}),C("div",{className:"edit-role-and-permission__tree-controls",children:[e(X,{type:"button",variant:"tertiary",onClick:k,disabled:s||E,children:i.expandAll}),e(X,{type:"button",variant:"tertiary",onClick:Y,disabled:s||E,children:i.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":i.rolePermissions,children:z.length>0?e(Xe,{items:z,expandedIds:O,onExpandedChange:A,checkedIds:U,onCheckedChange:w,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:o,expanded:l,hasChildren:m,toggle:j,checkbox:Q})=>C("div",{className:"edit-role-and-permission__tree-node",children:[m?e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:se=>{se.preventDefault(),se.stopPropagation(),j()},"aria-label":l?`Collapse ${o.label}`:`Expand ${o.label}`,children:l?"âˆ’":"+"}):e("span",{className:"edit-role-and-permission__tree-spacer"}),Q&&Q(),e("span",{className:"edit-role-and-permission__tree-label",children:o.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),C("div",{className:"edit-role-and-permission__actions",children:[e(X,{type:"button",variant:"secondary",onClick:b,disabled:s||E,children:i.cancel}),e(X,{type:"submit",variant:"primary",disabled:s||E,children:s||E?i.saving:i.saveRole})]})]}),(s||E)&&C("div",{className:"edit-role-and-permission__loading-overlay",children:[e(me,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:i.saving})]})]})},Qe=d=>{const a=[],n=(s,h)=>{a.push({id:s.id,parentId:h||null,label:s.text}),s.children&&[...s.children].sort((R,P)=>R.sortOrder-P.sortOrder).forEach(R=>{n(R,s.id)})};return[...d].sort((s,h)=>s.sortOrder-h.sortOrder).forEach(s=>n(s)),a},es=({isOpen:d,hasUsers:a=!1,onConfirm:n,onCancel:c})=>{const s=oe({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!d)return null;const h=a?s.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":s.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return C(ze,{open:!0,onClose:c,title:e(Ne,{children:a?s.cannotDeleteModalTitle||"Cannot Delete Role":s.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:h})}),e("div",{className:"delete-role-modal__actions",children:a?e(X,{variant:"primary",onClick:n,className:"delete-role-modal__ok-btn",children:s.cannotDeleteModalOk||"OK"}):C(Ne,{children:[e(X,{variant:"secondary",onClick:c,className:"delete-role-modal__cancel-btn",children:s.deleteModalCancel||"Cancel"}),e(X,{variant:"primary",onClick:n,className:"delete-role-modal__confirm-btn",children:s.deleteModalConfirm||"Delete"})]})})]})},Cs=({className:d,withHeader:a=!1})=>{const n=oe({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:c,handleSetInLineAlert:s}=Ge(),{permissions:h,loading:b,error:R}=He(),P=(h==null?void 0:h.canViewRoles)??!1,T=(h==null?void 0:h.canManageRoles)??!1,i=P||T,{roles:g,aclResources:F,isLoading:I,isCreating:v,isUpdating:x,error:_,createRole:Z,updateRole:u,deleteRole:E,clearError:S,refresh:z}=$e(te,i,!0),[M,O]=f(!1),[A,U]=f(!1),[w,N]=f(null),[$,L]=f(1),[V,t]=f(te),[y,B]=f("id"),[q,ae]=f("asc"),[k,Y]=f(null),[H,G]=f(null);W(()=>()=>{_&&S(),G(null)},[_,S]);const[o,l]=f(0);je(()=>{L(1),A&&(U(!1),N(null)),Y(null),S(),l(r=>r+1)},{eager:!0}),W(()=>{M&&!b&&!T&&(O(!1),G(null))},[M,b,T]),W(()=>{o!==0&&(b||i&&z())},[o,i,z,b]);const m=ce(()=>{const r=[...g];return r.sort((p,D)=>{let J,ee;if(y==="id"){const ye=Le=>{try{const fe=atob(Le),Re=fe.match(/role\/(\d+)/);if(Re)return parseInt(Re[1],10);const ge=parseInt(fe,10);return isNaN(ge)?0:ge}catch{return 0}};J=ye(p.id),ee=ye(D.id)}else if(y==="name")J=p.name.toLowerCase(),ee=D.name.toLowerCase();else if(y==="usersCount")J=p.usersCount||0,ee=D.usersCount||0;else return 0;return J<ee?q==="asc"?-1:1:J>ee?q==="asc"?1:-1:0}),r},[g,y,q]),j=m.length,Q=($-1)*V,se=Q+V,Pe=m.slice(Q,se);if(b&&!M&&!A)return e("div",{className:"roles-and-permissions-container","data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(R&&!M&&!A)return e("div",{className:"roles-and-permissions-container",children:e(ue,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(Ce,{heading:n.errorTitle||"Error Loading Permissions",message:e("p",{children:n.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})})});if(!i&&!M&&!A)return e("div",{className:"roles-and-permissions-container",children:e(ue,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(Ce,{heading:n.noAccessTitle||"Access Restricted",message:e("p",{children:n.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})})});const Te=r=>{L(r)},_e=r=>{t(r),L(1)},Ee=(r,p)=>{B(r),ae(p),L(1)},Se=()=>{G(null),O(!0)},pe=()=>{G(null),O(!1)},we=r=>{N(r),U(!0)},he=()=>{U(!1),N(null)},Ie=r=>{const p=g.find(D=>D.id===r);p&&(G({name:`${p.name} - Duplicated`,permissions:p.permissions||[]}),O(!0))},xe=async r=>{try{if(await Z({name:r.name,permissions:r.permissions})){const D=n.createSuccess?n.createSuccess.replace("{roleName}",r.name):`Role "${r.name}" created successfully!`;s({type:"success",text:D}),pe()}else s({type:"error",text:n.createError||"Failed to create role. Please try again."})}catch{s({type:"error",text:n.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},Me=async r=>{if(w)try{if(await u({id:w,name:r.name,permissions:r.permissions})){const D=n.updateSuccess?n.updateSuccess.replace("{roleName}",r.name):`Role "${r.name}" updated successfully!`;s({type:"success",text:D}),he()}else s({type:"error",text:n.updateError||"Failed to update role. Please try again."})}catch{s({type:"error",text:n.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},ke=r=>{const p=g.find(J=>J.id===r);if(!p)return;const D=p.usersCount>0;Y({id:r,name:p.name,hasUsers:D})},De=async()=>{if(k){if(k.hasUsers){Y(null);return}try{if(await E(k.id)){const p=n.deleteRoleSuccess?n.deleteRoleSuccess.replace("{roleName}",k.name||"Unknown Role"):`You have deleted role "${k.name||"Unknown Role"}".`;s({type:"success",text:p})}else s({type:"error",text:n.deleteError||"Failed to delete role. Please try again."})}catch{s({type:"error",text:n.deleteError||"Failed to delete role. Please try again."})}finally{Y(null)}}},Fe=()=>Y(null);return e("div",{className:"roles-and-permissions-container",children:C("div",{className:be(["roles-and-permissions",d]),children:[a?e(ne,{title:n.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,_&&e(re,{type:"error",heading:n.errorTitle||"Error",description:n.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:S}),c&&c.text&&e(re,{type:c.type||"success",heading:c.text,icon:c.icon}),M?e(Ae,{mode:"create",aclResources:F,existingRoleNames:g.map(r=>r.name),loading:v,onSubmit:xe,onCancel:()=>{G(null),pe()},inLineAlertProps:_?{type:"error",text:_}:void 0,prefillName:H==null?void 0:H.name,prefillPermissions:H==null?void 0:H.permissions},"create-role-form"):A&&w?e(Ae,{mode:"edit",role:g.find(r=>r.id===w),aclResources:F,existingRoleNames:g.map(r=>r.name),loading:x,onSubmit:Me,onCancel:he,inLineAlertProps:_?{type:"error",text:_}:void 0},`edit-role-form-${w}`):e(We,{roles:Pe,isLoading:I,canManageRoles:T,onShowCreateForm:Se,onShowEditForm:we,onDuplicateRole:Ie,onDeleteRole:ke,totalCount:j,currentPage:$,pageSize:V,onPageChange:Te,onPageSizeChange:_e,onSortChange:Ee,sortColumn:y,sortDirection:q}),e(es,{isOpen:!!k,hasUsers:k==null?void 0:k.hasUsers,onConfirm:De,onCancel:Fe})]})})};export{Cs as RolesAndPermissions,Cs as default};
//# sourceMappingURL=RolesAndPermissions.js.map
