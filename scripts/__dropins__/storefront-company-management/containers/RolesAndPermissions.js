/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as F,Fragment as he}from"@dropins/tools/preact-jsx-runtime.js";import{useState as N,useCallback as w,useEffect as ee,useMemo as me,useRef as te}from"@dropins/tools/preact-hooks.js";import{classes as le,VComponent as fe}from"@dropins/tools/lib.js";import{Button as X,Icon as Pe,Skeleton as we,SkeletonRow as Te,Picker as Ee,Checkbox as ke,Card as ue,Header as Ne,InLineAlert as pe,Field as Se,Input as xe,ProgressSpinner as ye,Modal as De,IllustratedMessage as ge}from"@dropins/tools/components.js";import{u as Ce}from"../chunks/useCompanyContextListener.js";import{g as be,a as Ie,c as Fe,u as Me,d as Be,i as ve}from"../chunks/isCompanyRoleNameAvailable.js";import{a as Re,b as Le}from"../chunks/company-permissions.js";import{f as Ue}from"../chunks/fetchUserPermissions.js";import{u as Oe}from"../chunks/useInLineAlert.js";import{useText as re}from"@dropins/tools/i18n.js";import{Fragment as ze}from"@dropins/tools/preact.js";import"@dropins/tools/event-bus.js";import"../chunks/fetch-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/preact-compat.js";const $e=({className:u,children:d,columns:i=[],rowData:h=[],mobileLayout:r="none",caption:f,expandedRows:U=new Set,loading:v=!1,skeletonRowCount:g=10,onSortChange:A,...p})=>{const b=re({sortedAscending:"Dropin.Table.sortedAscending",sortedDescending:"Dropin.Table.sortedDescending",sortBy:"Dropin.Table.sortBy"}),O=l=>{if(!A)return;let y;l.sortBy===!0?y="asc":l.sortBy==="asc"?y="desc":y=!0,A(l.key,y)},D=l=>{if(l.sortBy===void 0)return null;let y,_;return l.sortBy==="asc"?(y="ChevronUp",_=b.sortedAscending.replace("{label}",l.label)):l.sortBy==="desc"?(y="ChevronDown",_=b.sortedDescending.replace("{label}",l.label)):(y="Sort",_=b.sortBy.replace("{label}",l.label)),e(X,{variant:"tertiary",size:"medium",className:"dropin-table__header__sort-button",icon:e(Pe,{source:y}),"aria-label":_,onClick:()=>O(l)})},M=()=>Array.from({length:g},(l,y)=>e("tr",{className:"dropin-table__body__row",children:i.map(_=>e("td",{className:"dropin-table__body__cell","data-label":_.label,children:e(we,{children:e(Te,{variant:"row",size:"small",fullWidth:!0})})},_.key))},`skeleton-${y}`)),E=()=>h.map((l,y)=>{const _=l._rowDetails!==void 0,j=U.has(y);return F(ze,{children:[e("tr",{className:"dropin-table__body__row",children:i.map(B=>{const S=l[B.key];return typeof S=="string"||typeof S=="number"?e("td",{className:"dropin-table__body__cell","data-label":B.label,children:S},B.key):e("td",{className:"dropin-table__body__cell","data-label":B.label,children:e(fe,{node:S})},B.key)})}),_&&j&&e("tr",{className:"dropin-table__row-details dropin-table__row-details--expanded",id:`row-${y}-details`,children:e("td",{className:"dropin-table__row-details__cell",colSpan:i.length,role:"region","aria-labelledby":`row-${y}-details`,children:typeof l._rowDetails=="string"?l._rowDetails:e(fe,{node:l._rowDetails})})},`${y}-details`)]},y)}),H=l=>{if(l.sortBy===!0)return"none";if(l.sortBy==="asc")return"ascending";if(l.sortBy==="desc")return"descending"};return e("div",{className:le(["dropin-table",`dropin-table--mobile-layout-${r}`,u]),children:F("table",{...p,className:"dropin-table__table",children:[f&&e("caption",{className:"dropin-table__caption",children:f}),e("thead",{className:"dropin-table__header",children:e("tr",{className:"dropin-table__header__row",children:i.map(l=>F("th",{className:le(["dropin-table__header__cell",["dropin-table__header__cell--sorted",l.sortBy==="asc"||l.sortBy==="desc"],["dropin-table__header__cell--sortable",l.sortBy!==void 0]]),"aria-sort":H(l),children:[l.label,D(l)]},l.key))})}),e("tbody",{className:"dropin-table__body",children:v?M():E()})]})})},ne=20,Ve=(u=ne,d=!0,i=!1)=>{const[h,r]=N([]),[f,U]=N([]),[v,g]=N(0),[A,p]=N(1),[b,O]=N(u),[D,M]=N(1),[E,H]=N(!1),[l,y]=N(!1),[_,j]=N(!1),[B,S]=N(!1),[G,T]=N(null),C=w(async(s={})=>{H(!0),T(null);try{if(i){const t=await be({pageSize:1e3,currentPage:1,...s});r(t.items),g(t.totalCount),M(1),p(1)}else{const t=await be({pageSize:b,currentPage:A,...s});r(t.items),g(t.totalCount),M(t.pageInfo.totalPages),p(t.pageInfo.currentPage)}}catch(t){T(t instanceof Error?t.message:"Failed to fetch roles")}finally{H(!1)}},[i,b,A]),z=w(async()=>{try{const s=await Ie();U(s)}catch(s){T(s instanceof Error?s.message:"Failed to fetch ACL resources")}},[]),$=w(async s=>{y(!0),T(null);try{const t=await Fe(s);return await C(),t}catch(t){return T(t instanceof Error?t.message:"Failed to create role"),null}finally{y(!1)}},[C]),c=w(async s=>{j(!0),T(null);try{const t=await Me(s);return r(P=>P.map(k=>k.id===t.id?t:k)),t}catch(t){return T(t instanceof Error?t.message:"Failed to update role"),null}finally{j(!1)}},[]),x=w(async s=>{S(!0),T(null);try{const t=await Be({id:s});return t&&(r(P=>P.filter(k=>k.id!==s)),g(P=>P-1)),t}catch(t){return T(t instanceof Error?t.message:"Failed to delete role"),!1}finally{S(!1)}},[]),V=w(async s=>{try{return await ve({name:s})}catch(t){return T(t instanceof Error?t.message:"Failed to check role name availability"),!1}},[]),K=w(s=>{p(s)},[]),W=w(s=>{O(s),p(1)},[]),Y=w(async()=>{await Promise.all([C(),z()])},[C,z]),Z=w(()=>{T(null)},[]);return ee(()=>{if(d){const s=setTimeout(()=>{C()},100);return()=>clearTimeout(s)}},[C,d]),ee(()=>{if(d){const s=setTimeout(()=>{z()},100);return()=>clearTimeout(s)}},[z,d]),Ce(w(async()=>{p(1),await Y()},[Y]),{eager:!0}),{roles:h,aclResources:f,totalCount:v,currentPage:A,pageSize:b,totalPages:D,isLoading:E,isCreating:l,isUpdating:_,isDeleting:B,error:G,fetchRoles:C,fetchAclResources:z,createRole:$,updateRole:c,deleteRole:x,checkRoleNameAvailability:V,setPage:K,setPageSize:W,refresh:Y,clearError:Z}},qe=u=>{try{if(/^\d+$/.test(u))return u;const i=atob(u).match(/(\d+)$/);return i?i[1]:u}catch(d){return console.warn("Failed to decode role ID:",u,d),u}},He=({className:u,roles:d,isLoading:i,canManageRoles:h=!1,onShowCreateForm:r,onShowEditForm:f,onDuplicateRole:U,onDeleteRole:v,totalCount:g=d.length,currentPage:A=1,pageSize:p=ne,onPageChange:b,onPageSizeChange:O,children:D,...M})=>{const E=re({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),H=[{key:"id",label:E.columnId||"ID"},{key:"name",label:E.columnRole||"Role"},{key:"usersCount",label:E.columnUsers||"Users"},{key:"actions",label:E.columnActions||"Actions"}],l=w(c=>h&&c.id!=="0",[h]),y=w(c=>h&&c.id!=="0",[h]),_=w(c=>h&&c.id!=="0"&&g>1,[h,g]),j=w(c=>{const x=[];return l(c)&&x.push(e(X,{variant:"tertiary",size:"medium",onClick:()=>f(c.id),className:"role-action-button",children:E.editButton||"Edit"},"edit")),y(c)&&U&&x.push(e(X,{variant:"tertiary",size:"medium",onClick:()=>U(c.id),className:"role-action-button",children:E.duplicateButton||"Duplicate"},"duplicate")),_(c)&&v&&x.push(e(X,{variant:"tertiary",size:"medium",onClick:()=>v(c.id),className:"role-action-button",children:E.deleteButton||"Delete"},"delete")),x.length===0?h?e("span",{className:"no-actions",children:E.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:x.map((V,K)=>F("span",{className:"role-action-wrapper",children:[K>0&&e("span",{className:"separator",children:"|"}),V]},K))})},[l,y,_,f,U,v,E,h]),B=me(()=>d.map(c=>({id:qe(c.id),name:c.name,usersCount:c.usersCount,actions:e("div",{className:"roles-actions",children:j(c)})})),[d,j]),S=[ne,30,50,100,200].map(c=>({value:c.toString(),label:c.toString(),text:c.toString()})),G=Math.ceil(g/p),T=A<G,C=A>1,z=(A-1)*p,$=z+p;return F("div",{...M,className:le(["company-management-role-and-permission-table",u]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e($e,{columns:H,rowData:B,mobileLayout:"none",loading:i,skeletonRowCount:10})}),F("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:F("span",{className:"item-count",children:["Items ",z+1," to ",Math.min($,g)," of ",g," total"]})}),G>1&&e("div",{className:"table-footer-center",children:F("div",{className:"page-navigation",children:[e(X,{variant:"tertiary",size:"medium",onClick:()=>b==null?void 0:b(A-1),disabled:!C,className:"page-nav-button",children:"<"}),e("span",{className:"page-info",children:A}),e(X,{variant:"tertiary",size:"medium",onClick:()=>b==null?void 0:b(A+1),disabled:!T,className:"page-nav-button",children:">"})]})}),e("div",{className:"table-footer-right",children:F("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:E.show||"Show"}),e(Ee,{value:p.toString(),onChange:c=>{const x=c.target;O==null||O(parseInt(x.value,10))},options:S,className:"page-size-picker",placeholder:"Select page size"}),e("span",{className:"pagination-label",children:E.perPage||"per page"})]})})]}),h&&e("div",{className:"add-role-section",children:e(X,{variant:"primary",onClick:r,children:E.addNewRole||"Add New Role"})}),D]})},je=(u,d=!1)=>{const i=new Map;for(const h of u){const r=h.parentId??null,f=i.get(r)??[];f.push(h),i.set(r,f)}if(!d)for(const[,h]of i)h.sort((r,f)=>r.label.localeCompare(f.label));return i},Ge=({items:u,rootId:d=null,className:i,expandedIds:h,selectedId:r=null,selectedIds:f,onExpandedChange:U,onSelectedChange:v,onSelectedIdsChange:g,renderNode:A,role:p="tree",preserveOrder:b=!1,draggable:O,canDrop:D,onMove:M,isCheckable:E,checkedIds:H,onCheckedChange:l,biDirectionalChecking:y=!1,renderExpander:_,renderCheckbox:j,renderIcon:B})=>{const S=me(()=>je(u,b),[u,b]),G=te(null),T=te(!1),C=me(()=>new Map(u.map(s=>[s.id,s])),[u]),z=(s,t)=>{const P=[],k=[t];for(;k.length;){const n=k.pop(),a=s.get(n)??[];for(const o of a)P.push(o.id),k.push(o.id)}return P},$=w(s=>z(S,s),[S]),c=w(s=>E?E(s):!0,[E]),x=w(s=>{if(!C.get(s))return{checked:!1,indeterminate:!1};const P=H??new Set;if(y){if(P.has(s))return{checked:!0,indeterminate:!1};const a=$(s).filter(R=>{const q=C.get(R);return q?c(q):!1});return a.length===0?{checked:!1,indeterminate:!1}:a.reduce((R,q)=>P.has(q)?R+1:R,0)===0?{checked:!1,indeterminate:!1}:{checked:!1,indeterminate:!0}}const k=[s,...$(s)].filter(a=>{const o=C.get(a);return o?c(o):!1});if(k.length===0)return{checked:!1,indeterminate:!1};const n=k.reduce((a,o)=>P.has(o)?a+1:a,0);return n===0?{checked:!1,indeterminate:!1}:n===k.length?{checked:!0,indeterminate:!1}:{checked:!1,indeterminate:!0}},[C,$,c,H,y]),V=w(s=>{if(!l)return;const t=new Set(H??[]),{checked:P}=x(s),k=$(s),n=[s,...k].filter(a=>{const o=C.get(a);return o?c(o):!1});if(P)for(const a of n)t.delete(a);else for(const a of n)t.add(a);if(y){const a=C.get(s);if(a){let o=a.parentId;for(;o;){const R=C.get(o);if(!R||!c(R))break;P?(S.get(o)??[]).some(J=>c(J)&&t.has(J.id))||t.delete(o):t.add(o),o=R.parentId}}}l(t)},[H,l,x,$,C,S,c,y]),K=w(s=>e(ke,{name:`tree-checkbox-${Math.random().toString(36).substr(2,9)}`,checked:s.checked,indeterminate:s.indeterminate,onChange:s.onCheck}),[]),W=w(s=>{const t=new Set(h);t.has(s)?t.delete(s):t.add(s),U(t)},[h,U]),Y=w(s=>{const t=C.get(s);if(t&&c(t)&&l&&V(s),!g){v==null||v(s);return}const P=!!T.current,k=P?new Set(f??[]):new Set;P&&k.has(s)?k.delete(s):k.add(s),g(k),T.current=!1},[v,g,f,C,c,l,V]),Z=(s,t)=>{const P=S.get(s)??[];return P.length?e("ul",{role:t===1?p:"group",className:t===1?i??"acm-tree":"acm-tree__group",children:P.map((n,a)=>{const o=(S.get(n.id)??[]).length>0,R=h.has(n.id),q=f?f.has(n.id):r===n.id,se=!!(O!=null&&O(n)),J=L=>D?D(L,n.id):L!==n.id,ae=o?()=>_?_({expanded:R,hasChildren:o,toggle:()=>W(n.id)}):null:void 0,oe=(()=>{if(!l)return;const L=C.get(n.id);if(!L||!c(L))return;const m=x(n.id),I=j||K;return()=>I({checked:m.checked,indeterminate:m.indeterminate,onCheck:()=>V(n.id)})})(),ie=B?()=>B({item:n,level:t,hasChildren:o,expanded:R}):void 0,ce=A({item:n,level:t,expanded:R,selected:!!q,hasChildren:o,toggle:()=>W(n.id),select:()=>Y(n.id),...ae?{expander:ae}:{},...oe?{checkbox:oe}:{},...ie?{icon:ie}:{}});return F("li",{role:"treeitem",className:"acm-tree__item","data-level":t,"aria-expanded":o?R:void 0,"aria-selected":q||void 0,"aria-level":t,"aria-setsize":P.length,"aria-posinset":a+1,draggable:se,onMouseDown:L=>{T.current=!!(L.metaKey||L.ctrlKey)},onDragStart:L=>{var m;if(L.stopPropagation(),!!se){G.current=n.id;try{(m=L.dataTransfer)==null||m.setData("text/plain",n.id)}catch{}}},onDragOver:L=>{var I;L.stopPropagation();const m=G.current??(((I=L.dataTransfer)==null?void 0:I.getData("text/plain"))||"");m&&J(m)&&L.preventDefault()},onDrop:L=>{var I;L.stopPropagation();const m=G.current??(((I=L.dataTransfer)==null?void 0:I.getData("text/plain"))||"");G.current=null,m&&J(m)&&(M==null||M({id:m,newParentId:n.id}))},children:[ce,o&&R?Z(n.id,t+1):null]},n.id)})}):null};return e("div",{className:"acm-tree-root",children:Z(d,1)})},Ke={MAX_LENGTH:40},de=u=>(typeof u=="string"?u:String(u||"")).trim().slice(0,Ke.MAX_LENGTH),_e=({mode:u,role:d,aclResources:i,existingRoleNames:h=[],loading:r=!1,onSubmit:f,onCancel:U,inLineAlertProps:v,prefillName:g,prefillPermissions:A})=>{const p=re({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[b,O]=N({name:(d==null?void 0:d.name)||""}),[D,M]=N({}),[E,H]=N({}),[l,y]=N(!1),[_,j]=N(!1),[B,S]=N([]),[G,T]=N(new Set),[C,z]=N(new Set),$=te(null),c=te("");ee(()=>{if(u==="edit"&&d){if(O({name:d.name}),d.permissions&&d.permissions.length>0){const n=Re(d.permissions);z(new Set(n))}}else if(u==="create")if(O({name:g??""}),A&&A.length>0){const a=Re(A);z(new Set(a))}else z(new Set)},[u,d,g,A]),ee(()=>{if(i.length>0){const n=Xe(i);S(n);const a=n.filter(o=>!o.parentId).map(o=>o.id);T(new Set(a))}},[i]),ee(()=>()=>{$.current&&clearTimeout($.current)},[]);const x=w(n=>{const a=de(n);return a?(u==="edit"&&d?h.filter(R=>R!==d.name):h).includes(a)?p.roleNameExists:null:p.roleNameRequired||"This is a required field."},[u,d,h,p.roleNameRequired,p.roleNameExists]),V=w(async n=>{const a=de(n),o=x(a);if(o)return o;if(u==="edit"&&d&&a===d.name)return null;try{return y(!0),await ve({name:a})?null:p.roleNameExists}catch(R){return console.error("Role name validation failed:",R),null}finally{y(!1)}},[u,d,p.roleNameExists,x]),K=w(n=>{$.current&&clearTimeout($.current),n!==c.current&&($.current=setTimeout(async()=>{const a=await V(n);M(a?o=>({...o,name:a}):o=>({...o,name:""})),c.current=n},500))},[V]),W=()=>{const n={};let a=!0;const o=x(b.name);return o&&(n.name=o,a=!1),M(n),a},Y=n=>{const a=typeof n=="string"?n:n.target.value;O(o=>({...o,name:a})),D.name&&M(o=>({...o,name:""})),K(a)},Z=n=>{const o=n.target.value;H(R=>({...R,name:!0})),$.current&&clearTimeout($.current),V(o).then(R=>{M(R?q=>({...q,name:R}):q=>({...q,name:""})),c.current=o})},s=()=>{const n=new Set(B.map(a=>a.id));T(n)},t=()=>{T(new Set)},P=async n=>{n.preventDefault(),H({name:!0}),j(!0);try{const a=await V(b.name);if(a){M(R=>({...R,name:a}));return}if(!W())return;const o={name:de(b.name),permissions:Array.from(C)};f&&await f(o)}catch(a){console.error("Form submission failed:",a)}finally{j(!1)}},k=u==="create"?p.createTitle:p.editTitle;return F(ue,{variant:"secondary",className:"edit-role-and-permission",children:[e(Ne,{title:k,divider:!1,className:"edit-role-and-permission__title"}),(v==null?void 0:v.text)&&e(pe,{className:"edit-role-and-permission__notification",type:v.type,variant:"secondary",heading:v.text,"data-testid":"editRoleInLineAlert"}),F("form",{className:"edit-role-and-permission-form",onSubmit:P,children:[F("div",{className:"edit-role-and-permission__section",children:[e("h3",{className:"edit-role-and-permission__section-title",children:p.roleInformation||"Role Information"}),e(Se,{label:p.roleName||"Role Name",required:!0,error:E.name&&D.name?D.name:void 0,children:e(xe,{type:"text",name:"roleName",value:b.name,onChange:Y,onBlur:Z,disabled:r||_,"data-testid":"roleNameInput",placeholder:p.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),l&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(ye,{size:"medium"})})]}),F("div",{className:"edit-role-and-permission__section",children:[e("h3",{className:"edit-role-and-permission__section-title",children:p.rolePermissions}),e("p",{className:"edit-role-and-permission__permissions-description",children:p.permissionsDescription}),F("div",{className:"edit-role-and-permission__tree-controls",children:[e(X,{type:"button",variant:"tertiary",onClick:s,disabled:r||_,children:p.expandAll}),e(X,{type:"button",variant:"tertiary",onClick:t,disabled:r||_,children:p.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":p.rolePermissions,children:B.length>0?e(Ge,{items:B,expandedIds:G,onExpandedChange:T,checkedIds:C,onCheckedChange:z,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:n,expanded:a,hasChildren:o,toggle:R,checkbox:q})=>F("div",{className:"edit-role-and-permission__tree-node",children:[o&&e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:R,"aria-label":a?`Collapse ${n.label}`:`Expand ${n.label}`,children:a?"âˆ’":"+"}),q&&q(),e("span",{className:"edit-role-and-permission__tree-label",children:n.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),F("div",{className:"edit-role-and-permission__actions",children:[e(X,{type:"button",variant:"secondary",onClick:U,disabled:r||_,children:p.cancel}),e(X,{type:"submit",variant:"primary",disabled:r||_||l,children:r||_?p.saving:p.saveRole})]})]}),(r||_)&&F("div",{className:"edit-role-and-permission__loading-overlay",children:[e(ye,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:p.saving})]})]})},Xe=u=>{const d=[],i=(r,f)=>{d.push({id:r.id,parentId:f||null,label:r.text}),r.children&&[...r.children].sort((v,g)=>v.sortOrder-g.sortOrder).forEach(v=>{i(v,r.id)})};return[...u].sort((r,f)=>r.sortOrder-f.sortOrder).forEach(r=>i(r)),d},Ye=({isOpen:u,hasUsers:d=!1,onConfirm:i,onCancel:h})=>{const r=re({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!u)return null;const f=d?r.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":r.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return F(De,{open:!0,onClose:h,title:e(he,{children:d?r.cannotDeleteModalTitle||"Cannot Delete Role":r.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:f})}),e("div",{className:"delete-role-modal__actions",children:d?e(X,{variant:"primary",onClick:i,className:"delete-role-modal__ok-btn",children:r.cannotDeleteModalOk||"OK"}):F(he,{children:[e(X,{variant:"secondary",onClick:h,className:"delete-role-modal__cancel-btn",children:r.deleteModalCancel||"Cancel"}),e(X,{variant:"primary",onClick:i,className:"delete-role-modal__confirm-btn",children:r.deleteModalConfirm||"Delete"})]})})]})},We=()=>{const[u,d]=N(null),[i,h]=N(!0),[r,f]=N(null),U=te(!1),v=te(!1),g=w(async()=>{var A,p;if(!U.current){U.current=!0,h(!0),f(null);try{const{roleResponse:b}=await Ue(),O=(p=(A=b==null?void 0:b.data)==null?void 0:A.customer)==null?void 0:p.role,D=Le(O);d(D)}catch(b){console.error("Failed to fetch user permissions:",b),f(b)}finally{h(!1),U.current=!1}}},[]);return ee(()=>{v.current||(v.current=!0,g())},[g]),{permissions:u,loading:i,error:r,refetch:g}},ps=({className:u,withHeader:d=!1})=>{const i=re({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:h,handleSetInLineAlert:r}=Oe(),{permissions:f,loading:U,error:v}=We(),{roles:g,aclResources:A,isLoading:p,isCreating:b,isUpdating:O,error:D,createRole:M,updateRole:E,deleteRole:H,clearError:l}=Ve(ne,!0,!0),[y,_]=N(!1),[j,B]=N(!1),[S,G]=N(null),[T,C]=N(1),[z,$]=N(ne),[c,x]=N(null),[V,K]=N(null);ee(()=>()=>{D&&l(),K(null)},[D,l]),Ce(()=>{C(1),j&&(B(!1),G(null)),x(null),l()},{eager:!0});const W=(f==null?void 0:f.canViewRoles)??!1,Y=(f==null?void 0:f.canManageRoles)??!1,Z=W||Y;if(U)return e("div",{"data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(v)return e(ue,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(ge,{heading:i.errorTitle||"Error Loading Permissions",message:e("p",{children:i.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})});if(!Z)return e(ue,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(ge,{heading:i.noAccessTitle||"Access Restricted",message:e("p",{children:i.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})});const s=g.length,t=(T-1)*z,P=t+z,k=g.slice(t,P),n=m=>{C(m)},a=m=>{$(m),C(1)},o=()=>{K(null),_(!0)},R=()=>{K(null),_(!1)},q=m=>{G(m),B(!0)},se=()=>{B(!1),G(null)},J=m=>{const I=g.find(Q=>Q.id===m);I&&(K({name:`${I.name} - Duplicated`,permissions:I.permissions||[]}),_(!0))},ae=async m=>{try{if(await M({name:m.name,permissions:m.permissions})){const Q=i.createSuccess?i.createSuccess.replace("{roleName}",m.name):`Role "${m.name}" created successfully!`;r({type:"success",text:Q}),R()}else r({type:"error",text:i.createError||"Failed to create role. Please try again."})}catch{r({type:"error",text:i.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},oe=async m=>{if(S)try{if(await E({id:S,name:m.name,permissions:m.permissions})){const Q=i.updateSuccess?i.updateSuccess.replace("{roleName}",m.name):`Role "${m.name}" updated successfully!`;r({type:"success",text:Q}),se()}else r({type:"error",text:i.updateError||"Failed to update role. Please try again."})}catch{r({type:"error",text:i.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},ie=m=>{const I=g.find(Ae=>Ae.id===m);if(!I)return;const Q=I.usersCount>0;x({id:m,name:I.name,hasUsers:Q})},ce=async()=>{if(c){if(c.hasUsers){x(null);return}try{if(await H(c.id)){const I=i.deleteRoleSuccess?i.deleteRoleSuccess.replace("{roleName}",c.name||"Unknown Role"):`You have deleted role "${c.name||"Unknown Role"}".`;r({type:"success",text:I})}else r({type:"error",text:i.deleteError||"Failed to delete role. Please try again."})}catch{r({type:"error",text:i.deleteError||"Failed to delete role. Please try again."})}finally{x(null)}}},L=()=>x(null);return F("div",{className:le(["roles-and-permissions",u]),children:[d?e(Ne,{title:i.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,D&&e(pe,{type:"error",heading:i.errorTitle||"Error",description:i.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:l}),h&&h.text&&e(pe,{type:h.type||"success",heading:h.text,icon:h.icon}),y?e(_e,{mode:"create",aclResources:A,existingRoleNames:g.map(m=>m.name),loading:b,onSubmit:ae,onCancel:()=>{K(null),R()},inLineAlertProps:D?{type:"error",text:D}:void 0,prefillName:V==null?void 0:V.name,prefillPermissions:V==null?void 0:V.permissions}):j&&S?e(_e,{mode:"edit",role:g.find(m=>m.id===S),aclResources:A,existingRoleNames:g.map(m=>m.name),loading:O,onSubmit:oe,onCancel:se,inLineAlertProps:D?{type:"error",text:D}:void 0}):e(He,{roles:k,isLoading:p,canManageRoles:Y,onShowCreateForm:o,onShowEditForm:q,onDuplicateRole:J,onDeleteRole:ie,totalCount:s,currentPage:T,pageSize:z,onPageChange:n,onPageSizeChange:a}),e(Ye,{isOpen:!!c,hasUsers:c==null?void 0:c.hasUsers,onConfirm:ce,onCancel:L})]})};export{ps as RolesAndPermissions,ps as default};
//# sourceMappingURL=RolesAndPermissions.js.map
