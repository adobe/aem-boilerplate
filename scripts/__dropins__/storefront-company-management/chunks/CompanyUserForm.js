/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as P,jsx as o}from"@dropins/tools/preact-jsx-runtime.js";import{memo as D}from"@dropins/tools/preact-compat.js";import{useState as d,useEffect as H}from"@dropins/tools/preact-hooks.js";import{Card as J,InLineAlert as K,ProgressSpinner as Q,Field as S,Input as A,Picker as z,Button as O}from"@dropins/tools/components.js";import{i as W}from"./company-permissions.js";import{g as X,c as Y,u as Z,i as ee}from"./updateCompanyUser.js";import{useText as G}from"@dropins/tools/i18n.js";import{u as ae}from"./useCompanyRoles.js";import{c as te}from"./CompanyLoaders.js";function re(q){const{mode:I,entityId:h,parentStructureId:T,onSaved:w,onError:N,onSuccess:v}=q,u=G({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError",createUserSuccess:"Company.CompanyStructure.messages.createUserSuccess",updateUserSuccess:"Company.CompanyStructure.messages.updateUserSuccess"}),[r,U]=d({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[x,c]=d({}),[m,p]=d({}),[V,R]=d(!1),[y,j]=d(null),[_,E]=d(null),[b,k]=d(""),[l,a]=d(""),[i,B]=d(!1);H(()=>{I!=="edit"||!h||(R(!0),X(h).then(e=>{var f;if(!e)return;const t=e.email||"";U(g=>({...g,firstName:e.firstName||"",lastName:e.lastName||"",email:t,jobTitle:e.jobTitle||"",telephone:e.telephone||"",status:e.status||"ACTIVE"})),a(t),(f=e==null?void 0:e.role)!=null&&f.id&&U(g=>({...g,roleId:e.role.id})),B((e==null?void 0:e.isCompanyAdmin)??!1)}).finally(()=>R(!1)))},[I,h]);const F=e=>/.+@.+\..+/.test(e),M=(e,t)=>e==="firstName"?t!=null&&t.trim()?null:u.firstNameRequired:e==="lastName"?t!=null&&t.trim()?null:u.lastNameRequired:e==="email"?t!=null&&t.trim()?F(t.trim())?null:u.emailInvalid:u.emailRequired:e==="roleId"?t?null:u.selectRole:null,$=(e,t)=>{U(f=>({...f,[e]:t})),e==="email"&&E(null),y&&j(null)};return{values:r,errors:x,touched:m,loading:V,setValue:$,onBlur:async(e,t)=>{t!==void 0&&$(e,t),p(C=>({...C,[e]:!0}));const f=t!==void 0?t:r[e],g=M(e,f);if(c(g?C=>({...C,[e]:g}):C=>{const s={...C};return delete s[e],s}),e==="email"){const s=(t!==void 0?t:r.email||"").trim();if(I==="edit"&&s.toLowerCase()===(l||"").trim().toLowerCase()){E(null);return}if(F(s)&&s!==b){const n=await ee(s);k(s),E(n),n===!1&&c(L=>({...L,email:"A user with this email address is already a member of your company."}))}}},submit:async()=>{const e=["firstName","lastName","email","roleId"],t={};for(const s of e){const n=M(s,r[s]);n&&(t[s]=n)}if(c(t),p({firstName:!0,lastName:!0,email:!0,roleId:!0}),Object.keys(t).length||_===!1){setTimeout(()=>{const s=document.querySelector(".company-user-form__content .dropin-field__hint--error");if(s){const n=s.closest(".dropin-field");if(n){n.scrollIntoView({behavior:"smooth",block:"center"});const L=n.querySelector("input, select");L&&L.focus()}}},100);return}const f=`${r.firstName||""} ${r.lastName||""}`.trim()||r.email||"",C=i||W({id:r.roleId})?"ACTIVE":r.status;try{if(I==="add"){const s=await Y({email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",roleId:r.roleId,status:C,targetId:T??null});if(!s){const n=u.createUserError;N?N(n):j(n);return}w({label:f,structureId:s.structureId,entityId:s.id,type:"user"}),v&&v(u.createUserSuccess)}else h&&(await Z({id:h,email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",status:C,roleId:r.roleId}),w({label:f,entityId:h,type:"user"}),v&&v(u.updateUserSuccess))}catch(s){const n=s instanceof Error?s.message:u.saveUserError;N?N(n):j(n)}},isCompanyAdmin:i,generalError:y}}const fe=D(({mode:q,entityId:I,parentStructureId:h,permissions:T,onSaved:w,onCancel:N,onError:v,onSuccess:u})=>{const r=(T==null?void 0:T.canEditUsers)??!1,{roles:U,isLoading:x}=ae(),{values:c,errors:m,touched:p,loading:V,setValue:R,onBlur:y,submit:j,isCompanyAdmin:_,generalError:E}=re({mode:q,entityId:I,parentStructureId:h,onSaved:w,onError:v?a=>{v(a),N()}:void 0,onSuccess:u}),[b,k]=d(!1),l=G({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator",save:"Company.CompanyStructure.shared.buttons.save",cancel:"Company.CompanyStructure.shared.buttons.cancel"});return P("div",{children:[o("h3",{className:"acm-structure-panel__title",children:q==="add"?l.addUser:l.editUser}),P(J,{variant:"secondary",className:`company-user-form__card ${b?"is-working":""}`,children:[!v&&E?o(K,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:E}):null,b?o("div",{className:"company-user-form__overlay","aria-live":"polite",children:o(Q,{size:"small"})}):null,V||x?o(te,{}):P("div",{className:"company-user-form__content",children:[o(S,{label:l.jobTitle,className:"acm-structure-panel__field",error:p.jobTitle&&m.jobTitle?m.jobTitle:void 0,children:o(A,{name:"job_title",type:"text",value:c.jobTitle||"",onBlur:a=>{const i=a.target;y("jobTitle",i.value)},variant:"primary",size:"medium"})}),o(S,{label:l.userRole,required:!0,className:"acm-structure-panel__field",error:!_&&p.roleId&&m.roleId?m.roleId:void 0,disabled:_,children:_?o(z,{name:"role",value:"MA==",options:[{value:"MA==",text:l.companyAdministrator}]}):o(z,{name:"role",value:c.roleId||"placeholder",onChange:a=>{var i,B;return R("roleId",String(((i=a==null?void 0:a.target)==null?void 0:i.value)==="placeholder"?"":((B=a==null?void 0:a.target)==null?void 0:B.value)??""))},onBlur:a=>{const i=a.target;y("roleId",i.value==="placeholder"?"":i.value)},options:[{value:"placeholder",text:l.selectRole,disabled:!0},...U.map(a=>({value:a.id,text:a.name}))]})}),o(S,{label:l.firstName,required:!0,className:"acm-structure-panel__field",error:p.firstName&&m.firstName?m.firstName:void 0,children:o(A,{name:"first_name",type:"text",value:c.firstName,onBlur:a=>{const i=a.target;y("firstName",i.value)},variant:"primary",size:"medium"})}),o(S,{label:l.lastName,required:!0,className:"acm-structure-panel__field",error:p.lastName&&m.lastName?m.lastName:void 0,children:o(A,{name:"last_name",type:"text",value:c.lastName,onBlur:a=>{const i=a.target;y("lastName",i.value)},variant:"primary",size:"medium"})}),o(S,{label:l.email,required:!0,className:"acm-structure-panel__field",error:p.email&&m.email?m.email:void 0,children:o(A,{name:"email",type:"email",value:c.email,onBlur:a=>{const i=a.target;y("email",i.value)},placeholder:"jdoe@example.com",variant:"primary",size:"medium"})}),o(S,{label:l.workPhoneNumber,className:"acm-structure-panel__field",error:p.telephone&&m.telephone?m.telephone:void 0,children:o(A,{name:"telephone",type:"text",value:c.telephone||"",onBlur:a=>{const i=a.target;y("telephone",i.value)},variant:"primary",size:"medium"})}),o(S,{label:l.status,className:"acm-structure-panel__field",disabled:_||!r,children:o(z,{name:"status",value:c.status,onChange:a=>{var i;return R("status",String(((i=a==null?void 0:a.target)==null?void 0:i.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:l.active},{value:"INACTIVE",text:l.inactive}]})})]})]}),V||x?null:P("div",{className:"acm-structure-modal__actions",children:[o(O,{type:"button",variant:"primary",disabled:b||!r,onClick:async()=>{if(!b){k(!0);try{await j()}finally{k(!1)}}},children:l.save}),o(O,{type:"button",variant:"secondary",disabled:b,onClick:N,children:l.cancel})]})]})});export{fe as C};
//# sourceMappingURL=CompanyUserForm.js.map
