/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as L,jsx as r}from"@dropins/tools/preact-jsx-runtime.js";import{classes as le}from"@dropins/tools/lib.js";import{i as ne,g as oe,P as ie,d as ce}from"../chunks/pageSize.config.js";import{P as de}from"../chunks/PurchaseOrdersHeader.js";import"../chunks/PurchaseOrderHistoryLogContent.js";import{ActionButton as V,Tag as ue,Button as pe,Skeleton as he,SkeletonRow as me}from"@dropins/tools/components.js";import{useState as f,useEffect as W,useCallback as v,useMemo as X}from"@dropins/tools/preact-hooks.js";import{events as Y}from"@dropins/tools/event-bus.js";import{u as be}from"../chunks/useCustomerRolePermissions.js";import{g as ge,d as fe}from"../chunks/getPurchaseOrderApprovalRules.js";import{Text as w,useText as we}from"@dropins/tools/i18n.js";import"@dropins/tools/preact.js";import"../chunks/permissions.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-purchase-order-approval-rule.js";const ee=[{key:"ruleName",label:"Rule Name"},{key:"status",label:"Status"},{key:"createdBy",label:"Created By"},{key:"action",label:"Actions"}],Pe=20,Te=({routeApprovalRuleDetails:u,routeCreateApprovalRule:p,routeEditApprovalRule:h,setColumns:m,setRowsData:P,initialPageSize:$,permissions:y,loadingPermissions:S,t:l})=>{const[b,o]=f([]),[T,n]=f(!0),[k,i]=f(!0),[c,A]=f($),[U,x]=f({currentPage:1,totalPages:1,totalCount:0}),[O,g]=f(new Set);W(()=>{const s=Y.on("purchase-order/refresh",()=>{n(!0)},{eager:!0});return()=>{s==null||s.off()}},[]);const{currentPage:R,totalPages:N,totalCount:re}=U,I=v(s=>{x(t=>({...t,currentPage:s})),g(new Set),n(!0)},[]),se=v(s=>{const t=s.target.value;A(e=>e.map(a=>({...a,selected:a.value===t}))),I(1),g(new Set),n(!0)},[I]),H=v(s=>{g(t=>{const e=new Set(t);return e.has(s)?e.delete(s):e.add(s),e})},[]);W(()=>{var e;if(!T||S)return;i(!0);const s=(e=c==null?void 0:c.find(a=>a.selected))==null?void 0:e.value,t=parseInt(s??Pe.toString(),10);ge(R,t).then(a=>{var z,E;const j=(a==null?void 0:a.items)??[],B=(z=a==null?void 0:a.pageInfo)==null?void 0:z.currentPage,C=(E=a==null?void 0:a.pageInfo)==null?void 0:E.totalPages,D=a==null?void 0:a.totalCount;x({currentPage:B>C?C||1:B,totalPages:C,totalCount:D}),o(j)}).catch(a=>{console.error("Error fetching approval rules:",a),o([])}).finally(()=>{i(!1),n(!1)})},[T,R,c,N,S]);const _=v((s,t)=>{let e="";switch(t){case"new":{e=p==null?void 0:p(s);break}case"edit":{e=h==null?void 0:h(s);break}case"view":{e=u==null?void 0:u(s);break}}return ne(e??"")?e:"#"},[p,h,u]),ae=X(()=>(m==null?void 0:m(ee))??ee.map(s=>({...s,label:l[s.key]||s.label})),[m,l]),M=v((s,t)=>{s.preventDefault(),i(!0),fe(t).then(()=>{Y.emit("purchase-order/refresh",!0)}).finally(()=>{g(new Set)})},[]),te=X(()=>{const s=b==null?void 0:b.map((e,a)=>{var G,Z,q,J,K,Q;const{isAdmin:j,permissions:{manageApprovalRules:B}}=y,C=O.has(a),D=j||B,z=r(V,{onClick:()=>H(a),children:r(w,{id:`PurchaseOrders.purchaseOrdersTable.buttons.${C?"expandedHidden":"expandedShow"}`})}),E=L("div",{className:"b2b-purchase-order-purchase-orders-table__row-details",children:[L("div",{className:"b2b-purchase-order-purchase-orders-table__row-details-content",children:[L("p",{children:[r("span",{children:r(w,{id:"PurchaseOrders.purchaseOrdersTable.expandedRowLabels.ruleType"})})," ",r(w,{id:`PurchaseOrders.purchaseOrdersTable.ruleTypes.${(Z=(G=e.condition)==null?void 0:G.attribute)==null?void 0:Z.toLocaleLowerCase()}`})]}),r("p",{children:r("span",{children:r(w,{id:"PurchaseOrders.purchaseOrdersTable.expandedRowLabels.appliesTo"})})}),r("ul",{children:((q=e==null?void 0:e.appliesToRoles)==null?void 0:q.length)<=0?r("li",{children:l.appliesToAll}):(J=e==null?void 0:e.appliesToRoles)==null?void 0:J.map((d,F)=>r("li",{children:d.name},F))}),r("p",{children:r("span",{children:r(w,{id:"PurchaseOrders.purchaseOrdersTable.expandedRowLabels.approver"})})}),r("ul",{children:(K=e==null?void 0:e.approverRoles)==null?void 0:K.map((d,F)=>r("li",{children:d==null?void 0:d.name},F))})]}),D?r("div",{className:"b2b-purchase-order-purchase-orders-table__row-details-action",children:L("div",{className:"b2b-purchase-order-purchase-orders-table__row-details-action-inner-wrapper",children:[r(V,{onClick:()=>{window.location.href=_(e.uid,"edit")},"aria-label":l.ariaLabelEditRule.replace("{{ruleName}}",e.name),"data-testid":`edit-approval-rule-${e.uid}`,children:l.actionEdit}),r(V,{onClick:d=>M(d,e.uid),"aria-label":l.ariaLabelDeleteRule.replace("{{ruleName}}",e.name),"data-testid":`delete-approval-rule-${e.uid}`,children:l.actionDelete})]})}):r("div",{className:"b2b-purchase-order-purchase-orders-table__row-details-action",children:r(V,{onClick:()=>{window.location.href=_(e.uid,"view")},"aria-label":l.ariaLabelViewRule.replace("{{ruleName}}",e.name),"data-testid":`view-approval-rule-${e.uid}`,children:l.actionView})})]});return{ruleName:e.name,status:r(ue,{className:`b2b-purchase-order-purchase-orders-table__status b2b-purchase-order-purchase-orders-table__status--${oe(e.status)}`,children:r(w,{id:`PurchaseOrders.purchaseOrdersTable.rulesStatus.${(Q=e.status)==null?void 0:Q.toLocaleLowerCase()}`})}),createdBy:e.createdBy,action:z,_rowDetails:E}});let t=s;if(P){const e=P(s);e!==void 0&&Array.isArray(e)&&(t=e)}return t},[b,O,y,P,l,_,M,H]);return{tableConfig:{columns:ae,rows:te,expandedRows:O},paginationConfig:{currentPage:R,totalPages:N,handlePageChange:I},pageSizeConfig:{pageSizeOptionsList:c,onChange:se},totalCount:re,loading:k,handleCreateUrl:_}},Ae=({routeCreateApprovalRule:u,routeEditApprovalRule:p,routeApprovalRuleDetails:h,setColumns:m,setRowsData:P,className:$="",withHeader:y=!0,withWrapper:S=!0,skeletonRowCount:l=5,initialPageSize:b=ce})=>{const o=we({headerText:"PurchaseOrders.approvalRulesList.containerTitle",ruleName:"PurchaseOrders.purchaseOrdersTable.tableColumns.ruleName",ruleType:"PurchaseOrders.purchaseOrdersTable.tableColumns.ruleType",appliesTo:"PurchaseOrders.purchaseOrdersTable.tableColumns.appliesTo",approver:"PurchaseOrders.purchaseOrdersTable.tableColumns.approver",createdBy:"PurchaseOrders.purchaseOrdersTable.tableColumns.createdBy",status:"PurchaseOrders.purchaseOrdersTable.tableColumns.status",actionEdit:"PurchaseOrders.purchaseOrdersTable.actionEdit",actionDelete:"PurchaseOrders.purchaseOrdersTable.actionDelete",addNewRule:"PurchaseOrders.approvalRulesList.buttons.newRule",actionView:"PurchaseOrders.purchaseOrdersTable.actionView",appliesToAll:"PurchaseOrders.purchaseOrdersTable.appliesToAll",emptyTitle:"PurchaseOrders.approvalRulesList.emptyTitle",ariaLabelEditRule:"PurchaseOrders.approvalRulesList.ariaLabel.editRule",ariaLabelDeleteRule:"PurchaseOrders.approvalRulesList.ariaLabel.deleteRule",ariaLabelViewRule:"PurchaseOrders.approvalRulesList.ariaLabel.viewRule"}),{permissions:T,loadingPermissions:n}=be(),{loading:k,tableConfig:i,paginationConfig:c,totalCount:A,pageSizeConfig:U,handleCreateUrl:x}=Te({routeCreateApprovalRule:u,routeEditApprovalRule:p,routeApprovalRuleDetails:h,setColumns:m,setRowsData:P,permissions:T,initialPageSize:b,loadingPermissions:n,t:o}),{isAdmin:O,permissions:{manageApprovalRules:g}}=T,R=O||g?r(pe,{variant:"primary",onClick:()=>{window.location.href=x("","new")},"data-testid":"add-new-rule-button",children:o.addNewRule}):null,N=k||n?r(he,{"data-testid":"approval-rules-skeleton",children:r(me,{variant:"row",size:"small"})}):R;return L("div",{className:le(["purchase-orders",$]),"data-testid":"purchase-orders-container",children:[y?r(de,{headerText:o.headerText}):null,r(ie,{totalCount:A,columns:i.columns,rows:i.rows,expandedRows:i.expandedRows,paginationConfig:c,loading:k||n,skeletonRowCount:l,pageSizeConfig:U,emptyTitle:o.emptyTitle,withWrapper:S,footer:N})]})};export{Ae as ApprovalRulesList,Ae as default};
//# sourceMappingURL=ApprovalRulesList.js.map
