/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as a,jsxs as A}from"@dropins/tools/preact-jsx-runtime.js";import{useState as f,useRef as B,useMemo as F,useCallback as U,useEffect as z}from"@dropins/tools/preact-hooks.js";import{Button as w,InLineAlert as q,Picker as K,Modal as R}from"@dropins/tools/components.js";import{T as Z}from"../chunks/Table.js";import{C as $}from"../chunks/CompanyUserForm.js";import{classes as H}from"@dropins/tools/lib.js";import"@dropins/tools/event-bus.js";import{u as J}from"../chunks/useInLineAlert.js";import{g as Q,u as W}from"../chunks/updateCompanyUserStatus.js";import{useText as j}from"@dropins/tools/i18n.js";import{a as X}from"../chunks/updateCompanyUser.js";import{c as Y}from"../chunks/CompanyLoaders.js";import{f as ee}from"../chunks/fetchUserPermissions.js";import{u as ae}from"../chunks/useCompanyContextListener2.js";import"@dropins/tools/preact.js";import"@dropins/tools/preact-compat.js";import"../chunks/company-permissions.js";import"../chunks/useCompanyRoles.js";import"../chunks/useCompanyContextListener.js";import"../chunks/isCompanyRoleNameAvailable.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/fetch-error.js";const te=(r,i)=>!r||typeof r!="string"?"":r==="ACTIVE"&&i.statusActive?i.statusActive:r==="INACTIVE"&&i.statusInactive?i.statusInactive:r.charAt(0).toUpperCase()+r.slice(1).toLowerCase(),ne=(r,i)=>{const l=(r==null?void 0:r.trim())||"",o=(i==null?void 0:i.trim())||"";return`${l} ${o}`.trim()},se=({filterType:r,onFilterChange:i,translations:l})=>{const o=[{type:"all",label:l.showAllUsers,ariaLabel:l.showAllUsers},{type:"active",label:l.showActiveUsers,ariaLabel:l.showActiveUsers},{type:"inactive",label:l.showInactiveUsers,ariaLabel:l.showInactiveUsers}];return a("div",{className:"filterButtons",role:"group","aria-label":l.ariaFilterOptions,children:o.filter(e=>e.type!==r).map(e=>a(w,{variant:"tertiary",onClick:()=>i(e.type),"aria-label":e.ariaLabel,children:e.label},e.type))})},re=20,G=1,oe=({translations:r})=>{const[i,l]=f([]),[o,e]=f(!1),[m,u]=f(G),[y,L]=f(re),[S,T]=f("all"),[h,p]=f(0),[g,N]=f(1),[k,M]=f(""),[t,I]=f(null),P=B(r);P.current=r;const _=F(()=>{switch(S){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[S]),d=U(async()=>{e(!0);try{const s=await Q({pageSize:y,currentPage:m,filter:_});l(s.users),p(s.totalCount||s.users.length),N(s.pageInfo.totalPages),M(P.current.ariaDataLoaded.replace("{count}",s.users.length.toString()))}catch{l([]),p(0),N(1),M(P.current.ariaDataError)}finally{e(!1)}},[y,m,_]),C=U(async()=>{try{const{allowedIds:s}=await ee();I(s)}catch{I(new Set)}},[]);z(()=>{d()},[d]),z(()=>{C()},[C]);const E=U(s=>{T(s),u(G)},[]),c=U(s=>{let D;if(typeof s=="string")D=s;else if("target"in s&&s.target&&"value"in s.target)D=s.target.value;else return;const V=parseInt(D,10);isNaN(V)||(L(V),u(G))},[]),v=U(()=>{m>1&&u(m-1)},[m]),b=U(()=>{m<g&&u(m+1)},[m,g]),n=(t==null?void 0:t.has("Magento_Company::users_edit"))||!1,x=U(async()=>{await C(),await d()},[C,d]);return{users:i,userPermissions:t,currentPage:m,pageSize:y,totalItems:h,totalPages:g,filterType:S,filter:_,loading:o,announcement:k,canEditUsers:n,handleFilterChange:E,handlePageSizeChange:c,handlePreviousPage:v,handleNextPage:b,refreshUsers:x}},O=r=>{const[i,l]=f(!1),[o,e]=f(null),m=U(y=>{y&&e(y),l(!0)},[]),u=U(()=>{l(!1),e(null),r==null||r()},[r]);return{isOpen:i,selectedId:o,open:m,close:u}},ie=({className:r,userId:i,userStatus:l,onClose:o,isOpen:e=!1,...m})=>{const[u,y]=f(!1),[L,S]=f(!1),{inLineAlertProps:T,showError:h,clearAlert:p}=J(),g=B(null),N=B(null),k=`modal-title-${i}`,M=`modal-desc-${i}`,t=j({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),I=U(async()=>{if(L)return;const c=l==="ACTIVE"?"INACTIVE":"ACTIVE",v=c==="ACTIVE";S(!0),p();try{(await W({id:i,status:c})).success?o():h(v?t.setActiveErrorSpecific:t.setInactiveErrorSpecific)}catch(b){const n=b instanceof Error?b.message:v?t.setActiveErrorGeneric:t.setInactiveErrorGeneric;h(n)}finally{S(!1)}},[i,l,o,L,p,h,t.setActiveErrorSpecific,t.setInactiveErrorSpecific,t.setActiveErrorGeneric,t.setInactiveErrorGeneric]),P=U(async()=>{if(!u){y(!0),p();try{(await X({id:i})).success?o():h(t.deleteErrorSpecific)}catch(c){const v=c instanceof Error?c.message:t.deleteErrorGeneric;h(v)}finally{y(!1)}}},[i,o,u,p,h,t.deleteErrorSpecific,t.deleteErrorGeneric]),_=U(()=>{p(),o()},[o,p]),d=U(c=>{if(c.key==="Escape"&&(p(),o()),c.key==="Tab"){const v=g.current;if(!v)return;const b=v.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=b[0],x=b[b.length-1];c.shiftKey?document.activeElement===n&&(x.focus(),c.preventDefault()):document.activeElement===x&&(n.focus(),c.preventDefault())}},[o,p]),C=U(c=>{c.target===c.currentTarget&&(p(),o())},[o,p]),E=U(()=>{p(),o()},[o,p]);return z(()=>{if(e)return N.current=document.activeElement,document.addEventListener("keydown",d),setTimeout(()=>{const c=g.current;if(c){const v=c.querySelector("button");v?v.focus():c.focus()}},100),()=>{document.removeEventListener("keydown",d)};N.current&&N.current.focus()},[e,d]),e?a("div",{className:H(["company-management-company-users-management-modal-overlay",r]),onClick:C,...m,children:A("div",{ref:g,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":k,"aria-describedby":M,tabIndex:-1,children:[A("div",{className:"company-management-company-users-management-modal__header",children:[a("h2",{id:k,className:"company-management-company-users-management-modal__title",children:t.title}),a("button",{className:"company-management-company-users-management-modal__close",onClick:E,"aria-label":t.ariaCloseModal,children:"Ã—"})]}),A("div",{id:M,className:"company-management-company-users-management-modal__content",children:[a("p",{className:"company-management-company-users-management-modal__text",children:l==="ACTIVE"?t.setInactiveText:t.setActiveText}),a("p",{className:"company-management-company-users-management-modal__text",children:t.deleteText})]}),(T==null?void 0:T.text)&&a("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:a(q,{type:"error",heading:T.text,icon:T.icon,"data-testid":"companyUsersManagementModalAlert"})}),A("div",{className:"company-management-company-users-management-modal__actions",children:[a(w,{variant:"primary",onClick:I,disabled:L,className:"company-management-company-users-management-modal__button-primary",children:L?l==="ACTIVE"?t.settingInactiveButton:t.settingActiveButton:l==="ACTIVE"?t.setInactiveButton:t.setActiveButton}),a(w,{variant:"tertiary",onClick:P,disabled:u,className:"company-management-company-users-management-modal__button-delete",children:u?t.deletingButton:t.deleteButton}),a(w,{variant:"secondary",onClick:_,className:"company-management-company-users-management-modal__button-cancel",children:t.cancelButton})]})]})}):null},le=[{text:"20",value:"20"},{text:"30",value:"30"},{text:"50",value:"50"},{text:"100",value:"100"},{text:"200",value:"200"}],Me=({children:r,className:i,...l})=>{const o=B(null),e=j({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsText:"Company.CompanyUsers.pagination.itemsCount",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",perPageLabel:"Company.CompanyUsers.pagination.perPage",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaLoadingUsers:"Company.CompanyUsers.ariaLabels.loadingUsers",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",editUser:"Company.CompanyUsers.actions.edit",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser",ariaEditUser:"Company.CompanyUsers.ariaLabels.editUser",addNewUser:"Company.CompanyUsers.actions.addNewUser"}),{users:m,loading:u,currentPage:y,pageSize:L,filterType:S,totalItems:T,totalPages:h,announcement:p,canEditUsers:g,handleFilterChange:N,handlePageSizeChange:k,handlePreviousPage:M,handleNextPage:t,refreshUsers:I}=oe({translations:{ariaDataLoaded:e.ariaDataLoaded,ariaDataError:e.ariaDataError}}),P=B(e);P.current=e,z(()=>{!u&&o.current&&m.length>0&&o.current.setAttribute("aria-busy","false")},[u,y,S,m.length]);const _=U(()=>{I()},[I]);ae(_);const d=O(I),C=O(I),E=O(I),c=F(()=>{const n=P.current;return[{key:"id",label:n.idColumn},{key:"name",label:n.nameColumn},{key:"email",label:n.emailColumn},{key:"role",label:n.roleColumn},{key:"team",label:n.teamColumn},{key:"status",label:n.statusColumn},{key:"actions",label:n.actionsColumn}]},[]),v=F(()=>m.map(n=>{const x=ne(n.firstName,n.lastName),s=P.current;return{id:n.id,name:x,email:n.email,role:n.role,team:n.team||s.emptyTeam,status:te(n.status,s),actions:g?A("div",{className:"user-actions",children:[a(w,{variant:"tertiary",onClick:()=>C.open(n.id),"aria-label":s.ariaEditUser.replace("{name}",x),className:"edit-user-button",children:s.editUser}),a(w,{variant:"tertiary",onClick:()=>d.open(n.id),"aria-label":s.ariaManageUser.replace("{name}",x),className:"manage-user-button",children:s.manageUser})]}):a("span",{className:"no-actions",children:s.emptyActions})}}),[m,g,C,d]),b=F(()=>m.find(n=>n.id===d.selectedId),[m,d.selectedId]);return A("section",{className:i,...l,children:[a("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:p}),a(se,{filterType:S,onFilterChange:N,translations:{showAllUsers:e.showAllUsers,showActiveUsers:e.showActiveUsers,showInactiveUsers:e.showInactiveUsers,ariaFilterOptions:e.ariaFilterOptions}}),a("div",{ref:o,"aria-busy":u,children:u?A("div",{className:"loadingContainer",role:"status","aria-live":"polite",children:[a(Y,{testId:"companyUsersTableLoader"}),a("span",{className:"sr-only",children:e.ariaLoadingUsers})]}):a(Z,{columns:c,rowData:v,mobileLayout:"stacked","aria-label":e.ariaUsersTable,summary:e.ariaShowingUsers.replace("{count}",m.length.toString())})}),A("nav",{"aria-label":e.ariaPaginationNav,className:"paginationContainer",children:[a("div",{"aria-live":"polite","aria-atomic":"true",children:e.itemsText.replace("{count}",T.toString())}),h>1&&A("div",{className:"paginationButtons",role:"group","aria-label":e.ariaPageNavigation,children:[a(w,{variant:"secondary",onClick:M,disabled:y===1,"aria-label":e.ariaPreviousPageFull.replace("{current}",y.toString()),children:e.previousPage}),a("span",{"aria-current":"page","aria-live":"polite",children:e.pageInfo.replace("{current}",y.toString()).replace("{total}",h.toString())}),a(w,{variant:"secondary",onClick:t,disabled:y===h,"aria-label":e.ariaNextPageFull.replace("{current}",y.toString()),children:e.nextPage})]}),A("div",{className:"pageSizeSelector",children:[a("label",{htmlFor:"page-size-select",id:"page-size-label",children:a("span",{children:e.showLabel})}),a(K,{id:"page-size-select",name:"pageSize",value:L.toString(),options:le,onChange:k,"aria-labelledby":"page-size-label","aria-describedby":"page-size-description"}),a("span",{id:"page-size-description",children:e.perPageLabel})]})]}),g&&a("div",{className:"addUserButtonContainer",children:a(w,{variant:"primary",onClick:()=>E.open(),"aria-label":e.addNewUser,children:e.addNewUser})}),r,E.isOpen&&g&&a(R,{open:E.isOpen,onClose:E.close,size:"medium",children:a($,{mode:"add",entityId:null,parentStructureId:null,permissions:{canEditUsers:g},onSaved:E.close,onCancel:E.close})}),C.selectedId&&C.isOpen&&g&&a(R,{open:C.isOpen,onClose:C.close,size:"medium",children:a($,{mode:"edit",entityId:C.selectedId,parentStructureId:null,permissions:{canEditUsers:g},onSaved:C.close,onCancel:C.close})}),d.selectedId&&g&&b&&a(ie,{isOpen:d.isOpen,userId:d.selectedId,userStatus:b.status||"ACTIVE",onClose:d.close})]})};export{Me as CompanyUsers,Me as default};
//# sourceMappingURL=CompanyUsers.js.map
