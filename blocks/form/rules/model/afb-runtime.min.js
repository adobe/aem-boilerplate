/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2022 Adobe
* All Rights Reserved.
*
* NOTICE: All information contained herein is, and remains
* the property of Adobe and its suppliers, if any. The intellectual
* and technical concepts contained herein are proprietary to Adobe
* and its suppliers and are protected by all applicable intellectual
* property laws, including trade secret and copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe.

* Adobe permits you to use and modify this file solely in accordance with
* the terms of the Adobe license agreement accompanying it.
*************************************************************************/

import{propertyChange as e,ExecuteRule as t,Initialize as n,RemoveItem as i,FormLoad as s,FieldChanged as r,ValidationComplete as a,Change as o,Valid as l,Invalid as u,SubmitSuccess as d,CustomEvent as h,SubmitError as c,SubmitFailure as p,Submit as m,RemoveInstance as f,AddInstance as g,Reset as _,AddItem as y,Click as v}from"./afb-events.min.js";import M from"../formula/index.min.js";import{format as b,parseDefaultDate as j,datetimeToNumber as x,parseDateSkeleton as E,formatDate as T,numberToDatetime as I}from"./afb-formatters.min.js";function $(e,t,n,i){var s,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(r<3?s(a):r>3?s(t,n,a):s(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a}const O=Object.freeze({PATTERN_MISMATCH:"patternMismatch",TOO_SHORT:"tooShort",TOO_LONG:"tooLong",RANGE_OVERFLOW:"rangeOverflow",RANGE_UNDERFLOW:"rangeUnderflow",TYPE_MISMATCH:"typeMismatch",VALUE_MISSING:"valueMissing",STEP_MISMATCH:"stepMismatch",FORMAT_MISMATCH:"formatMismatch",ACCEPT_MISMATCH:"acceptMismatch",FILE_SIZE_MISMATCH:"fileSizeMismatch",UNIQUE_ITEMS_MISMATCH:"uniqueItemsMismatch",MIN_ITEMS_MISMATCH:"minItemsMismatch",MAX_ITEMS_MISMATCH:"maxItemsMismatch",EXPRESSION_MISMATCH:"expressionMismatch"}),N=Object.freeze({pattern:O.PATTERN_MISMATCH,minLength:O.TOO_SHORT,maxLength:O.TOO_LONG,maximum:O.RANGE_OVERFLOW,minimum:O.RANGE_UNDERFLOW,type:O.TYPE_MISMATCH,required:O.VALUE_MISSING,step:O.STEP_MISMATCH,format:O.FORMAT_MISMATCH,accept:O.ACCEPT_MISMATCH,maxFileSize:O.FILE_SIZE_MISMATCH,uniqueItems:O.UNIQUE_ITEMS_MISMATCH,minItems:O.MIN_ITEMS_MISMATCH,maxItems:O.MAX_ITEMS_MISMATCH,validationExpression:O.EXPRESSION_MISMATCH}),w=Object.freeze({[O.PATTERN_MISMATCH]:"Please match the format requested.",[O.TOO_SHORT]:"Please lengthen this text to ${0} characters or more.",[O.TOO_LONG]:"Please shorten this text to ${0} characters or less.",[O.RANGE_OVERFLOW]:"Value must be less than or equal to ${0}.",[O.RANGE_UNDERFLOW]:"Value must be greater than or equal to ${0}.",[O.TYPE_MISMATCH]:"Please enter a valid value.",[O.VALUE_MISSING]:"Please fill in this field.",[O.STEP_MISMATCH]:"Please enter a valid value.",[O.FORMAT_MISMATCH]:"Specify the value in allowed format : ${0}.",[O.ACCEPT_MISMATCH]:"The specified file type not supported.",[O.FILE_SIZE_MISMATCH]:"File too large. Reduce size and try again.",[O.UNIQUE_ITEMS_MISMATCH]:"All the items must be unique.",[O.MIN_ITEMS_MISMATCH]:"Specify a number of items equal to or greater than ${0}.",[O.MAX_ITEMS_MISMATCH]:"Specify a number of items equal to or less than ${0}.",[O.EXPRESSION_MISMATCH]:"Please enter a valid value."});let D={};class C{fieldName;errorMessages;constructor(e="",t=[]){this.errorMessages=t,this.fieldName=e}}var S;!function(e){e.NEXT_ITEM="nextItem",e.PREVIOUS_ITEM="previousItem"}(S||(S={}));const F=e=>new Map(Object.entries(e)),A=F({date:"date-input","data-url":"file-input",binary:"file-input"}),k=F({number:"number-input",boolean:"checkbox",object:"panel",array:"panel",file:"file-input","file[]":"file-input"}),R=["string[]","boolean[]","number[]","array"],P=e=>{const t=e.type||"string";if("enum"in e){return e.enum.length>2||R.indexOf(t)>-1?"drop-down":"checkbox"}return"string"===t||"string[]"===t?A.get(e.format)||"text-input":k.get(t)||"text-input"},q=function(e){return"file"===e?.type||"file[]"===e?.type||("string"===e?.type||"string[]"===e?.type)&&("binary"===e?.format||"data-url"===e?.format)};function V(e,t){let n;return e instanceof Array?(n=[],n=e.map((e=>V(e,t)))):"object"==typeof e&&null!==e?(n={},Object.entries(e).forEach((([e,i])=>{n[e]=V(i,t)}))):n=e,t&&n&&n.id&&(n.id=t()),n}const z=e=>JSON.stringify(e,null,2),U=e=>e.repeatable&&(void 0===e.minOccur&&void 0===e.maxOccur||void 0!==e.minOccur&&void 0!==e.maxOccur&&0!==e.maxOccur||void 0!==e.minOccur&&void 0!==e.maxOccur&&0!==e.minOccur&&0!==e.maxOccur||void 0!==e.minOccur&&e.minOccur>=0||void 0!==e.maxOccur&&0!==e.maxOccur)||!1;class L{$_name;$_value;$_type;$_fields=[];constructor(e,t,n=typeof t){this.$_name=e,this.$_value=t,this.$_type=n}valueOf(){return this.$_value}get $name(){return this.$_name}get $value(){if(this.$_fields.find((e=>!1!==e.enabled))||!this.$_fields.length)return this.$_value}setValue(e,t,n){this.$_value=e,this.$_fields.forEach((e=>{n!==e&&(e.value=t)}))}get $type(){return this.$_type}$bindToField(e){-1===this.$_fields.indexOf(e)&&this.$_fields.push(e)}$convertToDataValue(){return this}get $isDataGroup(){return!1}}const H=Symbol("NullValue");const Q=new class extends L{constructor(){super("",H,"null")}setValue(){}$bindToField(){}$length(){return 0}$convertToDataValue(){return this}$addDataNode(){}$removeDataNode(){}$getDataNode(){return this}$containsDataNode(){return!1}};class G extends L{$_items;createEntry(e,t){const n=t instanceof Array?"array":typeof t;return"object"==typeof t&&null!=t?new G(e,t,n):new L(e,t,n)}constructor(e,t,n=typeof t){super(e,t,n),this.$_items=t instanceof Array?t.map(((e,t)=>this.createEntry(t,e))):Object.fromEntries(Object.entries(t).map((([e,t])=>[e,this.createEntry(e,t)])))}get $value(){return!this.$_fields.find((e=>!1!==e.enabled))&&this.$_fields.length?"array"===this.$type?[]:{}:"array"===this.$type?Object.values(this.$_items).filter((e=>void 0!==e)).map((e=>e.$value)):Object.fromEntries(Object.values(this.$_items).filter((e=>void 0!==e)).map((e=>[e.$name,e.$value])))}get $length(){return Object.entries(this.$_items).length}$convertToDataValue(){return new L(this.$name,this.$value,this.$type)}$addDataNode(e,t,n=!1){if(t!==Q)if("array"===this.$type){const i=e;n?this.$_items[e]=t:this.$_items.splice(i,0,t)}else this.$_items[e]=t}$removeDataNode(e){"array"===this.$type?this.$_items.splice(e,1):this.$_items[e]=void 0}$getDataNode(e){if(this.$_items.hasOwnProperty(e))return this.$_items[e]}$containsDataNode(e){return this.$_items.hasOwnProperty(e)&&void 0!==this.$_items[e]}get $isDataGroup(){return!0}}const W="Identifier",B="Global",X="Repeatable",J="bracket",Z=(e,t)=>({type:W,value:e,start:t}),Y=function(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e},K=(e,t,n)=>null===e&&"$"===t[n],ee=(e,t,n)=>null===e&&"#"===t[n],te=(e,t)=>{const n=e[t];return"$"===n?e.length>t&&Y(e[t+1]):n>="a"&&n<="z"||n>="A"&&n<="Z"||"_"===n},ne=e=>e>="0"&&e<="9";class ie{stream;_current;_tokens=[];_result_tokens=[];constructor(e){this.stream=e,this._current=0}_consumeGlobal(){return this._current+=1,{type:B,start:0,value:"$"}}_consumeRepeatable(){return this._current+=1,{type:X,start:0,value:"#"}}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&Y(e[this._current]);)this._current+=1;return Z(e.slice(t,this._current),t)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const n=e.length;for(;'"'!==e[this._current]&&this._current<n;){let t=this._current;"\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?t+=1:t+=2,this._current=t}return this._current+=1,Z(JSON.parse(e.slice(t,this._current)),t)}_consumeNumber(e){const t=this._current;this._current+=1;const n=e.length;for(;ne(e[this._current])&&this._current<n;)this._current+=1;const i=e.slice(t,this._current);return{type:"Number",value:parseInt(i,10),start:t}}_consumeBracket(e){const t=this._current;let n;if(this._current+=1,!ne(e[this._current]))throw new Error(`unexpected exception at position ${this._current}. Must be a character`);if(n=this._consumeNumber(e).value,this._current<this.stream.length&&"]"!==e[this._current])throw new Error(`unexpected exception at position ${this._current}. Must be a character`);return this._current++,((e,t)=>({type:J,value:e,start:t}))(n,t)}tokenize(){const e=this.stream;for(;this._current<e.length;){const t=this._tokens.length?this._tokens.slice(-1)[0]:null;if(K(t,e,this._current)){const e=this._consumeGlobal();this._tokens.push(e),this._result_tokens.push(e)}else if(ee(t,e,this._current)){const e=this._consumeRepeatable();this._tokens.push(e),this._result_tokens.push(e)}else if(te(e,this._current)){const t=this._consumeUnquotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}else if("."===e[this._current]&&null!=t&&"DOT"!==t.type)this._tokens.push({type:"DOT",value:".",start:this._current}),this._current+=1;else if("["===e[this._current]){const t=this._consumeBracket(e);this._tokens.push(t),this._result_tokens.push(t)}else{if('"'!==e[this._current]){const e=Math.max(0,this._current-2),t=Math.min(this.stream.length,this._current+2);throw new Error(`Exception at parsing stream ${this.stream.slice(e,t)}`)}{const t=this._consumeQuotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}}}return this._result_tokens}}const se=e=>new ie(e).tokenize(),re=(e,t,n)=>{let i;i="string"==typeof t?se(t):t;let s=e,r=0;const a=(e,t,n)=>null===t?n:t.type===J?new G(e.value,[],"array"):new G(e.value,{});for(;r<i.length&&null!=s;){const t=i[r];if(t.type===B)s=e;else if(t.type===W){if(!(s instanceof G&&"object"===s.$type))throw new Error(`Looking for ${t.value} in ${s.$value}`);if(s.$containsDataNode(t.value)&&null!==s.$getDataNode(t.value).$value)s=s.$getDataNode(t.value);else if(n){const e=a(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(t.value,e),s=e}else s=void 0}else if(t.type===J){if(!(s instanceof G&&"array"===s.$type))throw new Error(`Looking for index ${t.value} in non array${s.$value}`);{const e=t.value;if(e<s.$length)s=s.$getDataNode(e);else if(n){const o=a(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(e,o),s=o}else s=void 0}}r+=1}return s};class ae{data;mediaType="application/octet-stream";name="unknown";size=0;constructor(e){Object.assign(this,e)}get type(){return this.mediaType}toJSON(){return{name:this.name,size:this.size,mediaType:this.mediaType,data:this.data.toString()}}equals(e){return this.data===e.data&&this.mediaType===e.mediaType&&this.name===e.name&&this.size===e.size}}const oe="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_".split(""),le=/^(\d*\.?\d+)(\\?(?=[KMGT])([KMGT])(?:i?B)?|B?)$/i,ue=e=>{const t=[];for(let n=0;n<=e;n++){let e;e=0===n?Math.floor(Math.random()*(oe.length-11)):Math.floor(Math.random()*oe.length),t.push(oe[e])}return t.join("")},de=(e,t=!1)=>{const n=e.items||[];return n?.reduce(((e,n)=>{if(t&&null===n.dataRef)return e;let i=null;if(n.isContainer)i=de(n,t);else if(q(n.getState())){i={};const e=n.name||"",t=null!=n.dataRef?n.dataRef:e.length>0?n.name:void 0;n.value instanceof Array?i[n.id]=n.value.map((e=>({...e,dataRef:t}))):null!=n.value&&(i[n.id]={...n.value,dataRef:t})}return Object.assign(e,i)}),{})},he=e=>{let t=0;if("string"==typeof e){const n=le.exec(e.trim());null!=n&&(t=ce(parseFloat(n[1]),(n[2]||"kb").toUpperCase()))}return t},ce=(e,t)=>{const n=Math.pow(1024,{KB:1,MB:2,GB:3,TB:4}[t]);return Math.round(e*n)},pe=e=>null!=/^data:([a-z]+\/[a-z0-9-+.]+)?;(?:name=(.*);)?base64,(.*)$/.exec(e.trim()),me=e=>{const t=/^data:([a-z]+\/[a-z0-9-+.]+)?(?:;name=([^;]+))?(;base64)?,(.+)$/.exec(e);if(null!==t){const e=t[1]||"",n=t[2]||"unknown";if("string"==typeof t[3]){const i=atob(t[4]),s=[];for(let e=0;e<i.length;e++)s.push(i.charCodeAt(e));return{name:n,blob:new window.Blob([new Uint8Array(s)],{type:e})}}return{name:n,blob:new window.Blob([t[4]],{type:e})}}return null},fe=e=>{if(!e||!Object.keys(e).length)return e;if((":items"in(t=e)||"cqItems"in t)&&(":itemsOrder"in t||"cqItemsOrder"in t)){const t=[],n=e[":itemsOrder"]||e.cqItemsOrder,i=e[":items"]||e.cqItems;n.forEach((e=>{t.push(fe(i[e]))})),e.items=t}var t;return e},ge=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,_e=/^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/,ye=[31,28,31,30,31,30,31,31,30,31,30,31],ve=e=>{if(""===e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t);return n||(t=e),{value:t,valid:n}},Me=e=>{if(""==e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t)&&Math.round(t)===t;return n||(t=e),{value:t,valid:n}},be=e=>null==e||e instanceof Array?e:[e],je=e=>{const t="boolean"==typeof e||"true"===e||"false"===e;return{valid:t,value:"boolean"==typeof e?e:t?"true"===e:e}},xe=e=>{const t=(e=>{if(null!==e){let t=null;if(e instanceof ae)t=e;else if("undefined"!=typeof File&&e instanceof File)t={name:e.name,mediaType:e.type,size:e.size,data:e};else if("string"==typeof e&&pe(e)){const n=me(e);if(null!==n){const{blob:e,name:i}=n;t={name:i,mediaType:e.type,size:e.size,data:e}}}else{let n=e;try{n=JSON.parse(e),t=n,t.mediaType||(t.mediaType=t.type)}catch(e){}if("string"==typeof n?.data&&pe(n?.data)){const e=me(n?.data);if(null!==e){const i=e.blob;t={name:n?.name,mediaType:n?.type||n?.mediaType,size:i.size,data:i}}}else"string"==typeof n?t={name:n.split("/").pop(),mediaType:"application/octet-stream",size:0,data:n}:"object"==typeof n&&(t={name:n?.name,mediaType:n?.type||n?.mediaType,size:n?.size,data:n?.data})}return null!==t&&null!=t.data?new ae(t):null}return null})(e),n=null!==t;return{value:n?t:e,valid:n}},Ee=(e,t)=>{const n=be(e);return null==n?[[],[n]]:n.reduce(((e,n)=>{if(0==e[1].length){const i=t(n);e[i.valid?0:1].push(i.value)}return e}),[[],[]])},Te={date:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","format"],string:["minLength","maxLength","pattern"],number:["minimum","maximum","exclusiveMinimum","exclusiveMaximum"],array:["minItems","maxItems","uniqueItems"],file:["accept","maxFileSize"],email:["minLength","maxLength","format","pattern"]},Ie=["type","format","minimum","maximum","exclusiveMinimum","exclusiveMaximum","minItems","maxItems","uniqueItems","minLength","maxLength","pattern","required","enum","accept","maxFileSize"],$e={type:(e,t)=>{let n=t;if(null==t)return{valid:!0,value:t};let i,s=!0;switch(e){case"string":s=!0,n=t.toString();break;case"string[]":n=be(t);break;case"number":i=ve(t),n=i.value,s=i.valid;break;case"boolean":i=je(t),s=i.valid,n=i.value;break;case"integer":i=Me(t),s=i.valid,n=i.value;break;case"integer[]":i=Ee(t,Me),s=0===i[1].length,n=s?i[0]:t;break;case"file":i=xe(t instanceof Array?t[0]:t),s=i.valid,n=i.value;break;case"file[]":i=Ee(t,xe),s=0===i[1].length,n=s?i[0]:t;break;case"number[]":i=Ee(t,ve),s=0===i[1].length,n=s?i[0]:t;break;case"boolean[]":i=Ee(t,je),s=0===i[1].length,n=s?i[0]:t}return{valid:s,value:n}},format:(e,t)=>{let n=!0;const i=t;if(null===t)return{value:i,valid:n};let s;switch(e){case"date":if(s=ge.exec((t||"").trim()),null!=s){const[e,t,i,r]=s,[a,o]=[+i,+r],l=(e=>e%400==0||e%4==0&&e%100!=0)(+t);n=a>=1&&a<=12&&o>=1&&o<=((e,t)=>e&&2==t?29:ye[t-1])(l,a)}else n=!1;break;case"email":n=new RegExp(_e).test((t||"").trim());break;case"data-url":n=!0}return{valid:n,value:i}},minimum:(e,t)=>({valid:t>=e,value:t}),maximum:(e,t)=>({valid:t<=e,value:t}),exclusiveMinimum:(e,t)=>({valid:t>e,value:t}),exclusiveMaximum:(e,t)=>({valid:t<e,value:t}),minItems:(e,t)=>({valid:t instanceof Array&&t.length>=e,value:t}),maxItems:(e,t)=>({valid:t instanceof Array&&t.length<=e,value:t}),uniqueItems:(e,t)=>({valid:!e||t instanceof Array&&t.length===new Set(t).size,value:t}),minLength:(e,t)=>({...$e.minimum(e,"string"==typeof t?t.length:0),value:t}),maxLength:(e,t)=>({...$e.maximum(e,"string"==typeof t?t.length:0),value:t}),pattern:(e,t)=>{let n;return n="string"==typeof e?new RegExp(e):e,{valid:n.test(t),value:t}},required:(e,t)=>({valid:!e||null!=t&&""!==t,value:t}),enum:(e,t)=>({valid:e.indexOf(t)>-1,value:t}),accept:(e,t)=>{if(!e||0===e.length||null==t)return{valid:!0,value:t};return{valid:!(t instanceof Array?t:[t]).some((t=>{return n=t.type,i=e,!(!n||i.some((e=>{const t=e.trim(),i=t.split("/")[0],s=t.split(".")[1];return t.includes("*")&&n.startsWith(i)||t.includes(".")&&n.endsWith(s)||t===n})));var n,i})),value:t}},maxFileSize:(e,t)=>{const n="string"==typeof e?he(e):e;return{valid:!(t instanceof ae)||t.size<=n,value:t}}},Oe=["value","label","description","visible","enabled","valid","errorMessage","readOnly","enum","enumNames","required","properties","exclusiveMinimum","exclusiveMaximum","maximum","maxItems","minimum","minItems","checked"],Ne=[...Oe,"index","activeChild"],we=["plain-text","image"];class De{_action;_target;constructor(e,t){this._action=e,this._target=t}get type(){return this._action.type}get payload(){return this._action.payload}get metadata(){return this._action.metadata}get target(){return this._target}get isCustomEvent(){return this._action.isCustomEvent}get originalAction(){return this._action.originalAction}toString(){return this._action.toString()}}const Ce=Symbol("target"),Se=Symbol("qualifiedName");const Fe=e=>(...t)=>(n,i,s)=>{const r=s.get;null!=r&&(s.get=function(){if(t.indexOf(this.fieldType)>-1===e)return r.call(this)});const a=s.set;null!=a&&(s.set=function(n){t.indexOf(this.fieldType)>-1===e&&a.call(this,n)})},Ae=Fe(!0),ke=Fe(!1);class Re{_options;_ruleNode;_lang="";_callbacks={};_dependents=[];_jsonModel;_tokens=[];get isContainer(){return!1}constructor(e,t){this._options=t,this[Se]=null,this._jsonModel={...e,id:"id"in e?e.id:this.form.getUniqueId()}}setupRuleNode(){const e=this;this._ruleNode=new Proxy(this.ruleNodeReference(),{get:(t,n)=>e.getFromRule(t,n)})}ruleNodeReference(){return this}getRuleNode(){return this._ruleNode}getFromRule(e,t){if(t===Symbol.toPrimitive||"valueOf"===t&&!e.hasOwnProperty("valueOf"))return this.valueOf;if(t===Ce)return this;if("string"==typeof t)if(t.startsWith("$")){if("function"!=typeof this[t=t.substr(1)]){const e=this[t];return e instanceof Re?e.getRuleNode():e instanceof Array?e.map((e=>e instanceof Re?e.getRuleNode():e)):e}}else{if(e.hasOwnProperty(t))return e[t];if("function"==typeof e[t])return e[t]}}get id(){return this._jsonModel.id}get index(){return this.parent?this.parent.indexOf(this):0}get parent(){return this._options.parent}get type(){return this._jsonModel.type}get repeatable(){return this.parent?.hasDynamicItems()}get fieldType(){return this._jsonModel.fieldType||"text-input"}get":type"(){return this._jsonModel[":type"]||this.fieldType}get name(){return this._jsonModel.name}get description(){return this._jsonModel.description}set description(e){this._setProperty("description",e)}get dataRef(){return this._jsonModel.dataRef}get visible(){return void 0!==this.parent?.visible?!!this.parent?.visible&&this._jsonModel.visible:this._jsonModel.visible}set visible(t){if(t!==this._jsonModel.visible){const n=e("visible",t,this._jsonModel.visible);this._jsonModel.visible=t,this.notifyDependents(n)}}get form(){return this._options.form}get ruleEngine(){return this.form.ruleEngine}get label(){return this._jsonModel.label}set label(t){if(t!==this._jsonModel.label){const n=e("label",t,this._jsonModel.label);this._jsonModel={...this._jsonModel,label:t},this.notifyDependents(n)}}get uniqueItems(){return this._jsonModel.uniqueItems}isTransparent(){const e="array"===this.parent?._jsonModel.type;return!this._jsonModel.name&&!e}getState(e=!1){return{...this._jsonModel,properties:this.properties,index:this.index,parent:void 0,qualifiedName:this.qualifiedName,...!0===this.repeatable?{repeatable:!0,minOccur:this.parent.minItems,maxOccur:this.parent.maxItems}:{},":type":this[":type"],...e?{_dependents:this._dependents.length?this._dependents.map((e=>e.node.id)):void 0,allowedComponents:void 0,columnClassNames:void 0,columnCount:void 0,gridClassNames:void 0}:{}}}subscribe(e,t="change"){return this._callbacks[t]=this._callbacks[t]||[],this._callbacks[t].push(e),{unsubscribe:()=>{this._callbacks[t]=this._callbacks[t].filter((t=>t!==e))}}}_addDependent(e){if(void 0===this._dependents.find((({node:t})=>t===e))){const n=this.subscribe((n=>{const i=n.payload.changes,s=[...Ne,"items"];i.findIndex((e=>s.indexOf(e.propertyName)>-1))>-1&&e.dispatch(new t)}));this._dependents.push({node:e,subscription:n})}}removeDependent(e){const t=this._dependents.findIndex((({node:t})=>t===e));t>-1&&(this._dependents[t].subscription.unsubscribe(),this._dependents.splice(t,1))}queueEvent(e){const t=new De(e,this);this.form.getEventQueue().queue(this,t,["valid","invalid"].indexOf(t.type)>-1)}dispatch(e){this.queueEvent(e),this.form.getEventQueue().runPendingQueue()}notifyDependents(e){const t=this._jsonModel._dependents;t&&(t.forEach((e=>{const t=this.form.getElement(e);t&&this._addDependent(t)})),this._jsonModel._dependents=void 0);(this._callbacks[e.type]||[]).forEach((t=>{t(new De(e,this))}))}isEmpty(e=this._jsonModel.value){return null==e||""===e}_setProperty(t,n,i=!0,s=(e=>{})){const r=this._jsonModel[t];let a=!1;if(a=null!==n&&null!==r&&"object"==typeof n&&"object"==typeof r?JSON.stringify(n)===JSON.stringify(r):r===n,!a){this._jsonModel[t]=n;const a=e(t,n,r);return i&&this.notifyDependents(a),s.call(this,a),Ie.includes(t)&&this.validate(),a.payload.changes}return[]}_bindToDataModel(e){if("$form"===this.id)return void(this._data=e);const t=this._jsonModel.dataRef;let n,i=e,s="";if(null===t)n=Q;else if(void 0===t||this.repeatable){if(e!==Q&&-1===we.indexOf(this.fieldType)){i=e;const t=this._jsonModel.name||"",r="array"===e.$type?this.index:t;if(s=r,""!==r){const t=this.defaultDataModel(r);void 0!==t&&(n=e.$getDataNode(r),void 0===n&&(n=t,e.$addDataNode(r,n)))}else n=void 0}}else{0===this._tokens.length&&(this._tokens=se(t));let r=e;if(this._tokens[0].type===B)r=this.form.getDataNode();else if(this._tokens[0].type===X){let e=this.parent;for(;!e.repeatable&&e!==this.form;)e=e.parent;r=e.getDataNode()}if(void 0!==r){const e=this._tokens[this._tokens.length-1].value,t=this.defaultDataModel(e);n=re(r,this._tokens,t),i=re(r,this._tokens.slice(0,-1)),s=e}}n&&(this.isContainer||i===Q||n===Q||(n=n?.$convertToDataValue(),i.$addDataNode(s,n,!0)),n?.$bindToField(this),this._data=n)}_data;getDataNode(){return this._data}get lang(){return this._jsonModel.lang&&(this._lang=this._jsonModel.lang),this._lang||(this.parent?this._lang=this.parent.lang:this._lang=Intl.DateTimeFormat().resolvedOptions().locale),this._lang}get properties(){return this._jsonModel.properties||{}}set properties(e){this._setProperty("properties",{...e})}getNonTransparentParent(){let e=this.parent;for(;null!=e&&e.isTransparent();)e=e.parent;return e}_initialize(e){if(void 0===this._data){let e,t=this.parent;do{e=t.getDataNode(),t=t.parent}while(void 0===e);this._bindToDataModel(e)}}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=t[n],s=this._setProperty(n,i,!1);return s.length>0&&(e[n]=s[0]),e}),{})}get qualifiedName(){if(this.isTransparent())return null;if(null!==this[Se])return this[Se];const e=this.getNonTransparentParent();return e&&"array"===e.type?this[Se]=`${e.qualifiedName}[${this.index}]`:this[Se]=`${e.qualifiedName}.${this.name}`,this[Se]}focus(){this.parent&&(this.parent.activeChild=this)}_getDefaults(){return{}}_applyDefaultsInModel(){Object.entries(this._getDefaults()).map((([e,t])=>{void 0===this._jsonModel[e]&&void 0!==t?this._jsonModel[e]=t:"object"!=typeof t||null===t||Array.isArray(t)||Object.keys(t).forEach((n=>{void 0===this._jsonModel[e][n]&&(this._jsonModel[e][n]=t[n])}))}))}}$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Re.prototype,"index",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Re.prototype,"description",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Re.prototype,"visible",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Re.prototype,"label",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Re.prototype,"properties",null);class Pe extends Re{_events={};_rules={};getRules(){return"object"!=typeof this._jsonModel.rules?{}:this._jsonModel.rules}getCompiledRule(e,t){if(!(e in this._rules)){const n=t||this.getRules()[e];if(!("string"==typeof n&&n.length>0))throw new Error(`only expression strings are supported. ${typeof n} types are not supported`);try{this._rules[e]=this.ruleEngine.compileRule(n,this.lang)}catch(t){this.form.logger.error(`Unable to compile rule \`"${e}" : "${n}"\` Exception : ${t}`)}}return this._rules[e]}getCompiledEvent(e){if(!(e in this._events)){let t=this._jsonModel.events?.[e];"string"==typeof t&&t.length>0&&(t=[t]),void 0!==t&&t.length>0&&(this._events[e]=t.map((n=>{try{return this.ruleEngine.compileRule(n,this.lang)}catch(n){this.form.logger.error(`Unable to compile expression \`"${e}" : "${t}"\` Exception : ${n}`)}return null})).filter((e=>null!==e)))}return this._events[e]||[]}applyUpdates(e){Object.entries(e).forEach((([e,t])=>{if(e in Oe||e in this&&"function"!=typeof this[e])try{this[e]=t}catch(e){console.error(e)}}))}executeAllRules(e){const t=Object.entries(this.getRules());if(t.length>0){const n=this.getExpressionScope();t.forEach((([t,i])=>{const s=this.getCompiledRule(t,i);if(s){const i=this.ruleEngine.execute(s,n,e,!0);if(Oe.indexOf(t)>-1){this.isEmpty()&&this.isEmpty(i)&&"value"===t||(this[t]=i)}else this.form.logger.warn(`${t} is not a valid editable property.`)}}))}}getExpressionScope(){const e=this.getNonTransparentParent(),t={self:this.getRuleNode(),siblings:e?.ruleNodeReference()||{}},n=new Proxy(t,{get:(e,t)=>{if(t===Symbol.toStringTag)return"Object";if("string"==typeof t&&t.startsWith("$")){const n=e.self[t];return n instanceof Re?n.getRuleNode():n instanceof Array?n.map((e=>e instanceof Re?e.getRuleNode():e)):n}return t in e.siblings?e.siblings[t]:e.self[t]},has:(e,t)=>{const n=e.self[t],i=e.siblings[t];return void 0!==n||void 0!==i}});return n}executeEvent(e,t){let n;t&&(n=this.ruleEngine.execute(t,this.getExpressionScope(),e)),void 0!==n&&null!=n&&this.applyUpdates(n)}executeRule(e,t){void 0===e.payload.ruleName&&this.executeAllRules(t)}executeExpression(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this},n=this.ruleEngine.compileRule(e,this.lang);return this.ruleEngine.execute(n,this.getExpressionScope(),t)}executeAction(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this,$event:{type:e.type,payload:e.payload,target:this.getRuleNode()}},n=e.isCustomEvent?`custom:${e.type}`:e.type,i=e.isCustomEvent?`custom_${e.type}`:e.type,s=this.getCompiledEvent(n);i in this&&"function"==typeof this[i]&&this[i](e,t),s.forEach((e=>this.executeEvent(t,e))),this.notifyDependents(e)}}const qe=["readOnly","enabled"];class Ve extends Pe{_children=[];_childrenReference;_itemTemplate=null;fieldFactory;constructor(e,t){super(e,{form:t.form,parent:t.parent,mode:t.mode}),this.fieldFactory=t.fieldFactory}_getDefaults(){return{...super._getDefaults(),enabled:!0,readOnly:!1}}ruleNodeReference(){return this._childrenReference}get items(){return this._children}get maxItems(){return this._jsonModel.maxItems}set maxItems(t){this._jsonModel.maxItems=t;const n=this._jsonModel.minItems||1,i=this._children.length,s=Math.min(i-t,i-n);if(s>0){for(let e=0;e<s;e++)this.getDataNode().$removeDataNode(t+e),this._childrenReference.pop();const n=this._children.splice(t,s);this.notifyDependents(e("items",n,null))}}get minItems(){return this._jsonModel.minItems}set minItems(t){this._jsonModel.minItems=t;const n=this._children.length-t,i=Math.abs(n);if(n<0){const t=[];for(let e=0;e<i;e++)t.push(this._addChild(this._itemTemplate,null,!0));this.notifyDependents(e("items",t,null))}}hasDynamicItems(){return null!=this._itemTemplate}get isContainer(){return!0}_activeChild=null;isSiteContainer(e){return(":items"in e||"cqItems"in e)&&!("fieldType"in e)}isAFormField(e){return"fieldType"in e||"id"in e||"name"in e||"dataRef"in e||"type"in e}_getFormAndSitesState(e=!1,t=!1){return this._jsonModel.items?this._jsonModel.items.map((n=>{if(this.isSiteContainer(n)){const e={...n?.id?{id:this.form.getUniqueId()}:{}};return{...n,...e,":items":this.walkSiteContainerItems(n)}}return this.isAFormField(n)?{...this.form.getElement(n?.id).getState(e,t)}:n})):[]}getItemsState(e=!1,t=!1){return"array"===this._jsonModel.type||U(this._jsonModel)||e?e?this._getFormAndSitesState(e,t):this._children.map((e=>({...e.getState(!0,t)}))):this._getFormAndSitesState(e,t)}getState(e=!1,t=!1){return{...super.getState(t),...t?{":items":void 0,":itemsOrder":void 0}:{},items:this.getItemsState(e,t),enabled:this.enabled,readOnly:this.readOnly}}_createChild(e,t){return this.fieldFactory.createField(e,t)}walkSiteContainerItems(e){return Object.fromEntries(Object.entries(e[":items"]).map((([e,t])=>{if(this.isAFormField(t))return[e,this.form.getElement(t?.id).getState()];if(this.isSiteContainer(t))return this.walkSiteContainerItems(t);if("object"==typeof t){const n={...t?.id?{id:this.form.getUniqueId()}:{}};return[e,{...t,...n}]}return[e,t]})))}_addChildToRuleNode(e,t){const n=this,{parent:i=this}=t,s="array"==i.type?i._children.length+"":e.name||"";s.length>0&&Object.defineProperty(i._childrenReference,s,{get:()=>(e.isContainer&&e.hasDynamicItems()&&n.ruleEngine.trackDependency(e),n.hasDynamicItems()?(n.ruleEngine.trackDependency(n),void 0!==this._children[s]?this._children[s].getRuleNode():void 0):e.getRuleNode()),configurable:!0,enumerable:!0})}_addChild(e,t,n=!1,i="create"){let s=this;for(;null!=s&&s.isTransparent();)s=s.parent;("number"!=typeof t||t>s._children.length)&&(t=this._children.length);const r=this.form,a={index:t,...V(e,n?()=>r.getUniqueId():void 0)},o=this._createChild(a,{parent:this,form:this.form,mode:i});return e.id=o.id,this.form.fieldAdded(o),this._addChildToRuleNode(o,{parent:s}),t===this._children.length?this._children.push(o):this._children.splice(t,0,o),o}indexOf(e){return this._children.indexOf(e)}defaultDataModel(e){const t=this._jsonModel.type||void 0;if(void 0!==t){return new G(e,"array"===t?[]:{},t)}}_canHaveRepeatingChildren(e="create"){const t=this._jsonModel.items;return"array"==this._jsonModel.type&&null!=this.getDataNode()&&(1===t.length||1==t[0].repeatable&&"restore"===e)}_initialize(e){super._initialize(e);const t=this._jsonModel.items||[];if(this._childrenReference="array"==this._jsonModel.type?[]:{},this._canHaveRepeatingChildren(e)){this._itemTemplate=V(t[0]),"restore"===e&&(this._itemTemplate.repeatable=void 0),"number"!=typeof this._jsonModel.minItems&&(this._jsonModel.minItems=0),"number"!=typeof this._jsonModel.maxItems&&(this._jsonModel.maxItems=-1),"number"!=typeof this._jsonModel.initialItems&&(this._jsonModel.initialItems=Math.max(1,this._jsonModel.minItems));for(let n=0;n<this._jsonModel.initialItems;n++){let i;if("restore"===e){let s=this._itemTemplate;n<this._jsonModel.items.length&&(s=V(t[n]),s.repeatable=void 0),i=this._addChild(s,void 0,n>this._jsonModel.items.length-1,e)}else i=this._addChild(this._itemTemplate,void 0,n>this._jsonModel.items.length-1);"create"===e&&(t[0].id=i.id),i._initialize(e)}}else t.length>0?(t.forEach((t=>{if(this.isSiteContainer(t))this._initializeSiteContainer(t);else if(this.isAFormField(t)){this._addChild(t,void 0,!1,e)._initialize(e)}else this.form.logger.warn(`A container item was not initialized. ${t}`)})),this._jsonModel.minItems=this._children.length,this._jsonModel.maxItems=this._children.length,this._jsonModel.initialItems=this._children.length):this.form.logger.warn("A container exists with no items.");this.setupRuleNode()}_initializeSiteContainer(e){Object.entries(e[":items"]).forEach((([e,t])=>{if(this.isAFormField(t)){this._addChild(t)._initialize()}else if(this.isSiteContainer(t))return this._initializeSiteContainer(t)}))}addItem(i){if(("addItem"===i.type||"addInstance"==i.type)&&null!=this._itemTemplate&&(-1===this._jsonModel.maxItems||this._children.length<this._jsonModel.maxItems)){const s=this.getDataNode();let r=i.payload;const a=this._addChild(this._itemTemplate,i.payload,!0);("number"!=typeof r||r>this._children.length)&&(r=this._children.length);const o=a.defaultDataModel(r);o&&s.$addDataNode(r,o),a._initialize("create"),this.notifyDependents(e("items",a.getState(),null)),a.dispatch(new n),a.dispatch(new t);for(let e=r+1;e<this._children.length;e++)this._children[e].dispatch(new t)}}removeItem(n){if(("removeItem"===n.type||"removeInstance"==n.type)&&null!=this._itemTemplate){if(0==this._children.length)return;let i=n.payload;"number"!=typeof i&&(i=this._children.length-1);const s=this._children[i].getState();if(this._children.length>this._jsonModel.minItems){this._childrenReference.pop(),this._children.splice(i,1),this.getDataNode().$removeDataNode(i);for(let e=i;e<this._children.length;e++)this._children[e].dispatch(new t);this.notifyDependents(e("items",null,s))}}}queueEvent(e){super.queueEvent(e),e.metadata?.dispatch&&this.items.forEach((t=>{t.queueEvent(e)}))}reset(){if(("array"===this.type||U(this._jsonModel))&&this.items.length>this._jsonModel.initialItems){const e=this.items.length-this._jsonModel.initialItems;for(let t=0;t<e;t++)this.dispatch(new i)}this.items.forEach((e=>{e.reset()}))}validate(){return this.items.flatMap((e=>e.validate())).filter((e=>""!==e.fieldName))}dispatch(e){super.dispatch(e)}importData(e){this._bindToDataModel(e);const t=this.getDataNode()||e;this.syncDataAndFormModel(t)}syncDataAndFormModel(e){if("array"===e?.$type&&null!=this._itemTemplate){const t=e?.$value.length,n=this._children.length,i=-1===this._jsonModel.maxItems?t:this._jsonModel.maxItems,s=this._jsonModel.minItems;let r=Math.min(t-n,i-n);const a=Math.min(n-t,n-s);for(;r>0;){r--;this._addChild(this._itemTemplate)._initialize("create")}if(a>0){this._children.splice(t,a);for(let e=0;e<a;e++)this._childrenReference.pop()}}this._children.forEach((t=>{t.importData(e)}))}get activeChild(){return this._activeChild}set activeChild(t){if(t!==this._activeChild){let n=this._activeChild;for(;n instanceof Ve;){const e=n.activeChild;n.activeChild=null,n=e}const i=e("activeChild",t,this._activeChild);this._activeChild=t,this.parent&&null!==t&&(this.parent.activeChild=this),this._jsonModel.activeChild=t?.id,this.notifyDependents(i)}}get enabled(){return void 0!==this.parent?.enabled?!!this.parent?.enabled&&this._jsonModel.enabled:this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e,!0,this.notifyChildren)}get readOnly(){return void 0!==this.parent?.readOnly&&!!this.parent.readOnly||this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e,!0,this.notifyChildren)}notifyChildren(t){if(void 0!==t.payload&&void 0!==t.payload.changes)for(const n of t.payload.changes)void 0!==n.propertyName&&qe.includes(n.propertyName)&&this.items.forEach((i=>{this.notifyDependents.call(i,e(n.propertyName,i.getState()[n.propertyName],null)),"panel"===i.fieldType&&this.notifyChildren.call(i,t)}))}}$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Ve.prototype,"maxItems",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Ve.prototype,"minItems",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Ve.prototype,"activeChild",null);class ze{_jsonModel;constructor(e){this._jsonModel={...e}}getP(e,t){return((e,t,n)=>{if(t in e)return e[t];if(!t.startsWith(":")){const n=`:${t}`;if(n in e)return e[n]}return n})(this._jsonModel,e,t)}get isContainer(){return!1}}class Ue extends ze{get version(){return this.getP("version","")}get grammar(){return this.getP("grammar","")}}class Le{lang;captchaInfo;constructor(e="",t){this.lang=e,this.captchaInfo=t}}const He={off:0,debug:1,info:2,warn:3,error:4};class Qe{debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e){this.log(e,"error")}log(e,t){0!==this.logLevel&&this.logLevel<=He[t]&&console[t](e)}logLevel;constructor(e="off"){this.logLevel=He[e]}}class Ge{_node;_event;constructor(e,t){this._node=e,this._event=t}get node(){return this._node}get event(){return this._event}isEqual(e){return null!=e&&this._node==e._node&&this._event.type==e._event.type}toString(){return this._node.id+"__"+this.event.type}valueOf(){return this.toString()}}class We{logger;static MAX_EVENT_CYCLE_COUNT=10;_runningEventCount;_isProcessing=!1;_pendingEvents=[];constructor(e=new Qe("off")){this.logger=e,this._runningEventCount={}}get length(){return this._pendingEvents.length}get isProcessing(){return this._isProcessing}isQueued(e,t){const n=new Ge(e,t);return void 0!==this._pendingEvents.find((e=>n.isEqual(e)))}queue(e,t,n=!1){e&&t&&(t instanceof Array||(t=[t]),t.forEach((t=>{const i=new Ge(e,t),s=this._runningEventCount[i.valueOf()]||0;if(s<We.MAX_EVENT_CYCLE_COUNT){if(this.logger.info(`Queued event : ${t.type} node: ${e.id} - ${e.name}`),n){const e=this._isProcessing?1:0;this._pendingEvents.splice(e,0,i)}else this._pendingEvents.push(i);this._runningEventCount[i.valueOf()]=s+1}else this.logger.info(`Skipped queueing event : ${t.type} node: ${e.id} - ${e.name} with count=${s}`)})))}empty(){this._pendingEvents=[]}runPendingQueue(){if(!this._isProcessing){for(this._isProcessing=!0;this._pendingEvents.length>0;){const e=this._pendingEvents[0];this.logger.info(`Dequeued event : ${e.event.type} node: ${e.node.id} - ${e.node.name}`),e.node.executeAction(e.event),this._pendingEvents.shift()}this._runningEventCount={},this._isProcessing=!1}}}const Be=(e,t=null,n={})=>{const i={...Xe,...n},s="GET"===i.method&&t?Je(e,t):e;return"GET"!==i.method&&(i.body=t),fetch(s,{...i}).then((async t=>{let n;t.ok||console.error(`Error while fetching response from ${e} : ${t.statusText}`),n=t?.headers?.get("Content-Type")?.includes("application/json")?await t.json():await t.text();const i={};return t?.headers?.forEach(((e,t)=>{i[t]=e})),{status:t.status,body:n,headers:i}}))},Xe={method:"GET"},Je=(e,t)=>{if(!t)return e;let n={};try{n=JSON.parse(t)}catch(e){console.log("Query params invalid")}const i=[];return Object.keys(n).forEach((e=>{Array.isArray(n[e])?i.push(`${encodeURIComponent(e)}=${encodeURIComponent(JSON.stringify(n[e]))}`):i.push(`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)})),i.length?e.includes("?")?`${e}&${i.join("&")}`:`${e}?${i.join("&")}`:e},Ze=e=>{const t=e;return t.length>0&&t.startsWith("custom:")?t.substring(7):t},Ye=async(e,t,n,i,s,r,a)=>{const o=t,l={method:n};let u;if(i&&i instanceof ae&&i.data instanceof File){const e=new FormData;e.append(i.name,i.data),u=e}else if(i instanceof FormData)u=i;else if(i&&"object"==typeof i&&Object.keys(i).length>0){const e=Object.keys(a);e.length>0?l.headers={...a,...-1===e.indexOf("Content-Type")?{"Content-Type":"application/json"}:{}}:l.headers={"Content-Type":"application/json"};const t=l?.headers?.["Content-Type"]||"application/json";"application/json"===t?u=JSON.stringify(i):t.indexOf("multipart/form-data")>-1?u=et(i):t.indexOf("application/x-www-form-urlencoded")>-1&&(u=Ke(i))}const m=await Be(o,u,l);if(m?.status>=200&&m?.status<=299){const t=Ze(s);"submitSuccess"===s?e.form.dispatch(new d(m,!0)):e.form.dispatch(new h(t,m,!0))}else{e.form.logger.error("Error invoking a rest API");const t=Ze(r);"submitError"===r?(e.form.dispatch(new c(m,!0)),e.form.dispatch(new p(m,!0))):e.form.dispatch(new h(t,m,!0))}},Ke=e=>{const t=new URLSearchParams;return Object.entries(e).forEach((([e,n])=>{null!=n&&"object"==typeof n?t.append(e,z(n)):t.append(e,n)})),t},et=(e,t)=>{const n=new FormData;Object.entries(e).forEach((([e,t])=>{null!=t&&"object"==typeof t?n.append(e,z(t)):n.append(e,t)}));const i=(e,t)=>{if(e?.data instanceof File){let n=`${e?.dataRef}/${e?.name}`;n.startsWith("/")||(n=`/${n}`),t.append(n,e.data)}};return t&&Object.keys(t).reduce(((e,s)=>{const r=t[s];return r&&r instanceof Array?[...e,...r.map((e=>i(e,n)))]:[...e,i(r,n)]}),[]),n},tt=(e,t={})=>{switch(e){case"change":return new o(t);case"submit":return new m(t);case"click":return new v(t);case"addItem":return new y(t);case"removeItem":return new i(t);case"reset":return new _(t);case"addInstance":return new g(t);case"removeInstance":return new f(t);default:console.error("invalid action")}};class nt{static instance=null;customFunctions={};constructor(){}static getInstance(){return nt.instance||(nt.instance=new nt),nt.instance}registerFunctions(e){Object.entries(e).forEach((([e,t])=>{let n=t;"function"==typeof t&&(n={_func:(e,n,i)=>{const s={form:i.globals.$form,field:i.globals.$field,event:i.globals.$event,functions:{setProperty:(e,t)=>{const s=[e,"custom:setProperty",t];return nt.getInstance().getFunctions().dispatchEvent._func.call(void 0,s,n,i)},reset:e=>{const t=[e=e||"reset","reset"];return nt.getInstance().getFunctions().dispatchEvent._func.call(void 0,t,n,i)},validate:e=>{const t=[e];return nt.getInstance().getFunctions().validate._func.call(void 0,t,n,i)},exportData:()=>nt.getInstance().getFunctions().exportData._func.call(void 0,e,n,i),submitForm:(e,t,s)=>{const r=["custom:submitSuccess","custom:submitError",s||"multipart/form-data",e,t];return nt.getInstance().getFunctions().submitForm._func.call(void 0,r,n,i)}}};return t(...e,s)},_signature:[]}),n.hasOwnProperty("_func")?nt.getInstance().customFunctions[e]=n:console.warn(`Unable to register function with name ${e}.`)}))}unregisterFunctions(...e){e.forEach((e=>{e in nt.getInstance().customFunctions&&delete nt?.getInstance().customFunctions[e]}))}getFunctions(){function e(t){return null==t?t:null!==(n=t)&&"[object Array]"===Object.prototype.toString.call(n)?t.map((t=>e(t))):t.valueOf();var n}function t(e){return null==e?"":e.toString()}return{...{validate:{_func:(e,t,n)=>{const i=e[0];let s;return s="string"==typeof i||void 0===i?n.globals.form.validate():n.globals.form.getElement(i.$id).validate(),Array.isArray(s)&&s.length&&n.globals.form.logger.error("Form Validation Error"),s},_signature:[]},setFocus:{_func:(e,t,n)=>{const i=e[0],s=e[1];try{const e=n.globals.form.getElement(i?.$id)||n.globals.field;n.globals.form.setFocus(e,s)}catch(e){n.globals.form.logger.error("An error has occurred within the setFocus API.")}},_signature:[]},getData:{_func:(e,t,n)=>(n.globals.form.logger.warn("The `getData` function is depricated. Use `exportData` instead."),n.globals.form.exportData()),_signature:[]},exportData:{_func:(e,t,n)=>n.globals.form.exportData(),_signature:[]},importData:{_func:(e,t,n)=>{const i=e[0];return"object"==typeof i&&null!==i&&n.globals.form.importData(i),{}},_signature:[]},submitForm:{_func:(n,i,s)=>{let r,a,o,l="custom:submitSuccess",u="custom:submitError";return n.length>0&&"object"==typeof e(n[0])?(r=n.length>0?e(n[0]):null,a=!(n.length>1)||e(n[1]),o=n.length>2?t(n[2]):"multipart/form-data"):(s.globals.form.logger.warn("This usage of submitForm is deprecated. Please see the documentation and update"),l=t(n[0]),u=t(n[1]),o=n.length>2?t(n[2]):"multipart/form-data",r=n.length>3?e(n[3]):null,a=!(n.length>4)||e(n[4])),s.globals.form.dispatch(new m({success:l,error:u,submit_as:o,validate_form:a,data:r})),{}},_signature:[]},request:{_func:(n,i,s)=>{const r=t(n[0]),a=t(n[1]),o=e(n[2]);let l,u,d={};return"string"==typeof n[3]?(s.globals.form.logger.warn("This usage of request is deprecated. Please see the documentation and update"),l=e(n[3]),u=e(n[4])):(d=e(n[3]),l=e(n[4]),u=e(n[5])),Ye(s.globals,r,a,o,l,u,d),{}},_signature:[]},addInstance:{_func:(t,n,i)=>{const s=t[0],r=t.length>2?e(t[2]):void 0;try{const e=i.globals.form.getElement(s.$id),t=tt("addInstance",r);e.addItem(t)}catch(e){i.globals.form.logger.error("Invalid argument passed in addInstance. An element is expected")}},_signature:[]},removeInstance:{_func:(t,n,i)=>{const s=t[0],r=t.length>2?e(t[2]):void 0;try{const e=i.globals.form.getElement(s.$id),t=tt("removeInstance",r);e.removeItem(t)}catch(e){i.globals.form.logger.error("Invalid argument passed in removeInstance. An element is expected")}},_signature:[]},dispatchEvent:{_func:(t,n,i)=>{const s=t[0];let r,a=e(t[1]),o=t.length>2?e(t[2]):void 0,l=!1;return"string"==typeof s&&(o=a,a=s,l=!0),r=a.startsWith("custom:")?new h(a.substring(7),o,l):tt(a,o),null!=r&&("string"==typeof s?i.globals.form.dispatch(r):i.globals.form.getElement(s.$id).dispatch(r)),{}},_signature:[]}},...nt.getInstance().customFunctions}}}const it=nt.getInstance();class st extends Ve{_ruleEngine;_eventQueue;_fields={};_ids;_invalidFields=[];constructor(e,i,r,a=new We,o="off",l="create"){super(e,{fieldFactory:i,mode:l}),this._ruleEngine=r,this._eventQueue=a,this._logger=new Qe(o),"create"===l&&(this.queueEvent(new n),this.queueEvent(new t)),this._ids=function*(e=50){const t=function(){const t=[];for(let n=0;n<e;n++)t.push(ue(10));return t},n={};let i=t();do{let e=i.pop();for(;e in n;)0===i.length&&(i=t()),e=i.pop();n[e]=!0,yield i.pop(),0===i.length&&(i=t())}while(i.length>0)}(),this._bindToDataModel(new G("$form",{})),this._initialize(l),"create"===l&&this.queueEvent(new s)}_logger;get logger(){return this._logger}dataRefRegex=/("[^"]+?"|[^.]+?)(?:\.|$)/g;get metaData(){const e=this._jsonModel.metadata||{};return new Ue(e)}get action(){return this._jsonModel.action}importData(e){this._bindToDataModel(new G("$form",e)),this.syncDataAndFormModel(this.getDataNode()),this._eventQueue.runPendingQueue()}exportData(){return this.getDataNode()?.$value}resolveQualifiedName(e){let t=null;return this.visit((n=>{n.qualifiedName===e&&(t=n)})),t}exportSubmitMetaData(){let e=null;const t={};return this.visit((e=>{var n,i;"captcha"===e.fieldType&&(n=e.qualifiedName,i=e.value,t[n]||(t[n]=i))})),e=new Le(this.form.lang,t),e}#e(e){return e.filter((e=>!0===e.visible))}#t(e){const t=this.#e(e.items);return t?t[0]:null}#n(e){if(!e.isContainer){return void(e.parent.activeChild=e)}this.#i(e);let t=e.activeChild;t=null===t?this.#t(e):e.activeChild,this.#n(t)}#s(e,t){return e<t.length-1?t[e+1]:null}#r(e,t){return e>0?t[e-1]:null}#i(e){const t=e.parent;null!=t&&null!=t.activeChild&&(t.activeChild=null)}setFocus(e,t){if(!t)return this.#i(e),void this.#n(e);const n=e?.isContainer?e:e.parent,i=this.#e(n.items);let s=n.activeChild,r=null!==s?i.indexOf(s):-1;if(null===n.activeChild)return this.#n(i[0]),void(r=0);t===S.NEXT_ITEM?s=this.#s(r,i):t===S.PREVIOUS_ITEM&&(s=this.#r(r,i)),null!==s&&this.#n(s)}getState(e=!1){const t=this,n=super.getState(!1,e);return n.id="$form",Object.defineProperty(n,"data",{get:function(){return t.exportData()}}),Object.defineProperty(n,"attachments",{get:function(){return de(t)}}),n}get type(){return"object"}isTransparent(){return!1}get form(){return this}get ruleEngine(){return this._ruleEngine}getUniqueId(){return null==this._ids?"":this._ids.next().value}fieldAdded(e){this._fields[e.id]=e,e.subscribe((e=>{-1===this._invalidFields.indexOf(e.target.id)&&this._invalidFields.push(e.target.id)}),"invalid"),e.subscribe((e=>{const t=this._invalidFields.indexOf(e.target.id);t>-1&&this._invalidFields.splice(t,1)}),"valid"),e.subscribe((e=>{const t=e.target.getState();if(t){const n=e=>e&&"object"==typeof e?Array.isArray(e)?e.map(n):{...e}:e,i=e.payload.changes.map((({propertyName:e,currentValue:t,prevValue:i})=>({propertyName:e,currentValue:n(t),prevValue:n(i)}))),s=new r(i,t);this.dispatch(s)}}))}visit(e){this.traverseChild(this,e)}traverseChild(e,t){e.items.forEach((e=>{e.isContainer&&this.traverseChild(e,t),t(e)}))}validate(){const e=super.validate();return this.dispatch(new a(e)),e}isValid(){return 0===this._invalidFields.length}dispatch(e){"submit"===e.type?(super.queueEvent(e),this._eventQueue.runPendingQueue()):super.dispatch(e)}submit(e,t){const n=e?.payload?.validate_form;if(!n||0===this.validate().length){const n=e?.payload||{};(async(e,t,n,i="multipart/form-data",s=null)=>{const r=e.form.action;let a=s;"object"==typeof a&&null!=a||(a=e.form.exportData());const o=de(e.form,!0);let l=i;const u={data:a,submitMetadata:e.form.exportSubmitMetaData()};let d=u;(Object.keys(o).length>0||"multipart/form-data"===i)&&(d=et(u,o),l="multipart/form-data"),await Ye(e,r,"POST",d,t,n,{"Content-Type":l})})(t,n?.success?n?.success:"submitSuccess",n?.error?n?.error:"submitError",n?.submit_as,n?.data)}}reset(){super.reset(),this._invalidFields=[]}getElement(e){return e==this.id?this:this._fields[e]}get qualifiedName(){return"$form"}getEventQueue(){return this._eventQueue}get name(){return"$form"}get value(){return null}get id(){return"$form"}get title(){return this._jsonModel.title||""}}function rt(e){if(null==e){const t=(new Intl.DateTimeFormat).resolvedOptions();e=t.locale}return t=>function(e,t){if(null===e)return 0;const n=+e;if(!isNaN(n))return n;if(t){const n=j(e,t,!0);if(n!==e)return x(n)}return 0}(t,e)}class at{_context;_globalNames=["$form","$field","$event"];customFunctions;debugInfo=[];constructor(){this.customFunctions=it.getFunctions()}compileRule(e,t){const n=new M(this.customFunctions,rt(t),this.debugInfo);return{formula:n,ast:n.compile(e,this._globalNames)}}execute(e,t,n,i=!1){const{formula:s,ast:r}=e,a=this._context;let o;this._context=n;try{o=s.run(r,t,"en-US",n)}catch(e){this._context?.form?.logger?.error(e)}for(;this.debugInfo.length>0;)this._context?.form?.logger?.debug(this.debugInfo.pop());let l=o;return i&&"object"==typeof o&&null!==o&&(l=Object.getPrototypeOf(o).valueOf.call(o)),this._context=a,l}trackDependency(e){this._context&&void 0!==this._context.field&&this._context.field!==e&&e._addDependent(this._context.field)}}class ot extends Ve{constructor(e,i){super(e,i),"restore"!==i.mode&&(this._applyDefaults(),this.queueEvent(new n),this.queueEvent(new t))}_getDefaults(){return{...super._getDefaults(),visible:!0,required:!1,label:{visible:!0,richText:!1}}}_applyDefaults(){super._applyDefaultsInModel(),this._jsonModel.dataRef&&void 0===this._jsonModel.type&&(this._jsonModel.type="object")}get type(){const e=super.type;if("array"===e||"object"===e)return e}get items(){return super.items}get value(){return null}get fieldType(){return"panel"}}class lt extends ot{get maxOccur(){return this._jsonModel.maxItems}set maxOccur(e){this.maxItems=e}get minOccur(){return this.minItems}addInstance(e){return this.addItem(e)}removeInstance(e){return this.removeItem(e)}}$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],lt.prototype,"maxOccur",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],lt.prototype,"minOccur",null);const ut=["string","number","integer","boolean","file","string[]","number[]","integer[]","boolean[]","file[]","array","object"];class dt extends Pe{constructor(e,i){super(e,i),"restore"!==i.mode&&(this._applyDefaults(),this.queueEvent(new n),this.queueEvent(new t))}_ruleNodeReference=[];_initialize(){super._initialize(),this.setupRuleNode()}ruleNodeReference(){return this.type?.endsWith("[]")?this._ruleNodeReference=[]:this._ruleNodeReference=this,this._ruleNodeReference}_getDefaults(){return{readOnly:!1,enabled:!0,visible:!0,label:{visible:!0,richText:!1},required:!1,type:this._getFallbackType()}}_getFallbackType(){const e=this._jsonModel.type;let t=e;if("string"!=typeof e||-1===ut.indexOf(e)){const e=this.enum;if(t=typeof e?.[0],"undefined"===t&&void 0!==this._jsonModel.default&&(t=this._jsonModel.default instanceof Array&&this._jsonModel.default.length>0?typeof this._jsonModel.default[0]+"[]":typeof this._jsonModel.default),0===t.indexOf("undefined")){t={"text-input":"string","multiline-input":"string","number-input":"number","date-input":"string",email:"string","plain-text":"string",image:"string",checkbox:"boolean"}[this.fieldType]}}return t}_applyDefaults(){super._applyDefaultsInModel(),this.coerceParam("required","boolean"),this.coerceParam("readOnly","boolean"),this.coerceParam("enabled","boolean");const e=this._jsonModel.type;"string"==typeof e&&-1!==ut.indexOf(e)||(this._jsonModel.type=this._getFallbackType()),-1===["plain-text","image"].indexOf(this.fieldType)&&(this._jsonModel.value=void 0);if(void 0===this._jsonModel.value){const e=$e.type(this.getInternalType()||"string",this._jsonModel.default);this._jsonModel.value=e.value}if("string"!==this._jsonModel.type&&this.unset("emptyValue"),void 0===this._jsonModel.fieldType&&(this.form.logger.debug("fieldType property is mandatory. Please ensure all the fields have a fieldType"),this._jsonModel.viewType?(this._jsonModel.viewType.startsWith("custom:")?this.form.logger.error("viewType property has been removed. For custom types, use :type property"):this.form.logger.error("viewType property has been removed. Use fieldType property"),this._jsonModel.fieldType=this._jsonModel.viewType):this._jsonModel.fieldType=P(this._jsonModel)),void 0===this._jsonModel.enum){"boolean"===this._jsonModel.type&&(this._jsonModel.enum=[!0,!1])}else for(void 0===this._jsonModel.enumNames&&(this._jsonModel.enumNames=this._jsonModel.enum.map((e=>e.toString())));this._jsonModel.enumNames.length<this._jsonModel.enum.length;)this._jsonModel.enumNames.push(this._jsonModel.enum[this._jsonModel.enumNames.length].toString());const t=["minimum","maximum","exclusiveMinimum","exclusiveMaximum"];"string"!==this._jsonModel.type?this.unset("format","pattern","minLength","maxLength"):"date-input"===this._jsonModel.fieldType&&(this._jsonModel.format="date"),this.coerceParam("minLength","number"),this.coerceParam("maxLength","number"),"number"!==this._jsonModel.type&&"date"!==this._jsonModel.format&&"integer"!==this._jsonModel.type&&this.unset("step",...t),t.forEach((e=>{this.coerceParam(e,"integer"===this._jsonModel.type?"number":this._jsonModel.type)})),"number"!=typeof this._jsonModel.step&&this.coerceParam("step","number")}unset(...e){e.forEach((e=>this._jsonModel[e]=void 0))}coerceParam(e,t){const n=this._jsonModel[e];if(void 0!==n&&typeof n!==t){this.form.logger.info(`${e} is not of type ${t}. Trying to coerce.`);try{this._jsonModel[e]=((e,t)=>{let n;switch(t){case"string":return e+"";case"number":if(n=+e,!isNaN(n))return n;break;case"boolean":if("string"==typeof e)return"true"===e;if("number"==typeof e)return 0!==e}throw`${e} has invalid type. Expected : ${t}, Actual ${typeof e}`})(n,t)}catch(t){this.form.logger.warn(t),this.unset(e)}}}get editFormat(){return this.withCategory(this._jsonModel.editFormat)}get displayFormat(){return this.withCategory(this._jsonModel.displayFormat)}get displayValueExpression(){return this._jsonModel.displayValueExpression}get placeholder(){return this._jsonModel.placeholder}get readOnly(){return void 0!==this.parent.readOnly&&!0===this.parent.readOnly||this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e)}get enabled(){return void 0!==this.parent.enabled?!1!==this.parent.enabled&&this._jsonModel.enabled:this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e)}get valid(){return this._jsonModel?.validity?.valid}set valid(e){const t={valid:e};this._setProperty("valid",e),this._setProperty("validity",t)}get validity(){return this._jsonModel.validity}get emptyValue(){return"null"===this._jsonModel.emptyValue?null:""===this._jsonModel.emptyValue&&"string"===this.type?"":void 0}get enum(){return this._jsonModel.enum}set enum(e){this._setProperty("enum",e)}get enumNames(){return this._jsonModel.enumNames}set enumNames(e){this._setProperty("enumNames",e)}get required(){return this._jsonModel.required||!1}set required(e){this._setProperty("required",e)}get maximum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.maximum}set maximum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||this._setProperty("maximum",e)}get minimum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.minimum}set minimum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||this._setProperty("minimum",e)}withCategory(e){if(e){const t=e?.match(/^(?:date|num)\|/);if(null===t)return"date"===this.format?e=`date|${e}`:"number"!==this.type&&"integer"!==this.type||(e=`num|${e}`),e}return e}get editValue(){const e=this.editFormat;if(!e||!this.isNotEmpty(this.value)||!1===this.valid)return this.value;try{return b(this.value,this.lang,e)}catch(e){return this.value}}get displayValue(){if(this.displayValueExpression&&"string"==typeof this.displayValueExpression&&0!==this.displayValueExpression.length)return this.executeExpression(this.displayValueExpression);const e=this.displayFormat;if(!e||!this.isNotEmpty(this.value)||!1===this.valid)return this.value;try{return b(this.value,this.lang,e)}catch(e){return this.value}}getDataNodeValue(e){return this.isEmpty()?this.emptyValue:e}updateDataNodeAndTypedValue(e){const t=this.getDataNode();if(we.indexOf(this.fieldType)>-1&&void 0!==t)return;const n=this._getConstraintObject().type(this.getInternalType()||"string",e),i=this._setProperty("value",n.value,!1);return i.length>0&&(this._updateRuleNodeReference(n.value),void 0!==t&&t.setValue(this.getDataNodeValue(this._jsonModel.value),this._jsonModel.value,this)),i}get value(){return void 0===this._jsonModel.value?null:this._jsonModel.value}set value(e){const t=this.updateDataNodeAndTypedValue(e);let n={valid:!0},i="type";if(t?.length>0){let s={};const r=$e.type(this.getInternalType()||"string",e);if(this.parent.uniqueItems&&"array"===this.parent.type&&(n=$e.uniqueItems(this.parent.uniqueItems,this.parent.getDataNode().$value),i="uniqueItems"),r.valid&&n.valid)s=this.evaluateConstraints();else{const e=r.valid&&n.valid,t={valid:e,errorMessage:r.valid&&n.valid?"":this.getErrorMessage("type"),...e?{}:{validationMessage:e?"":this.getErrorMessage(i),validity:{valid:e,[N[i]]:!0}}};s=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],t)}s.valid&&this.triggerValidationEvent(s);const a=new o({changes:t.concat(Object.values(s))});this.dispatch(a)}}reset(){const e=this.updateDataNodeAndTypedValue(this.default),t={valid:void 0,errorMessage:"",validationMessage:"",validity:{valid:void 0}},n=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],t),i=new o({changes:e.concat(Object.values(n))});this.dispatch(i)}_updateRuleNodeReference(e){if(this.type?.endsWith("[]"))if(null!=e)for(e.forEach(((e,t)=>{this._ruleNodeReference[t]=e}));e.length!==this._ruleNodeReference.length;)this._ruleNodeReference.pop();else for(;0!==this._ruleNodeReference.length;)this._ruleNodeReference.pop()}getInternalType(){return this.type}valueOf(){const e=this[Ce],t=void 0===e?this:e;return t.ruleEngine.trackDependency(t),t._jsonModel.value||null}toString(){const e=this[Ce],t=void 0===e?this:e;return t._jsonModel.value?.toString()||""}getErrorMessage(e){const t=e,n=N[t],i={...w,...D};return this._jsonModel.constraintMessages?.[t]||((e,t=[])=>e?.replace(/\${(\d+)}/g,((e,n)=>{const i=t[n];return void 0!==i?i:e})))(i[n],[this._jsonModel[t]])}get errorMessage(){return this._jsonModel.errorMessage}set errorMessage(e){this._setProperty("errorMessage",e),this._setProperty("validationMessage",e)}get screenReaderText(){return this._jsonModel.screenReaderText}_getConstraintObject(){return $e}isArrayType(){return!!this.type&&this.type.indexOf("[]")>-1}checkEnum(e,t){if(!0===this._jsonModel.enforceEnum&&null!=e){const n=t.enum;return e instanceof Array&&this.isArrayType()?e.every((e=>n(this.enum||[],e).valid)):n(this.enum||[],e).valid}return!0}checkStep(){const e=this._jsonModel.value,t=this._jsonModel.step;if("number"==typeof t){const n=t.toString().split(".")?.[1]?.length||0,i=Math.pow(10,n),s=t*i,r=e*i,a=(this._jsonModel.minimum||this._jsonModel.default||0)*i,o=(r-a)/s,l=Math.abs(r-a)%s<.001;let u,d;return l||(u=(Math.ceil(o)*s+a)/i,d=(u-s)/i),{valid:l,next:u,prev:d}}return{valid:!0}}checkValidationExpression(){const e=this._jsonModel.validationExpression;return"string"!=typeof e||0===e.length||this.executeExpression(e)}getConstraints(){switch(this.type){case"string":switch(this.format){case"date":return Te.date;case"email":return Te.email;case"binary":case"data-url":return Te.file;default:return Te.string}case"file":return Te.file;case"number":case"integer":return Te.number}return this.isArrayType()?Te.array:[]}get format(){if(void 0===this._jsonModel.format&&"string"===this.type)switch(this.fieldType){case"date-input":this._jsonModel.format="date";break;case"file-input":this._jsonModel.format="data-url"}return this._jsonModel.format}get enforceEnum(){return this._jsonModel.enforceEnum}get tooltip(){return this._jsonModel.tooltip}get maxLength(){return this._jsonModel.maxLength}get minLength(){return this._jsonModel.minLength}get pattern(){return this._jsonModel.pattern}get step(){if("number"===this.type||"date"===this.format)return this._jsonModel.step}get exclusiveMinimum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.exclusiveMinimum}set exclusiveMinimum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||(this._jsonModel.exclusiveMinimum=e)}get exclusiveMaximum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.exclusiveMaximum}set exclusiveMaximum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||(this._jsonModel.exclusiveMaximum=e)}get default(){return this._jsonModel.default}isNotEmpty(e){return null!=e&&""!==e}evaluateConstraints(){let e="type";const t=this._jsonModel,n=this._jsonModel.value,i=this._getConstraintObject(),s=this.getConstraints();let r=!0;if(r&&(r=i.required(this.required,n).valid&&(!this.isArrayType()||!this.required||n.length>0),e="required"),r&&this.isNotEmpty(n)){const a=s.find((e=>{if(e in t&&void 0!==t[e]){const s=t[e],r=i[e];return n instanceof Array&&this.isArrayType()?-1!==Te.array.indexOf(e)?!r(s,n).valid:n.some((e=>!r(s,e).valid)):"function"==typeof r&&!r(s,n).valid}return!1}));null!=a?(r=!1,e=a):(r=this.checkEnum(n,i),e="enum",r&&"number"===this.type&&(r=this.checkStep().valid,e="step"),r&&(r=this.checkValidationExpression(),e="validationExpression"))}r||this.form.logger.info(`${e} constraint evaluation failed ${this._jsonModel[e]}. Received ${this._jsonModel.value}`);const a={valid:r,errorMessage:r?"":this.getErrorMessage(e),validationMessage:r?"":this.getErrorMessage(e),validity:{valid:r,...r?{}:{[N[e]]:!0}}};return this._applyUpdates(["valid","errorMessage","validationMessage","validity"],a)}triggerValidationEvent(e){e.validity&&(this.validity.valid?this.dispatch(new l):this.dispatch(new u))}validate(){if(!1===this.visible)return[];const e=this.evaluateConstraints();return e.validity&&(this.triggerValidationEvent(e),this.notifyDependents(new o({changes:Object.values(e)}))),this.valid?[]:[new C(this.id,[this._jsonModel.errorMessage])]}importData(t){this._bindToDataModel(t);const n=this.getDataNode();if(void 0!==n&&n!==Q&&n.$value!==this._jsonModel.value){const t=e("value",n.$value,this._jsonModel.value);this._jsonModel.value=n.$value,this.queueEvent(t)}}defaultDataModel(e){const t=we.indexOf(this.fieldType)>-1?void 0:this.getDataNodeValue(this._jsonModel.value);return new L(e,t,this.type||"string")}getState(e=!1,t=!1){return{...super.getState(t),editFormat:this.editFormat,displayFormat:this.displayFormat,editValue:this.editValue,displayValue:this.displayValue,enabled:this.enabled,readOnly:this.readOnly}}markAsInvalid(e,t=null){const n={valid:!1,errorMessage:e,validationMessage:e,validity:{valid:!1,...null!=t?{[N[t]]:!0}:{}}},i=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],n),s=new o({changes:[].concat(Object.values(i))});0!==s.payload.changes.length&&(this.triggerValidationEvent(i),this.dispatch(s))}}function ht(e,t){return e.replace(";base64",`;name=${encodeURIComponent(t)};base64`)}async function ct(e){const{name:t,size:n,type:i}=e;return await new Promise(((s,r)=>{const a=new FileReader;a.onload=e=>{s(new ae({data:ht(e.target.result,t),type:i,name:t,size:n}))},a.readAsDataURL(e.data)}))}$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})},ke("button","image","plain-text")],dt.prototype,"readOnly",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})},ke("image","plain-text")],dt.prototype,"enabled",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"valid",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"validity",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"enum",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"enumNames",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"required",null),$([Ae("date-input","number-input")],dt.prototype,"editValue",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"value",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"errorMessage",null),$([Ae("text-input","date-input","file-input","email")],dt.prototype,"format",null),$([Ae("text-input")],dt.prototype,"maxLength",null),$([Ae("text-input")],dt.prototype,"minLength",null),$([Ae("text-input")],dt.prototype,"pattern",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"exclusiveMinimum",null),$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],dt.prototype,"exclusiveMaximum",null);class pt extends dt{_getDefaults(){return{...super._getDefaults(),accept:["audio/*","video/*","image/*","text/*","application/pdf"],maxFileSize:"2MB"}}_getFallbackType(){return"file"}get maxFileSize(){return he(this._jsonModel.maxFileSize)}get accept(){return this._jsonModel.accept}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=this._jsonModel[n],s=t[n];return s!==i&&(e[n]={propertyName:n,currentValue:s,prevValue:i},this._jsonModel[n]=i instanceof ae&&"object"==typeof s&&"value"===n?new ae({...i,data:s.data}):s),e}),{})}getInternalType(){return this.type?.endsWith("[]")?"file[]":"file"}getDataNodeValue(e){let t=e;return null!=t&&("string"===this.type?t=t.data?.toString():"string[]"===this.type&&(t=t instanceof Array?t:[t],t=t.map((e=>e?.data?.toString())))),t}async _serialize(){const e=this._jsonModel.value;if(void 0===e)return null;var t;return await(t=e instanceof Array?e:[e],Promise.all([].map.call(t,ct)))}importData(t){this._bindToDataModel(t);const n=this.getDataNode();if(void 0!==n&&n!==Q){const t=n?.$value;if(null!=t){const n=$e.type(this.getInternalType(),t);n.valid||this.form.logger.debug(`unable to bind ${this.name} to data`),this.form.getEventQueue().queue(this,e("value",n.value,this._jsonModel.value)),this._jsonModel.value=n.value}else this._jsonModel.value=null}}}class mt extends dt{offValue(){const e=this.enum;return e.length>1?e[1]:null}_getConstraintObject(){const e={...super._getConstraintObject()};var t;return e.required=(t=this.offValue(),(e,n)=>({valid:$e.required(e,n).valid&&(!e||n!=t),value:n})),e}_applyDefaults(){"boolean"==typeof this._jsonModel.checked&&(this._jsonModel.checked?this._jsonModel.default=this._jsonModel.enum?.[0]:this._jsonModel.default=this._jsonModel.enum?.[1]),super._applyDefaults()}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0}}get enum(){return this._jsonModel.enum||[]}updateDataNodeAndTypedValue(e){const t=super.updateDataNodeAndTypedValue(e),n=t.find((e=>"value"===e.propertyName));if(n){const e=n.prevValue===this._jsonModel.enum?.[0],i=n.currentValue===this._jsonModel.enum?.[0];e!==i&&t.push({propertyName:"checked",prevValue:e,currentValue:i})}return t}set checked(e){this.value=e?this._jsonModel.enum?.[0]:this._jsonModel.enum?.[1]}get checked(){return this.value===this._jsonModel.enum?.[0]}getState(e=!1,t=!1){return{...super.getState(e,t),checked:this.checked}}}$([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"checked",null);class ft extends dt{constructor(e,t){super(e,t)}_getFallbackType(){const e=super._getFallbackType();return"string"==typeof e?`${e}[]`:"string[]"}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0,enum:[]}}}class gt extends dt{locale;_dataFormat="yyyy-MM-dd";_applyDefaults(){super._applyDefaults(),this.locale=(new Intl.DateTimeFormat).resolvedOptions().locale,this._jsonModel.editFormat||(this._jsonModel.editFormat="short"),this._jsonModel.displayFormat||(this._jsonModel.displayFormat=this._jsonModel.editFormat),this._jsonModel.placeholder||(this._jsonModel.placeholder=E(this._jsonModel.editFormat,this.locale)),this._jsonModel.description||(this._jsonModel.description=`To enter today's date use ${T(new Date,this.locale,this._jsonModel.editFormat)}`)}get value(){return super.value}set value(e){if("number"==typeof e){const t=I(e);isNaN(t)||(super.value=T(t,this.locale,this._dataFormat))}else super.value=e}}class _t extends dt{_getDefaults(){return{...super._getDefaults(),format:"email"}}}class yt extends dt{getDataNode(){}}const vt={text:"text-input",number:"number-input",email:"email",file:"file-input",range:"range",textarea:"multiline-input"};const Mt=new class{createField(e,t){let n;const i={...t,fieldFactory:this};if(e.fieldType=e.fieldType?e.fieldType in vt?vt[e.fieldType]:e.fieldType:"text-input",U(e)){const t={...e,..."items"in e&&{type:"object"},minOccur:void 0,maxOccur:void 0,repeatable:void 0,name:void 0},s={minItems:e.minOccur||0,maxItems:e.maxOccur||-1,fieldType:e.fieldType,type:"array",name:e.name,dataRef:e.dataRef,items:[t]};n=new lt(s,i)}else"items"in e?n=new ot(e,i):q(e)||"file-input"===e.fieldType?n=new pt(e,i):(s=e,n="checkbox"===(s?.fieldType||P(s))?new mt(e,i):function(e){return"checkbox-group"===(e?.fieldType||P(e))}(e)?new ft(e,i):function(e){const t=e?.fieldType||P(e);return"text-input"===t&&"email"===e?.format||"email"===t}(e)?new _t(e,i):function(e){const t=e?.fieldType||P(e);return"text-input"===t&&"date"===e?.format||"date-input"===t}(e)?new gt(e,i):function(e){return"captcha"===(e?.fieldType||P(e))}(e)?new yt(e,i):new dt(e,i));var s;return n}},bt=(e,t,n="error",i=void 0)=>{try{let s=i;null==s&&(e=fe(e),s=new st({...e},Mt,new at,new We(new Qe(n)),n));const r=e?.data;return r&&s.importData(r),"function"==typeof t&&t(s),s.getEventQueue().runPendingQueue(),s}catch(e){throw console.error(`Unable to create an instance of the Form ${e}`),new Error(e)}},jt={logLevel:"error"},xt=(e,t=null,{logLevel:n}=jt)=>{try{const i=new st({...e},Mt,new at,new We(new Qe(n)),n,"restore");return t&&(i._bindToDataModel(new G("$form",t)),i.syncDataAndFormModel(i.getDataNode())),i.getEventQueue().empty(),i}catch(e){throw console.error(`Unable to restore an instance of the Form ${e}`),new Error(e)}},Et=(e,t)=>{try{const n=new st({...e},Mt,new at);return t&&n.importData(t),0===n.validate().length}catch(e){throw new Error(e)}},Tt=(e,t)=>{try{const n=new st({...e},Mt,new at);t&&n.importData(t);const i=n.validate();return{messages:i,valid:0===i.length}}catch(e){throw new Error(e)}},It=(e,t={})=>{const n=new Headers;return Object.entries(t).forEach((([e,t])=>{n.append(e,t)})),new Promise(((n,i)=>{Be(`${e}.model.json`,null,{headers:t}).then((e=>{if(200!==e.status)i("Not Found");else{let t=e.body;if("model"in t){const{model:e}=t;t=e}n(z(t))}}))}))},$t=e=>{it.registerFunctions(e)};export{bt as createFormInstance,It as fetchForm,$t as registerFunctions,xt as restoreFormInstance,Tt as validateFormData,Et as validateFormInstance};
