/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as g,Fragment as Ce}from"@dropins/tools/preact-jsx-runtime.js";import{useMemo as ce,useCallback as K,useState as f,useRef as ie,useEffect as W}from"@dropins/tools/preact-hooks.js";import{classes as be}from"@dropins/tools/lib.js";import{ActionButton as le,Pagination as Be,ProgressSpinner as me,Picker as Oe,Button as X,Card as ue,Header as ne,InLineAlert as te,Field as Ue,Input as Ve,Modal as $e,IllustratedMessage as ge}from"@dropins/tools/components.js";import{D as re,u as qe}from"../chunks/useCompanyRoles.js";import{T as ze,u as He}from"../chunks/useUserPermissions.js";import{u as Ge}from"../chunks/useInLineAlert.js";import{u as je}from"../chunks/useCompanyContextListener.js";import{T as Xe}from"../chunks/Tree.js";import{f as ve}from"../chunks/company-permissions.js";import{i as Ye}from"../chunks/isCompanyRoleNameAvailable.js";import{useText as oe}from"@dropins/tools/i18n.js";import"@dropins/tools/preact.js";import"../chunks/fetchUserPermissions.js";import"../chunks/fetch-error.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/preact-compat.js";var Je={};const Ke=d=>{try{if(/^\d+$/.test(d))return d;const n=atob(d).match(/(\d+)$/);return n?n[1]:d}catch(a){return console.warn("Failed to decode role ID:",d,a),d}},We=({className:d,roles:a,isLoading:n,canManageRoles:c=!1,onShowCreateForm:s,onShowEditForm:p,onDuplicateRole:b,onDeleteRole:R,totalCount:P=a.length,currentPage:T=1,pageSize:i=re,onPageChange:N,onPageSizeChange:F,onSortChange:I,sortColumn:v,sortDirection:x,children:_,...Z})=>{const h=oe({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",itemsRange:"Company.RoleAndPermissionTable.itemsRange",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),E=typeof process<"u"&&Je.JEST_WORKER_ID!==void 0,S=!!(I&&x&&v)&&!E,$=ce(()=>[{key:"id",label:h.columnId||"ID",...S&&{sortBy:v==="id"?x:!0}},{key:"name",label:h.columnRole||"Role",...S&&{sortBy:v==="name"?x:!0}},{key:"usersCount",label:h.columnUsers||"Users",...S&&{sortBy:v==="usersCount"?x:!0}},{key:"actions",label:h.columnActions||"Actions"}],[h,v,x,S]),M=K(r=>c&&r.id!=="0",[c]),O=K(r=>c&&r.id!=="0",[c]),A=K(r=>c&&r.id!=="0"&&P>1,[c,P]),U=K(r=>{const y=[];return M(r)&&y.push(e(le,{onClick:()=>p(r.id),className:"role-action-button",children:h.editButton||"Edit"},"edit")),O(r)&&b&&y.push(e(le,{onClick:()=>b(r.id),className:"role-action-button",children:h.duplicateButton||"Duplicate"},"duplicate")),A(r)&&R&&y.push(e(le,{onClick:()=>R(r.id),className:"role-action-button",children:h.deleteButton||"Delete"},"delete")),y.length===0?c?e("span",{className:"no-actions",children:h.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:y.map((B,z)=>e("span",{className:"role-action-wrapper",children:B},z))})},[M,O,A,p,b,R,h,c]),w=ce(()=>a.map(r=>({id:Ke(r.id),name:r.name,usersCount:r.usersCount,actions:e("div",{className:"roles-actions",children:U(r)})})),[a,U]),C=[re,20,50,100].map(r=>({value:r.toString(),label:r.toString(),text:r.toString()})),q=Math.ceil(P/i),L=(T-1)*i,V=L+i;return g("div",{...Z,className:be(["company-management-role-and-permission-table",d]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e(ze,{columns:$,rowData:w,mobileLayout:"stacked",loading:n,skeletonRowCount:10,onSortChange:(r,y)=>{let B;y===!0?v===r&&x?B=x==="asc"?"desc":"asc":B="asc":B=y,I==null||I(r,B)}})}),g("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:e("span",{className:"item-count",children:(h.itemsRange||"Items {start}-{end} of {total}").replace("{start}",String(L+1)).replace("{end}",String(Math.min(V,P))).replace("{total}",String(P))})}),q>1&&e("div",{className:"table-footer-center",children:e(Be,{currentPage:T,totalPages:q,onChange:r=>N==null?void 0:N(r)})}),e("div",{className:"table-footer-right",children:g("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:h.show||"Show"}),n?e("div",{className:"page-size-loading",children:e(me,{size:"small"})}):e(Oe,{value:i.toString(),onChange:r=>{const y=r.target;F==null||F(parseInt(y.value,10))},options:C,className:"page-size-picker"})]})})]}),c&&e("div",{className:"add-role-section",children:e(X,{variant:"primary",onClick:s,children:h.addNewRole||"Add New Role"})}),_]})},Ze={MAX_LENGTH:40},de=d=>(typeof d=="string"?d:String(d||"")).trim().slice(0,Ze.MAX_LENGTH),Ae=({mode:d,role:a,aclResources:n,existingRoleNames:c=[],loading:s=!1,onSubmit:p,onCancel:b,inLineAlertProps:R,prefillName:P,prefillPermissions:T})=>{const i=oe({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[N,F]=f({name:(a==null?void 0:a.name)||""}),[I,v]=f({}),[x,_]=f({}),[Z,h]=f(!1),[E,S]=f(!1),[$,M]=f([]),[O,A]=f(new Set),[U,w]=f(new Set),C=ie(null),q=ie(""),L=ie(!1);W(()=>{if(!L.current){if(L.current=!0,d==="edit"&&a){if(F({name:a.name}),a.permissions&&a.permissions.length>0){const o=ve(a.permissions);w(new Set(o))}}else if(d==="create")if(F({name:P??""}),T&&T.length>0){const l=ve(T);w(new Set(l))}else w(new Set)}},[d,a,P,T]),W(()=>{if(n.length>0){const o=Qe(n);M(o);const l=o.filter(m=>!m.parentId).map(m=>m.id);A(new Set(l))}},[n]),W(()=>()=>{C.current&&clearTimeout(C.current)},[]);const V=K(o=>{const l=de(o);return l?(d==="edit"&&a?c.filter(j=>j!==a.name):c).includes(l)?i.roleNameExists:null:i.roleNameRequired||"This is a required field."},[d,a,c,i.roleNameRequired,i.roleNameExists]),r=K(async o=>{const l=de(o),m=V(l);if(m)return m;if(d==="edit"&&a&&l===a.name)return null;try{return h(!0),await Ye({name:l})?null:i.roleNameExists}catch(j){return console.error("Role name validation failed:",j),null}finally{h(!1)}},[d,a,i.roleNameExists,V]),y=K(o=>{C.current!==null&&clearTimeout(C.current),o!==q.current&&(C.current=window.setTimeout(async()=>{const l=await r(o);v(l?m=>({...m,name:l}):m=>({...m,name:""})),q.current=o},500))},[r]),B=()=>{const o={};let l=!0;const m=V(N.name);return m&&(o.name=m,l=!1),v(o),l},z=o=>{const l=typeof o=="string"?o:o.target.value;F(m=>({...m,name:l})),I.name&&v(m=>({...m,name:""})),y(l)},ae=()=>{_(o=>({...o,name:!0})),C.current&&(clearTimeout(C.current),C.current=null)},k=()=>{const o=new Set($.map(l=>l.id));A(o)},Y=()=>{A(new Set)},H=async o=>{if(o.preventDefault(),!E&&(_({name:!0}),!!B()&&!I.name)){S(!0);try{const l={name:de(N.name),permissions:Array.from(U)};p&&await p(l)}catch(l){console.error("Form submission failed:",l)}finally{S(!1)}}},G=d==="create"?i.createTitle:i.editTitle;return g(ue,{variant:"secondary",className:"edit-role-and-permission",children:[e(ne,{level:2,size:"large",title:G,divider:!1,className:"edit-role-and-permission__title"}),(R==null?void 0:R.text)&&e(te,{className:"edit-role-and-permission__notification",type:R.type,variant:"secondary",heading:R.text,"data-testid":"editRoleInLineAlert"}),g("form",{className:"edit-role-and-permission-form",onSubmit:H,children:[g("div",{className:"edit-role-and-permission__section",children:[e(ne,{level:3,size:"medium",title:i.roleInformation||"Role Information",divider:!1,className:"edit-role-and-permission__section-title"}),e(Ue,{label:i.roleName||"Role Name",required:!0,error:x.name&&I.name?I.name:void 0,children:e(Ve,{type:"text",name:"roleName",value:N.name,onChange:z,onBlur:ae,disabled:s||E,"data-testid":"roleNameInput",placeholder:i.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),Z&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(me,{size:"medium"})})]}),g("div",{className:"edit-role-and-permission__section",children:[e(ne,{level:3,size:"medium",title:i.rolePermissions,divider:!1,className:"edit-role-and-permission__section-title"}),e(te,{type:"info",variant:"secondary",heading:i.permissionsDescription,className:"edit-role-and-permission__permissions-description"}),g("div",{className:"edit-role-and-permission__tree-controls",children:[e(X,{type:"button",variant:"tertiary",onClick:k,disabled:s||E,children:i.expandAll}),e(X,{type:"button",variant:"tertiary",onClick:Y,disabled:s||E,children:i.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":i.rolePermissions,children:$.length>0?e(Xe,{items:$,expandedIds:O,onExpandedChange:A,checkedIds:U,onCheckedChange:w,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:o,expanded:l,hasChildren:m,toggle:j,checkbox:Q})=>g("div",{className:"edit-role-and-permission__tree-node",children:[m?e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:se=>{se.preventDefault(),se.stopPropagation(),j()},"aria-label":l?`Collapse ${o.label}`:`Expand ${o.label}`,children:l?"âˆ’":"+"}):e("span",{className:"edit-role-and-permission__tree-spacer"}),Q&&Q(),e("span",{className:"edit-role-and-permission__tree-label",children:o.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),g("div",{className:"edit-role-and-permission__actions",children:[e(X,{type:"button",variant:"secondary",onClick:b,disabled:s||E,children:i.cancel}),e(X,{type:"submit",variant:"primary",disabled:s||E,children:s||E?i.saving:i.saveRole})]})]}),(s||E)&&g("div",{className:"edit-role-and-permission__loading-overlay",children:[e(me,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:i.saving})]})]})},Qe=d=>{const a=[],n=(s,p)=>{a.push({id:s.id,parentId:p||null,label:s.text}),s.children&&[...s.children].sort((R,P)=>R.sortOrder-P.sortOrder).forEach(R=>{n(R,s.id)})};return[...d].sort((s,p)=>s.sortOrder-p.sortOrder).forEach(s=>n(s)),a},es=({isOpen:d,hasUsers:a=!1,onConfirm:n,onCancel:c})=>{const s=oe({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!d)return null;const p=a?s.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":s.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return g($e,{open:!0,onClose:c,title:e(Ce,{children:a?s.cannotDeleteModalTitle||"Cannot Delete Role":s.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:p})}),e("div",{className:"delete-role-modal__actions",children:a?e(X,{variant:"primary",onClick:n,className:"delete-role-modal__ok-btn",children:s.cannotDeleteModalOk||"OK"}):g(Ce,{children:[e(X,{variant:"secondary",onClick:c,className:"delete-role-modal__cancel-btn",children:s.deleteModalCancel||"Cancel"}),e(X,{variant:"primary",onClick:n,className:"delete-role-modal__confirm-btn",children:s.deleteModalConfirm||"Delete"})]})})]})},gs=({className:d,withHeader:a=!1})=>{const n=oe({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:c,handleSetInLineAlert:s}=Ge(),{permissions:p,loading:b,error:R}=He(),P=(p==null?void 0:p.canViewRoles)??!1,T=(p==null?void 0:p.canManageRoles)??!1,i=P||T,{roles:N,aclResources:F,isLoading:I,isCreating:v,isUpdating:x,error:_,createRole:Z,updateRole:h,deleteRole:E,clearError:S,refresh:$}=qe(re,i,!0),[M,O]=f(!1),[A,U]=f(!1),[w,C]=f(null),[q,L]=f(1),[V,r]=f(re),[y,B]=f("id"),[z,ae]=f("asc"),[k,Y]=f(null),[H,G]=f(null);W(()=>()=>{_&&S(),G(null)},[_,S]);const[o,l]=f(0);je(()=>{L(1),A&&(U(!1),C(null)),Y(null),S(),l(t=>t+1)},{eager:!0}),W(()=>{M&&!b&&!T&&(O(!1),G(null))},[M,b,T]),W(()=>{o!==0&&(b||i&&$())},[o,i,$,b]);const m=ce(()=>{const t=[...N];return t.sort((u,D)=>{let J,ee;if(y==="id"){const ye=Le=>{try{const fe=atob(Le),Re=fe.match(/role\/(\d+)/);if(Re)return parseInt(Re[1],10);const Ne=parseInt(fe,10);return isNaN(Ne)?0:Ne}catch{return 0}};J=ye(u.id),ee=ye(D.id)}else if(y==="name")J=u.name.toLowerCase(),ee=D.name.toLowerCase();else if(y==="usersCount")J=u.usersCount||0,ee=D.usersCount||0;else return 0;return J<ee?z==="asc"?-1:1:J>ee?z==="asc"?1:-1:0}),t},[N,y,z]),j=m.length,Q=(q-1)*V,se=Q+V,Pe=m.slice(Q,se);if(b&&!M&&!A)return e("div",{className:"roles-and-permissions-container","data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(R&&!M&&!A)return e("div",{className:"roles-and-permissions-container",children:e(ue,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(ge,{heading:n.errorTitle||"Error Loading Permissions",message:e("p",{children:n.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})})});if(!i&&!M&&!A)return e("div",{className:"roles-and-permissions-container",children:e(ue,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(ge,{heading:n.noAccessTitle||"Access Restricted",message:e("p",{children:n.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})})});const Te=t=>{L(t)},_e=t=>{r(t),L(1)},Ee=(t,u)=>{B(t),ae(u),L(1)},Se=()=>{G(null),O(!0)},pe=()=>{G(null),O(!1)},we=t=>{C(t),U(!0)},he=()=>{U(!1),C(null)},Ie=t=>{const u=N.find(D=>D.id===t);u&&(G({name:`${u.name} - Duplicated`,permissions:u.permissions||[]}),O(!0))},xe=async t=>{try{if(await Z({name:t.name,permissions:t.permissions})){const D=n.createSuccess?n.createSuccess.replace("{roleName}",t.name):`Role "${t.name}" created successfully!`;s({type:"success",text:D}),pe()}else s({type:"error",text:n.createError||"Failed to create role. Please try again."})}catch{s({type:"error",text:n.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},Me=async t=>{if(w)try{if(await h({id:w,name:t.name,permissions:t.permissions})){const D=n.updateSuccess?n.updateSuccess.replace("{roleName}",t.name):`Role "${t.name}" updated successfully!`;s({type:"success",text:D}),he()}else s({type:"error",text:n.updateError||"Failed to update role. Please try again."})}catch{s({type:"error",text:n.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},ke=t=>{const u=N.find(J=>J.id===t);if(!u)return;const D=u.usersCount>0;Y({id:t,name:u.name,hasUsers:D})},De=async()=>{if(k){if(k.hasUsers){Y(null);return}try{if(await E(k.id)){const u=n.deleteRoleSuccess?n.deleteRoleSuccess.replace("{roleName}",k.name||"Unknown Role"):`You have deleted role "${k.name||"Unknown Role"}".`;s({type:"success",text:u})}else s({type:"error",text:n.deleteError||"Failed to delete role. Please try again."})}catch{s({type:"error",text:n.deleteError||"Failed to delete role. Please try again."})}finally{Y(null)}}},Fe=()=>Y(null);return e("div",{className:"roles-and-permissions-container",children:g("div",{className:be(["roles-and-permissions",d]),children:[a?e(ne,{title:n.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,_&&e(te,{type:"error",heading:n.errorTitle||"Error",description:n.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:S}),c&&c.text&&e(te,{type:c.type||"success",heading:c.text,icon:c.icon}),M?e(Ae,{mode:"create",aclResources:F,existingRoleNames:N.map(t=>t.name),loading:v,onSubmit:xe,onCancel:()=>{G(null),pe()},inLineAlertProps:_?{type:"error",text:_}:void 0,prefillName:H==null?void 0:H.name,prefillPermissions:H==null?void 0:H.permissions},"create-role-form"):A&&w?e(Ae,{mode:"edit",role:N.find(t=>t.id===w),aclResources:F,existingRoleNames:N.map(t=>t.name),loading:x,onSubmit:Me,onCancel:he,inLineAlertProps:_?{type:"error",text:_}:void 0},`edit-role-form-${w}`):e(We,{roles:Pe,isLoading:I,canManageRoles:T,onShowCreateForm:Se,onShowEditForm:we,onDuplicateRole:Ie,onDeleteRole:ke,totalCount:j,currentPage:q,pageSize:V,onPageChange:Te,onPageSizeChange:_e,onSortChange:Ee,sortColumn:y,sortDirection:z}),e(es,{isOpen:!!k,hasUsers:k==null?void 0:k.hasUsers,onConfirm:De,onCancel:Fe})]})})};export{gs as RolesAndPermissions,gs as default};
//# sourceMappingURL=RolesAndPermissions.js.map
