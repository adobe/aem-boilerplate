/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as t,jsxs as S}from"@dropins/tools/preact-jsx-runtime.js";import{useState as h,useRef as D,useMemo as z,useCallback as d,useEffect as V}from"@dropins/tools/preact-hooks.js";import{Button as w,InLineAlert as j,Picker as Z,Modal as R}from"@dropins/tools/components.js";import{u as H,T as J}from"../chunks/useUserPermissions.js";import{C as $}from"../chunks/CompanyUserForm.js";import{classes as Q}from"@dropins/tools/lib.js";import{u as W}from"../chunks/useCustomerCompanyInfo.js";import{u as q}from"../chunks/useInLineAlert.js";import{g as X,u as Y}from"../chunks/updateCompanyUserStatus.js";import{useText as K}from"@dropins/tools/i18n.js";import{d as ee}from"../chunks/updateCompanyUser.js";import{C as ae}from"../chunks/CompanyLoaders.js";import{f as te}from"../chunks/fetchUserPermissions.js";import{u as ne}from"../chunks/useCompanyContextListener.js";import"@dropins/tools/preact.js";import"../chunks/company-permissions.js";import"@dropins/tools/preact-compat.js";import"../chunks/useCompanyRoles.js";import"../chunks/isCompanyRoleNameAvailable.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";import"../chunks/fetch-error.js";import"../chunks/getCustomerCompany.js";const se=s=>{try{return atob(s)}catch{return s}},re=s=>!s||typeof s!="string"?s:se(s),oe=(s,o)=>!s||typeof s!="string"?"":s==="ACTIVE"&&o.statusActive?o.statusActive:s==="INACTIVE"&&o.statusInactive?o.statusInactive:s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(),ie=(s,o)=>{const i=(s==null?void 0:s.trim())||"",l=(o==null?void 0:o.trim())||"";return`${i} ${l}`.trim()},le=({filterType:s,onFilterChange:o,translations:i})=>{const l=[{type:"all",label:i.showAllUsers,ariaLabel:i.showAllUsers},{type:"active",label:i.showActiveUsers,ariaLabel:i.showActiveUsers},{type:"inactive",label:i.showInactiveUsers,ariaLabel:i.showInactiveUsers}];return t("div",{className:"filterButtons",role:"group","aria-label":i.ariaFilterOptions,children:l.filter(a=>a.type!==s).map(a=>t(w,{variant:"tertiary",onClick:()=>o(a.type),"aria-label":a.ariaLabel,children:a.label},a.type))})},ce=20,G=1,me=({translations:s})=>{const[o,i]=h([]),[l,a]=h(!1),[c,v]=h(G),[g,L]=h(ce),[x,P]=h("all"),[f,m]=h(0),[p,M]=h(1),[_,k]=h(""),[T,n]=h(null),U=D(s);U.current=s;const B=z(()=>{switch(x){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[x]),C=d(async()=>{a(!0);try{const e=await X({pageSize:g,currentPage:c,filter:B});i(e.users),m(e.totalCount||e.users.length),M(e.pageInfo.totalPages),k(U.current.ariaDataLoaded.replace("{count}",e.users.length.toString()))}catch{i([]),m(0),M(1),k(U.current.ariaDataError)}finally{a(!1)}},[g,c,B]),u=d(async()=>{try{const{allowedIds:e}=await te();n(e)}catch{n(new Set)}},[]);V(()=>{C()},[C]),V(()=>{u()},[u]);const b=d(e=>{P(e),v(G)},[]),N=d(e=>{let E;if(typeof e=="string")E=e;else if("target"in e&&e.target&&"value"in e.target)E=e.target.value;else return;const A=parseInt(E,10);isNaN(A)||(L(A),v(G))},[]),F=d(()=>{c>1&&v(c-1)},[c]),r=d(()=>{c<p&&v(c+1)},[c,p]),y=(T==null?void 0:T.has("Magento_Company::users_edit"))||!1,I=d(async()=>{await u(),await C()},[u,C]);return{users:o,userPermissions:T,currentPage:c,pageSize:g,totalItems:f,totalPages:p,filterType:x,filter:B,loading:l,announcement:_,canEditUsers:y,handleFilterChange:b,handlePageSizeChange:N,handlePreviousPage:F,handleNextPage:r,refreshUsers:I}},O=s=>{const[o,i]=h(!1),[l,a]=h(null),c=d(g=>{g&&a(g),i(!0)},[]),v=d(()=>{i(!1),a(null),s==null||s()},[s]);return{isOpen:o,selectedId:l,open:c,close:v}},pe=({className:s,userId:o,userStatus:i,onClose:l,isOpen:a=!1,...c})=>{const[v,g]=h(!1),[L,x]=h(!1),{inLineAlertProps:P,showError:f,clearAlert:m}=q(),{companyInfo:p}=W(),M=D(null),_=D(null),k=`modal-title-${o}`,T=`modal-desc-${o}`,n=K({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),U=d(r=>{const y=(p==null?void 0:p.companyName)||"";return r.replace(/%1/g,y)},[p==null?void 0:p.companyName]),B=d(async()=>{if(L)return;const r=i==="ACTIVE"?"INACTIVE":"ACTIVE",y=r==="ACTIVE";x(!0),m();try{if((await Y({id:o,status:r})).success)l();else{const e=y?n.setActiveErrorSpecific:n.setInactiveErrorSpecific;f(U(e))}}catch(I){const e=I instanceof Error?I.message:y?n.setActiveErrorGeneric:n.setInactiveErrorGeneric;f(U(e))}finally{x(!1)}},[o,i,l,L,m,f,U,n.setActiveErrorSpecific,n.setInactiveErrorSpecific,n.setActiveErrorGeneric,n.setInactiveErrorGeneric]),C=d(async()=>{if(!v){g(!0),m();try{(await ee({id:o})).success?l():f(U(n.deleteErrorSpecific))}catch(r){const y=r instanceof Error?r.message:n.deleteErrorGeneric;f(U(y))}finally{g(!1)}}},[o,l,v,m,f,U,n.deleteErrorSpecific,n.deleteErrorGeneric]),u=d(()=>{m(),l()},[l,m]),b=d(r=>{if(r.key==="Escape"&&(m(),l()),r.key==="Tab"){const y=M.current;if(!y)return;const I=y.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),e=I[0],E=I[I.length-1];r.shiftKey?document.activeElement===e&&(E.focus(),r.preventDefault()):document.activeElement===E&&(e.focus(),r.preventDefault())}},[l,m]),N=d(r=>{r.target===r.currentTarget&&(m(),l())},[l,m]),F=d(()=>{m(),l()},[l,m]);return V(()=>{if(a)return _.current=document.activeElement,document.addEventListener("keydown",b),setTimeout(()=>{const r=M.current;if(r){const y=r.querySelector("button");y?y.focus():r.focus()}},100),()=>{document.removeEventListener("keydown",b)};_.current&&_.current.focus()},[a,b]),a?t("div",{className:Q(["company-management-company-users-management-modal-overlay",s]),onClick:N,...c,children:S("div",{ref:M,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":k,"aria-describedby":T,tabIndex:-1,children:[S("div",{className:"company-management-company-users-management-modal__header",children:[t("h2",{id:k,className:"company-management-company-users-management-modal__title",children:n.title}),t("button",{className:"company-management-company-users-management-modal__close",onClick:F,"aria-label":n.ariaCloseModal,children:"Ã—"})]}),S("div",{id:T,className:"company-management-company-users-management-modal__content",children:[t("p",{className:"company-management-company-users-management-modal__text",children:i==="ACTIVE"?n.setInactiveText:n.setActiveText}),t("p",{className:"company-management-company-users-management-modal__text",children:n.deleteText})]}),(P==null?void 0:P.text)&&t("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:t(j,{type:"error",heading:P.text,icon:P.icon,"data-testid":"companyUsersManagementModalAlert"})}),S("div",{className:"company-management-company-users-management-modal__actions",children:[t(w,{variant:"primary",onClick:B,disabled:L,className:"company-management-company-users-management-modal__button-primary",children:L?i==="ACTIVE"?n.settingInactiveButton:n.settingActiveButton:i==="ACTIVE"?n.setInactiveButton:n.setActiveButton}),t(w,{variant:"tertiary",onClick:C,disabled:v,className:"company-management-company-users-management-modal__button-delete",children:v?n.deletingButton:n.deleteButton}),t(w,{variant:"secondary",onClick:u,className:"company-management-company-users-management-modal__button-cancel",children:n.cancelButton})]})]})}):null},de=[{text:"20",value:"20"},{text:"30",value:"30"},{text:"50",value:"50"},{text:"100",value:"100"},{text:"200",value:"200"}],De=({children:s,className:o,...i})=>{const{permissions:l}=H(),a=K({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsText:"Company.CompanyUsers.pagination.itemsCount",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",perPageLabel:"Company.CompanyUsers.pagination.perPage",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaLoadingUsers:"Company.CompanyUsers.ariaLabels.loadingUsers",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",editUser:"Company.CompanyUsers.actions.edit",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser",ariaEditUser:"Company.CompanyUsers.ariaLabels.editUser",addNewUser:"Company.CompanyUsers.actions.addNewUser"}),{users:c,loading:v,currentPage:g,pageSize:L,filterType:x,totalItems:P,totalPages:f,announcement:m,canEditUsers:p,handleFilterChange:M,handlePageSizeChange:_,handlePreviousPage:k,handleNextPage:T,refreshUsers:n}=me({translations:{ariaDataLoaded:a.ariaDataLoaded,ariaDataError:a.ariaDataError}}),U=D(a);U.current=a;const B=d(()=>{n()},[n]);ne(B);const C=O(n),u=O(n),b=O(n),{inLineAlertProps:N,handleSetInLineAlert:F}=q(),r=z(()=>{const e=U.current;return[{key:"id",label:e.idColumn},{key:"name",label:e.nameColumn},{key:"email",label:e.emailColumn},{key:"role",label:e.roleColumn},{key:"team",label:e.teamColumn},{key:"status",label:e.statusColumn},{key:"actions",label:e.actionsColumn}]},[]),y=z(()=>c.map(e=>{const E=ie(e.firstName,e.lastName),A=U.current;return{id:re(e.id),name:E,email:e.email,role:e.role,team:e.team||A.emptyTeam,status:oe(e.status,A),actions:p?S("div",{className:"user-actions",children:[t(w,{variant:"tertiary",onClick:()=>u.open(e.id),"aria-label":A.ariaEditUser.replace("{name}",E),className:"edit-user-button",children:A.editUser}),t(w,{variant:"tertiary",onClick:()=>C.open(e.id),"aria-label":A.ariaManageUser.replace("{name}",E),className:"manage-user-button",children:A.manageUser})]}):t("span",{className:"no-actions",children:A.emptyActions})}}),[c,p,u,C]),I=z(()=>c.find(e=>e.id===C.selectedId),[c,C.selectedId]);return S("section",{className:o,...i,children:[t("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:m}),t(le,{filterType:x,onFilterChange:M,translations:{showAllUsers:a.showAllUsers,showActiveUsers:a.showActiveUsers,showInactiveUsers:a.showInactiveUsers,ariaFilterOptions:a.ariaFilterOptions}}),N&&N.text?t(j,{className:"company-users__alert",type:N.type||"success",variant:"secondary",heading:N.text,icon:N.icon}):null,t("div",{"aria-busy":v,children:v?S("div",{className:"loadingContainer",role:"status","aria-live":"polite",children:[t(ae,{testId:"companyUsersTableLoader"}),t("span",{className:"sr-only",children:a.ariaLoadingUsers})]}):t(J,{className:"companyUsersTable",columns:r,rowData:y,mobileLayout:"stacked","aria-label":a.ariaUsersTable,summary:a.ariaShowingUsers.replace("{count}",c.length.toString())})}),S("nav",{"aria-label":a.ariaPaginationNav,className:"paginationContainer",children:[t("div",{"aria-live":"polite","aria-atomic":"true",children:a.itemsText.replace("{count}",P.toString())}),f>1&&S("div",{className:"paginationButtons",role:"group","aria-label":a.ariaPageNavigation,children:[t(w,{variant:"secondary",onClick:k,disabled:g===1,"aria-label":a.ariaPreviousPageFull.replace("{current}",g.toString()),children:a.previousPage}),t("span",{"aria-current":"page","aria-live":"polite",children:a.pageInfo.replace("{current}",g.toString()).replace("{total}",f.toString())}),t(w,{variant:"secondary",onClick:T,disabled:g===f,"aria-label":a.ariaNextPageFull.replace("{current}",g.toString()),children:a.nextPage})]}),S("div",{className:"pageSizeSelector",children:[t("label",{htmlFor:"page-size-select",id:"page-size-label",children:t("span",{children:a.showLabel})}),t(Z,{id:"page-size-select",name:"pageSize",value:L.toString(),options:de,onChange:_,"aria-labelledby":"page-size-label","aria-describedby":"page-size-description"}),t("span",{id:"page-size-description",children:a.perPageLabel})]})]}),p&&t("div",{className:"addUserButtonContainer",children:t(w,{variant:"primary",onClick:()=>b.open(),"aria-label":a.addNewUser,children:a.addNewUser})}),s,b.isOpen&&p&&t(R,{open:b.isOpen,onClose:b.close,size:"medium",children:t($,{mode:"add",entityId:void 0,parentStructureId:void 0,permissions:l,onSaved:b.close,onCancel:b.close,onError:e=>{F({text:e,type:"error"})}})}),u.selectedId&&u.isOpen&&p&&t(R,{open:u.isOpen,onClose:u.close,size:"medium",children:t($,{mode:"edit",entityId:u.selectedId,parentStructureId:void 0,permissions:l,onSaved:u.close,onCancel:u.close,onError:e=>{F({text:e,type:"error"})}})}),C.selectedId&&p&&I&&t(pe,{isOpen:C.isOpen,userId:C.selectedId,userStatus:I.status||"ACTIVE",onClose:C.close})]})};export{De as CompanyUsers,De as default};
//# sourceMappingURL=CompanyUsers.js.map
