/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as t,jsxs as A,Fragment as N}from"@dropins/tools/preact-jsx-runtime.js";import{useState as T,useCallback as g,useEffect as W,useMemo as b}from"@dropins/tools/preact-compat.js";import{Card as F,Button as z,Header as V,InLineAlert as Z,Table as J,Pagination as K}from"@dropins/tools/components.js";import{Slot as Q,classes as U,VComponent as X}from"@dropins/tools/lib.js";import"@dropins/tools/preact-hooks.js";import"../chunks/RequisitionListForm.js";import{R as H}from"../chunks/RequisitionListForm2.js";import"../chunks/state.js";import{events as L}from"@dropins/tools/event-bus.js";import{u as Y,E as $}from"../chunks/RequisitionListView.js";import"@dropins/tools/preact.js";import{R as I}from"../chunks/RequisitionListActions.js";import{R as ii}from"../chunks/RequisitionListModal.js";import{D as E,P as ei}from"../chunks/PageSizePicker.js";import{useText as O}from"@dropins/tools/i18n.js";import{d as ti}from"../chunks/deleteRequisitionList.js";import{g as k}from"../chunks/getRequisitionLists.js";import"../chunks/updateRequisitionList.js";import"@dropins/tools/fetch-graphql.js";function ni(l,a){const o=O({actionDelete:"RequisitionList.RequisitionListItem.actionDelete",actionUpdate:"RequisitionList.RequisitionListItem.actionUpdate"}),[e,q]=T(null),[h,n]=T(null),[y,f]=T(!1),[P,C]=T(!1),R=g(i=>{n(i),f(!1)},[]),_=g(()=>n(null),[]),x=g(()=>{f(!0),n(null)},[]),u=g(()=>f(!1),[]),c=g(async(i,r)=>{var v,m,S;C(!0);try{const d=await k(i,r),D=((v=d==null?void 0:d.page_info)==null?void 0:v.current_page)??1,G=((m=d==null?void 0:d.page_info)==null?void 0:m.total_pages)??0;if(!((((S=d==null?void 0:d.items)==null?void 0:S.length)??0)>0)&&D>1&&G>=D-1){const B=D-1,j=await k(B,r);q(j)}else q(d)}finally{C(!1)}},[]);W(()=>{const i=L.on("requisitionLists/data",r=>{r&&r.items&&q(r)},{eager:!0});return()=>{i==null||i.off()}},[]),W(()=>{e||c(1,E)},[e,c]);const s=g(i=>{var m,S;const r=i??((m=e==null?void 0:e.page_info)==null?void 0:m.current_page)??1,v=((S=e==null?void 0:e.page_info)==null?void 0:S.page_size)??E;return c(r,v)},[c,e]),w=g(async i=>{await c(1,i)},[c]),p=b(()=>((e==null?void 0:e.items)??[]).map(i=>{const r=h===i.uid;return{name:A("div",{className:"requisition-list-grid-wrapper__name",children:[t("div",{className:"requisition-list-grid-wrapper__name__title",children:t("a",{href:"#",onClick:v=>{if(v.preventDefault(),a){const m=a(i.uid);typeof m=="string"&&(window.location.href=m)}},children:i.name})}),i.description&&t("div",{className:"requisition-list-grid-wrapper__name__description",children:i.description})]}),items_count:i.items_count,last_updated:new Date(i.updated_at).toLocaleString(),actions:A("div",{className:"requisition-list-grid-wrapper__actions",children:[t(z,{variant:"tertiary",type:"button","data-testid":"update-button",onClick:()=>R(i.uid),children:o.actionUpdate}),t(z,{variant:"tertiary",type:"button","data-testid":"delete-button",onClick:()=>l==null?void 0:l.handleOpenModal(i),children:o.actionDelete})]}),_rowDetails:r?t(F,{variant:"secondary",className:"requisition-list-grid-wrapper__form-row",children:t(H,{mode:"update",requisitionListUid:i.uid,defaultValues:{name:i.name,description:i.description},onSuccess:async()=>{await s(),L.emit("requisitionList/alert",{action:"update",type:"success",context:"requisitionList"}),n(null)},onError:()=>{L.emit("requisitionList/alert",{action:"update",type:"error",context:"requisitionList"})},onCancel:_})}):void 0}}),[e==null?void 0:e.items,h,R,_,o.actionUpdate,o.actionDelete,l,s,a]),M=b(()=>new Set(p.map((i,r)=>i._rowDetails?r:-1).filter(i=>i>=0)),[p]);return{rows:p,expandedRows:M,isLoading:P||!e,pageInfo:e==null?void 0:e.page_info,handlePageChange:s,handlePageSizeChange:w,isAdding:y,handleAddNew:x,handleCancelCreate:u}}const Ai=({routeRequisitionListDetails:l,slots:a})=>{const[o,e]=T({isOpen:!1,isLoading:!1,rl:null}),q=p=>e({isOpen:!0,isLoading:!1,rl:p}),h=()=>e({isOpen:!1,isLoading:!1,rl:null}),n=async()=>{o.rl&&(e(p=>({...p,isLoading:!0})),await ti(o.rl.uid).then(async()=>{L.emit("requisitionList/alert",{type:"success",action:"delete",context:"requisitionList"})}).catch(()=>{L.emit("requisitionList/alert",{type:"error",action:"delete",context:"requisitionList"})}).finally(async()=>{await R(),h()}))},{rows:y,expandedRows:f,isLoading:P,pageInfo:C,handlePageChange:R,handlePageSizeChange:_,isAdding:x,handleAddNew:u,handleCancelCreate:c}=ni({handleOpenModal:q},l),s=O({containerTitle:"RequisitionList.containerTitle",deleteRequisitionListTitle:"RequisitionList.RequisitionListWrapper.deleteRequisitionListTitle",deleteRequisitionListMessage:"RequisitionList.RequisitionListWrapper.deleteRequisitionListMessage",cancelAction:"RequisitionList.RequisitionListWrapper.cancelAction",confirmAction:"RequisitionList.RequisitionListWrapper.confirmAction"}),w=g(()=>a!=null&&a.Header?t(Q,{name:"Header","aria-label":s.containerTitle,title:s.containerTitle,slot:a.Header}):t(V,{"aria-label":s.containerTitle,role:"region",title:s.containerTitle}),[a,s.containerTitle]);return A(N,{children:[t(si,{header:w(),rows:y,expandedRows:f,skeletonRowCount:10,isLoading:P,pageInfo:C,handlePageChange:R,handlePageSizeChange:_,defaultPageSize:10,isAdding:x,handleAddNew:u,handleCancelCreate:c}),o.isOpen&&t(ii,{isOpen:!0,isLoading:o.isLoading,title:s.deleteRequisitionListTitle,modalContent:s.deleteRequisitionListMessage,confirmBtnCaption:s.confirmAction,closeBtnCaption:s.cancelAction,handleModalOnClose:h,handleModalOnConfirm:n})]})},si=({className:l,isLoading:a=!1,header:o,rows:e=[],expandedRows:q,skeletonRowCount:h=10,pageInfo:n,handlePageChange:y,handlePageSizeChange:f,defaultPageSize:P=10,isAdding:C,handleAddNew:R,handleCancelCreate:_,...x})=>{const u=O({name:"RequisitionList.RequisitionListWrapper.name",itemsCount:"RequisitionList.RequisitionListWrapper.itemsCount",lastUpdated:"RequisitionList.RequisitionListWrapper.lastUpdated",actions:"RequisitionList.RequisitionListWrapper.actions",emptyList:"RequisitionList.RequisitionListWrapper.emptyList"}),c=((n==null?void 0:n.total_pages)??0)>0,s=!a&&e.length===0&&!c,{alert:w,setAlert:p,handleRequisitionListAlert:M}=Y();return W(()=>{L.on("requisitionList/alert",M)},[M]),A("div",{...x,className:U(["requisition-list-grid-wrapper",l]),"data-testid":"requisition-list-grid-wrapper",children:[o&&t("div",{className:U(["requisition-list-grid-wrapper__header",l]),"data-testid":"requisition-list-grid-wrapper-header",children:t(X,{node:o})}),w&&t(N,{children:t(Z,{heading:w.description,type:w.type,variant:"primary",onDismiss:()=>p(null)})}),s?t($,{textContent:u.emptyList}):A(N,{children:[t(J,{columns:[{key:"name",label:u.name},{key:"items_count",label:u.itemsCount},{key:"last_updated",label:u.lastUpdated},{key:"actions",label:u.actions}],rowData:e,expandedRows:q,loading:a,skeletonRowCount:h}),t("div",{className:U(["requisition-list-grid-wrapper__pagination",l]),children:A("div",{className:"requisition-list-grid-wrapper__pagination-controls",children:[t(ei,{currentPageSize:(n==null?void 0:n.page_size)||P,onPageSizeChange:f||(()=>Promise.resolve()),disabled:a}),n&&n.total_pages>1&&t(K,{totalPages:n.total_pages,currentPage:n.current_page,onChange:y})]})})]}),t("div",{className:U(["requisition-list-grid-wrapper__add-new",l]),children:C?t(F,{variant:"secondary",children:t(H,{mode:"create",onSuccess:async()=>{await y(),_(),L.emit("requisitionList/alert",{type:"success",action:"create",context:"requisitionList"})},onError:()=>{L.emit("requisitionList/alert",{type:"error",action:"create",context:"requisitionList"})},onCancel:_})}):t(I,{onAddNew:R})})]})};export{Ai as RequisitionListGrid,Ai as default};
//# sourceMappingURL=RequisitionListGrid.js.map
