/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as b,jsx as i,Fragment as pe}from"@dropins/tools/preact-jsx-runtime.js";import*as d from"@dropins/tools/preact-compat.js";import{useState as A,useEffect as ie,useCallback as T}from"@dropins/tools/preact-compat.js";import{b as be,a as ke,d as ve,u as ye,g as ne,i as Ce}from"../chunks/addRequisitionListItemsToCart.js";import{Icon as Z,Button as ee,Price as me,Field as Re,Input as Se,Image as Ie,Checkbox as Pe,Table as Ae,ProgressSpinner as Ee,InLineAlert as Ne,Pagination as xe}from"@dropins/tools/components.js";import{events as Q}from"@dropins/tools/event-bus.js";import{useState as ge,useCallback as oe}from"@dropins/tools/preact-hooks.js";import{classes as he,VComponent as Te}from"@dropins/tools/lib.js";import{D as U}from"../chunks/RequisitionListForm.js";import"../chunks/state.js";import{u as Ve,E as Me}from"../chunks/RequisitionListView.js";import{h as De}from"@dropins/tools/preact.js";import{useText as se}from"@dropins/tools/i18n.js";import{R as He}from"../chunks/RequisitionListHeader.js";import{R as Be}from"../chunks/RequisitionListModal.js";import{P as ze}from"../chunks/PageSizePicker.js";import"../chunks/updateRequisitionList.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/deleteRequisitionList.js";function Fe(){const[a,S]=ge(null),[h,p]=ge(new Set),y=oe((k,I)=>{p(g=>{const v=new Set(g);return I?v.add(k):v.delete(k),v})},[]),C=oe(()=>{var I;const k=(I=a==null?void 0:a.items)==null?void 0:I.map(g=>g.uid);p(new Set(k))},[a]),E=oe(()=>{p(new Set)},[]);return{currentRequisitionList:a,setCurrentRequisitionList:S,selectedItems:h,setSelectedItems:p,handleItemSelection:y,handleSelectAll:C,handleSelectNone:E}}const $e=a=>d.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},d.createElement("g",{clipPath:"url(#clip0_102_196)"},d.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M18.3601 18.16H6.5601L4.8801 3H2.3501M19.6701 19.59C19.6701 20.3687 19.0388 21 18.2601 21C17.4814 21 16.8501 20.3687 16.8501 19.59C16.8501 18.8113 17.4814 18.18 18.2601 18.18C19.0388 18.18 19.6701 18.8113 19.6701 19.59ZM7.42986 19.59C7.42986 20.3687 6.79858 21 6.01986 21C5.24114 21 4.60986 20.3687 4.60986 19.59C4.60986 18.8113 5.24114 18.18 6.01986 18.18C6.79858 18.18 7.42986 18.8113 7.42986 19.59Z",stroke:"currentColor",strokeLinejoin:"round"}),d.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M5.25 6.37L20.89 8.06L20.14 14.8H6.19",stroke:"currentColor",strokeLinejoin:"round"})),d.createElement("defs",null,d.createElement("clipPath",{id:"clip0_102_196"},d.createElement("rect",{vectorEffect:"non-scaling-stroke",width:19.29,height:19.5,fill:"white",transform:"translate(2.3501 2.25)"})))),We=a=>d.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},d.createElement("path",{d:"M17.3332 11.75H6.6665",strokeWidth:1,strokeLinecap:"square",strokeLinejoin:"round",vectorEffect:"non-scaling-stroke",fill:"none",stroke:"currentColor"})),je=a=>d.createElement("svg",{id:"Icon_Search_Base","data-name":"Icon \\u2013 Search \\u2013 Base",xmlns:"http://www.w3.org/2000/svg",width:24,height:24,fill:"none",viewBox:"0 0 24 24",...a},d.createElement("g",{id:"Large"},d.createElement("rect",{id:"Placement_area","data-name":"Placement area",width:24,height:24,fill:"#fff",opacity:0}),d.createElement("g",{id:"Search_icon","data-name":"Search icon",transform:"translate(3.75 3.75)"},d.createElement("circle",{vectorEffect:"non-scaling-stroke",id:"Ellipse_186","data-name":"Ellipse 186",cx:6,cy:6,r:6,fill:"none",stroke:"currentColor"}),d.createElement("line",{vectorEffect:"non-scaling-stroke",id:"Line_556","data-name":"Line 556",x2:6,y2:6,transform:"translate(10.5 10.5)",fill:"none",stroke:"currentColor"})))),fe=a=>d.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",...a},d.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M1 5H23",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),d.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M17.3674 22H6.63446C5.67952 22 4.88992 21.2688 4.8379 20.3338L4 5H20L19.1621 20.3338C19.1119 21.2688 18.3223 22 17.3655 22H17.3674Z",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),d.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M9.87189 2H14.1281C14.6085 2 15 2.39766 15 2.88889V5H9V2.88889C9 2.39912 9.39006 2 9.87189 2Z",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),d.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M8.87402 8.58057L9.39348 17.682",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),d.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M14.6673 8.58057L14.146 17.682",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10})),Qe=({className:a,title:S="404 - Not Found",message:h="The requisition list you are looking for does not exist.",actionLabel:p,onAction:y,...C})=>b("div",{className:he(["not-found",a]),"data-testid":"not-found",...C,children:[i(Z,{source:je,size:"64",stroke:"2"}),i("h2",{children:S}),h&&i("p",{children:h}),p&&y&&i(ee,{variant:"primary",onClick:y,children:p})]}),Ze=({className:a,items:S,selectedItems:h,currentPage:p,pageSize:y,canEdit:C=!0,handleItemSelection:E,handleUpdateQuantity:k,onAddToCart:I,onDeleteItem:g,...v})=>{const f=se({productNameHeader:"RequisitionList.RequisitionListView.productListTable.headers.productName",skuHeader:"RequisitionList.RequisitionListView.productListTable.headers.sku",priceHeader:"RequisitionList.RequisitionListView.productListTable.headers.price",quantityHeader:"RequisitionList.RequisitionListView.productListTable.headers.quantity",subtotalHeader:"RequisitionList.RequisitionListView.productListTable.headers.subtotal",actionsHeader:"RequisitionList.RequisitionListView.productListTable.headers.actions",actionAddToCart:"RequisitionList.RequisitionListView.actionAddToCart",actionDelete:"RequisitionList.RequisitionListView.actionDelete",itemQuantity:"RequisitionList.RequisitionListView.productListTable.itemQuantity"}),z=[{label:"#",key:"index"},{label:"item",key:"item"},{label:f.priceHeader,key:"price"},{label:f.quantityHeader,key:"quantity"},{label:f.subtotalHeader,key:"subtotal"}];C&&(z.unshift({label:"",key:"selector"}),z.push({label:f.actionsHeader,key:"actions"}));const O=(e,r)=>{const l=e.target.checked;E(r.uid,l)},J=e=>(p-1)*y+e+1,H=e=>{var r,l;return((r=e.configured_product)==null?void 0:r.name)||((l=e.product)==null?void 0:l.name)||e.sku},x=e=>{var r,l,w,P;return(r=e.configured_product)!=null&&r.images?(l=e.configured_product.images[0])==null?void 0:l.url:(w=e.product)!=null&&w.images?(P=e.product.images[0])==null?void 0:P.url:""},K=e=>{var r;return((r=e.product)==null?void 0:r.name)||e.sku},te=e=>{var r;return(r=e.configured_product)==null?void 0:r.name},F=e=>e.bundle_options?e.bundle_options.map((l,w)=>b("span",{className:"requisition-list-view-product-list-table__product-configurable-name",children:[l.values[0].label," x ",l.values[0].quantity]},l.values[0].label||w)):void 0,X=e=>{var r;return((r=e.configured_product)==null?void 0:r.sku)||e.sku},B=e=>{var r,l,w,P,c,N,M,u;return Array.isArray(e.bundle_options)&&e.bundle_options.length>0?e.bundle_options.reduce((q,W)=>{var j,Y,G;return q+(((Y=(j=W.values[0])==null?void 0:j.priceV2)==null?void 0:Y.value)||0)*(((G=W.values[0])==null?void 0:G.quantity)||0)},0):((P=(w=(l=(r=e.configured_product)==null?void 0:r.price)==null?void 0:l.final)==null?void 0:w.amount)==null?void 0:P.value)||((u=(M=(N=(c=e.product)==null?void 0:c.price)==null?void 0:N.final)==null?void 0:M.amount)==null?void 0:u.value)||0},V=e=>{var r,l,w,P,c,N,M,u;return((P=(w=(l=(r=e.configured_product)==null?void 0:r.price)==null?void 0:l.final)==null?void 0:w.amount)==null?void 0:P.currency)||((u=(M=(N=(c=e.product)==null?void 0:c.price)==null?void 0:N.final)==null?void 0:M.amount)==null?void 0:u.currency)},$=e=>B(e)*e.quantity,t=S.map((e,r)=>({selector:i(Pe,{className:"requisition-list-view-product-list-table__checkbox",name:"itemSelected","data-testid":`item-checkbox-${e.sku}`,onChange:l=>O(l,e),value:e.sku,checked:h.has(e.uid)}),index:i("div",{className:"requisition-list-view-product-list-table__index-container",children:J(r)}),item:b("div",{className:"requisition-list-view-product-list-table__item-container",children:[i(Ie,{className:"requisition-list-view-product-list-table__thumbnail",alt:H(e),src:x(e)}),b("div",{className:"requisition-list-view-product-list-table__item-details",children:[i("div",{className:"requisition-list-view-product-list-table__product-name",children:K(e)}),i("span",{className:"requisition-list-view-product-list-table__product-configurable-name",children:te(e)}),i("div",{className:"requisition-list-view-product-list-table__sku",children:X(e)}),F(e)]})]}),price:i(me,{className:"requisition-list-view-product-list-table__price",amount:B(e),currency:V(e)}),quantity:i("span",{className:"requisition-list-view-product-list-table__quantity",children:i(Re,{disabled:!1,children:i(Se,{id:`requisition-list-item-quantity-${e.sku}`,"data-testid":`requisition-list-item-quantity-${e.sku}`,name:"quantity",type:"text",value:e.quantity,onBlur:l=>{const w=Number.parseInt(l.target.value,10);k(e.uid,w)}})})}),subtotal:i(me,{className:"requisition-list-view-product-list-table__price",amount:$(e),currency:V(e)}),actions:b("div",{className:"requisition-list-view__bulk-actions",children:[i(ee,{type:"button",onClick:()=>I([e.uid]),icon:i(Z,{source:$e}),"data-testid":"product-list-table-add-to-cart-button"}),i(ee,{type:"button",variant:"secondary",icon:i(Z,{source:fe}),onClick:()=>g([e.uid]),"data-testid":"product-list-table-delete-button"})]})})),m=i(Ae,{columns:z,rowData:t,"data-testid":"product-list-table",mobileLayout:"stacked"});return i(Te,{node:De("div",{}),className:he(["requisition-list-view-product-list-table-container",a]),"data-testid":"product-list-table-container",...v,children:m})},Oe=({selectedItems:a,deletingItemId:S,addingToCartItemId:h,bulkAddingToCart:p,updatingQuantityItemId:y,onSelectAll:C,onSelectNone:E,onBulkAddToCart:k,onBulkDelete:I})=>{const g=se({statusDeleting:"RequisitionList.RequisitionListView.statusDeleting",actionSelectAll:"RequisitionList.RequisitionListView.actionSelectAll",actionSelectNone:"RequisitionList.RequisitionListView.actionSelectNone",actionAddToCart:"RequisitionList.RequisitionListView.actionAddToCart",actionDeleteSelectedItems:"RequisitionList.RequisitionListView.actionDeleteSelectedItems",statusBulkAddingToCart:"RequisitionList.RequisitionListView.statusBulkAddingToCart"}),v=S!==null||h!==null||p||y!==null,f=a.size>0;return b("div",{className:"requisition-list-view__batch-actions",children:[b("div",{className:"requisition-list-view__batch-actions-left",children:[i("button",{"data-testid":"bulk-actions-select-toggle-btn",type:"button",className:`requisition-list-view__batch-actions-select-toggle ${f?"requisition-list-view__batch-actions-select-toggle--active":""}`,onClick:f?E:C,disabled:v,"aria-label":f?g.actionSelectNone:g.actionSelectAll,children:i(Z,{source:We})}),i("button",{type:"button",className:"requisition-list-view__batch-actions-select-label",onClick:f?E:C,disabled:v,children:g.actionSelectAll})]}),f&&b("div",{className:"requisition-list-view__batch-actions-buttons",children:[i("span",{className:"requisition-list-view__batch-actions-count-badge","aria-label":`${a.size} items selected`,children:a.size}),i(ee,{"data-testid":"bulk-actions-add-to-cart-btn",type:"button",variant:"secondary",onClick:k,disabled:v,children:p?g.statusBulkAddingToCart:g.actionAddToCart}),i("button",{"data-testid":"bulk-actions-delete-btn",type:"button",className:"requisition-list-view__batch-actions-delete-icon",onClick:I,disabled:v,"aria-label":g.actionDeleteSelectedItems,children:i(Z,{source:fe})})]})]})},pt=({requisitionListUid:a,skipProductLoading:S=!1,pageSize:h=U,routeRequisitionListGrid:p})=>{var ae,re,ce,le,ue;const[y,C]=A(!1),[E,k]=A(null),[I,g]=A(null),[v,f]=A(!1),[z,O]=A(null),[J,H]=A(!1),[x,K]=A(h),[te,F]=A(!0),[X,B]=A(!1),[V,$]=A([]),{currentRequisitionList:t,setCurrentRequisitionList:m,selectedItems:e,setSelectedItems:r,handleItemSelection:l,handleSelectAll:w,handleSelectNone:P}=Fe(),c=se({emptyRequisitionList:"RequisitionList.RequisitionListView.emptyRequisitionList",errorLoadingProducts:"RequisitionList.RequisitionListView.errorLoadingProducts",errorLoadPage:"RequisitionList.RequisitionListView.errorLoadPage",notFoundTitle:"RequisitionList.RequisitionListView.notFoundTitle",notFoundMessage:"RequisitionList.RequisitionListView.notFoundMessage",notFoundActionLabel:"RequisitionList.RequisitionListView.notFoundActionLabel",show:"RequisitionList.RequisitionListView.show",itemsCounter:"RequisitionList.RequisitionListView.itemsCounter",deleteItemsTitle:"RequisitionList.RequisitionListView.deleteItemsTitle",deleteItemsMessage:"RequisitionList.RequisitionListView.deleteItemsMessage",confirmAction:"RequisitionList.RequisitionListView.confirmAction",cancelAction:"RequisitionList.RequisitionListView.cancelAction"}),{alert:N,setAlert:M,handleRequisitionListAlert:u}=Ve();ie(()=>{const n=Q.on("requisitionList/data",s=>{(s==null?void 0:s.uid)===a&&(m(s),r(new Set))}),o=Q.on("requisitionList/alert",u);return()=>{n==null||n.off(),o==null||o.off()}},[u,a,m,r]),ie(()=>{K(h)},[h]);const q=T(async n=>{var s,_;const o=((s=n.items)==null?void 0:s.map(R=>R.sku))||[];if(o.length===0)return n;C(!0);try{const R=await be(o);if(R){const D=new Map;return R.forEach(L=>{D.set(L.sku,L)}),{...n,items:(_=n.items)==null?void 0:_.map(L=>({...L,product:D.get(L.sku)||L.product}))}}return console.warn("No products found"),n}catch(R){return console.warn(R instanceof Error?R.message:c.errorLoadingProducts),n}finally{C(!1)}},[c.errorLoadingProducts]);ie(()=>{if(!a){F(!1);return}if(t&&t.uid===a)return;F(!0),(async()=>{try{const o=await ne(a,1,h);if(o)if(S)m(o);else{const s=await q(o);m(s)}}catch(o){console.error("Failed to initialize requisition list from UID:",o)}finally{F(!1)}})()},[a,h,S,q,m,t]);const W=T(async n=>{n&&n.length===1?(f(!1),g(n)):(f(!0),g(null));try{const o=await ke(t.uid,n);if(o&&o.length>0){const s={action:"move",type:"error",context:"product",message:o.map(_=>_.message)};u(s),Q.emit("requisitionList/alert",s)}else{const s={action:"move",type:"success",context:"product"};u(s),Q.emit("requisitionList/alert",s)}}catch{const s={action:"move",type:"error",context:"product"};u(s),Q.emit("requisitionList/alert",s)}finally{g(null),f(!1)}},[t,u]),j=T(n=>{n&&n.length>0&&($(n),B(!0))},[]),Y=T(async()=>{V.length===1?k(V[0]):k("bulk");try{const n=await ve(t.uid,V,x,t.page_info.current_page);if(n){const o=await q(n);m(o),u({action:"delete",type:"success",context:"product"})}else u({action:"delete",type:"error",context:"product"})}catch{u({action:"delete",type:"error",context:"product"})}finally{k(null),B(!1),$([])}},[V,t,x,q,m,u]),G=T(async(n,o)=>{var s;O(n);try{const _=(s=t.items)==null?void 0:s.find(L=>L.uid===n);if(!_){u({action:"update",type:"error",context:"product"});return}const R={item_id:_.uid,entered_options:_.entered_options,selected_options:_.selected_options,quantity:o},D=await ye(t.uid,[R],x,t.page_info.current_page);if(D){const L=await q(D);m(L),u({action:"update",type:"success",context:"product"})}else u({action:"update",type:"error",context:"product"})}catch{u({action:"update",type:"error",context:"product"})}finally{O(null)}},[t,q,m,x,u]),we=T(async n=>{H(!0);try{const o=await ne(t.uid,n,x);if(o){const s=await q(o);m(s)}else console.warn(c.errorLoadPage)}catch(o){console.warn(o instanceof Error?o.message:c.errorLoadPage)}finally{H(!1)}},[t==null?void 0:t.uid,q,x,c,m]),qe=T(async n=>{K(n),H(!0);try{const o=await ne(t.uid,1,n);if(o){const s=await q(o);m(s)}else console.warn(c.errorLoadPage)}catch{console.warn(c.errorLoadPage)}finally{H(!1)}},[t==null?void 0:t.uid,q,c,m]),_e=T(async n=>{const o=await q(n);m(o)},[m,q]),Le=()=>{var L,de;const n=((L=t.page_info)==null?void 0:L.page_size)??U,o=((de=t.page_info)==null?void 0:de.current_page)??1,s=n*o,_=(t==null?void 0:t.items_count)??0,R=s-n+1,D=s>_?_:s;return i("span",{className:"requisition-list-view__pagination-items",children:c.itemsCounter.replace("{from}",R.toString()).replace("{to}",D.toString()).replace("{total}",_.toString())})};return b("div",{className:"requisition-list-view__container",children:[te?i("div",{className:"requisition-list-view__loading",children:i(Ee,{stroke:"4",size:"large"})}):!t||!Ce(t==null?void 0:t.uid)?i(Qe,{title:c.notFoundTitle,message:c.notFoundMessage,actionLabel:p?c.notFoundActionLabel:void 0,onAction:p?()=>{const n=p();n&&typeof n=="string"&&(window.location.href=n)}:void 0}):b(pe,{children:[i(He,{requisitionList:t,routeRequisitionListGrid:p,onUpdate:_e,onAlert:u}),N&&i("div",{className:"requisition-list__alert-wrapper",children:i(Ne,{heading:N.description,type:N.type,variant:"primary",onDismiss:()=>M(null)})}),t.items_count===0?i(Me,{textContent:`${t.name} ${c.emptyRequisitionList}`}):b(pe,{children:[i(Oe,{selectedItems:e,deletingItemId:E,addingToCartItemId:I,bulkAddingToCart:v,updatingQuantityItemId:z,onSelectAll:w,onSelectNone:P,onBulkAddToCart:()=>W(Array.from(e)),onBulkDelete:()=>j(Array.from(e))}),i(Ze,{items:t.items,selectedItems:e,currentPage:((ae=t.page_info)==null?void 0:ae.current_page)||1,pageSize:((re=t.page_info)==null?void 0:re.page_size)||U,handleItemSelection:l,handleUpdateQuantity:G,onAddToCart:W,onDeleteItem:j}),t.page_info&&b("div",{className:"requisition-list-view__pagination",children:[Le(),(((ce=t.page_info)==null?void 0:ce.total_pages)||0)>1&&i(xe,{totalPages:t.page_info.total_pages,currentPage:((le=t.page_info)==null?void 0:le.current_page)||1,onChange:we,disabled:J||y}),b("div",{className:"requisition-list-view__pagination-picker",children:[i("span",{children:c.show}),i(ze,{currentPageSize:((ue=t.page_info)==null?void 0:ue.page_size)||U,onPageSizeChange:qe,disabled:J||y})]})]})]})]}),X&&i(Be,{isOpen:X,isLoading:E!==null,title:c.deleteItemsTitle,modalContent:c.deleteItemsMessage,confirmBtnCaption:c.confirmAction,closeBtnCaption:c.cancelAction,handleModalOnClose:()=>{B(!1),$([])},handleModalOnConfirm:Y})]})};export{pt as RequisitionListView,pt as default};
//# sourceMappingURL=RequisitionListView.js.map
