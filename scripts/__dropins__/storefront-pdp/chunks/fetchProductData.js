/*! Copyright 2025 Adobe
All Rights Reserved. */
import{merge as ce,Initializer as fe}from"@dropins/tools/lib.js";import{events as H}from"@dropins/tools/event-bus.js";import{PRODUCT_FRAGMENT as ie}from"../fragments.js";import{FetchGraphQL as Pe}from"@dropins/tools/fetch-graphql.js";import{s as de,a as he}from"./isProductConfigurationValid.js";function je(e){const r=new URLSearchParams(window.location.search);Object.entries(e).forEach(([n,t])=>{t===null?r.delete(n):r.set(n,String(t))});let i=window.location.pathname;i+=`?${r.toString()}`,i+=window.location.hash,window.history.replaceState({},"",i)}function se(){const e=new URLSearchParams(window.location.search),r={};return e.forEach((i,n)=>{r[n]=i}),r}function ye(e=1){const i=(se()||{}).quantity;if(i){const n=parseInt(i,10);if(!isNaN(n)&&Number.isInteger(n)&&n>0)return n}return e}function ge(e){var r,i,n,t,o,s,l,a,m,u,c,f;return{productId:Number(e==null?void 0:e.externalId),name:e==null?void 0:e.name,sku:(e==null?void 0:e.variantSku)||(e==null?void 0:e.sku),topLevelSku:e==null?void 0:e.sku,specialToDate:void 0,specialFromDate:void 0,newToDate:void 0,newFromDate:void 0,createdAt:void 0,updatedAt:void 0,manufacturer:void 0,countryOfManufacture:void 0,categories:void 0,productType:e==null?void 0:e.productType,pricing:{regularPrice:((i=(r=e==null?void 0:e.prices)==null?void 0:r.regular)==null?void 0:i.amount)||0,minimalPrice:(t=(n=e==null?void 0:e.prices)==null?void 0:n.final)==null?void 0:t.minimumAmount,maximalPrice:(s=(o=e==null?void 0:e.prices)==null?void 0:o.final)==null?void 0:s.maximumAmount,specialPrice:(a=(l=e==null?void 0:e.prices)==null?void 0:l.final)==null?void 0:a.amount,tierPricing:void 0,currencyCode:((u=(m=e==null?void 0:e.prices)==null?void 0:m.final)==null?void 0:u.currency)||"USD"},canonicalUrl:e==null?void 0:e.url,mainImageUrl:(f=(c=e==null?void 0:e.images)==null?void 0:c[0])==null?void 0:f.url}}const oe={PRODUCT_CONTEXT:"productContext",CHANNEL_CONTEXT:"channelContext"},we={PRODUCT_PAGE_VIEW:"product-page-view"};function ae(){return window.adobeDataLayer=window.adobeDataLayer||[],window.adobeDataLayer}function Ce(){return{_id:"https://ns.adobe.com/xdm/channels/web",_type:"https://ns.adobe.com/xdm/channel-types/web"}}function ue(e,r){const i=ae();i.push({[e]:null}),i.push({[e]:r})}function xe(){typeof window>"u"||ue(oe.CHANNEL_CONTEXT,Ce())}function De(e,r){ae().push(n=>{const t=n.getState?n.getState():{};n.push({event:e,eventInfo:{...t,...r}})})}function Te(e){const r=ge(e);ue(oe.PRODUCT_CONTEXT,r),xe(),De(we.PRODUCT_PAGE_VIEW)}var j=(e=>(e.ComplexProduct="complex",e.SimpleProduct="simple",e))(j||{}),le=(e=>(e.ComplexProductView="ComplexProductView",e.SimpleProductView="SimpleProductView",e))(le||{});function K(e,r){var s,l,a,m,u,c,f,d,h,g,P,_;const i=((m=(a=(l=(s=e==null?void 0:e.options)==null?void 0:s[0])==null?void 0:l.values)==null?void 0:a[0])==null?void 0:m.__typename)==="ProductViewOptionValueProduct",n=be(e,i,r==null?void 0:r.preselectFirstOption),t=(e==null?void 0:e.__typename)===le.SimpleProductView?j.SimpleProduct:j.ComplexProduct,o=e?{name:e.name,sku:e.sku,isBundle:i,addToCartAllowed:e.addToCartAllowed,inStock:e.inStock,shortDescription:e.shortDescription,metaDescription:e.metaDescription,metaKeyword:e.metaKeyword,metaTitle:e.metaTitle,description:e.description,images:Oe(e),prices:ke(e,i,n),attributes:Ee(e),options:Se(e,i),optionUIDs:n,url:e.url,urlKey:e.urlKey,externalId:e.externalId,externalParentId:e.externalParentId,variantSku:e.variantSku,productType:t}:null;return ce(o,((d=(f=(c=(u=p.getConfig())==null?void 0:u.models)==null?void 0:c.ProductDetails)==null?void 0:f.transformer)==null?void 0:d.call(f,e))??((_=(P=(g=(h=p.getConfig())==null?void 0:h.models)==null?void 0:g.ProductDetails)==null?void 0:P.transform)==null?void 0:_.call(P,e)))}function Oe(e){var r,i;return(i=(r=e.images)==null?void 0:r.filter(n=>{var t;return!((t=n.roles)!=null&&t.includes("hide_from_pdp"))}))==null?void 0:i.map(n=>(n.url=n.url.replace(/^https?:/,""),n))}function Ee(e){var r,i;return(i=(r=e.attributes)==null?void 0:r.filter(({roles:n})=>(n==null?void 0:n.indexOf("visible_in_pdp"))!==-1))==null?void 0:i.map(({label:n,value:t,name:o})=>{if(o==="ac_giftcard")try{let s;typeof t=="string"?s=JSON.parse(t):typeof t=="object"&&(s=t);const l=X(s);return{id:o,label:n,value:JSON.stringify(l)}}catch{return{id:o,label:n,value:t.toString().split(",").join(", ")}}return{id:o,label:n,value:t.toString().split(",").join(", ")}})}function X(e){if(Array.isArray(e))return e.map(X);if(e!==null&&typeof e=="object"){const r={};for(const[i,n]of Object.entries(e)){let t=i;i==="validation_rule"?t="validationRule":i==="min_length"?t="minLength":i==="max_length"&&(t="maxLength"),r[t]=X(n)}return r}return e}function Se(e,r){const{options:i,optionUIDs:n}=e;return i==null?void 0:i.map(({id:t,title:o,required:s,multi:l,values:a})=>{var c;const m=(c=a==null?void 0:a[0])==null?void 0:c.__typename;let u=a==null?void 0:a[0].type;return u?u=u.replace("COLOR_HEX","color").replace("TEXT","text").replace("IMAGE","image"):u="dropdown",{id:t,type:u,typename:m,label:o,required:s,multiple:l,items:r?pe(a,n):_e(a,n,u)}})}function pe(e,r){return e==null?void 0:e.filter(({enabled:i})=>typeof i>"u"||i).map(({id:i,title:n,inStock:t,isDefault:o,product:s})=>({id:i,inStock:t,label:n,selected:(r==null?void 0:r.indexOf(i))>-1||o,value:i,product:s}))}function _e(e,r,i){return e==null?void 0:e.map(({id:n,title:t,inStock:o,value:s})=>({id:n,inStock:o,label:t,selected:(r==null?void 0:r.indexOf(n))>-1,value:(i==null?void 0:i.toLowerCase())==="dropdown"?n:s==null?void 0:s.replace(/^https?:/,"")}))}function ke(e,r,i){var P,_,B,z,J;const{price:n,priceRange:t,options:o,optionUIDs:s=i}=e;let{__typename:l}=e;function a(){var D;const C=n==null?void 0:n.regular.amount.value,y=((D=n==null?void 0:n.final)==null?void 0:D.amount.value)??(n==null?void 0:n.regular.amount.value),x=(n==null?void 0:n.regular.amount.currency)==="NONE"?"USD":n==null?void 0:n.regular.amount.currency;return[C,y,y,x]}function m(){var O,E,k,b,A,U,N,I,v,F,V,L;const C=(O=t==null?void 0:t.minimum)==null?void 0:O.final.amount.value,y=(E=t==null?void 0:t.maximum)==null?void 0:E.final.amount.value;let x;((b=(k=t==null?void 0:t.minimum)==null?void 0:k.regular)==null?void 0:b.amount.value)===((U=(A=t==null?void 0:t.maximum)==null?void 0:A.regular)==null?void 0:U.amount.value)&&(x=(I=(N=t==null?void 0:t.minimum)==null?void 0:N.regular)==null?void 0:I.amount.value);const D=((F=(v=t==null?void 0:t.minimum)==null?void 0:v.final)==null?void 0:F.amount.currency)==="NONE"?"USD":(L=(V=t==null?void 0:t.minimum)==null?void 0:V.final)==null?void 0:L.amount.currency;return[x,C,y,D]}function u(){var k,b,A,U,N,I,v,F,V,L,W,Y,Z;let C=0,y=0;o==null||o.forEach(S=>{var R;const Q=S==null?void 0:S.values;if(Q&&Array.isArray(Q)){const T=Q.map(w=>{var G,M,ee,te;return(te=(ee=(M=(G=w==null?void 0:w.product)==null?void 0:G.price)==null?void 0:M.regular)==null?void 0:ee.amount)==null?void 0:te.value}).filter(w=>w!==void 0),$=T.length>0?Math.max(...T):0;C+=$}(R=S==null?void 0:S.values)==null||R.forEach(T=>{var $,w,G,M;s!=null&&s.includes(T.id)&&(y+=(M=(G=(w=($=T==null?void 0:T.product)==null?void 0:$.price)==null?void 0:w.final)==null?void 0:G.amount)==null?void 0:M.value)})});const x=(k=t==null?void 0:t.minimum)==null?void 0:k.final.amount.value,D=(b=t==null?void 0:t.maximum)==null?void 0:b.final.amount.value;let O;((U=(A=t==null?void 0:t.minimum)==null?void 0:A.regular)==null?void 0:U.amount.value)===((I=(N=t==null?void 0:t.maximum)==null?void 0:N.regular)==null?void 0:I.amount.value)&&(O=(F=(v=t==null?void 0:t.minimum)==null?void 0:v.regular)==null?void 0:F.amount.value);const E=((L=(V=t==null?void 0:t.minimum)==null?void 0:V.final)==null?void 0:L.amount.currency)==="NONE"?"USD":(Y=(W=t==null?void 0:t.minimum)==null?void 0:W.final)==null?void 0:Y.amount.currency;return r&&(s==null?void 0:s.length)<1?[O,x,D,E]:C===((Z=t==null?void 0:t.maximum)==null?void 0:Z.regular.amount.value)?[y,y,y,E]:[O,x,D,E]}const[c,f,d,h]=l==="SimpleProductView"?a():r?u():m(),g=l==="SimpleProductView"?(P=n==null?void 0:n.roles)==null?void 0:P.includes("visible"):((B=(_=t==null?void 0:t.maximum)==null?void 0:_.roles)==null?void 0:B.includes("visible"))&&((J=(z=t==null?void 0:t.minimum)==null?void 0:z.roles)==null?void 0:J.includes("visible"));return d&&f===d?{regular:{amount:c,currency:h,variant:c&&f!==c?"strikethrough":"default"},final:{amount:d,currency:h,variant:"default"},visible:g}:{final:{minimumAmount:f,maximumAmount:d,currency:h},visible:g}}function be(e,r,i){var n;return r?((n=e==null?void 0:e.options)==null?void 0:n.map(({values:o})=>{var a;const s=((a=o==null?void 0:o.find(({isDefault:m})=>m))==null?void 0:a.id)??null,l=i?o[0].id:null;return s||l})).filter(o=>o!==null):e==null?void 0:e.optionUIDs}const q=new fe({init:async e=>{var l,a,m;const r=(a=(l=e==null?void 0:e.models)==null?void 0:l.ProductDetails)==null?void 0:a.initialData,n=((m=(se()||{}).optionsUIDs)==null?void 0:m.split(","))||(r==null?void 0:r.optionsUIDs),t=ye(1),s={...{defaultLocale:"en-US",persistURLParams:!1,acdl:!1,optionsUIDs:n},...e};if(q.config.setConfig({...s}),s!=null&&s.sku){const u=r?K(r):await re(s.sku,{preselectFirstOption:s.preselectFirstOption});H.emit("pdp/data",u,{scope:s.scope});const c={sku:s.sku,quantity:t,optionsUIDs:u==null?void 0:u.optionUIDs};de(()=>({...c}),{scope:s.scope}),he(()=>{var f;return u!=null&&u.options?u.options.length===((f=u==null?void 0:u.optionUIDs)==null?void 0:f.length):!0},{scope:s.scope}),s.acdl&&u&&Te(u)}},listeners:()=>[H.on("locale",async()=>{const{sku:e,scope:r}=q.config.getConfig();if(e){const i=await re(e);H.emit("pdp/data",i,{scope:r})}})]}),p=q.config,{setEndpoint:Xe,setFetchGraphQlHeader:qe,removeFetchGraphQlHeader:Ke,setFetchGraphQlHeaders:Be,getFetchGraphQlHeader:ze,fetchGraphQl:me,getConfig:Je}=new Pe().getMethods(),Ae=`
query GET_PRODUCT_DATA($skus: [String]) {
    products(skus: $skus) {
        ...PRODUCT_FRAGMENT
    }
}

${ie}
`,Ue=async(e,r,i)=>{var o;const{data:n}=await me(Ae,{method:"GET",variables:{skus:[e]}}),t=(o=n==null?void 0:n.products)==null?void 0:o[0];return r!=null&&r.optionsUIDs&&(t.optionUIDs=r.optionsUIDs),t?i?t:K(t,{preselectFirstOption:r==null?void 0:r.preselectFirstOption}):null},Ne=`
query REFINE_PRODUCT_QUERY(
    $optionIds: [String!]!
    $sku: String!
) {
    # Refined Product
    refineProduct(
        optionIds: $optionIds 
        sku: $sku
    ) {
        ...PRODUCT_FRAGMENT
    }

    # Parent Product
    products(skus: [$sku]) {
        ...PRODUCT_FRAGMENT
    }

    # %extendedPlaceholder%
}

${ie}
`;async function ne(e,r){const i=ve(r),n=Fe(i,e),t=Ne.replace("# %extendedPlaceholder%",n),{data:o}=await me(t,{method:"GET",variables:{optionIds:r,sku:e}});return o}const Ie=async(e,r,i,n)=>{var d,h,g;const t=await ne(e,r);if(!t)return null;let{products:o,refineProduct:s,...l}=t;const a=o==null?void 0:o[0],m=Ve(Object.values(l),a.options,i);if(i!=null&&i.length&&s===null){r=Le(m,r,i);const P=await ne(e,r);s=P==null?void 0:P.refineProduct}const u={...s||a,sku:a.sku,name:a.name,externalParentId:a==null?void 0:a.externalId,options:m,optionUIDs:r,variantSku:(s==null?void 0:s.__typename)==="SimpleProductView"?s==null?void 0:s.sku:void 0},c=n?u:K(u),f=(g=(h=(d=p==null?void 0:p.getConfig())==null?void 0:d.models)==null?void 0:h.ProductDetails)==null?void 0:g.fallbackData;return f?f(a,c):c};function ve(e){if(e.length<2)return[e];const r=[];return e.forEach(i=>{const n=[];e.forEach(t=>{i!==t&&n.push(t)}),r.push(n)}),r}function Fe(e,r){return e.map((i,n)=>`
          ProductOption${n}: refineProduct(
            optionIds: [
              ${i.map(t=>`"${t}"`).join(", ")}
            ]
            sku: "${r}"
          ) {
            ... on ComplexProductView {
              options {
                ...PRODUCT_OPTION_FRAGMENT
              }
            }
          }
        `).join("")}function Ve(e,r=[],i){const n=Object.values(e).filter(o=>!!o).reduce((o,s)=>s.options?[...o,...s.options]:[...o],[]),t=new Map(r.map(o=>[o.id,o]));return n.forEach(o=>{i!=null&&i.includes(o.id)||t.set(o.id,o)}),[...t.values()]}function Le(e,r,i){const n=[];let t;return e.forEach(o=>{var s,l,a,m;i.includes(o.id)?t=((l=(s=o.values)==null?void 0:s.find(u=>r.includes(u==null?void 0:u.id)))==null?void 0:l.id)||((a=o.values[0])==null?void 0:a.id):t=(m=o.values[0])==null?void 0:m.id,n.push(t)}),n}const re=async(e,r)=>{const{anchors:i,optionsUIDs:n}=p.getConfig(),{optionsUIDs:t=n,anchors:o=i,preselectFirstOption:s,isBundle:l,skipTransform:a}=r??{};return!l&&t?await Ie(e,t,o,a):await Ue(e,{preselectFirstOption:s,optionsUIDs:t},a)};export{qe as a,Be as b,p as c,Je as d,Ue as e,me as f,ze as g,Ie as h,q as i,re as j,ye as k,je as l,Te as p,Ke as r,Xe as s,K as t};
//# sourceMappingURL=fetchProductData.js.map
