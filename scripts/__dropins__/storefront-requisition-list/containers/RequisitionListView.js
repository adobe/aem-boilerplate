/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as b,jsx as e,Fragment as bt}from"@dropins/tools/preact-jsx-runtime.js";import*as p from"@dropins/tools/preact-compat.js";import{useState as v,useEffect as lt,useCallback as x}from"@dropins/tools/preact-compat.js";import{b as kt,a as yt,d as vt,u as Ct,g as ct,i as Rt}from"../chunks/addRequisitionListItemsToCart.js";import{Button as pt,Icon as tt,Price as Lt,Field as It,Input as St,Image as At,Checkbox as Nt,Table as Pt,ProgressSpinner as Tt,InLineAlert as Et,Pagination as xt}from"@dropins/tools/components.js";import{events as Z}from"@dropins/tools/event-bus.js";import{useState as et,useCallback as ut}from"@dropins/tools/preact-hooks.js";import{VComponent as Vt,classes as Mt}from"@dropins/tools/lib.js";import{D as dt}from"../chunks/RequisitionListForm.js";import{a as Dt,u as Ht,E as Ft}from"../chunks/RequisitionListView.js";import{h as Bt}from"@dropins/tools/preact.js";import{useText as gt}from"@dropins/tools/i18n.js";import{R as zt}from"../chunks/RequisitionListHeader.js";import"../chunks/state.js";import{R as Ot}from"../chunks/RequisitionListModal.js";import{N as qt,P as $t,a as Wt}from"../chunks/PaginationItemsCounter.js";import"../chunks/updateRequisitionList.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/deleteRequisitionList.js";const Qt=c=>p.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...c},p.createElement("g",{clipPath:"url(#clip0_102_196)"},p.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M18.3601 18.16H6.5601L4.8801 3H2.3501M19.6701 19.59C19.6701 20.3687 19.0388 21 18.2601 21C17.4814 21 16.8501 20.3687 16.8501 19.59C16.8501 18.8113 17.4814 18.18 18.2601 18.18C19.0388 18.18 19.6701 18.8113 19.6701 19.59ZM7.42986 19.59C7.42986 20.3687 6.79858 21 6.01986 21C5.24114 21 4.60986 20.3687 4.60986 19.59C4.60986 18.8113 5.24114 18.18 6.01986 18.18C6.79858 18.18 7.42986 18.8113 7.42986 19.59Z",stroke:"currentColor",strokeLinejoin:"round"}),p.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M5.25 6.37L20.89 8.06L20.14 14.8H6.19",stroke:"currentColor",strokeLinejoin:"round"})),p.createElement("defs",null,p.createElement("clipPath",{id:"clip0_102_196"},p.createElement("rect",{vectorEffect:"non-scaling-stroke",width:19.29,height:19.5,fill:"white",transform:"translate(2.3501 2.25)"})))),jt=c=>p.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...c},p.createElement("path",{d:"M17.3332 11.75H6.6665",strokeWidth:1,strokeLinecap:"square",strokeLinejoin:"round",vectorEffect:"non-scaling-stroke",fill:"none",stroke:"currentColor"})),wt=c=>p.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",...c},p.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M1 5H23",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),p.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M17.3674 22H6.63446C5.67952 22 4.88992 21.2688 4.8379 20.3338L4 5H20L19.1621 20.3338C19.1119 21.2688 18.3223 22 17.3655 22H17.3674Z",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),p.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M9.87189 2H14.1281C14.6085 2 15 2.39766 15 2.88889V5H9V2.88889C9 2.39912 9.39006 2 9.87189 2Z",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),p.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M8.87402 8.58057L9.39348 17.682",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}),p.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M14.6673 8.58057L14.146 17.682",stroke:"currentColor",strokeWidth:1,strokeMiterlimit:10}));function Zt(){const[c,N]=et(null),[L,g]=et(new Set),V=ut((q,h)=>{g(m=>{const f=new Set(m);return h?f.add(q):f.delete(q),f})},[]),C=ut(()=>{var h;const q=(h=c==null?void 0:c.items)==null?void 0:h.map(m=>m.uid);g(new Set(q))},[c]),R=ut(()=>{g(new Set)},[]);return{currentRequisitionList:c,setCurrentRequisitionList:N,selectedItems:L,setSelectedItems:g,handleItemSelection:V,handleSelectAll:C,handleSelectNone:R}}const Kt=({className:c,items:N,selectedItems:L,currentPage:g,pageSize:V,canEdit:C=!0,handleItemSelection:R,handleUpdateQuantity:q,onAddToCart:h,onDeleteItem:m,...f})=>{const[I,H]=et({}),[it,z]=et({}),S=gt({productNameHeader:"RequisitionList.RequisitionListView.productListTable.headers.productName",skuHeader:"RequisitionList.RequisitionListView.productListTable.headers.sku",priceHeader:"RequisitionList.RequisitionListView.productListTable.headers.price",quantityHeader:"RequisitionList.RequisitionListView.productListTable.headers.quantity",subtotalHeader:"RequisitionList.RequisitionListView.productListTable.headers.subtotal",actionsHeader:"RequisitionList.RequisitionListView.productListTable.headers.actions",actionAddToCart:"RequisitionList.RequisitionListView.actionAddToCart",actionDelete:"RequisitionList.RequisitionListView.actionDelete",itemQuantity:"RequisitionList.RequisitionListView.productListTable.itemQuantity",outOfStock:"RequisitionList.RequisitionListView.productListTable.outOfStock",onlyXLeftInStock:"RequisitionList.RequisitionListView.productListTable.onlyXLeftInStock"}),P=[{label:"#",key:"index"},{label:"item",key:"item"},{label:S.priceHeader,key:"price"},{label:S.quantityHeader,key:"quantity"},{label:S.subtotalHeader,key:"subtotal"}];C&&(P.unshift({label:"",key:"selector"}),P.push({label:S.actionsHeader,key:"actions"}));const T=(t,n)=>{const r=t.target.checked;R(n.uid,r)},K=t=>(g-1)*V+t+1,nt=t=>{var n,r;return((n=t.configured_product)==null?void 0:n.name)||((r=t.product)==null?void 0:r.name)||t.sku},O=t=>{var n,r,o,k,u,w;return(r=(n=t.configured_product)==null?void 0:n.images)!=null&&r.length?((o=t.configured_product.images[0])==null?void 0:o.url)||"":(u=(k=t.product)==null?void 0:k.images)!=null&&u.length&&((w=t.product.images[0])==null?void 0:w.url)||""},X=t=>{var n;return((n=t.product)==null?void 0:n.name)||t.sku},$=t=>{var n;return(n=t.configured_product)==null?void 0:n.name},F=t=>t.bundle_options?t.bundle_options.map((r,o)=>b("span",{className:"requisition-list-view-product-list-table__product-configurable-name",children:[r.values[0].label," x ",r.values[0].quantity]},r.values[0].label||o)):void 0,W=t=>{var n;return((n=t.configured_product)==null?void 0:n.sku)||t.sku},i=t=>{var n,r,o,k,u,w,E,M;return Array.isArray(t.bundle_options)&&t.bundle_options.length>0?t.bundle_options.reduce((rt,U)=>{var Y,G,Q;return rt+(((G=(Y=U.values[0])==null?void 0:Y.priceV2)==null?void 0:G.value)||0)*(((Q=U.values[0])==null?void 0:Q.quantity)||0)},0):((k=(o=(r=(n=t.configured_product)==null?void 0:n.price)==null?void 0:r.final)==null?void 0:o.amount)==null?void 0:k.value)||((M=(E=(w=(u=t.product)==null?void 0:u.price)==null?void 0:w.final)==null?void 0:E.amount)==null?void 0:M.value)||0},d=t=>{var n,r,o,k,u,w,E,M;return((k=(o=(r=(n=t.configured_product)==null?void 0:n.price)==null?void 0:r.final)==null?void 0:o.amount)==null?void 0:k.currency)||((M=(E=(w=(u=t.product)==null?void 0:u.price)==null?void 0:w.final)==null?void 0:E.amount)==null?void 0:M.currency)},B=t=>i(t)*t.quantity,J=(t,n)=>{const r=+t.target.value;r>0&&!Number.isNaN(t.target.value)&&z(o=>({...o,[n.uid]:r}))},st=async(t,n)=>{let r=+t.target.value;if(!(r>0&&r!==n.quantity)){z(o=>({...o,[n.uid]:n.quantity}));return}H(o=>({...o,[n.uid]:!0}));try{await q(n.uid,r)}finally{H(o=>({...o,[n.uid]:!1}))}},ot=N.map((t,n)=>({selector:e(Nt,{className:"requisition-list-view-product-list-table__checkbox",name:"itemSelected","data-testid":`item-checkbox-${t.sku}`,onChange:r=>T(r,t),value:t.sku,checked:L.has(t.uid)}),index:e("div",{className:"requisition-list-view-product-list-table__index-container",children:K(n)}),item:b("div",{className:"requisition-list-view-product-list-table__item-container",children:[e(At,{className:"requisition-list-view-product-list-table__thumbnail",alt:nt(t),src:O(t)}),b("div",{className:"requisition-list-view-product-list-table__item-details",children:[e("div",{className:"requisition-list-view-product-list-table__product-name",children:X(t)}),t.stock_status==="OUT_OF_STOCK"&&e("div",{className:"requisition-list-view-product-list-table__out-of-stock",children:S.outOfStock}),t.stock_status!=="OUT_OF_STOCK"&&t.only_x_left_in_stock!==null&&t.only_x_left_in_stock<t.quantity&&e("div",{className:"requisition-list-view-product-list-table__low-stock",children:S.onlyXLeftInStock.replace("{count}",String(t.only_x_left_in_stock))}),e("span",{className:"requisition-list-view-product-list-table__product-configurable-name",children:$(t)}),e("div",{className:"requisition-list-view-product-list-table__sku",children:W(t)}),F(t)]})]}),price:e(Lt,{className:"requisition-list-view-product-list-table__price",amount:i(t),currency:d(t)}),quantity:e("span",{className:"requisition-list-view-product-list-table__quantity",children:e(It,{disabled:!!I[t.uid],children:e(St,{id:`requisition-list-item-quantity-${t.sku}`,"data-testid":`requisition-list-item-quantity-${t.sku}`,name:"quantity",type:"text",value:it[t.uid]??t.quantity,onChange:r=>J(r,t),onBlur:r=>st(r,t)})})}),subtotal:e(Lt,{className:"requisition-list-view-product-list-table__price",amount:B(t),currency:d(t)}),actions:b("div",{className:"requisition-list-view__bulk-actions",children:[e(pt,{type:"button",onClick:()=>h([t.uid]),icon:e(tt,{source:Qt}),"data-testid":"product-list-table-add-to-cart-button"}),e(pt,{type:"button",variant:"secondary",icon:e(tt,{source:wt}),onClick:()=>m([t.uid]),"data-testid":"product-list-table-delete-button"})]})})),at=e(Pt,{columns:P,rowData:ot,"data-testid":"product-list-table",mobileLayout:"stacked"});return e(Vt,{node:Bt("div",{}),className:Mt(["requisition-list-view-product-list-table-container",c]),"data-testid":"product-list-table-container",...f,children:at})},Xt=({selectedItems:c,deletingItemId:N,addingToCartItemId:L,bulkAddingToCart:g,updatingQuantityItemId:V,onSelectAll:C,onSelectNone:R,onBulkAddToCart:q,onBulkDelete:h})=>{const m=gt({statusDeleting:"RequisitionList.RequisitionListView.statusDeleting",actionSelectAll:"RequisitionList.RequisitionListView.actionSelectAll",actionSelectNone:"RequisitionList.RequisitionListView.actionSelectNone",actionAddToCart:"RequisitionList.RequisitionListView.actionAddToCart",actionDeleteSelectedItems:"RequisitionList.RequisitionListView.actionDeleteSelectedItems",statusBulkAddingToCart:"RequisitionList.RequisitionListView.statusBulkAddingToCart"}),f=N!==null||L!==null||g||V!==null,I=c.size>0;return b("div",{className:"requisition-list-view__batch-actions",children:[b("div",{className:"requisition-list-view__batch-actions-left",children:[e("button",{"data-testid":"bulk-actions-select-toggle-btn",type:"button",className:`requisition-list-view__batch-actions-select-toggle ${I?"requisition-list-view__batch-actions-select-toggle--active":""}`,onClick:I?R:C,disabled:f,"aria-label":I?m.actionSelectNone:m.actionSelectAll,children:e(tt,{source:jt})}),e("button",{type:"button",className:"requisition-list-view__batch-actions-select-label",onClick:I?R:C,disabled:f,children:m.actionSelectAll})]}),I&&b("div",{className:"requisition-list-view__batch-actions-buttons",children:[e("span",{className:"requisition-list-view__batch-actions-count-badge","aria-label":`${c.size} items selected`,children:c.size}),e(pt,{"data-testid":"bulk-actions-add-to-cart-btn",type:"button",variant:"secondary",onClick:q,disabled:f,children:g?m.statusBulkAddingToCart:m.actionAddToCart}),e("button",{"data-testid":"bulk-actions-delete-btn",type:"button",className:"requisition-list-view__batch-actions-delete-icon",onClick:h,disabled:f,"aria-label":m.actionDeleteSelectedItems,children:e(tt,{source:wt})})]})]})},me=({requisitionListUid:c,skipProductLoading:N=!1,pageSize:L=dt,routeRequisitionListGrid:g,fallbackRoute:V="/customer/account"})=>{var Q,mt,ft,ht,_t;const[C,R]=v(!1),[q,h]=v(null),[m,f]=v(null),[I,H]=v(!1),[it,z]=v(null),[S,P]=v(!1),[T,K]=v(L),[nt,O]=v(!0),[X,$]=v(!1),[F,W]=v([]),{currentRequisitionList:i,setCurrentRequisitionList:d,selectedItems:B,setSelectedItems:J,handleItemSelection:st,handleSelectAll:ot,handleSelectNone:at}=Zt(),t=gt({emptyRequisitionList:"RequisitionList.RequisitionListView.emptyRequisitionList",errorLoadingProducts:"RequisitionList.RequisitionListView.errorLoadingProducts",errorLoadPage:"RequisitionList.RequisitionListView.errorLoadPage",notFoundTitle:"RequisitionList.RequisitionListView.notFoundTitle",notFoundMessage:"RequisitionList.RequisitionListView.notFoundMessage",notFoundActionLabel:"RequisitionList.RequisitionListView.notFoundActionLabel",notEnabledTitle:"RequisitionList.RequisitionListsNotEnabled.title",notEnabledMessage:"RequisitionList.RequisitionListsNotEnabled.message",notEnabledActionLabel:"RequisitionList.RequisitionListsNotEnabled.actionLabel",show:"RequisitionList.PageSizePicker.show",deleteItemsTitle:"RequisitionList.RequisitionListView.deleteItemsTitle",deleteItemsMessage:"RequisitionList.RequisitionListView.deleteItemsMessage",confirmAction:"RequisitionList.RequisitionListView.confirmAction",cancelAction:"RequisitionList.RequisitionListView.cancelAction"}),{alert:n,setAlert:r,handleRequisitionListAlert:o}=Dt(),{isEnabled:k}=Ht();lt(()=>{const s=Z.on("requisitionList/data",l=>{(l==null?void 0:l.uid)===c&&(d(l),J(new Set))}),a=Z.on("requisitionList/alert",o);return()=>{s==null||s.off(),a==null||a.off()}},[o,c,d,J]),lt(()=>{K(L)},[L]);const u=x(async s=>{var l,y;const a=((l=s.items)==null?void 0:l.map(A=>A.sku))||[];if(a.length===0)return s;R(!0);try{const A=await kt(a);if(A){const j=new Map;return A.forEach(_=>{j.set(_.sku,_)}),{...s,items:(y=s.items)==null?void 0:y.map(_=>{const D=j.get(_.sku);return{..._,product:D||_.product,stock_status:_.stock_status||(D==null?void 0:D.stock_status)||"IN_STOCK",only_x_left_in_stock:_.only_x_left_in_stock??(D==null?void 0:D.only_x_left_in_stock)??null}})}}return console.warn("No products found"),s}catch(A){return console.warn(A instanceof Error?A.message:t.errorLoadingProducts),s}finally{R(!1)}},[t.errorLoadingProducts]);lt(()=>{if(!c){O(!1);return}if(i&&i.uid===c)return;O(!0),(async()=>{try{const a=await ct(c,1,L);if(a)if(N)d(a);else{const l=await u(a);d(l)}}catch(a){console.error("Failed to initialize requisition list from UID:",a)}finally{O(!1)}})()},[c,L,N,u,d,i]);const w=x(async s=>{s&&s.length===1?(H(!1),f(s)):(H(!0),f(null));try{const a=await yt(i.uid,s);if(a&&a.length>0){const l={action:"move",type:"error",context:"product",message:a.map(y=>y.message)};o(l),Z.emit("requisitionList/alert",l)}else{const l={action:"move",type:"success",context:"product"};o(l),Z.emit("requisitionList/alert",l)}}catch{const l={action:"move",type:"error",context:"product"};o(l),Z.emit("requisitionList/alert",l)}finally{f(null),H(!1)}},[i,o]),E=x(s=>{s&&s.length>0&&(W(s),$(!0))},[]),M=x(async()=>{F.length===1?h(F[0]):h("bulk");try{const s=await vt(i.uid,F,T,i.page_info.current_page);if(s){const a=await u(s);d(a),o({action:"delete",type:"success",context:"product"})}else o({action:"delete",type:"error",context:"product"})}catch{o({action:"delete",type:"error",context:"product"})}finally{h(null),$(!1),W([])}},[F,i,T,u,d,o]),rt=x(async(s,a)=>{var l;z(s);try{const y=(l=i.items)==null?void 0:l.find(_=>_.uid===s);if(!y){o({action:"update",type:"error",context:"product"});return}const A={item_id:y.uid,entered_options:y.entered_options,selected_options:y.selected_options,quantity:a},j=await Ct(i.uid,[A],T,i.page_info.current_page);if(j){const _=await u(j);d(_),o({action:"update",type:"success",context:"product"})}else o({action:"update",type:"error",context:"product"})}catch{o({action:"update",type:"error",context:"product"})}finally{z(null)}},[i,u,d,T,o]),U=x(async s=>{P(!0);try{const a=await ct(i.uid,s,T);if(a){const l=await u(a);d(l)}else console.warn(t.errorLoadPage)}catch(a){console.warn(a instanceof Error?a.message:t.errorLoadPage)}finally{P(!1)}},[i==null?void 0:i.uid,u,T,t,d]),Y=x(async s=>{K(s),P(!0);try{const a=await ct(i.uid,1,s);if(a){const l=await u(a);d(l)}else console.warn(t.errorLoadPage)}catch{console.warn(t.errorLoadPage)}finally{P(!1)}},[i==null?void 0:i.uid,u,t,d]),G=x(async s=>{const a=await u(s);d(a)},[d,u]);return b("div",{className:"requisition-list-view__container",children:[nt?e("div",{className:"requisition-list-view__loading",children:e(Tt,{stroke:"4",size:"large"})}):k===!1?e(qt,{title:t.notEnabledTitle,message:t.notEnabledMessage,actionLabel:t.notEnabledActionLabel,onAction:()=>{window.location.href=V}}):!i||!Rt(i==null?void 0:i.uid)?e(qt,{title:t.notFoundTitle,message:t.notFoundMessage,actionLabel:g?t.notFoundActionLabel:void 0,onAction:g?()=>{const s=g();s&&typeof s=="string"&&(window.location.href=s)}:void 0}):b(bt,{children:[e(zt,{requisitionList:i,routeRequisitionListGrid:g,onUpdate:G,onAlert:o}),n&&e("div",{className:"requisition-list__alert-wrapper",children:e(Et,{heading:n.description,type:n.type,variant:"primary",onDismiss:()=>r(null)})}),i.items_count===0?e(Ft,{textContent:`${i.name} ${t.emptyRequisitionList}`}):b(bt,{children:[e(Xt,{selectedItems:B,deletingItemId:q,addingToCartItemId:m,bulkAddingToCart:I,updatingQuantityItemId:it,onSelectAll:ot,onSelectNone:at,onBulkAddToCart:()=>w(Array.from(B)),onBulkDelete:()=>E(Array.from(B))}),e(Kt,{items:i.items,selectedItems:B,currentPage:((Q=i.page_info)==null?void 0:Q.current_page)||1,pageSize:((mt=i.page_info)==null?void 0:mt.page_size)||dt,handleItemSelection:st,handleUpdateQuantity:rt,onAddToCart:w,onDeleteItem:E}),i.page_info&&b("div",{className:"requisition-list-view__pagination",children:[e($t,{pageInfo:i.page_info,totalCount:i.items_count}),(((ft=i.page_info)==null?void 0:ft.total_pages)||0)>1&&e(xt,{totalPages:i.page_info.total_pages,currentPage:((ht=i.page_info)==null?void 0:ht.current_page)||1,onChange:U,disabled:S||C}),b("div",{className:"requisition-list-view__pagination-picker",children:[e("span",{children:t.show}),e(Wt,{currentPageSize:((_t=i.page_info)==null?void 0:_t.page_size)||dt,onPageSizeChange:Y,disabled:S||C})]})]})]})]}),X&&e(Ot,{isOpen:X,isLoading:q!==null,title:t.deleteItemsTitle,modalContent:t.deleteItemsMessage,confirmBtnCaption:t.confirmAction,closeBtnCaption:t.cancelAction,handleModalOnClose:()=>{$(!1),W([])},handleModalOnConfirm:M})]})};export{me as RequisitionListView,me as default};
//# sourceMappingURL=RequisitionListView.js.map
