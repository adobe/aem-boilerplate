/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as B,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{memo as O}from"@dropins/tools/preact-compat.js";import{useState as c,useEffect as G}from"@dropins/tools/preact-hooks.js";import{Card as D,InLineAlert as H,ProgressSpinner as J,Field as b,Input as j,Picker as L,Button as M}from"@dropins/tools/components.js";import{i as K}from"./company-permissions.js";import{g as Q,c as W,u as X,i as Y}from"./updateCompanyUser.js";import{useText as $}from"@dropins/tools/i18n.js";import{u as Z}from"./useCompanyRoles.js";import{C as ee}from"./CompanyLoaders.js";function ae(A){const{mode:g,entityId:h,parentStructureId:_,onSaved:U}=A,u=$({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError"}),[r,E]=c({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[q,m]=c({}),[n,p]=c({}),[w,T]=c(!1),[y,R]=c(null),[I,S]=c(null),[v,x]=c(""),[l,a]=c(""),[i,V]=c(!1);G(()=>{g!=="edit"||!h||(T(!0),Q(h).then(e=>{var f;if(!e)return;const t=e.email||"";E(N=>({...N,firstName:e.firstName||"",lastName:e.lastName||"",email:t,jobTitle:e.jobTitle||"",telephone:e.telephone||"",status:e.status||"ACTIVE"})),a(t),(f=e==null?void 0:e.role)!=null&&f.id&&E(N=>({...N,roleId:e.role.id})),V((e==null?void 0:e.isCompanyAdmin)??!1)}).finally(()=>T(!1)))},[g,h]);const P=e=>/.+@.+\..+/.test(e),z=(e,t)=>e==="firstName"?t!=null&&t.trim()?null:u.firstNameRequired:e==="lastName"?t!=null&&t.trim()?null:u.lastNameRequired:e==="email"?t!=null&&t.trim()?P(t.trim())?null:u.emailInvalid:u.emailRequired:e==="roleId"?t?null:u.selectRole:null,F=(e,t)=>{E(f=>({...f,[e]:t})),e==="email"&&S(null),y&&R(null)};return{values:r,errors:q,touched:n,loading:w,setValue:F,onBlur:async(e,t)=>{t!==void 0&&F(e,t),p(C=>({...C,[e]:!0}));const f=t!==void 0?t:r[e],N=z(e,f);if(m(N?C=>({...C,[e]:N}):C=>{const o={...C};return delete o[e],o}),e==="email"){const o=(t!==void 0?t:r.email||"").trim();if(g==="edit"&&o.toLowerCase()===(l||"").trim().toLowerCase()){S(null);return}if(P(o)&&o!==v){const d=await Y(o);x(o),S(d),d===!1&&m(k=>({...k,email:"A user with this email address is already a member of your company."}))}}},submit:async()=>{const e=["firstName","lastName","email","roleId"],t={};for(const o of e){const d=z(o,r[o]);d&&(t[o]=d)}if(m(t),p({firstName:!0,lastName:!0,email:!0,roleId:!0}),Object.keys(t).length||I===!1){setTimeout(()=>{const o=document.querySelector(".company-user-form__content .dropin-field__hint--error");if(o){const d=o.closest(".dropin-field");if(d){d.scrollIntoView({behavior:"smooth",block:"center"});const k=d.querySelector("input, select");k&&k.focus()}}},100);return}const f=`${r.firstName||""} ${r.lastName||""}`.trim()||r.email||"",C=i||K({id:r.roleId})?"ACTIVE":r.status;try{if(g==="add"){const o=await W({email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",roleId:r.roleId,status:C,targetId:_??null});if(!o){R(u.createUserError);return}U({label:f,structureId:o.structureId,entityId:o.id,type:"user"})}else h&&(await X({id:h,email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",status:C,roleId:r.roleId}),U({label:f,entityId:h,type:"user"}))}catch(o){const d=o instanceof Error?o.message:u.saveUserError;R(d)}},isCompanyAdmin:i,generalError:y}}const pe=O(({mode:A,entityId:g,parentStructureId:h,permissions:_,onSaved:U,onCancel:u})=>{const r=(_==null?void 0:_.canEditUsers)??!1,{roles:E,isLoading:q}=Z(),{values:m,errors:n,touched:p,loading:w,setValue:T,onBlur:y,submit:R,isCompanyAdmin:I,generalError:S}=ae({mode:A,entityId:g,parentStructureId:h,onSaved:U}),[v,x]=c(!1),l=$({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator",save:"Company.CompanyStructure.shared.buttons.save",cancel:"Company.CompanyStructure.shared.buttons.cancel"});return B("div",{children:[s("h3",{className:"acm-structure-panel__title",children:A==="add"?l.addUser:l.editUser}),B(D,{variant:"secondary",className:`company-user-form__card ${v?"is-working":""}`,children:[S?s(H,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:S}):null,v?s("div",{className:"company-user-form__overlay","aria-live":"polite",children:s(J,{size:"small"})}):null,w||q?s(ee,{}):B("div",{className:"company-user-form__content",children:[s(b,{label:l.jobTitle,className:"acm-structure-panel__field",error:p.jobTitle&&n.jobTitle?n.jobTitle:void 0,children:s(j,{name:"job_title",type:"text",value:m.jobTitle||"",onBlur:a=>{const i=a.target;y("jobTitle",i.value)},variant:"primary",size:"medium"})}),s(b,{label:l.userRole,required:!0,className:"acm-structure-panel__field",error:!I&&p.roleId&&n.roleId?n.roleId:void 0,disabled:I,children:I?s(L,{name:"role",value:"MA==",options:[{value:"MA==",text:l.companyAdministrator}]}):s(L,{name:"role",value:m.roleId||"placeholder",onChange:a=>{var i,V;return T("roleId",String(((i=a==null?void 0:a.target)==null?void 0:i.value)==="placeholder"?"":((V=a==null?void 0:a.target)==null?void 0:V.value)??""))},onBlur:a=>{const i=a.target;y("roleId",i.value==="placeholder"?"":i.value)},options:[{value:"placeholder",text:l.selectRole,disabled:!0},...E.map(a=>({value:a.id,text:a.name}))]})}),s(b,{label:l.firstName,required:!0,className:"acm-structure-panel__field",error:p.firstName&&n.firstName?n.firstName:void 0,children:s(j,{name:"first_name",type:"text",value:m.firstName,onBlur:a=>{const i=a.target;y("firstName",i.value)},variant:"primary",size:"medium"})}),s(b,{label:l.lastName,required:!0,className:"acm-structure-panel__field",error:p.lastName&&n.lastName?n.lastName:void 0,children:s(j,{name:"last_name",type:"text",value:m.lastName,onBlur:a=>{const i=a.target;y("lastName",i.value)},variant:"primary",size:"medium"})}),s(b,{label:l.email,required:!0,className:"acm-structure-panel__field",error:p.email&&n.email?n.email:void 0,children:s(j,{name:"email",type:"email",value:m.email,onBlur:a=>{const i=a.target;y("email",i.value)},placeholder:"jdoe@example.com",variant:"primary",size:"medium"})}),s(b,{label:l.workPhoneNumber,className:"acm-structure-panel__field",error:p.telephone&&n.telephone?n.telephone:void 0,children:s(j,{name:"telephone",type:"text",value:m.telephone||"",onBlur:a=>{const i=a.target;y("telephone",i.value)},variant:"primary",size:"medium"})}),s(b,{label:l.status,className:"acm-structure-panel__field",disabled:I||!r,children:s(L,{name:"status",value:m.status,onChange:a=>{var i;return T("status",String(((i=a==null?void 0:a.target)==null?void 0:i.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:l.active},{value:"INACTIVE",text:l.inactive}]})})]})]}),w||q?null:B("div",{className:"acm-structure-modal__actions",children:[s(M,{type:"button",variant:"primary",disabled:v||!r,onClick:async()=>{if(!v){x(!0);try{await R()}finally{x(!1)}}},children:l.save}),s(M,{type:"button",variant:"secondary",disabled:v,onClick:u,children:l.cancel})]})]})});export{pe as C};
//# sourceMappingURL=CompanyUserForm.js.map
