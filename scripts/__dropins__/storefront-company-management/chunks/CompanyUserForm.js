/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as F,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{memo as X}from"@dropins/tools/preact-compat.js";import{useState as p,useEffect as J}from"@dropins/tools/preact-hooks.js";import{Card as K,InLineAlert as Q,ProgressSpinner as W,Field as I,Input as A,Picker as P,Button as D}from"@dropins/tools/components.js";import{i as Y}from"./company-permissions.js";import{g as Z,c as ee,a as te,i as ae}from"./updateCompanyUserStatus.js";import{useText as H}from"@dropins/tools/i18n.js";import{u as re}from"./useCompanyRoles.js";import{b as se}from"./CompanyLoaders.js";const y={firstName:255,lastName:255,email:254,jobTitle:255,telephone:20};function oe(M){const{mode:x,entityId:g,parentStructureId:E,onSaved:q,onError:b,onSuccess:v}=M,l=H({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",firstNameMaxLength:"Company.CompanyStructure.shared.validation.firstNameMaxLength",lastNameMaxLength:"Company.CompanyStructure.shared.validation.lastNameMaxLength",emailMaxLength:"Company.CompanyStructure.shared.validation.emailMaxLength",jobTitleMaxLength:"Company.CompanyStructure.shared.validation.jobTitleMaxLength",telephoneMaxLength:"Company.CompanyStructure.shared.validation.telephoneMaxLength",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError",createUserSuccess:"Company.CompanyStructure.messages.createUserSuccess",updateUserSuccess:"Company.CompanyStructure.messages.updateUserSuccess"}),[r,L]=p({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[w,d]=p({}),[m,h]=p({}),[V,U]=p(!1),[f,R]=p(null),[_,j]=p(null),[S,k]=p(""),[n,a]=p(""),[o,B]=p(!1);J(()=>{x!=="edit"||!g||(U(!0),Z(g).then(e=>{var C;if(!e)return;const t=e.email||"";L(N=>({...N,firstName:e.firstName||"",lastName:e.lastName||"",email:t,jobTitle:e.jobTitle||"",telephone:e.telephone||"",status:e.status||"ACTIVE"})),a(t),(C=e==null?void 0:e.role)!=null&&C.id&&L(N=>({...N,roleId:e.role.id})),B((e==null?void 0:e.isCompanyAdmin)??!1)}).finally(()=>U(!1)))},[x,g]);const z=e=>/.+@.+\..+/.test(e),$=(e,t)=>e==="firstName"?t!=null&&t.trim()?t.length>y.firstName?l.firstNameMaxLength:null:l.firstNameRequired:e==="lastName"?t!=null&&t.trim()?t.length>y.lastName?l.lastNameMaxLength:null:l.lastNameRequired:e==="email"?t!=null&&t.trim()?t.length>y.email?l.emailMaxLength:z(t.trim())?null:l.emailInvalid:l.emailRequired:e==="jobTitle"?t&&t.length>y.jobTitle?l.jobTitleMaxLength:null:e==="telephone"?t&&t.length>y.telephone?l.telephoneMaxLength:null:e==="roleId"?t?null:l.selectRole:null,G=(e,t)=>{L(C=>({...C,[e]:t})),e==="email"&&j(null),f&&R(null)};return{values:r,errors:w,touched:m,loading:V,setValue:G,onBlur:async(e,t)=>{t!==void 0&&G(e,t),h(T=>({...T,[e]:!0}));const C=t!==void 0?t:r[e],N=$(e,C);if(d(N?T=>({...T,[e]:N}):T=>{const u={...T};return delete u[e],u}),e==="email"){const u=(t!==void 0?t:r.email||"").trim();if(x==="edit"&&u.toLowerCase()===(n||"").trim().toLowerCase()){j(null);return}if(z(u)&&u!==S){const i=await ae(u);k(u),j(i),i===!1&&d(c=>({...c,email:"A user with this email address is already a member of your company."}))}}},submit:async()=>{const e=["firstName","lastName","email","roleId","jobTitle","telephone"],t={},C={};for(const i of e){C[i]=!0;const c=$(i,r[i]);c&&(t[i]=c)}if(d(t),h(C),Object.keys(t).length||_===!1){setTimeout(()=>{const i=document.querySelector(".company-user-form__content .dropin-field__hint--error");if(i){const c=i.closest(".dropin-field");if(c){c.scrollIntoView({behavior:"smooth",block:"center"});const O=c.querySelector("input, select");O&&O.focus()}}},100);return}const N=`${r.firstName||""} ${r.lastName||""}`.trim()||r.email||"",u=o||Y({id:r.roleId})?"ACTIVE":r.status;try{if(x==="add"){const i=await ee({email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",roleId:r.roleId,status:u,targetId:E??null});if(!i){const c=l.createUserError;b?b(c):R(c);return}q({label:N,structureId:i.structureId,entityId:i.id,type:"user",status:u,jobTitle:i.jobTitle}),v&&v(l.createUserSuccess)}else g&&(await te({id:g,email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",status:u,roleId:r.roleId}),q({label:N,entityId:g,type:"user",status:u,jobTitle:r.jobTitle}),v&&v(l.updateUserSuccess))}catch(i){const c=i instanceof Error?i.message:l.saveUserError;b?b(c):R(c)}},isCompanyAdmin:o,generalError:f}}const Ce=X(({mode:M,entityId:x,parentStructureId:g,permissions:E,onSaved:q,onCancel:b,onError:v,onSuccess:l})=>{const r=(E==null?void 0:E.canEditUsers)??!1,{roles:L,isLoading:w}=re(),{values:d,errors:m,touched:h,loading:V,setValue:U,onBlur:f,submit:R,isCompanyAdmin:_,generalError:j}=oe({mode:M,entityId:x,parentStructureId:g,onSaved:q,onError:v?a=>{v(a),b()}:void 0,onSuccess:l}),[S,k]=p(!1),n=H({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator",save:"Company.CompanyStructure.shared.buttons.save",cancel:"Company.CompanyStructure.shared.buttons.cancel"});return F("div",{children:[s("h3",{className:"acm-structure-panel__title",children:M==="add"?n.addUser:n.editUser}),F(K,{variant:"secondary",className:`company-user-form__card ${S?"is-working":""}`,children:[!v&&j?s(Q,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:j}):null,S?s("div",{className:"company-user-form__overlay","aria-live":"polite",children:s(W,{size:"small"})}):null,V||w?s(se,{}):F("div",{className:"company-user-form__content",children:[s(I,{label:n.jobTitle,className:"acm-structure-panel__field",error:h.jobTitle&&m.jobTitle?m.jobTitle:void 0,children:s(A,{name:"job_title",type:"text",value:d.jobTitle||"",onBlur:a=>{const o=a.target;f("jobTitle",o.value)},variant:"primary",size:"medium",maxLength:y.jobTitle})}),s(I,{label:n.userRole,required:!0,className:"acm-structure-panel__field",error:!_&&h.roleId&&m.roleId?m.roleId:void 0,disabled:_,children:_?s(P,{name:"role",value:"MA==",options:[{value:"MA==",text:n.companyAdministrator}]}):s(P,{name:"role",value:d.roleId||"placeholder",onChange:a=>{var o,B;return U("roleId",String(((o=a==null?void 0:a.target)==null?void 0:o.value)==="placeholder"?"":((B=a==null?void 0:a.target)==null?void 0:B.value)??""))},onBlur:a=>{const o=a.target;f("roleId",o.value==="placeholder"?"":o.value)},options:[{value:"placeholder",text:n.selectRole,disabled:!0},...L.map(a=>({value:a.id,text:a.name}))]})}),s(I,{label:n.firstName,required:!0,className:"acm-structure-panel__field",error:h.firstName&&m.firstName?m.firstName:void 0,children:s(A,{name:"first_name",type:"text",value:d.firstName,onBlur:a=>{const o=a.target;f("firstName",o.value)},variant:"primary",size:"medium",maxLength:y.firstName})}),s(I,{label:n.lastName,required:!0,className:"acm-structure-panel__field",error:h.lastName&&m.lastName?m.lastName:void 0,children:s(A,{name:"last_name",type:"text",value:d.lastName,onBlur:a=>{const o=a.target;f("lastName",o.value)},variant:"primary",size:"medium",maxLength:y.lastName})}),s(I,{label:n.email,required:!0,className:"acm-structure-panel__field",error:h.email&&m.email?m.email:void 0,children:s(A,{name:"email",type:"email",value:d.email,onBlur:a=>{const o=a.target;f("email",o.value)},placeholder:"jdoe@example.com",variant:"primary",size:"medium",maxLength:y.email})}),s(I,{label:n.workPhoneNumber,className:"acm-structure-panel__field",error:h.telephone&&m.telephone?m.telephone:void 0,children:s(A,{name:"telephone",type:"text",value:d.telephone||"",onBlur:a=>{const o=a.target;f("telephone",o.value)},variant:"primary",size:"medium",maxLength:y.telephone})}),s(I,{label:n.status,className:"acm-structure-panel__field",disabled:_||!r,children:s(P,{name:"status",value:d.status,onChange:a=>{var o;return U("status",String(((o=a==null?void 0:a.target)==null?void 0:o.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:n.active},{value:"INACTIVE",text:n.inactive}]})})]})]}),V||w?null:F("div",{className:"acm-structure-modal__actions",children:[s(D,{type:"button",variant:"primary",disabled:S||!r,onClick:async()=>{if(!S){k(!0);try{await R()}finally{k(!1)}}},children:n.save}),s(D,{type:"button",variant:"secondary",disabled:S,onClick:b,children:n.cancel})]})]})});export{Ce as C};
//# sourceMappingURL=CompanyUserForm.js.map
