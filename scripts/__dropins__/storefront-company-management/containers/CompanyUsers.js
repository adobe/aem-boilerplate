/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as r,jsxs as w}from"@dropins/tools/preact-jsx-runtime.js";import{useState as f,useRef as z,useMemo as D,useCallback as u,useEffect as V}from"@dropins/tools/preact-hooks.js";import{Button as F,InLineAlert as K,ActionButton as $,Pagination as J,Picker as Q,Modal as j}from"@dropins/tools/components.js";import{u as W,T as X}from"../chunks/useUserPermissions.js";import{C as q}from"../chunks/CompanyUserForm.js";import{classes as Y}from"@dropins/tools/lib.js";import{u as ee}from"../chunks/useCustomerCompanyInfo.js";import{u as Z}from"../chunks/useInLineAlert.js";import{g as ae,d as te}from"../chunks/getCompanyUsers.js";import{useText as H}from"@dropins/tools/i18n.js";import{u as ne}from"../chunks/updateCompanyUserStatus.js";import{f as se}from"../chunks/fetchUserPermissions.js";import{u as re}from"../chunks/useCompanyContextListener.js";import"@dropins/tools/preact.js";import"../chunks/company-permissions.js";import"@dropins/tools/preact-compat.js";import"../chunks/useCompanyRoles.js";import"../chunks/isCompanyRoleNameAvailable.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";import"../chunks/fetch-error.js";import"../chunks/CompanyLoaders.js";import"../chunks/getCustomerCompany.js";const oe=s=>{try{return atob(s)}catch{return s}},ie=s=>!s||typeof s!="string"?s:oe(s),ce=(s,l)=>!s||typeof s!="string"?"":s==="ACTIVE"&&l.statusActive?l.statusActive:s==="INACTIVE"&&l.statusInactive?l.statusInactive:s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(),le=(s,l)=>{const m=(s==null?void 0:s.trim())||"",p=(l==null?void 0:l.trim())||"";return`${m} ${p}`.trim()},me=({filterType:s,onFilterChange:l,translations:m})=>{const p=[{type:"all",label:m.showAllUsers,ariaLabel:m.showAllUsers},{type:"active",label:m.showActiveUsers,ariaLabel:m.showActiveUsers},{type:"inactive",label:m.showInactiveUsers,ariaLabel:m.showInactiveUsers}];return r("div",{className:"filterButtons",role:"group","aria-label":m.ariaFilterOptions,children:p.filter(n=>n.type!==s).map(n=>r(F,{variant:"tertiary",onClick:()=>l(n.type),"aria-label":n.ariaLabel,children:n.label},n.type))})},pe=10,G=1,de=({translations:s})=>{const[l,m]=f([]),[p,n]=f(!1),[o,U]=f(G),[g,N]=f(pe),[A,P]=f("all"),[S,b]=f(0),[c,I]=f(1),[L,x]=f(""),[v,T]=f(null),t=z(s);t.current=s;const d=D(()=>{switch(A){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[A]),y=u(async()=>{n(!0);try{const a=await ae({pageSize:g,currentPage:o,filter:d});m(a.users),b(a.totalCount||a.users.length),I(a.pageInfo.totalPages),x(t.current.ariaDataLoaded.replace("{count}",a.users.length.toString()))}catch{m([]),b(0),I(1),x(t.current.ariaDataError)}finally{n(!1)}},[g,o,d]),h=u(async()=>{try{const{allowedIds:a}=await se();T(a)}catch{T(new Set)}},[]);V(()=>{y()},[y]),V(()=>{h()},[h]);const M=u(a=>{P(a),U(G)},[]),E=u(a=>{let _;if(typeof a=="string")_=a;else if("target"in a&&a.target&&"value"in a.target)_=a.target.value;else return;const R=parseInt(_,10);isNaN(R)||(N(R),U(G))},[]),B=u(()=>{o>1&&U(o-1)},[o]),k=u(()=>{o<c&&U(o+1)},[o,c]),i=u(a=>{a>=1&&a<=c&&U(a)},[c]),e=(v==null?void 0:v.has("Magento_Company::users_edit"))||!1,C=u(async()=>{await h(),await y()},[h,y]);return{users:l,userPermissions:v,currentPage:o,pageSize:g,totalItems:S,totalPages:c,filterType:A,filter:d,loading:p,announcement:L,canEditUsers:e,handleFilterChange:M,handlePageSizeChange:E,handlePreviousPage:B,handleNextPage:k,handlePageChange:i,refreshUsers:C}},O=s=>{const[l,m]=f(!1),[p,n]=f(null),o=u(g=>{g&&n(g),m(!0)},[]),U=u(()=>{m(!1),n(null),s==null||s()},[s]);return{isOpen:l,selectedId:p,open:o,close:U}},ue=({className:s,userId:l,userStatus:m,onClose:p,isOpen:n=!1,onSuccess:o,...U})=>{const[g,N]=f(!1),[A,P]=f(!1),{inLineAlertProps:S,showError:b,clearAlert:c}=Z(),{companyInfo:I}=ee(),L=z(null),x=z(null),v=`modal-title-${l}`,T=`modal-desc-${l}`,t=H({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",setActiveSuccess:"Company.CompanyUsers.managementModal.setActiveSuccess",setInactiveSuccess:"Company.CompanyUsers.managementModal.setInactiveSuccess",deleteSuccess:"Company.CompanyUsers.managementModal.deleteSuccess",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),d=u(i=>{const e=(I==null?void 0:I.companyName)||"";return i.replace(/%1/g,e)},[I==null?void 0:I.companyName]),y=u(async()=>{if(A)return;const i=m==="ACTIVE"?"INACTIVE":"ACTIVE",e=i==="ACTIVE";P(!0),c();try{if((await ne({id:l,status:i})).success){const a=e?t.setActiveSuccess:t.setInactiveSuccess;o&&o(a),p()}else{const a=e?t.setActiveErrorSpecific:t.setInactiveErrorSpecific;b(d(a))}}catch(C){const a=C instanceof Error?C.message:e?t.setActiveErrorGeneric:t.setInactiveErrorGeneric;b(d(a))}finally{P(!1)}},[l,m,p,A,c,b,d,t.setActiveErrorSpecific,t.setInactiveErrorSpecific,t.setActiveErrorGeneric,t.setInactiveErrorGeneric,t.setActiveSuccess,t.setInactiveSuccess,o]),h=u(async()=>{if(!g){N(!0),c();try{(await te({id:l})).success?(o&&o(t.deleteSuccess),p()):b(d(t.deleteErrorSpecific))}catch(i){const e=i instanceof Error?i.message:t.deleteErrorGeneric;b(d(e))}finally{N(!1)}}},[l,p,g,c,b,d,t.deleteErrorSpecific,t.deleteErrorGeneric,t.deleteSuccess,o]),M=u(()=>{c(),p()},[p,c]),E=u(i=>{if(i.key==="Escape"&&(c(),p()),i.key==="Tab"){const e=L.current;if(!e)return;const C=e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),a=C[0],_=C[C.length-1];i.shiftKey?document.activeElement===a&&(_.focus(),i.preventDefault()):document.activeElement===_&&(a.focus(),i.preventDefault())}},[p,c]),B=u(i=>{i.target===i.currentTarget&&(c(),p())},[p,c]),k=u(()=>{c(),p()},[p,c]);return V(()=>{if(n)return x.current=document.activeElement,document.addEventListener("keydown",E),setTimeout(()=>{const i=L.current;if(i){const e=i.querySelector("button");e?e.focus():i.focus()}},100),()=>{document.removeEventListener("keydown",E)};x.current&&x.current.focus()},[n,E]),n?r("div",{className:Y(["company-management-company-users-management-modal-overlay",s]),onClick:B,...U,children:w("div",{ref:L,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":v,"aria-describedby":T,tabIndex:-1,children:[w("div",{className:"company-management-company-users-management-modal__header",children:[r("h2",{id:v,className:"company-management-company-users-management-modal__title",children:t.title}),r("button",{className:"company-management-company-users-management-modal__close",onClick:k,"aria-label":t.ariaCloseModal,children:"Ã—"})]}),w("div",{id:T,className:"company-management-company-users-management-modal__content",children:[r("p",{className:"company-management-company-users-management-modal__text",children:m==="ACTIVE"?t.setInactiveText:t.setActiveText}),r("p",{className:"company-management-company-users-management-modal__text",children:t.deleteText})]}),(S==null?void 0:S.text)&&r("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:r(K,{type:"error",heading:S.text,icon:S.icon,"data-testid":"companyUsersManagementModalAlert"})}),w("div",{className:"company-management-company-users-management-modal__actions",children:[r(F,{variant:"primary",onClick:y,disabled:A,className:"company-management-company-users-management-modal__button-primary",children:A?m==="ACTIVE"?t.settingInactiveButton:t.settingActiveButton:m==="ACTIVE"?t.setInactiveButton:t.setActiveButton}),r(F,{variant:"tertiary",onClick:h,disabled:g,className:"company-management-company-users-management-modal__button-delete",children:g?t.deletingButton:t.deleteButton}),r(F,{variant:"secondary",onClick:M,className:"company-management-company-users-management-modal__button-cancel",children:t.cancelButton})]})]})}):null},ye=[{text:"10",value:"10"},{text:"20",value:"20"},{text:"50",value:"50"},{text:"100",value:"100"}],Ge=({children:s,className:l,...m})=>{const{permissions:p}=W(),n=H({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsRange:"Company.CompanyUsers.pagination.itemsRange",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",editUser:"Company.CompanyUsers.actions.edit",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser",ariaEditUser:"Company.CompanyUsers.ariaLabels.editUser",addNewUser:"Company.CompanyUsers.actions.addNewUser",noUsersFound:"Company.CompanyUsers.noUsersFound"}),{users:o,loading:U,currentPage:g,pageSize:N,filterType:A,totalItems:P,totalPages:S,announcement:b,canEditUsers:c,handleFilterChange:I,handlePageSizeChange:L,handlePageChange:x,refreshUsers:v}=de({translations:{ariaDataLoaded:n.ariaDataLoaded,ariaDataError:n.ariaDataError}}),T=z(n);T.current=n;const t=u(()=>{v()},[v]);re(t);const d=O(v),y=O(v),h=O(v),{inLineAlertProps:M,handleSetInLineAlert:E}=Z(),B=D(()=>{const e=T.current;return[{key:"id",label:e.idColumn},{key:"name",label:e.nameColumn},{key:"email",label:e.emailColumn},{key:"role",label:e.roleColumn},{key:"team",label:e.teamColumn},{key:"status",label:e.statusColumn},{key:"actions",label:e.actionsColumn}]},[]),k=D(()=>o.map(e=>{const C=le(e.firstName,e.lastName),a=T.current;return{id:ie(e.id),name:C,email:e.email,role:e.role,team:e.team||a.emptyTeam,status:ce(e.status,a),actions:c?w("div",{className:"user-actions",children:[r($,{onClick:()=>y.open(e.id),"aria-label":a.ariaEditUser.replace("{name}",C),className:"edit-user-button",children:a.editUser}),r($,{onClick:()=>d.open(e.id),"aria-label":a.ariaManageUser.replace("{name}",C),className:"manage-user-button",children:a.manageUser})]}):r("span",{className:"no-actions",children:a.emptyActions})}}),[o,c,y,d]),i=D(()=>o.find(e=>e.id===d.selectedId),[o,d.selectedId]);return w("section",{className:l,...m,children:[r("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:b}),r(me,{filterType:A,onFilterChange:I,translations:{showAllUsers:n.showAllUsers,showActiveUsers:n.showActiveUsers,showInactiveUsers:n.showInactiveUsers,ariaFilterOptions:n.ariaFilterOptions}}),M&&M.text?r(K,{className:"company-users__alert",type:M.type||"success",variant:"secondary",heading:M.text,icon:M.icon}):null,w("div",{"aria-busy":U,children:[r(X,{className:"companyUsersTable",columns:B,rowData:k,mobileLayout:"stacked",loading:U,"aria-label":n.ariaUsersTable,summary:n.ariaShowingUsers.replace("{count}",o.length.toString())}),!U&&o.length===0&&r("div",{className:"companyUsersTable__empty",children:n.noUsersFound})]}),o.length>0&&w("nav",{"aria-label":n.ariaPaginationNav,className:"paginationContainer",children:[r("div",{"aria-live":"polite","aria-atomic":"true",children:(()=>{const e=P===0?0:(g-1)*N+1,C=Math.min(g*N,P);return n.itemsRange.replace("{start}",e.toString()).replace("{end}",C.toString()).replace("{total}",P.toString())})()}),S>1&&r(J,{currentPage:g,totalPages:S,onChange:x,className:"paginationButtons"}),w("div",{className:"pageSizeSelector",children:[r("label",{htmlFor:"page-size-select",id:"page-size-label",children:r("span",{children:n.showLabel})}),r(Q,{id:"page-size-select",name:"pageSize",value:N.toString(),options:ye,onChange:L,"aria-labelledby":"page-size-label","aria-label":n.ariaPageSizeSelector||n.itemsPerPageLabel||"Items per page"})]})]}),c&&r("div",{className:"addUserButtonContainer",children:r(F,{variant:"primary",onClick:()=>h.open(),"aria-label":n.addNewUser,children:n.addNewUser})}),s,h.isOpen&&c&&r(j,{open:h.isOpen,onClose:h.close,size:"medium",children:r(q,{mode:"add",entityId:void 0,parentStructureId:void 0,permissions:p,onSaved:h.close,onCancel:h.close,onError:e=>{E({text:e,type:"error"})},onSuccess:e=>{E({text:e,type:"success"})}})}),y.selectedId&&y.isOpen&&c&&r(j,{open:y.isOpen,onClose:y.close,size:"medium",children:r(q,{mode:"edit",entityId:y.selectedId,parentStructureId:void 0,permissions:p,onSaved:y.close,onCancel:y.close,onError:e=>{E({text:e,type:"error"})},onSuccess:e=>{E({text:e,type:"success"})}})}),d.selectedId&&c&&i&&r(ue,{isOpen:d.isOpen,userId:d.selectedId,userStatus:i.status||"ACTIVE",onClose:d.close,onSuccess:e=>{E({text:e,type:"success"})}})]})};export{Ge as CompanyUsers,Ge as default};
//# sourceMappingURL=CompanyUsers.js.map
