/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as V,jsx as e,Fragment as pe}from"@dropins/tools/preact-jsx-runtime.js";import{useState as b,useEffect as q,useRef as ce,useCallback as B}from"@dropins/tools/preact-hooks.js";import{Slot as Ie,classes as ve}from"@dropins/tools/lib.js";import{Card as re,InLineAlert as ue,ProgressSpinner as de,Field as ye,Input as Ce,Button as k,Modal as fe,IllustratedMessage as Le,Icon as Te,Header as we}from"@dropins/tools/components.js";import{f as he}from"../chunks/fetchUserPermissions.js";import{b as ge}from"../chunks/company-permissions.js";import{useText as K}from"@dropins/tools/i18n.js";import{u as Ee}from"../chunks/useCompanyContextListener.js";import{a as Ne,i as xe}from"../chunks/isCompanyUser.js";import*as Se from"@dropins/tools/preact-compat.js";import{memo as be}from"@dropins/tools/preact-compat.js";import{T as Ue}from"../chunks/Tree.js";import{C as Ae}from"../chunks/CompanyUserForm.js";import{events as se}from"@dropins/tools/event-bus.js";import{p as ie,E as le}from"../chunks/acdl.js";import{g as Ze,c as De,u as _e,a as ke,b as Ve,d as Pe}from"../chunks/updateCompanyTeam.js";import{u as He}from"../chunks/updateCompanyUserStatus.js";import{u as Fe}from"../chunks/useInLineAlert.js";import{C as Re,a as Be}from"../chunks/CompanyLoaders.js";import"../chunks/fetch-error.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/useCompanyRoles.js";import"../chunks/isCompanyRoleNameAvailable.js";const Oe=l=>Se.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...l},Se.createElement("path",{d:"M12.002 21L11.8275 21.4686C11.981 21.5257 12.1528 21.5041 12.2873 21.4106C12.4218 21.3172 12.502 21.1638 12.502 21H12.002ZM3.89502 17.9823H3.39502C3.39502 18.1912 3.52485 18.378 3.72059 18.4509L3.89502 17.9823ZM3.89502 8.06421L4.07193 7.59655C3.91831 7.53844 3.74595 7.55948 3.61082 7.65284C3.47568 7.74619 3.39502 7.89997 3.39502 8.06421H3.89502ZM12.0007 21H11.5007C11.5007 21.1638 11.5809 21.3172 11.7154 21.4106C11.8499 21.5041 12.0216 21.5257 12.1751 21.4686L12.0007 21ZM20.1076 17.9823L20.282 18.4509C20.4778 18.378 20.6076 18.1912 20.6076 17.9823H20.1076ZM20.1076 8.06421H20.6076C20.6076 7.89997 20.527 7.74619 20.3918 7.65284C20.2567 7.55948 20.0843 7.53844 19.9307 7.59655L20.1076 8.06421ZM12.0007 11.1311L11.8238 10.6634C11.6293 10.737 11.5007 10.9232 11.5007 11.1311H12.0007ZM20.2858 8.53191C20.5441 8.43421 20.6743 8.14562 20.5766 7.88734C20.4789 7.62906 20.1903 7.49889 19.932 7.5966L20.2858 8.53191ZM12.002 4.94826L12.1775 4.48008C12.0605 4.43623 11.9314 4.43775 11.8154 4.48436L12.002 4.94826ZM5.87955 6.87106C5.62334 6.97407 5.49915 7.26528 5.60217 7.52149C5.70518 7.77769 5.99639 7.90188 6.2526 7.79887L5.87955 6.87106ZM18.1932 7.80315C18.4518 7.90008 18.74 7.76904 18.8369 7.51047C18.9338 7.2519 18.8028 6.96371 18.5442 6.86678L18.1932 7.80315ZM12 4.94827L11.5879 5.23148C11.6812 5.36719 11.8353 5.44827 12 5.44827C12.1647 5.44827 12.3188 5.36719 12.4121 5.23148L12 4.94827ZM14.0263 2L14.2028 1.53218C13.9875 1.45097 13.7446 1.52717 13.6143 1.71679L14.0263 2ZM21.8421 4.94827L22.2673 5.2113C22.3459 5.08422 22.3636 4.92863 22.3154 4.78717C22.2673 4.64571 22.1584 4.53319 22.0186 4.48045L21.8421 4.94827ZM9.97368 2L10.3857 1.71679C10.2554 1.52717 10.0125 1.45097 9.79721 1.53218L9.97368 2ZM2.15789 4.94827L1.98142 4.48045C1.84161 4.53319 1.73271 4.64571 1.68456 4.78717C1.63641 4.92863 1.65406 5.08422 1.73267 5.2113L2.15789 4.94827ZM12 11.1256L11.6702 11.5014C11.8589 11.667 12.1411 11.667 12.3298 11.5014L12 11.1256ZM15.0395 8.45812L14.8732 7.98659C14.8131 8.00779 14.7576 8.04028 14.7097 8.08232L15.0395 8.45812ZM23 5.65024L23.3288 6.0269C23.5095 5.86916 23.5527 5.60532 23.4318 5.39817C23.3109 5.19102 23.0599 5.09893 22.8337 5.17871L23 5.65024ZM8.96053 8.45812L9.29034 8.08232C9.24244 8.04028 9.18695 8.00779 9.12685 7.98659L8.96053 8.45812ZM1 5.65024L1.16632 5.17871C0.940115 5.09893 0.689119 5.19102 0.568192 5.39817C0.447264 5.60532 0.49048 5.86916 0.671176 6.0269L1 5.65024ZM12.1764 20.5314L4.06945 17.5137L3.72059 18.4509L11.8275 21.4686L12.1764 20.5314ZM4.39502 17.9823V8.06421H3.39502V17.9823H4.39502ZM3.71811 8.53187L11.8251 11.5987L12.1789 10.6634L4.07193 7.59655L3.71811 8.53187ZM11.502 11.1311V21H12.502V11.1311H11.502ZM12.1751 21.4686L20.282 18.4509L19.9332 17.5137L11.8262 20.5314L12.1751 21.4686ZM20.6076 17.9823V8.06421H19.6076V17.9823H20.6076ZM19.9307 7.59655L11.8238 10.6634L12.1776 11.5987L20.2845 8.53187L19.9307 7.59655ZM11.5007 11.1311V21H12.5007V11.1311H11.5007ZM19.932 7.5966L11.8251 10.6634L12.1789 11.5987L20.2858 8.53191L19.932 7.5966ZM11.8154 4.48436L5.87955 6.87106L6.2526 7.79887L12.1885 5.41217L11.8154 4.48436ZM11.8265 5.41645L18.1932 7.80315L18.5442 6.86678L12.1775 4.48008L11.8265 5.41645ZM11.502 4.94826V11.1311H12.502V4.94826H11.502ZM12.4121 5.23148L14.4384 2.28321L13.6143 1.71679L11.5879 4.66507L12.4121 5.23148ZM13.8498 2.46782L21.6656 5.4161L22.0186 4.48045L14.2028 1.53218L13.8498 2.46782ZM21.4169 4.68525L20.5485 6.08919L21.3989 6.61524L22.2673 5.2113L21.4169 4.68525ZM12.4121 4.66507L10.3857 1.71679L9.56162 2.28321L11.5879 5.23148L12.4121 4.66507ZM9.79721 1.53218L1.98142 4.48045L2.33437 5.4161L10.1502 2.46782L9.79721 1.53218ZM1.73267 5.2113L2.60109 6.61524L3.45154 6.08919L2.58312 4.68525L1.73267 5.2113ZM12.3298 11.5014L15.3693 8.83392L14.7097 8.08232L11.6702 10.7498L12.3298 11.5014ZM15.2058 8.92965L23.1663 6.12177L22.8337 5.17871L14.8732 7.98659L15.2058 8.92965ZM22.6712 5.27358L19.7764 7.80067L20.4341 8.554L23.3288 6.0269L22.6712 5.27358ZM12.3298 10.7498L9.29034 8.08232L8.63072 8.83392L11.6702 11.5014L12.3298 10.7498ZM9.12685 7.98659L1.16632 5.17871L0.83368 6.12177L8.79421 8.92965L9.12685 7.98659ZM0.671176 6.0269L3.56591 8.554L4.22356 7.80067L1.32882 5.27358L0.671176 6.0269Z",fill:"currentColor"})),oe={name:39,description:1e3};function ze(l){const{mode:N,entityId:C,parentStructureId:p,onSaved:t,onError:M,onSuccess:o}=l,r=K({teamTitleRequired:"Company.CompanyStructure.shared.validation.teamTitleRequired",teamNameMaxLength:"Company.CompanyStructure.shared.validation.teamNameMaxLength",teamDescriptionMaxLength:"Company.CompanyStructure.shared.validation.teamDescriptionMaxLength",createTeamError:"Company.CompanyStructure.messages.createTeamError",saveTeamError:"Company.CompanyStructure.messages.saveTeamError",createTeamSuccess:"Company.CompanyStructure.messages.createTeamSuccess",updateTeamSuccess:"Company.CompanyStructure.messages.updateTeamSuccess"}),[d,m]=b({id:"",name:"",description:""}),[u,g]=b({}),[y,w]=b({}),[I,U]=b(!1),[H,P]=b(null);q(()=>{N!=="edit"||!C||(U(!0),Ze(C).then(h=>{h&&m({id:h.id,name:h.name||"",description:h.description||""})}).finally(()=>U(!1)))},[N,C]);const F=(h,S)=>h==="name"?S.trim()?S.length>oe.name?r.teamNameMaxLength:null:r.teamTitleRequired:h==="description"&&S&&S.length>oe.description?r.teamDescriptionMaxLength:null,A=(h,S)=>{m(Z=>({...Z,[h]:S})),H&&P(null)};return{values:d,errors:u,touched:y,loading:I,setValue:A,onBlur:(h,S)=>{S!==void 0&&A(h,S),w(D=>({...D,[h]:!0}));const Z=S!==void 0?S:d[h]||"",E=F(h,Z);g(E?D=>({...D,[h]:E}):D=>{const x={...D};return delete x[h],x})},submit:async()=>{const h=F("name",d.name),S=F("description",d.description||""),Z={},E={name:!0,description:!0};if(h&&(Z.name=h),S&&(Z.description=S),w(E),Object.keys(Z).length>0){g(Z);return}const D=d.name;try{if(N==="add"){const x=await De({name:d.name,description:d.description||null,targetId:p??null});if(!x){const $=r.createTeamError;M?M($):P($);return}t({label:D,structureId:x.structureId,entityId:x.id,type:"team",description:d.description||void 0}),o&&o(r.createTeamSuccess)}else C&&(await _e({id:C,name:d.name,description:d.description||null}),t({label:D,entityId:C,type:"team",description:d.description||void 0}),o&&o(r.updateTeamSuccess))}catch(x){const $=x instanceof Error?x.message:r.saveTeamError;M?M($):P($)}},generalError:H}}const Ye=be(({mode:l,entityId:N,parentStructureId:C,permissions:p,onSaved:t,onCancel:M,onError:o,onSuccess:r})=>{const d=(p==null?void 0:p.canEditUsers)??!1,{values:m,errors:u,touched:g,loading:y,onBlur:w,submit:I,generalError:U}=ze({mode:l,entityId:N,parentStructureId:C,onSaved:t,onError:o?A=>{o(A),M()}:void 0,onSuccess:r}),[H,P]=b(!1),F=K({addTeam:"Company.CompanyStructure.shared.titles.addTeam",editTeam:"Company.CompanyStructure.shared.titles.editTeam",teamTitle:"Company.CompanyStructure.shared.fields.teamTitle",description:"Company.CompanyStructure.shared.fields.description"});return V("div",{children:[e("h3",{className:"acm-structure-panel__title",children:l==="add"?F.addTeam:F.editTeam}),V(re,{variant:"secondary",className:`company-team-form__card ${H?"is-working":""}`,children:[!o&&U?e(ue,{className:"company-team-form__notification",type:"error",variant:"secondary",heading:U}):null,H?e("div",{className:"company-team-form__overlay","aria-live":"polite",children:e(de,{size:"small"})}):null,y?e(Re,{}):V("div",{className:"company-team-form__content",children:[e(ye,{label:F.teamTitle,required:!0,className:"acm-structure-panel__field",error:g.name&&u.name?u.name:void 0,children:e(Ce,{name:"team_title",type:"text",value:m.name,onBlur:A=>{const Y=A.target;w("name",Y.value)},variant:"primary",size:"medium",disabled:!d,maxLength:oe.name})}),e(ye,{label:F.description,className:"acm-structure-panel__field",error:g.description&&u.description?u.description:void 0,children:e(Ce,{name:"team_description",type:"textarea",value:m.description||"",onBlur:A=>{const Y=A.target;w("description",Y.value)},variant:"primary",size:"medium",disabled:!d,maxLength:oe.description})})]})]}),y?null:V("div",{className:"acm-structure-modal__actions",children:[e(k,{type:"button",variant:"primary",onClick:async()=>{if(!H){P(!0);try{await I()}finally{P(!1)}}},disabled:H||!d,children:"Save"}),e(k,{type:"button",variant:"secondary",disabled:H,onClick:M,children:"Cancel"})]})]})});function $e({handleSetInLineAlert:l,permissions:N}={permissions:null}){const C=(N==null?void 0:N.canViewUsers)??!1,p=K({loadError:"Company.CompanyStructure.messages.loadError",updateError:"Company.CompanyStructure.messages.updateError",failedToMoveItem:"Company.CompanyStructure.messages.failedToMoveItem",removeUserSuccess:"Company.CompanyStructure.messages.removeUserSuccess",deleteTeamSuccess:"Company.CompanyStructure.messages.deleteTeamSuccess",removeMultipleSuccess:"Company.CompanyStructure.messages.removeMultipleSuccess",moveUserSuccess:"Company.CompanyStructure.messages.moveUserSuccess",moveTeamSuccess:"Company.CompanyStructure.messages.moveTeamSuccess"}),{loadError:t,updateError:M}=p,[o,r]=b(null),[d,m]=b(!0),[u,g]=b(!1),[y,w]=b(!1),[I,U]=b(new Set),[H,P]=b(null),[F,A]=b(new Set),[Y,G]=b({}),h=ce(l),S=ce(!1),Z=ce(!1);q(()=>{h.current=l},[l]);const E=B((s,i)=>{l&&(s==="success"?l({type:"success",text:i}):s==="error"?l({type:"error",text:i}):l(),g(!1))},[l]),D=B(async()=>{if(S.current)return null;if(S.current=!0,!C)return m(!1),r(null),U(new Set),P(null),A(new Set),S.current=!1,null;m(!0);try{const i=await ke();return r(i),U(new Set(i.map(_=>_.id))),m(!1),i}catch{return m(!1),h.current&&h.current({type:"error",text:t}),null}finally{S.current=!1}},[C,t]);q(()=>{C&&!Z.current&&(Z.current=!0,D())},[C,D]),q(()=>{const s=()=>{m(!0),U(new Set),P(null),A(new Set),D()},i=se.on("companyContext/changed",s,{eager:!0});return()=>{i==null||i.off()}},[D]);const x=B(async(s,i)=>{try{if(g(!0),!await Ve({id:s,parentId:i}))return E("error",p.failedToMoveItem),!1;const L=new Map(o==null?void 0:o.map(a=>[a.id,a])).get(s),R=(L==null?void 0:L.type)==="team"?p.moveTeamSuccess:p.moveUserSuccess;return r(a=>a?a.map(c=>c.id===s?{...c,parentId:i}:c):null),U(a=>new Set([...a,i])),ie(le.EDIT_COMPANY_STRUCTURE_EVENT,{action:"move",nodeId:s,newParentId:i}),se.emit("companyStructure/updated",{message:"Structure updated",action:"move",nodeId:s,newParentId:i,nodes:o||[]}),E("success",R),!0}catch(_){const O=_ instanceof Error?_.message:M;return E("error",O),!1}finally{g(!1)}},[o,E,M,p.failedToMoveItem,p.moveUserSuccess,p.moveTeamSuccess]),$=B(()=>{o&&U(new Set(o.map(s=>s.id)))},[o]),j=B(()=>{if(o){const s=o.filter(i=>i.parentId===null).map(i=>i.id);U(new Set(s))}},[o]),X=B(s=>{r(i=>{const _=i?[...i,{id:s.id,parentId:s.parentId,label:s.label,type:s.type,entityId:s.entityId,description:s.description}]:[{id:s.id,parentId:s.parentId,label:s.label,type:s.type,entityId:s.entityId,description:s.description}];return se.emit("companyStructure/updated",{message:"Structure updated",action:"add",nodeId:s.id,newParentId:s.parentId||void 0,nodes:_}),ie(le.EDIT_COMPANY_STRUCTURE_EVENT,{action:"add",nodeId:s.id,newParentId:s.parentId||void 0,nodeType:s.type}),_}),s.parentId&&U(i=>new Set([...i,s.parentId]))},[]),W=B((s,i,_)=>{i&&r(O=>O?O.map(L=>s.includes(L.id)?{...L,label:i,description:_}:L):null)},[]),ee=B(async s=>{if(s.length)try{g(!0);const i=new Map((o||[]).map(L=>[L.id,L])),_=s.map(L=>i.get(L)).filter(Boolean);for(const L of s){const R=i.get(L);!R||!R.entityId||(R.type==="team"?await Pe(R.entityId):await He({id:R.entityId,status:"INACTIVE"}))}r(L=>{if(!L)return null;const R=new Set(s);return L.filter(a=>!R.has(a.id))}),P(null),A(new Set),ie(le.EDIT_COMPANY_STRUCTURE_EVENT,{action:"remove",nodeIds:s}),se.emit("companyStructure/updated",{message:"Structure updated",action:"remove",nodeIds:s,nodes:o||[]});let O;if(s.length===1){const L=_[0];O=(L==null?void 0:L.type)==="team"?p.deleteTeamSuccess:p.removeUserSuccess}else O=p.removeMultipleSuccess.replace("{count}",s.length.toString());E("success",O)}catch(i){const _=i instanceof Error?i.message:M;E("error",_)}finally{g(!1)}},[o,E,M,p.removeUserSuccess,p.deleteTeamSuccess,p.removeMultipleSuccess]),te=B(s=>{G(s)},[]),Q=B(()=>{w(!0),E("success",""),G({})},[E]),ae=B(s=>{s==null||s(),w(!1),G({})},[]);return{nodes:o,loading:d,submitLoading:u,showEditForm:y,inputChange:Y,expanded:I,setExpanded:U,selected:H,setSelected:P,selectedMany:F,setSelectedMany:A,move:x,expandAll:$,collapseAll:j,insertNode:X,renameNodes:W,removeNodes:ee,handleInputChange:te,handleShowEditForm:Q,handleHideEditForm:ae,renderAlertMessage:E,working:u}}const je=be(({permissions:l,slots:N})=>{var R;const C=(l==null?void 0:l.canEditUsers)??!1,p=(l==null?void 0:l.canViewUsers)??!1,t=K({expandAll:"Company.CompanyStructure.shared.buttons.expandAll",collapseAll:"Company.CompanyStructure.shared.buttons.collapseAll",addUser:"Company.CompanyStructure.shared.buttons.addUser",addTeam:"Company.CompanyStructure.shared.buttons.addTeam",editSelected:"Company.CompanyStructure.shared.buttons.editSelected",remove:"Company.CompanyStructure.shared.buttons.remove",ok:"Company.CompanyStructure.shared.buttons.ok",cancel:"Company.CompanyStructure.shared.buttons.cancel",close:"Company.CompanyStructure.shared.buttons.close",deleting:"Company.CompanyStructure.shared.buttons.deleting",removing:"Company.CompanyStructure.shared.buttons.removing",noStructureData:"Company.CompanyStructure.messages.noStructureData",processing:"Company.CompanyStructure.shared.messages.processing",cannotDeleteUser:"Company.CompanyStructure.messages.cannotDeleteUser",cannotDeleteTeam:"Company.CompanyStructure.messages.cannotDeleteTeam",removeUserConfirm:"Company.CompanyStructure.messages.removeUserConfirm",deleteTeamConfirm:"Company.CompanyStructure.messages.deleteTeamConfirm",removeItemsConfirm:"Company.CompanyStructure.messages.removeItemsConfirm",teamDescription:"Company.CompanyStructure.shared.messages.teamDescription",removeUserMessage:"Company.CompanyStructure.messages.removeUserMessage",cannotDeleteUserMessage:"Company.CompanyStructure.messages.cannotDeleteUserMessage",cannotDeleteTeamMessage:"Company.CompanyStructure.messages.cannotDeleteTeamMessage",removeItemsMessage:"Company.CompanyStructure.messages.removeItemsMessage",companyStructureActions:"Company.CompanyStructure.shared.ariaLabels.companyStructureActions",expandAllNodes:"Company.CompanyStructure.shared.ariaLabels.expandAllNodes",collapseAllNodes:"Company.CompanyStructure.shared.ariaLabels.collapseAllNodes",addUserAria:"Company.CompanyStructure.shared.ariaLabels.addUser",addTeamAria:"Company.CompanyStructure.shared.ariaLabels.addTeam",editSelectedAria:"Company.CompanyStructure.shared.ariaLabels.editSelected",removeSelectedAria:"Company.CompanyStructure.shared.ariaLabels.removeSelected",showDescription:"Company.CompanyStructure.shared.ariaLabels.showDescription",delete:"Company.CompanyStructure.shared.options.delete",expand:"Company.CompanyStructure.shared.options.expand",collapse:"Company.CompanyStructure.shared.options.collapse",deleteTeamMessage:"Company.CompanyStructure.messages.deleteTeamMessage"}),{inLineAlertProps:M,handleSetInLineAlert:o}=Fe(),{nodes:r,loading:d,submitLoading:m,expanded:u,setExpanded:g,selected:y,setSelected:w,selectedMany:I,setSelectedMany:U,move:H,expandAll:P,collapseAll:F,insertNode:A,renameNodes:Y,removeNodes:G}=$e({handleSetInLineAlert:o,permissions:l}),[h,S]=b(null),[Z,E]=b("add"),[D,x]=b(!1),[$,j]=b([]),[X,W]=b({title:"",body:"",confirmLabel:t.remove,blocked:!1}),[ee,te]=b(null),Q=()=>S(null),ae=((R=r==null?void 0:r.find(a=>a.parentId===null))==null?void 0:R.id)??null,s=(r||[]).map(a=>({id:a.id,parentId:a.parentId,label:a.label})),i=a=>{if(!r)return 0;let c=0;const f=[a],n=new Set;for(;f.length>0;){const T=f.pop();if(!T||n.has(T))continue;n.add(T);const v=r.filter(z=>z.parentId===T);c+=v.length,v.forEach(z=>f.push(z.id))}return c},_=(a,c)=>{let f=a;const n=new Map(s.map(v=>[v.id,v])),T=new Set;for(;f&&!T.has(f);){T.add(f);const v=n.get(f);if(!v)break;if(v.parentId===c)return!0;f=v.parentId??null}return!1},O=(r||[]).map(a=>({id:a.id,parentId:a.parentId,label:a.label,type:a.type,description:a.description,entityId:a.entityId})),L=V(pe,{children:[(()=>{const a=I!=null&&I.size?Array.from(I):y?[y]:[],c=C&&a.length===1,f=C&&a.length>=1;return e(re,{variant:"secondary",className:"acm-structure-toolbar-card acm-structure-toolbar-card--spaced",children:V("div",{className:"acm-structure-toolbar",role:"toolbar","aria-label":t.companyStructureActions,children:[e(k,{type:"button",variant:"secondary",onClick:P,"aria-label":t.expandAllNodes,disabled:!p,"aria-disabled":!p,children:t.expandAll}),e(k,{type:"button",variant:"secondary",onClick:F,"aria-label":t.collapseAllNodes,disabled:!p,"aria-disabled":!p,children:t.collapseAll}),e(k,{type:"button",variant:"primary",onClick:()=>{E("add"),S("user")},"aria-label":t.addUserAria,disabled:!C,"aria-disabled":!C,children:t.addUser}),e(k,{type:"button",variant:"primary",onClick:()=>{E("add"),S("team")},"aria-label":t.addTeamAria,disabled:!C,"aria-disabled":!C,children:t.addTeam}),e(k,{type:"button",variant:"primary",disabled:!c,"aria-disabled":!c,"aria-label":t.editSelectedAria,onClick:()=>{if(!c)return;const n=a,T=r==null?void 0:r.find(v=>v.id===n[0]);(T==null?void 0:T.type)==="user"?(E("edit"),S("user")):(E("edit"),S("team"))},children:t.editSelected}),e(k,{type:"button",variant:"secondary",disabled:!f||m,"aria-disabled":!f||m,"aria-label":t.removeSelectedAria,onClick:()=>{if(!f||m)return;const n=a;if(n.length===1){const T=r==null?void 0:r.find(z=>z.id===n[0]);if(!T)return;(r==null?void 0:r.some(z=>z.parentId===T.id))?(W({title:T.type==="user"?t.cannotDeleteUser:t.cannotDeleteTeam,body:T.type==="user"?t.cannotDeleteUserMessage:t.cannotDeleteTeamMessage,confirmLabel:void 0,blocked:!0}),j([]),x(!0)):(W({title:T.type==="user"?t.removeUserConfirm:t.deleteTeamConfirm,body:T.type==="user"?t.removeUserMessage:t.deleteTeamMessage,confirmLabel:T.type==="user"?t.remove:t.delete,blocked:!1}),j(n),x(!0))}else W({title:t.removeItemsConfirm.replace("{count}",n.length.toString()),body:t.removeItemsMessage,confirmLabel:t.remove,blocked:!1}),j(n),x(!0)},children:t.remove})]})})})(),h?V("div",{className:"acm-structure-panel",children:[m?V("div",{className:"acm-structure-working","aria-live":"polite",children:[e(de,{size:"small"})," ",t.processing]}):null,h==="user"?(()=>{const a=I!=null&&I.size?Array.from(I):y?[y]:[],c=a.length?r==null?void 0:r.find(n=>n.id===a[0]):void 0,f=(c==null?void 0:c.id)??ae;return e(Ae,{mode:Z,entityId:c==null?void 0:c.entityId,parentStructureId:f,permissions:l,onSaved:n=>{Z==="add"?n.structureId&&(A({id:n.structureId,parentId:f,label:n.label,type:n.type,entityId:n.entityId,description:n.jobTitle??void 0}),n.structureId&&(w(n.structureId),U(new Set([n.structureId])))):a.length&&(n.status==="INACTIVE"?G(a):Y(a,n.label,n.jobTitle??void 0)),Q()},onCancel:Q,onError:n=>{o({text:n,type:"error"})},onSuccess:n=>{o({text:n,type:"success"})}})})():null,h==="team"?(()=>{const a=I!=null&&I.size?Array.from(I):y?[y]:[],c=a.length?r==null?void 0:r.find(n=>n.id===a[0]):void 0,f=(c==null?void 0:c.id)??ae;return e(Ye,{mode:Z,entityId:c==null?void 0:c.entityId,parentStructureId:f,permissions:l,onSaved:n=>{Z==="add"?n.structureId&&(A({id:n.structureId,parentId:f,label:n.label,type:n.type,entityId:n.entityId,description:n.description}),n.structureId&&(w(n.structureId),U(new Set([n.structureId])))):a.length&&Y(a,n.label,n.description),Q()},onCancel:Q,onError:n=>{o({text:n,type:"error"})},onSuccess:n=>{o({text:n,type:"success"})}})})():null]}):null,M&&M.text?e(re,{variant:"secondary",className:"acm-structure-message-card",children:e(ue,{className:"acm-structure-panel__notification",type:M.type||"success",variant:"secondary",heading:M.text})}):null,!d&&!m&&r&&r.length===0?e(re,{variant:"secondary",className:"acm-structure-message-card",children:e(ue,{className:"acm-structure-panel__notification",type:"warning",variant:"secondary",heading:t.noStructureData})}):null,!d&&m?e("div",{className:"acm-structure-tree-overlay","aria-live":"polite",children:e(de,{size:"medium"})}):null,d?e(re,{variant:"secondary",className:"acm-structure-message-card",children:e("div",{className:"acm-structure-tree-content",children:e(Be,{rows:8})})}):null,!d&&r&&r.length>0?e("div",{className:`acm-structure-tree-card ${m?"is-working":""}`,children:e(Ue,{rootId:null,items:s,expandedIds:u,selectedId:y,selectedIds:I,onExpandedChange:g,onSelectedChange:w,onSelectedIdsChange:U,renderExpander:({expanded:a,toggle:c})=>e("button",{type:"button",className:`acm-structure-expander acm-structure-expander-button ${a?"is-open":""}`,"aria-label":a?t.collapse:t.expand,onClick:f=>{f.stopPropagation(),c()},children:e("span",{className:`acm-structure-chevron ${a?"is-expanded":""}`})}),renderNode:({item:a,hasChildren:c,expander:f,icon:n,select:T})=>{const v=r==null?void 0:r.find(J=>J.id===a.id),z=i(a.id),ne=(v==null?void 0:v.description)||"",Me=(v==null?void 0:v.type)==="team"&&ne,me=(v==null?void 0:v.parentId)===null;return V("div",{className:"acm-structure-row",onClick:T,children:[!me&&e("span",{className:"acm-structure-handle","aria-hidden":!0}),n?e("span",{onClick:J=>J.stopPropagation(),children:n()}):e("span",{className:`acm-structure-icon ${(v==null?void 0:v.type)==="team"?"is-team":"is-user"} ${me?"is-root":""}`,"aria-hidden":!0}),V("div",{className:"acm-structure-info",children:[e("span",{className:"acm-structure-label",children:a.label}),ne?e("span",{className:"acm-structure-description",children:ne}):null]}),Me?e(k,{type:"button",variant:"secondary",onClick:J=>{J.stopPropagation(),te({id:a.id,text:ne})},"aria-label":t.showDescription,className:"acm-structure-description-button",children:"?"}):null,z>0?e("span",{className:"acm-structure-count",children:z}):null,c&&f?e("span",{className:"acm-structure-expander-wrapper",onClick:J=>J.stopPropagation(),children:f()}):null]})},draggable:a=>{const c=r==null?void 0:r.find(n=>n.id===a.id),f=c?c.parentId===null:!1;return!m&&C&&!f},canDrop:(a,c)=>{if(!C||a===c)return!1;const f=r==null?void 0:r.find(n=>n.id===a);return f&&f.parentId===c?!1:!_(c,a)},onMove:async({id:a,newParentId:c})=>{C&&await H(a,c)}})}):null,D?e(fe,{open:D,onClose:()=>{m||(x(!1),j([]))},children:V("div",{className:"acm-structure-modal-content",children:[e("h3",{className:"acm-structure-modal-title",children:X.title}),e("div",{children:X.body}),e("div",{className:"acm-structure-modal-actions",children:X.blocked?e(k,{type:"button",variant:"secondary",disabled:m,onClick:()=>{m||(x(!1),j([]))},children:t.ok}):V(pe,{children:[e(k,{type:"button",variant:"secondary",disabled:m,onClick:()=>{m||(x(!1),j([]))},children:t.cancel}),e(k,{type:"button",variant:"primary",disabled:m,onClick:async()=>{await G($),x(!1),j([])},children:m?X.confirmLabel===t.delete?t.deleting:t.removing:X.confirmLabel||t.remove})]})})]})}):null,ee?e(fe,{open:!!ee,onClose:()=>te(null),children:V("div",{className:"acm-structure-modal-content",children:[e("h3",{className:"acm-structure-modal-title",children:t.teamDescription}),e("div",{children:ee.text}),e("div",{className:"acm-structure-modal-actions",children:e(k,{type:"button",variant:"secondary",onClick:()=>te(null),children:t.close})})]})}):null]});return N!=null&&N.StructureData?e(Ie,{name:"StructureData",slot:N.StructureData,context:{structureData:O,Default:L}}):L}),qe=()=>{const l=K({fetchPermissionsError:"Company.CompanyStructure.messages.fetchPermissionsError"}),[N,C]=b(null),[p,t]=b(!0),[M,o]=b(null),r=B(async()=>{var d,m;try{t(!0),o(null);const{roleResponse:u}=await he(),g=(m=(d=u==null?void 0:u.data)==null?void 0:d.customer)==null?void 0:m.role,y=ge(g);C(y)}catch(u){o(u instanceof Error?u:new Error(l.fetchPermissionsError))}finally{t(!1)}},[l.fetchPermissionsError]);return q(()=>{let d=!0;return(async()=>{var u,g;try{t(!0),o(null);const{roleResponse:y}=await he();if(!d)return;const w=(g=(u=y==null?void 0:y.data)==null?void 0:u.customer)==null?void 0:g.role,I=ge(w);C(I)}catch(y){if(!d)return;o(y instanceof Error?y:new Error(l.fetchPermissionsError))}finally{d&&t(!1)}})(),()=>{d=!1}},[]),{permissions:N,loading:p,error:M,refreshPermissions:r}},Ge="/customer/company/create",Xe=({className:l,children:N,createCompanyAccountUrl:C=Ge,...p})=>{const t=K({individualUserMessage:"Company.CustomerCompanyInfo.individualUserMessage",createAccountCta:"Company.CustomerCompanyInfo.createAccountCta"});return e(Le,{className:ve(["company-management-company-structure-empty",l]),icon:e(Te,{source:Oe}),heading:t.individualUserMessage||"You don't have a company account yet.",action:e(k,{as:"a",href:C,variant:"primary","data-testid":"company-structure-create-company-button",children:t.createAccountCta||"Create a Company Account"}),variant:"secondary","data-testid":"company-structure-empty",...p})},St=({className:l,withHeader:N=!1,slots:C,isAuthenticated:p=!1,onRedirectLogin:t,onRedirectAccount:M})=>{const o=K({containerTitle:"Company.CompanyStructure.containerTitle",noAccessTitle:"Company.CompanyStructure.noAccess.title",noAccessMessage:"Company.CompanyStructure.noAccess.message"}),{permissions:r,loading:d,refreshPermissions:m}=qe(),[u,g]=b("loading");return Ee(m),q(()=>{let y=!0;return(async()=>{try{if(!p){y&&g("redirect-login");return}if(!await Ne()){y&&(console.log("Company registration disabled - redirecting to account dashboard"),g("redirect-account"));return}await xe()?y&&g("show-structure"):y&&g("show-empty")}catch(w){console.error("Error in CompanyStructure - redirecting to login page:",w),y&&g("redirect-login")}})(),()=>{y=!1}},[p]),q(()=>{if(u!=="show-structure"&&u!=="no-access"||d||!r)return;const w=r.canViewUsers??!1?"show-structure":"no-access";u!==w&&g(w)},[u,r,d]),q(()=>{u==="redirect-login"&&t&&t(),u==="redirect-account"&&M&&M()},[u,t,M]),u==="loading"||u==="redirect-login"||u==="redirect-account"?null:u==="show-empty"?e(Xe,{className:l}):u==="no-access"?e(Le,{className:l,heading:o.noAccessTitle||"Access Restricted",message:e("p",{children:o.noAccessMessage||"You don't have permission to view the company structure. Please contact your company administrator."})}):u==="show-structure"?d||!r?null:V("div",{className:ve(["account-company-structure",l]),children:[N?e(we,{title:o.containerTitle,divider:!1,className:"company-structure__title"}):null,e(je,{slots:C,permissions:r})]}):null};export{St as CompanyStructure,St as default};
//# sourceMappingURL=CompanyStructure.js.map
