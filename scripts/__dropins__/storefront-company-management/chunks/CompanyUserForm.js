/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as F,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{memo as Z}from"@dropins/tools/preact-compat.js";import{useState as p,useEffect as J}from"@dropins/tools/preact-hooks.js";import{Card as K,InLineAlert as Q,ProgressSpinner as W,Field as T,Input as R,Picker as P,Button as H}from"@dropins/tools/components.js";import{i as Y}from"./company-permissions.js";import{g as ee,c as te,a as ae,i as re}from"./updateCompanyUserStatus.js";import{useText as X}from"@dropins/tools/i18n.js";import{u as se}from"./useCompanyRoles.js";import{b as ne}from"./CompanyLoaders.js";const h={firstName:255,lastName:255,email:254,jobTitle:255,telephone:20},z={name:/^[a-zA-ZÀ-ÿ0-9\s,\-_.'`&]+$/,telephone:/^[\d\s+\-()]+$/};function ie(M){const{mode:_,entityId:v,parentStructureId:E,onSaved:q,onError:b,onSuccess:g}=M,i=X({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",firstNameMaxLength:"Company.CompanyStructure.shared.validation.firstNameMaxLength",lastNameMaxLength:"Company.CompanyStructure.shared.validation.lastNameMaxLength",emailMaxLength:"Company.CompanyStructure.shared.validation.emailMaxLength",jobTitleMaxLength:"Company.CompanyStructure.shared.validation.jobTitleMaxLength",telephoneMaxLength:"Company.CompanyStructure.shared.validation.telephoneMaxLength",firstNameInvalidChars:"Company.CompanyStructure.shared.validation.firstNameInvalidChars",lastNameInvalidChars:"Company.CompanyStructure.shared.validation.lastNameInvalidChars",telephoneInvalidChars:"Company.CompanyStructure.shared.validation.telephoneInvalidChars",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError",createUserSuccess:"Company.CompanyStructure.messages.createUserSuccess",updateUserSuccess:"Company.CompanyStructure.messages.updateUserSuccess"}),[r,L]=p({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[w,u]=p({}),[m,y]=p({}),[V,U]=p(!1),[f,A]=p(null),[x,j]=p(null),[S,k]=p(""),[l,a]=p(""),[n,B]=p(!1);J(()=>{_!=="edit"||!v||(U(!0),ee(v).then(t=>{var C;if(!t)return;const e=t.email||"";L(N=>({...N,firstName:t.firstName||"",lastName:t.lastName||"",email:e,jobTitle:t.jobTitle||"",telephone:t.telephone||"",status:t.status||"ACTIVE"})),a(e),(C=t==null?void 0:t.role)!=null&&C.id&&L(N=>({...N,roleId:t.role.id})),B((t==null?void 0:t.isCompanyAdmin)??!1)}).finally(()=>U(!1)))},[_,v]);const $=t=>/.+@.+\..+/.test(t),O=(t,e)=>t==="firstName"?e!=null&&e.trim()?e.length>h.firstName?i.firstNameMaxLength:z.name.test(e)?null:i.firstNameInvalidChars:i.firstNameRequired:t==="lastName"?e!=null&&e.trim()?e.length>h.lastName?i.lastNameMaxLength:z.name.test(e)?null:i.lastNameInvalidChars:i.lastNameRequired:t==="email"?e!=null&&e.trim()?e.length>h.email?i.emailMaxLength:$(e.trim())?null:i.emailInvalid:i.emailRequired:t==="jobTitle"?e&&e.length>h.jobTitle?i.jobTitleMaxLength:null:t==="telephone"?e&&e.length>h.telephone?i.telephoneMaxLength:e&&e.trim()&&!z.telephone.test(e)?i.telephoneInvalidChars:null:t==="roleId"?e?null:i.selectRole:null,D=(t,e)=>{L(C=>({...C,[t]:e})),t==="email"&&j(null),f&&A(null)};return{values:r,errors:w,touched:m,loading:V,setValue:D,onBlur:async(t,e)=>{e!==void 0&&D(t,e),y(I=>({...I,[t]:!0}));const C=e!==void 0?e:r[t],N=O(t,C);if(u(N?I=>({...I,[t]:N}):I=>{const c={...I};return delete c[t],c}),t==="email"){const c=(e!==void 0?e:r.email||"").trim();if(_==="edit"&&c.toLowerCase()===(l||"").trim().toLowerCase()){j(null);return}if($(c)&&c!==S){const o=await re(c);k(c),j(o),o===!1&&u(d=>({...d,email:"A user with this email address is already a member of your company."}))}}},submit:async()=>{const t=["firstName","lastName","email","roleId","jobTitle","telephone"],e={},C={};for(const o of t){C[o]=!0;const d=O(o,r[o]);d&&(e[o]=d)}if(u(e),y(C),Object.keys(e).length||x===!1){setTimeout(()=>{const o=document.querySelector(".company-user-form__content .dropin-field__hint--error");if(o){const d=o.closest(".dropin-field");if(d){d.scrollIntoView({behavior:"smooth",block:"center"});const G=d.querySelector("input, select");G&&G.focus()}}},100);return}const N=`${r.firstName||""} ${r.lastName||""}`.trim()||r.email||"",c=n||Y({id:r.roleId})?"ACTIVE":r.status;try{if(_==="add"){const o=await te({email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",roleId:r.roleId,status:c,targetId:E??null});if(!o){const d=i.createUserError;b?b(d):A(d);return}q({label:N,structureId:o.structureId,entityId:o.id,type:"user",status:c,jobTitle:o.jobTitle}),g&&g(i.createUserSuccess)}else v&&(await ae({id:v,email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",status:c,roleId:r.roleId}),q({label:N,entityId:v,type:"user",status:c,jobTitle:r.jobTitle}),g&&g(i.updateUserSuccess))}catch(o){const d=o instanceof Error?o.message:i.saveUserError;b?b(d):A(d)}},isCompanyAdmin:n,generalError:f}}const Ne=Z(({mode:M,entityId:_,parentStructureId:v,permissions:E,onSaved:q,onCancel:b,onError:g,onSuccess:i})=>{const r=(E==null?void 0:E.canEditUsers)??!1,{roles:L,isLoading:w}=se(),{values:u,errors:m,touched:y,loading:V,setValue:U,onBlur:f,submit:A,isCompanyAdmin:x,generalError:j}=ie({mode:M,entityId:_,parentStructureId:v,onSaved:q,onError:g?a=>{g(a),b()}:void 0,onSuccess:i}),[S,k]=p(!1),l=X({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator",save:"Company.CompanyStructure.shared.buttons.save",cancel:"Company.CompanyStructure.shared.buttons.cancel"});return F("div",{children:[s("h3",{className:"acm-structure-panel__title",children:M==="add"?l.addUser:l.editUser}),F(K,{variant:"secondary",className:`company-user-form__card ${S?"is-working":""}`,children:[!g&&j?s(Q,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:j}):null,S?s("div",{className:"company-user-form__overlay","aria-live":"polite",children:s(W,{size:"small"})}):null,V||w?s(ne,{}):F("div",{className:"company-user-form__content",children:[s(T,{label:l.jobTitle,className:"acm-structure-panel__field",error:y.jobTitle&&m.jobTitle?m.jobTitle:void 0,children:s(R,{name:"job_title",type:"text",value:u.jobTitle||"",onBlur:a=>{const n=a.target;f("jobTitle",n.value)},variant:"primary",size:"medium",maxLength:h.jobTitle})}),s(T,{label:l.userRole,required:!0,className:"acm-structure-panel__field",error:!x&&y.roleId&&m.roleId?m.roleId:void 0,disabled:x,children:x?s(P,{name:"role",value:"MA==",options:[{value:"MA==",text:l.companyAdministrator}]}):s(P,{name:"role",value:u.roleId||"placeholder",onChange:a=>{var n,B;return U("roleId",String(((n=a==null?void 0:a.target)==null?void 0:n.value)==="placeholder"?"":((B=a==null?void 0:a.target)==null?void 0:B.value)??""))},onBlur:a=>{const n=a.target;f("roleId",n.value==="placeholder"?"":n.value)},options:[{value:"placeholder",text:l.selectRole,disabled:!0},...L.map(a=>({value:a.id,text:a.name}))]})}),s(T,{label:l.firstName,required:!0,className:"acm-structure-panel__field",error:y.firstName&&m.firstName?m.firstName:void 0,children:s(R,{name:"first_name",type:"text",value:u.firstName,onBlur:a=>{const n=a.target;f("firstName",n.value)},variant:"primary",size:"medium",maxLength:h.firstName})}),s(T,{label:l.lastName,required:!0,className:"acm-structure-panel__field",error:y.lastName&&m.lastName?m.lastName:void 0,children:s(R,{name:"last_name",type:"text",value:u.lastName,onBlur:a=>{const n=a.target;f("lastName",n.value)},variant:"primary",size:"medium",maxLength:h.lastName})}),s(T,{label:l.email,required:!0,className:"acm-structure-panel__field",error:y.email&&m.email?m.email:void 0,children:s(R,{name:"email",type:"email",value:u.email,onBlur:a=>{const n=a.target;f("email",n.value)},placeholder:"jdoe@example.com",variant:"primary",size:"medium",maxLength:h.email})}),s(T,{label:l.workPhoneNumber,className:"acm-structure-panel__field",error:y.telephone&&m.telephone?m.telephone:void 0,children:s(R,{name:"telephone",type:"text",value:u.telephone||"",onBlur:a=>{const n=a.target;f("telephone",n.value)},variant:"primary",size:"medium",maxLength:h.telephone})}),s(T,{label:l.status,className:"acm-structure-panel__field",disabled:x||!r,children:s(P,{name:"status",value:u.status,onChange:a=>{var n;return U("status",String(((n=a==null?void 0:a.target)==null?void 0:n.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:l.active},{value:"INACTIVE",text:l.inactive}]})})]})]}),V||w?null:F("div",{className:"acm-structure-modal__actions",children:[s(H,{type:"button",variant:"primary",disabled:S||!r,onClick:async()=>{if(!S){k(!0);try{await A()}finally{k(!1)}}},children:l.save}),s(H,{type:"button",variant:"secondary",disabled:S,onClick:b,children:l.cancel})]})]})});export{Ne as C};
//# sourceMappingURL=CompanyUserForm.js.map
