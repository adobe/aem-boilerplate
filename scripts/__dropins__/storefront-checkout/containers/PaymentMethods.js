/*! Copyright 2025 Adobe
All Rights Reserved. */
import{h as ae,s as ce}from"../chunks/fetch-graphql.js";import{classes as V,VComponent as se,deepmerge as ie,Slot as j}from"@dropins/tools/lib.js";import{events as F}from"@dropins/tools/event-bus.js";import{v as me}from"../chunks/validation.js";import{s as K}from"../chunks/setPaymentMethod.js";import{jsxs as W,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{useState as N,useMemo as T,useCallback as E,useEffect as D}from"@dropins/tools/preact-hooks.js";import"../chunks/TermsAndConditions.js";import{Skeleton as de,SkeletonRow as I,IllustratedMessage as ue,Icon as Q,InLineAlert as le,ToggleButton as he,RadioButton as pe}from"@dropins/tools/components.js";/* empty css                             */import*as O from"@dropins/tools/preact-compat.js";import{useRef as fe,useEffect as ye}from"@dropins/tools/preact-compat.js";/* empty css                        *//* empty css                  *//* empty css                       *//* empty css                        */import{P as ke}from"../chunks/PurchaseOrder.js";import{P as ge}from"../chunks/PaymentOnAccount2.js";import{r as Me}from"../chunks/render.js";import{i as Se}from"../chunks/events.js";import{h as ve,a as Ce}from"../chunks/events2.js";import{g as L,n as Z}from"../chunks/values.js";import{W as Pe}from"../chunks/ConditionalWrapper.js";import{s as Ee}from"../chunks/dom.js";import{useText as X}from"@dropins/tools/i18n.js";import"@dropins/tools/signals.js";import"@dropins/tools/fetch-graphql.js";import"../fragments.js";import"../chunks/guards.js";import"../chunks/synchronizeCheckout.js";import"../chunks/transform-shipping-methods.js";import"../chunks/classifiers.js";import"../chunks/getCompanyCredit.js";const be=e=>O.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},O.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M17.93 14.8V18.75H5.97C4.75 18.75 3.75 17.97 3.75 17V6.5M3.75 6.5C3.75 5.53 4.74 4.75 5.97 4.75H15.94V8.25H5.97C4.75 8.25 3.75 7.47 3.75 6.5Z",stroke:"currentColor",strokeWidth:1,strokeLinecap:"round",strokeLinejoin:"round"}),O.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M19.35 11.64H14.04V14.81H19.35V11.64Z",stroke:"currentColor",strokeWidth:1,strokeLinecap:"round",strokeLinejoin:"round"}),O.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M17.9304 11.64V8.25H15.1504",stroke:"currentColor",strokeWidth:1,strokeLinecap:"round",strokeLinejoin:"round"})),_e=()=>W(de,{"data-testid":"payment-methods-skeleton",children:[s(I,{size:"medium",variant:"heading"}),s(I,{size:"medium",variant:"empty"}),s(I,{fullWidth:!0,size:"xlarge"}),s(I,{fullWidth:!0,size:"xlarge"})]}),we=({UIComponentType:e="ToggleButton",busy:n,code:c,icon:m,onSelectionChange:o,selected:i,title:d})=>{const l={busy:n,className:"checkout-payment-methods__method",label:d,name:"payment-method",onChange:()=>o({code:c,title:d}),value:c};return e==="ToggleButton"?s(he,{...l,icon:m?s(Q,{source:m}):void 0,selected:i}):s(pe,{...l,checked:i,icon:m??void 0})},Ne=({className:e,error:n=null,busy:c=!1,onDismissError:m,onSelectionChange:o=()=>{},options:i,paymentMethodContent:d,selection:l,title:g,UIComponentType:P})=>{const M=X({EmptyState:"Checkout.PaymentMethods.emptyState"}),h=n!==null,S=fe(null);return ye(()=>{h&&S.current&&Ee(S.current)},[h]),W("div",{className:V(["checkout-payment-methods",e]),"data-testid":"checkout-payment-methods",children:[g&&s(se,{className:"checkout-payment-methods__title",node:g}),!c&&i.length===0&&s(ue,{"data-testid":"checkout-payment-methods-empty",icon:s(Q,{source:be}),message:s("p",{children:M.EmptyState})}),W("div",{className:V(["checkout-payment-methods__wrapper",["checkout-payment-methods__wrapper--busy",c]]),"data-testid":"checkout-payment-methods-wrapper",children:[s("div",{className:V(["checkout-payment-methods__methods",["checkout-payment-methods--full-width",i.length%2!==0]]),children:i==null?void 0:i.map(k=>s(we,{UIComponentType:P,busy:c,code:k.code,icon:k.icon,selected:(l==null?void 0:l.code)===k.code,title:k.displayLabel??!0?k.title:"",onSelectionChange:o},k.code))}),d&&s("div",{className:"checkout-payment-methods__content",children:d})]}),h&&s("div",{ref:S,className:"checkout-payment-methods__error","data-testid":"checkout-payment-methods-alert",children:s(le,{heading:n,type:"error",variant:"primary",onDismiss:m})})]})},Te=Pe(Ne,_e),Ie=(e,n)=>{let c;return function(...m){clearTimeout(c),c=setTimeout(()=>e.apply(this,m),n)}};var Oe=(e=>(e.PaymentOnAccount="companycredit",e.PurchaseOrder="purchaseorder",e))(Oe||{});const G={companycredit:{Container:ge,autoSync:!0,formName:"payment-on-account",validateRefNumber:!1},purchaseorder:{Container:ke,autoSync:!1,formName:"purchase-order",validateRefNumber:!0}},A=new Map,Le=(e,n)=>{const c=`${e}-${n}`;if(!A.has(c)){const m=Ie(async o=>{if(!n||me(o))try{await K({code:e,purchase_order_number:o})}catch(i){console.error(`Failed to set payment method for ${e}:`,i)}},1e3);A.set(c,m)}return A.get(c)},w={},ht=()=>{Object.keys(w).forEach(e=>{delete w[e]}),A.clear()},q=e=>{if(!(e in G))throw new Error(`Invalid handler code: ${e}`);if(w[e])return w[e];const n=G[e],{autoSync:c,Container:m,formName:o,validateRefNumber:i}=n,d={enabled:!0,autoSync:c,render:l=>{var M;const g=String(((M=l.additionalData)==null?void 0:M.purchase_order_number)??""),P=document.createElement("div");Me.render(m,{name:o,initialReferenceNumber:g,onReferenceNumberChange:Le(e,i)})(P),l.replaceHTML(P)}};return w[e]=d,d},Ue={companycredit:q("companycredit"),purchaseorder:q("purchaseorder")};function U(e,n){return e?n.some(c=>c.code===e.code):!1}function J(e,n){return!e||!n?!1:e.code===n.code}function Ae(e){return e?!!e.code&&!!e.title:!1}const pt=({UIComponentType:e="ToggleButton",active:n=!0,autoSync:c=!0,displayTitle:m=!0,slots:o,onCartSyncError:i,onSelectionChange:d})=>{const[l,g]=N(null),[P,M]=N(!1),[h,S]=N(null),[k,x]=N([]),Y=ae.value,{cartSyncError:z,defaultTitle:H}=X({cartSyncError:"Checkout.PaymentMethods.cartSyncError",defaultTitle:"Checkout.PaymentMethods.title"}),p=T(()=>{const t=(o==null?void 0:o.Methods)??{};return ie(Ue,t)},[o==null?void 0:o.Methods]),v=T(()=>k.filter(t=>{var a;return((a=p==null?void 0:p[t.code])==null?void 0:a.enabled)!==!1}).map(t=>{const a=(p==null?void 0:p[t.code])||{};return{...t,...a}}),[k,p]),B=E(t=>{S(r=>r&&{...r,additionalData:t});const a=L("selectedPaymentMethod");a&&Z({selectedPaymentMethod:{...a,additionalData:t}})},[]),ee=E(()=>{g(null)},[]),f=E(t=>{g(null),S(t),Z({selectedPaymentMethod:t})},[]),C=E(async(t,a)=>{if(!(Se()||ve()))return;const u=p==null?void 0:p[t.code];((u==null?void 0:u.autoSync)??c)&&K({code:t.code}).catch(y=>{f(a??null),i==null||i({method:t,error:y}),i||g(z)})},[p,c,f,i,z]),te=E(async t=>{const a=L("selectedPaymentMethod");f(t),d==null||d(t),await C(t,a)},[d,f,C]),b=E(t=>{if(!t||t.isEmpty){f(null),x([]);return}const r=t.availablePaymentMethods??[];if(x(r),r.length===0){f(null);return}const u=t.selectedPaymentMethod??null,_=Ae(u),y=L("selectedPaymentMethod"),R=U(y,r),oe=J(y,u);if(y&&R&&!oe){C(y,u);return}if((!y||!R)&&_&&U(u,r)){f(u);return}if((!y||!R)&&(!_||!U(u,r))){const $=r[0];f($),C($)}},[f,C]);D(()=>{if(!n)return;const t=Ce();if(t){M(!0);const r=L("selectedPaymentMethod");r&&S(r),b(t);return}const a=F.on("checkout/initialized",r=>{M(!0),b(r)},{eager:!0});return()=>{a==null||a.off()}},[n,b]),D(()=>{if(!n)return;const t=F.on("checkout/updated",b,{eager:!1});return()=>{t==null||t.off()}},[n,b]),D(()=>{if(v.length===0||U(h,v))return;const a=v[0],{code:r,title:u,additionalData:_}=a,y={code:r,title:u,additionalData:_};f(y),C(y)},[v,h,f,C]);const ne=T(()=>{if(m)return s(j,{name:"checkout-payment-methods-title",slot:o==null?void 0:o.Title,children:s("h2",{children:H})})},[m,o==null?void 0:o.Title,H]),re=T(()=>{var a;const t=(a=v.find(r=>J(r,h)))==null?void 0:a.render;if(t)return s(j,{context:{additionalData:h.additionalData,cartId:ce.cartId??"",replaceHTML(r){this.replaceWith(r)},setAdditionalData:B},name:"PaymentMethodContent",slot:t},h.code)},[v,h,B]);return s(Te,{UIComponentType:e,busy:Y,error:l,initialized:P,options:v,paymentMethodContent:re,selection:h,title:ne,visible:n,onDismissError:ee,onSelectionChange:te})};export{Oe as HandlerCode,pt as PaymentMethods,q as createHandler,pt as default,Ue as defaultHandlers,Le as handleRefNumberChange,ht as resetHandlersCache};
//# sourceMappingURL=PaymentMethods.js.map
