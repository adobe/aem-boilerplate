/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as O,Fragment as fe}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Ce,classes as be}from"@dropins/tools/lib.js";import{Checkbox as ve,Card as ie,InLineAlert as ce,ProgressSpinner as de,Field as te,Input as ne,Picker as me,Button as W,Modal as he,Header as ge}from"@dropins/tools/components.js";import{useMemo as ue,useRef as oe,useCallback as $,useState as b,useEffect as se}from"@dropins/tools/preact-hooks.js";import{i as Se,f as Ne,b as Ie}from"../chunks/fetchUserPermissions.js";import{useText as ae}from"@dropins/tools/i18n.js";import{events as le}from"@dropins/tools/event-bus.js";import{g as Te,c as Ee,u as we,i as _e,a as ke,b as xe,d as Ue,e as Ae,f as Re,h as De,j as Me,k as Pe}from"../chunks/isCompanyUserEmailAvailable.js";import{C as je,a as Ve,p as pe,E as ye,u as qe,b as Fe}from"../chunks/useInLineAlert.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/preact-compat.js";const Le=p=>{const S=new Map;for(const u of p){const v=u.parentId??null,t=S.get(v)??[];t.push(u),S.set(v,t)}for(const[,u]of S)u.sort((v,t)=>v.label.localeCompare(t.label));return S},ze=({items:p,rootId:S=null,className:u,expandedIds:v,selectedId:t=null,selectedIds:N,onExpandedChange:s,onSelectedChange:a,onSelectedIdsChange:C,renderNode:c,role:x="tree",draggable:I,canDrop:j,onMove:_,isCheckable:E,checkedIds:V,onCheckedChange:M,renderExpander:A,renderCheckbox:H,renderIcon:q})=>{const G=ue(()=>Le(p),[p]),m=oe(null),d=oe(!1),y=ue(()=>new Map(p.map(i=>[i.id,i])),[p]),B=(i,T)=>{const w=[],L=[T];for(;L.length;){const g=L.pop(),n=i.get(g)??[];for(const o of n)w.push(o.id),L.push(o.id)}return w},Y=$(i=>B(G,i),[G]),K=$(i=>E?E(i):!0,[E]),F=$(i=>{if(!y.get(i))return{checked:!1,indeterminate:!1};const w=[i,...Y(i)].filter(n=>{const o=y.get(n);return o?K(o):!1});if(w.length===0)return{checked:!1,indeterminate:!1};const L=V??new Set,g=w.reduce((n,o)=>L.has(o)?n+1:n,0);return g===0?{checked:!1,indeterminate:!1}:g===w.length?{checked:!0,indeterminate:!1}:{checked:!1,indeterminate:!0}},[y,Y,K,V]),X=$(i=>{if(!M)return;const T=new Set(V??[]),{checked:w}=F(i),L=[i,...Y(i)].filter(g=>{const n=y.get(g);return n?K(n):!1});if(w)for(const g of L)T.delete(g);else for(const g of L)T.add(g);M(T)},[V,M,F,Y,y,K]),Z=$(i=>e(ve,{name:`tree-checkbox-${Math.random().toString(36).substr(2,9)}`,checked:i.checked,indeterminate:i.indeterminate,onChange:i.onCheck}),[]),l=$(i=>{const T=new Set(v);T.has(i)?T.delete(i):T.add(i),s(T)},[v,s]),R=$(i=>{const T=y.get(i);if(T&&K(T)&&M&&X(i),!C){a==null||a(i);return}const w=!!d.current,L=w?new Set(N??[]):new Set;w&&L.has(i)?L.delete(i):L.add(i),C(L),d.current=!1},[a,C,N,y,K,M,X]),U=(i,T)=>{const w=G.get(i)??[];return w.length?e("ul",{role:T===1?x:"group",className:T===1?u??"acm-tree":"acm-tree__group",children:w.map((g,n)=>{const o=(G.get(g.id)??[]).length>0,D=v.has(g.id),r=N?N.has(g.id):t===g.id,f=!!(I!=null&&I(g)),P=k=>j?j(k,g.id):k!==g.id,h=o?()=>A?A({expanded:D,hasChildren:o,toggle:()=>l(g.id)}):null:void 0,z=(()=>{if(!M)return;const k=y.get(g.id);if(!k||!K(k))return;const Q=F(g.id),ee=H||Z;return()=>ee({checked:Q.checked,indeterminate:Q.indeterminate,onCheck:()=>X(g.id)})})(),J=q?()=>q({item:g,level:T,hasChildren:o,expanded:D}):void 0,re=c({item:g,level:T,expanded:D,selected:!!r,hasChildren:o,toggle:()=>l(g.id),select:()=>R(g.id),...h?{expander:h}:{},...z?{checkbox:z}:{},...J?{icon:J}:{}});return O("li",{role:"treeitem",className:"acm-tree__item","data-level":T,"aria-expanded":o?D:void 0,"aria-selected":r||void 0,"aria-level":T,"aria-setsize":w.length,"aria-posinset":n+1,draggable:f,onMouseDown:k=>{d.current=!!(k.metaKey||k.ctrlKey)},onDragStart:k=>{var Q;if(k.stopPropagation(),!!f){m.current=g.id;try{(Q=k.dataTransfer)==null||Q.setData("text/plain",g.id)}catch{}}},onDragOver:k=>{var ee;k.stopPropagation();const Q=m.current??(((ee=k.dataTransfer)==null?void 0:ee.getData("text/plain"))||"");Q&&P(Q)&&k.preventDefault()},onDrop:k=>{var ee;k.stopPropagation();const Q=m.current??(((ee=k.dataTransfer)==null?void 0:ee.getData("text/plain"))||"");m.current=null,Q&&P(Q)&&(_==null||_({id:Q,newParentId:g.id}))},children:[re,o&&D?U(g.id,T+1):null]},g.id)})}):null};return e("div",{className:"acm-tree-root",children:U(S,1)})};function Be(p){const{mode:S,entityId:u,parentStructureId:v,onSaved:t}=p,N=ae({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError"}),[s,a]=b({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[C,c]=b({}),[x,I]=b({}),[j,_]=b(!1),[E,V]=b(null),[M,A]=b(null),[H,q]=b(""),[G,m]=b(""),[d,y]=b(!1);se(()=>{S!=="edit"||!u||(_(!0),Te(u).then(l=>{var U;if(!l)return;const R=l.email||"";a(i=>({...i,firstName:l.firstName||"",lastName:l.lastName||"",email:R,jobTitle:l.jobTitle||"",telephone:l.telephone||"",status:l.status||"ACTIVE"})),m(R),(U=l==null?void 0:l.role)!=null&&U.id&&a(i=>({...i,roleId:l.role.id})),y((l==null?void 0:l.isCompanyAdmin)??!1)}).finally(()=>_(!1)))},[S,u]);const B=l=>/.+@.+\..+/.test(l),Y=(l,R)=>l==="firstName"?R.trim()?null:N.firstNameRequired:l==="lastName"?R.trim()?null:N.lastNameRequired:l==="email"?R.trim()?B(R.trim())?null:N.emailInvalid:N.emailRequired:l==="jobTitle"?R.trim()?null:N.jobTitleRequired:l==="telephone"?R.trim()?null:N.workPhoneRequired:l==="roleId"?R?null:N.selectRole:null,K=(l,R)=>{a(U=>({...U,[l]:R})),C[l]&&c(U=>({...U,[l]:""})),l==="email"&&A(null),E&&V(null)},F=async l=>{I(U=>({...U,[l]:!0}));const R=Y(l,String(s[l]??""));if(R&&c(U=>({...U,[l]:R})),l==="email"){const U=(s.email||"").trim();if(S==="edit"&&U.toLowerCase()===(G||"").trim().toLowerCase()){A(null);return}if(B(U)&&U!==H){const i=await _e(U);q(U),A(i),i===!1&&c(T=>({...T,email:"A user with this email address is already a member of your company."}))}}},X=ue(()=>!!s.roleId&&!!(s.firstName||"").trim()&&!!(s.lastName||"").trim()&&!!(s.jobTitle||"").trim()&&!!(s.telephone||"").trim()&&B((s.email||"").trim())&&!C.email&&M!==!1,[s,C,M]);return{values:s,errors:C,touched:x,loading:j,setValue:K,onBlur:F,canSubmit:X,submit:async()=>{const l=["firstName","lastName","email","jobTitle","telephone","roleId"],R={};for(const w of l){const L=Y(w,String(s[w]??""));L&&(R[w]=L)}if(c(R),I({firstName:!0,lastName:!0,email:!0,jobTitle:!0,telephone:!0,roleId:!0}),Object.keys(R).length||M===!1)return;const U=`${s.firstName||""} ${s.lastName||""}`.trim()||s.email||"",T=d||Se({id:s.roleId})?"ACTIVE":s.status;try{if(S==="add"){const w=await Ee({email:s.email||"",firstName:s.firstName||"",lastName:s.lastName||"",jobTitle:s.jobTitle||"",telephone:s.telephone||"",roleId:s.roleId,status:T,targetId:v??null});if(!w){V(N.createUserError);return}t({label:U,structureId:w.structureId,entityId:w.id,type:"user"})}else u&&(await we({id:u,email:s.email||"",firstName:s.firstName||"",lastName:s.lastName||"",jobTitle:s.jobTitle||"",telephone:s.telephone||"",status:T,roleId:s.roleId}),t({label:U,entityId:u,type:"user"}))}catch(w){const L=(w==null?void 0:w.message)||N.saveUserError;V(L)}},isCompanyAdmin:d,generalError:E}}function Oe(){const p=ae({loadRolesError:"Company.CompanyStructure.messages.loadRolesError"}),[S,u]=b([]),[v,t]=b(!0),[N,s]=b(null);return se(()=>{let a=!0;return t(!0),ke().then(C=>{a&&u(C)}).catch(()=>{a&&s(p.loadRolesError)}).finally(()=>{a&&t(!1)}),()=>{a=!1}},[p.loadRolesError]),{roles:S,loading:v,error:N}}const $e=({mode:p,entityId:S,parentStructureId:u,permissions:v,onSaved:t,onCancel:N})=>{const s=(v==null?void 0:v.canEditUsers)??!1,{roles:a,loading:C}=Oe(),{values:c,errors:x,touched:I,loading:j,setValue:_,onBlur:E,canSubmit:V,submit:M,isCompanyAdmin:A,generalError:H}=Be({mode:p,entityId:S,parentStructureId:u,onSaved:t}),[q,G]=b(!1),m=ae({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator"});return O("div",{children:[e("h3",{className:"acm-structure-panel__title",children:p==="add"?m.addUser:m.editUser}),O(ie,{variant:"secondary",className:`company-user-form__card ${q?"is-working":""}`,children:[H?e(ce,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:H}):null,q?e("div",{className:"company-user-form__overlay","aria-live":"polite",children:e(de,{size:"small"})}):null,j||C?e(je,{}):O("div",{className:"company-user-form__content",children:[e(te,{label:m.jobTitle,required:!0,className:"acm-structure-panel__field",error:I.jobTitle&&x.jobTitle?x.jobTitle:void 0,children:e(ne,{name:"job_title",type:"text",value:c.jobTitle||"",onValue:d=>_("jobTitle",d),onBlur:()=>E("jobTitle"),variant:"primary",size:"medium"})}),e(te,{label:m.userRole,required:!0,className:"acm-structure-panel__field",error:!A&&I.roleId&&x.roleId?x.roleId:void 0,disabled:A,children:A?e(me,{name:"role",value:"MA==",options:[{value:"MA==",text:m.companyAdministrator}]}):e(me,{name:"role",value:c.roleId||"placeholder",onChange:d=>{var y,B;return _("roleId",String(((y=d==null?void 0:d.target)==null?void 0:y.value)==="placeholder"?"":((B=d==null?void 0:d.target)==null?void 0:B.value)??""))},options:[{value:"placeholder",text:m.selectRole,disabled:!0},...a.map(d=>({value:d.id,text:d.name}))]})}),e(te,{label:m.firstName,required:!0,className:"acm-structure-panel__field",error:I.firstName&&x.firstName?x.firstName:void 0,children:e(ne,{name:"first_name",type:"text",value:c.firstName,onValue:d=>_("firstName",d),onBlur:()=>E("firstName"),variant:"primary",size:"medium"})}),e(te,{label:m.lastName,required:!0,className:"acm-structure-panel__field",error:I.lastName&&x.lastName?x.lastName:void 0,children:e(ne,{name:"last_name",type:"text",value:c.lastName,onValue:d=>_("lastName",d),onBlur:()=>E("lastName"),variant:"primary",size:"medium"})}),e(te,{label:m.email,required:!0,className:"acm-structure-panel__field",error:I.email&&x.email?x.email:void 0,children:e(ne,{name:"email",type:"email",value:c.email,onValue:d=>_("email",d),onBlur:()=>void E("email"),placeholder:"jdoe@example.com",variant:"primary",size:"medium"})}),e(te,{label:m.workPhoneNumber,required:!0,className:"acm-structure-panel__field",error:I.telephone&&x.telephone?x.telephone:void 0,children:e(ne,{name:"telephone",type:"text",value:c.telephone||"",onValue:d=>_("telephone",d),onBlur:()=>E("telephone"),variant:"primary",size:"medium"})}),e(te,{label:m.status,className:"acm-structure-panel__field",disabled:A||!s,children:e(me,{name:"status",value:c.status,onChange:d=>{var y;return _("status",String(((y=d==null?void 0:d.target)==null?void 0:y.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:m.active},{value:"INACTIVE",text:m.inactive}]})})]})]}),j||C?null:O("div",{className:"acm-structure-modal__actions",children:[e(W,{type:"button",variant:"primary",disabled:!V||q,onClick:async()=>{if(!q){G(!0);try{await M()}finally{G(!1)}}},children:"Save"}),e(W,{type:"button",variant:"secondary",disabled:q,onClick:N,children:"Cancel"})]})]})};function He(p){const{mode:S,entityId:u,parentStructureId:v,onSaved:t}=p,N=ae({teamTitleRequired:"Company.CompanyStructure.shared.validation.teamTitleRequired",createTeamError:"Company.CompanyStructure.messages.createTeamError",saveTeamError:"Company.CompanyStructure.messages.saveTeamError"}),[s,a]=b({title:"",description:""}),[C,c]=b({}),[x,I]=b({}),[j,_]=b(!1),[E,V]=b(null);se(()=>{S!=="edit"||!u||(_(!0),xe(u).then(m=>{m&&a({title:m.name||"",description:m.description||""})}).finally(()=>_(!1)))},[S,u]);const M=(m,d)=>m==="title"?d.trim()?null:N.teamTitleRequired:null,A=(m,d)=>{a(y=>({...y,[m]:d})),C[m]&&c(y=>({...y,[m]:""})),E&&V(null)},H=m=>{I(y=>({...y,[m]:!0}));const d=M(m,s[m]||"");d&&c(y=>({...y,[m]:d}))},q=ue(()=>!!s.title.trim(),[s.title]);return{values:s,errors:C,touched:x,loading:j,setValue:A,onBlur:H,canSubmit:q,submit:async()=>{const m=M("title",s.title);if(m){c({title:m}),I({title:!0});return}const d=s.title;try{if(S==="add"){const y=await Ue({name:s.title,description:s.description||null,targetId:v??null});if(!y){V(N.createTeamError);return}t({label:d,structureId:y.structureId,entityId:y.id,type:"team",description:s.description})}else u&&(await Ae({id:u,name:s.title,description:s.description||null}),t({label:d,entityId:u,type:"team",description:s.description}))}catch(y){const B=(y==null?void 0:y.message)||N.saveTeamError;V(B)}},generalError:E}}const Ye=({mode:p,entityId:S,parentStructureId:u,permissions:v,onSaved:t,onCancel:N})=>{const s=(v==null?void 0:v.canEditUsers)??!1,{values:a,errors:C,touched:c,loading:x,setValue:I,onBlur:j,canSubmit:_,submit:E,generalError:V}=He({mode:p,entityId:S,parentStructureId:u,onSaved:t}),[M,A]=b(!1),H=ae({addTeam:"Company.CompanyStructure.shared.titles.addTeam",editTeam:"Company.CompanyStructure.shared.titles.editTeam",teamTitle:"Company.CompanyStructure.shared.fields.teamTitle",description:"Company.CompanyStructure.shared.fields.description"});return O("div",{children:[e("h3",{className:"acm-structure-panel__title",children:p==="add"?H.addTeam:H.editTeam}),O(ie,{variant:"secondary",className:`company-team-form__card ${M?"is-working":""}`,children:[V?e(ce,{className:"company-team-form__notification",type:"error",variant:"secondary",heading:V}):null,M?e("div",{className:"company-team-form__overlay","aria-live":"polite",children:e(de,{size:"small"})}):null,x?e(Ve,{}):O("div",{className:"company-team-form__content",children:[e(te,{label:H.teamTitle,required:!0,className:"acm-structure-panel__field",error:c.title&&C.title?C.title:void 0,children:e(ne,{name:"team_title",type:"text",value:a.title,onValue:q=>I("title",q),onBlur:()=>j("title"),variant:"primary",size:"medium",disabled:!s})}),e(te,{label:H.description,className:"acm-structure-panel__field",children:e(ne,{name:"team_description",type:"textarea",value:a.description,onValue:q=>I("description",q),variant:"primary",size:"medium",disabled:!s})})]})]}),x?null:O("div",{className:"acm-structure-modal__actions",children:[e(W,{type:"button",variant:"primary",onClick:async()=>{if(!M){A(!0);try{await E()}finally{A(!1)}}},disabled:!_||M,children:"Save"}),e(W,{type:"button",variant:"secondary",disabled:M,onClick:N,children:"Cancel"})]})]})};function Ge({handleSetInLineAlert:p,permissions:S}={permissions:null}){const u=(S==null?void 0:S.canViewUsers)??!1,v=ae({structureSuccess:"Company.CompanyStructure.messages.structureSuccess",structureError:"Company.CompanyStructure.messages.structureError",loadError:"Company.CompanyStructure.messages.loadError",updateError:"Company.CompanyStructure.messages.updateError",failedToMoveItem:"Company.CompanyStructure.messages.failedToMoveItem"}),{structureSuccess:t,structureError:N,loadError:s,updateError:a}=v,[C,c]=b(null),[x,I]=b(!0),[j,_]=b(!1),[E,V]=b(!1),[M,A]=b(new Set),[H,q]=b(null),[G,m]=b(new Set),[d,y]=b({}),B=oe(p),Y=oe(!1),K=oe(!1);se(()=>{B.current=p},[p]);const F=$((n,o)=>{p&&(n==="success"?p({type:"success",text:o??t}):n==="error"?p({type:"error",text:o??N}):p(),_(!1))},[p,t,N]),X=$(async()=>{if(Y.current)return null;if(Y.current=!0,!u)return I(!1),c(null),A(new Set),q(null),m(new Set),Y.current=!1,null;I(!0);try{const o=await Re();return c(o),A(new Set(o.map(D=>D.id))),I(!1),o}catch(o){return console.error("Failed to load company structure:",o),I(!1),B.current&&B.current({type:"error",text:s}),null}finally{Y.current=!1}},[u,s]);se(()=>{u&&!K.current&&(K.current=!0,X())},[u,X]),se(()=>{const n=()=>{I(!0),A(new Set),q(null),m(new Set),X()},o=le.on("companyContext/changed",n,{eager:!0});return()=>{o==null||o.off()}},[X]);const Z=$(async(n,o)=>{try{return _(!0),await De({id:n,parentId:o})?(c(r=>r?r.map(f=>f.id===n?{...f,parentId:o}:f):null),A(r=>new Set([...r,o])),pe(ye.EDIT_COMPANY_STRUCTURE_EVENT,{action:"move",nodeId:n,newParentId:o}),le.emit("companyStructure/updated",{message:"Structure updated",action:"move",nodeId:n,newParentId:o,nodes:C||[]}),F("success"),!0):(F("error",v.failedToMoveItem),!1)}catch(D){return console.error("Failed to move node:",D),F("error",D.message||a),!1}finally{_(!1)}},[C,F,a,v.failedToMoveItem]),l=$(()=>{C&&A(new Set(C.map(n=>n.id)))},[C]),R=$(()=>{if(C){const n=C.filter(o=>o.parentId===null).map(o=>o.id);A(new Set(n))}},[C]),U=$(n=>{c(o=>{const D=o?[...o,{id:n.id,parentId:n.parentId,label:n.label,type:n.type,entityId:n.entityId,description:n.description}]:[{id:n.id,parentId:n.parentId,label:n.label,type:n.type,entityId:n.entityId,description:n.description}];return le.emit("companyStructure/updated",{message:"Structure updated",action:"add",nodeId:n.id,newParentId:n.parentId||void 0,nodes:D}),pe(ye.EDIT_COMPANY_STRUCTURE_EVENT,{action:"add",nodeId:n.id,newParentId:n.parentId||void 0,nodeType:n.type}),D}),n.parentId&&A(o=>new Set([...o,n.parentId]))},[]),i=$((n,o,D)=>{o&&c(r=>r?r.map(f=>n.includes(f.id)?{...f,label:o,description:D}:f):null)},[]),T=$(async n=>{if(n.length)try{_(!0);const o=new Map((C||[]).map(D=>[D.id,D]));for(const D of n){const r=o.get(D);!r||!r.entityId||(r.type==="team"?await Me(r.entityId):await Pe(r.entityId))}c(D=>{if(!D)return null;const r=new Set(n);return D.filter(f=>!r.has(f.id))}),q(null),m(new Set),pe(ye.EDIT_COMPANY_STRUCTURE_EVENT,{action:"remove",nodeIds:n}),le.emit("companyStructure/updated",{message:"Structure updated",action:"remove",nodeIds:n,nodes:C||[]}),F("success")}catch(o){console.error("Failed to remove nodes:",o),F("error",o.message||a)}finally{_(!1)}},[C,F,a]),w=$(n=>{y(n)},[]),L=$(()=>{V(!0),F("success",""),y({})},[F]),g=$(n=>{n==null||n(),V(!1),y({})},[]);return{nodes:C,loading:x,submitLoading:j,showEditForm:E,inputChange:d,expanded:M,setExpanded:A,selected:H,setSelected:q,selectedMany:G,setSelectedMany:m,move:Z,expandAll:l,collapseAll:R,insertNode:U,renameNodes:i,removeNodes:T,handleInputChange:w,handleShowEditForm:L,handleHideEditForm:g,renderAlertMessage:F,working:j}}const Ke=({permissions:p,slots:S})=>{var D;const u=(p==null?void 0:p.canEditUsers)??!1,v=(p==null?void 0:p.canViewUsers)??!1,t=ae({expandAll:"Company.CompanyStructure.shared.buttons.expandAll",collapseAll:"Company.CompanyStructure.shared.buttons.collapseAll",addUser:"Company.CompanyStructure.shared.buttons.addUser",addTeam:"Company.CompanyStructure.shared.buttons.addTeam",editSelected:"Company.CompanyStructure.shared.buttons.editSelected",remove:"Company.CompanyStructure.shared.buttons.remove",ok:"Company.CompanyStructure.shared.buttons.ok",cancel:"Company.CompanyStructure.shared.buttons.cancel",close:"Company.CompanyStructure.shared.buttons.close",deleting:"Company.CompanyStructure.shared.buttons.deleting",removing:"Company.CompanyStructure.shared.buttons.removing",noStructureData:"Company.CompanyStructure.messages.noStructureData",processing:"Company.CompanyStructure.shared.messages.processing",cannotDeleteUser:"Company.CompanyStructure.messages.cannotDeleteUser",cannotDeleteTeam:"Company.CompanyStructure.messages.cannotDeleteTeam",removeUserConfirm:"Company.CompanyStructure.messages.removeUserConfirm",deleteTeamConfirm:"Company.CompanyStructure.messages.deleteTeamConfirm",removeItemsConfirm:"Company.CompanyStructure.messages.removeItemsConfirm",teamDescription:"Company.CompanyStructure.shared.messages.teamDescription",removeUserMessage:"Company.CompanyStructure.messages.removeUserMessage",cannotDeleteUserMessage:"Company.CompanyStructure.messages.cannotDeleteUserMessage",cannotDeleteTeamMessage:"Company.CompanyStructure.messages.cannotDeleteTeamMessage",removeItemsMessage:"Company.CompanyStructure.messages.removeItemsMessage",companyStructureActions:"Company.CompanyStructure.shared.ariaLabels.companyStructureActions",expandAllNodes:"Company.CompanyStructure.shared.ariaLabels.expandAllNodes",collapseAllNodes:"Company.CompanyStructure.shared.ariaLabels.collapseAllNodes",addUserAria:"Company.CompanyStructure.shared.ariaLabels.addUser",addTeamAria:"Company.CompanyStructure.shared.ariaLabels.addTeam",editSelectedAria:"Company.CompanyStructure.shared.ariaLabels.editSelected",removeSelectedAria:"Company.CompanyStructure.shared.ariaLabels.removeSelected",showDescription:"Company.CompanyStructure.shared.ariaLabels.showDescription",delete:"Company.CompanyStructure.shared.options.delete",expand:"Company.CompanyStructure.shared.options.expand",collapse:"Company.CompanyStructure.shared.options.collapse",deleteTeamMessage:"Company.CompanyStructure.messages.deleteTeamMessage"}),{inLineAlertProps:N,handleSetInLineAlert:s}=qe(),{nodes:a,loading:C,submitLoading:c,expanded:x,setExpanded:I,selected:j,setSelected:_,selectedMany:E,setSelectedMany:V,move:M,expandAll:A,collapseAll:H,insertNode:q,renameNodes:G,removeNodes:m}=Ge({handleSetInLineAlert:s,permissions:p}),[d,y]=b(null),[B,Y]=b("add"),[K,F]=b(!1),[X,Z]=b([]),[l,R]=b({title:"",body:"",confirmLabel:t.remove,blocked:!1}),[U,i]=b(null),T=()=>y(null),w=((D=a==null?void 0:a.find(r=>r.parentId===null))==null?void 0:D.id)??null,L=(a||[]).map(r=>({id:r.id,parentId:r.parentId,label:r.label})),g=(r,f)=>{let P=r;const h=new Map(L.map(J=>[J.id,J])),z=new Set;for(;P&&!z.has(P);){z.add(P);const J=h.get(P);if(!J)break;if(J.parentId===f)return!0;P=J.parentId??null}return!1},n=(a||[]).map(r=>({id:r.id,parentId:r.parentId,label:r.label,type:r.type,description:r.description,entityId:r.entityId})),o=O(fe,{children:[(()=>{const r=E!=null&&E.size?Array.from(E):j?[j]:[],f=u&&r.length===1,P=u&&r.length>=1;return e(ie,{variant:"secondary",className:"acm-structure-toolbar-card acm-structure-toolbar-card--spaced",children:O("div",{className:"acm-structure-toolbar",role:"toolbar","aria-label":t.companyStructureActions,children:[e(W,{type:"button",variant:"secondary",onClick:A,"aria-label":t.expandAllNodes,disabled:!v,"aria-disabled":!v,children:t.expandAll}),e(W,{type:"button",variant:"secondary",onClick:H,"aria-label":t.collapseAllNodes,disabled:!v,"aria-disabled":!v,children:t.collapseAll}),e(W,{type:"button",variant:"primary",onClick:()=>{Y("add"),y("user")},"aria-label":t.addUserAria,disabled:!u,"aria-disabled":!u,children:t.addUser}),e(W,{type:"button",variant:"primary",onClick:()=>{Y("add"),y("team")},"aria-label":t.addTeamAria,disabled:!u,"aria-disabled":!u,children:t.addTeam}),e(W,{type:"button",variant:"primary",disabled:!f,"aria-disabled":!f,"aria-label":t.editSelectedAria,onClick:()=>{if(!f)return;const h=r,z=a==null?void 0:a.find(J=>J.id===h[0]);(z==null?void 0:z.type)==="user"?(Y("edit"),y("user")):(Y("edit"),y("team"))},children:t.editSelected}),e(W,{type:"button",variant:"secondary",disabled:!P||c,"aria-disabled":!P||c,"aria-label":t.removeSelectedAria,onClick:()=>{if(!P||c)return;const h=r;if(h.length===1){const z=a==null?void 0:a.find(re=>re.id===h[0]);if(!z)return;(a==null?void 0:a.some(re=>re.parentId===z.id))?(R({title:z.type==="user"?t.cannotDeleteUser:t.cannotDeleteTeam,body:z.type==="user"?t.cannotDeleteUserMessage:t.cannotDeleteTeamMessage,confirmLabel:void 0,blocked:!0}),Z([]),F(!0)):(R({title:z.type==="user"?t.removeUserConfirm:t.deleteTeamConfirm,body:z.type==="user"?t.removeUserMessage:t.deleteTeamMessage,confirmLabel:z.type==="user"?t.remove:t.delete,blocked:!1}),Z(h),F(!0))}else R({title:t.removeItemsConfirm,body:t.removeItemsMessage,confirmLabel:t.remove,blocked:!1}),Z(h),F(!0)},children:t.remove})]})})})(),d?O("div",{className:"acm-structure-panel",children:[c?O("div",{className:"acm-structure-working","aria-live":"polite",children:[e(de,{size:"small"})," ",t.processing]}):null,d==="user"?(()=>{const r=E!=null&&E.size?Array.from(E):j?[j]:[],f=r.length?a==null?void 0:a.find(h=>h.id===r[0]):void 0,P=(f==null?void 0:f.id)??w;return e($e,{mode:B,entityId:f==null?void 0:f.entityId,parentStructureId:P,permissions:p,onSaved:h=>{B==="add"?h.structureId&&(q({id:h.structureId,parentId:P,label:h.label,type:h.type,entityId:h.entityId}),h.structureId&&(_(h.structureId),V(new Set([h.structureId])))):r.length&&G(r,h.label),T()},onCancel:T})})():null,d==="team"?(()=>{const r=E!=null&&E.size?Array.from(E):j?[j]:[],f=r.length?a==null?void 0:a.find(h=>h.id===r[0]):void 0,P=(f==null?void 0:f.id)??w;return e(Ye,{mode:B,entityId:f==null?void 0:f.entityId,parentStructureId:P,permissions:p,onSaved:h=>{B==="add"?h.structureId&&(q({id:h.structureId,parentId:P,label:h.label,type:h.type,entityId:h.entityId,description:h.description}),h.structureId&&(_(h.structureId),V(new Set([h.structureId])))):r.length&&G(r,h.label,h.description),T()},onCancel:T})})():null]}):null,O(ie,{variant:"secondary",className:`acm-structure-tree-card ${c?"is-working":""}`,children:[N&&N.text?e(ce,{className:"acm-structure-panel__notification",type:N.type||"success",variant:"secondary",heading:N.text}):null,!C&&!c&&a&&a.length===0?e(ce,{className:"acm-structure-panel__notification",type:"warning",variant:"secondary",heading:t.noStructureData}):null,!C&&c?e("div",{className:"acm-structure-tree-overlay","aria-live":"polite",children:e(de,{size:"medium"})}):null,C?e("div",{className:"acm-structure-tree-content",children:e(Fe,{rows:8})}):e("div",{className:"acm-structure-tree-content",children:e(ze,{rootId:null,items:L,expandedIds:x,selectedId:j,selectedIds:E,onExpandedChange:I,onSelectedChange:_,onSelectedIdsChange:V,renderExpander:({expanded:r,toggle:f})=>e("button",{type:"button",className:`acm-structure-expander acm-structure-expander-button ${r?"is-open":""}`,"aria-label":r?t.collapse:t.expand,onClick:P=>{P.stopPropagation(),f()},children:r?"âˆ’":"+"}),renderNode:({item:r,hasChildren:f,select:P,expander:h,checkbox:z,icon:J})=>{var re;return O("div",{className:"acm-structure-row",onClick:P,children:[f?h?e("span",{onClick:k=>k.stopPropagation(),children:h()}):e("span",{className:"acm-structure-expander acm-structure-expander--placeholder"}):e("span",{className:"acm-structure-expander acm-structure-expander--placeholder"}),e("span",{className:"acm-structure-handle","aria-hidden":!0}),J?e("span",{onClick:k=>k.stopPropagation(),children:J()}):e("span",{className:`acm-structure-icon ${((re=a==null?void 0:a.find(k=>k.id===r.id))==null?void 0:re.type)==="team"?"is-team":"is-user"}`,"aria-hidden":!0}),z?e("span",{onClick:k=>k.stopPropagation(),children:z()}):null,e("span",{className:"acm-structure-label",children:r.label}),(()=>{const k=a==null?void 0:a.find(ee=>ee.id===r.id),Q=(k==null?void 0:k.type)==="team"&&k.description||"";return Q?e(W,{type:"button",variant:"secondary",onClick:ee=>{ee.stopPropagation(),i({id:r.id,text:Q})},"aria-label":t.showDescription,className:"acm-structure-description-button",children:"?"}):null})()]})},draggable:()=>!c&&u,canDrop:(r,f)=>{if(!u||r===f)return!1;const P=a==null?void 0:a.find(h=>h.id===r);return P&&P.parentId===f?!1:!g(f,r)},onMove:async({id:r,newParentId:f})=>{u&&await M(r,f)}})})]}),K?e(he,{open:K,onClose:()=>{c||(F(!1),Z([]))},children:O("div",{className:"acm-structure-modal-content",children:[e("h3",{className:"acm-structure-modal-title",children:l.title}),e("div",{children:l.body}),e("div",{className:"acm-structure-modal-actions",children:l.blocked?e(W,{type:"button",variant:"secondary",disabled:c,onClick:()=>{c||(F(!1),Z([]))},children:t.ok}):O(fe,{children:[e(W,{type:"button",variant:"secondary",disabled:c,onClick:()=>{c||(F(!1),Z([]))},children:t.cancel}),e(W,{type:"button",variant:"primary",disabled:c,onClick:async()=>{await m(X),F(!1),Z([])},children:c?l.confirmLabel===t.delete?t.deleting:t.removing:l.confirmLabel||t.remove})]})})]})}):null,U?e(he,{open:!!U,onClose:()=>i(null),children:O("div",{className:"acm-structure-modal-content",children:[e("h3",{className:"acm-structure-modal-title",children:t.teamDescription}),e("div",{children:U.text}),e("div",{className:"acm-structure-modal-actions",children:e(W,{type:"button",variant:"secondary",onClick:()=>i(null),children:t.close})})]})}):null]});return S!=null&&S.StructureData?e(Ce,{name:"StructureData",slot:S.StructureData,context:{structureData:n,Default:o}}):o},Je=()=>{const p=ae({fetchPermissionsError:"Company.CompanyStructure.messages.fetchPermissionsError"}),[S,u]=b(null),[v,t]=b(!0),[N,s]=b(null);return se(()=>{let a=!0;return(async()=>{var c,x;try{t(!0),s(null);const{roleResponse:I}=await Ne();if(!a)return;const j=(x=(c=I==null?void 0:I.data)==null?void 0:c.customer)==null?void 0:x.role,_=Ie(j);u(_)}catch(I){if(!a)return;s(I instanceof Error?I:new Error(p.fetchPermissionsError))}finally{a&&t(!1)}})(),()=>{a=!1}},[p.fetchPermissionsError]),{permissions:S,loading:v,error:N}},lt=({className:p,withHeader:S=!1,slots:u})=>{const v=ae({containerTitle:"Company.CompanyStructure.containerTitle"}),{permissions:t}=Je();return O("div",{className:be(["account-company-structure",p]),children:[S?e(ge,{title:v.containerTitle,divider:!1,className:"company-structure__title"}):null,e(Ke,{slots:u,permissions:t})]})};export{lt as CompanyStructure};
//# sourceMappingURL=CompanyStructure.js.map
