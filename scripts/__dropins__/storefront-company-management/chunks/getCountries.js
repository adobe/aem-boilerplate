/*! Copyright 2025 Adobe
All Rights Reserved. */
import{f as c}from"./fetch-graphql.js";import{events as p}from"@dropins/tools/event-bus.js";const y=(e=[])=>{const a=new Set,t=[...e];for(;t.length;){const n=t.pop();if(n&&(typeof n.id=="string"&&a.add(n.id),Array.isArray(n.children)&&n.children.length))for(const r of n.children)t.push(r)}return a},u=e=>(e==null?void 0:e.id)==="0"||typeof(e==null?void 0:e.id)=="number"&&(e==null?void 0:e.id)===0||(e==null?void 0:e.name)==="Company Administrator",h=e=>{const a=y((e==null?void 0:e.permissions)||[]),t=u(e);return{canViewAccount:t||a.has("Magento_Company::view_account"),canEditAccount:t||a.has("Magento_Company::edit_account"),canViewAddress:t||a.has("Magento_Company::view_address"),canEditAddress:t||a.has("Magento_Company::edit_address"),canViewContacts:t||a.has("Magento_Company::contacts"),canViewPaymentInformation:t||a.has("Magento_Company::payment_information"),canViewShippingInformation:t||a.has("Magento_Company::shipping_information")}},I=e=>{var d;if(!(e!=null&&e.data))throw new Error("Invalid response: missing data");const a="updateCompany"in e.data?(d=e.data.updateCompany)==null?void 0:d.company:e.data.company;if(!a)throw new Error("Invalid response: missing company data");const t="customer"in e.data?e.data.customer:void 0,n=a.legal_address?{street:Array.isArray(a.legal_address.street)?a.legal_address.street.filter(i=>i&&i.trim()!==""):[],city:(a.legal_address.city||"").trim(),region:a.legal_address.region?{region:(a.legal_address.region.region||"").trim(),regionCode:(a.legal_address.region.region_code||"").trim(),regionId:a.legal_address.region.region_id?Number(a.legal_address.region.region_id):0}:void 0,countryCode:(a.legal_address.country_code||"").toUpperCase().trim(),postcode:(a.legal_address.postcode||"").trim(),telephone:a.legal_address.telephone?a.legal_address.telephone.trim():void 0}:void 0,r=t==null?void 0:t.role,s=h(r),o={id:(a.id||"").toString(),name:(a.name||"").trim(),email:(a.email||"").trim().toLowerCase(),legalName:a.legal_name?a.legal_name.trim():void 0,vatTaxId:a.vat_tax_id?a.vat_tax_id.trim():void 0,resellerId:a.reseller_id?a.reseller_id.trim():void 0,legalAddress:n,companyAdmin:a.company_admin?{id:(a.company_admin.id||"").toString(),firstname:(a.company_admin.firstname||"").trim(),lastname:(a.company_admin.lastname||"").trim(),email:(a.company_admin.email||"").trim().toLowerCase(),jobTitle:a.company_admin.job_title?a.company_admin.job_title.trim():void 0}:void 0,salesRepresentative:a.sales_representative?{firstname:(a.sales_representative.firstname||"").trim(),lastname:(a.sales_representative.lastname||"").trim(),email:(a.sales_representative.email||"").trim().toLowerCase()}:void 0,availablePaymentMethods:Array.isArray(a.available_payment_methods)?a.available_payment_methods.filter(i=>i&&typeof i.code=="string"&&typeof i.title=="string").map(i=>({code:i.code.trim(),title:i.title.trim()})).filter(i=>i.code.length>0&&i.title.length>0):void 0,availableShippingMethods:Array.isArray(a.available_shipping_methods)?a.available_shipping_methods.filter(i=>i&&typeof i.code=="string"&&typeof i.title=="string").map(i=>({code:i.code.trim(),title:i.title.trim()})).filter(i=>i.code.length>0&&i.title.length>0):void 0,canEditAccount:s.canEditAccount,canEditAddress:s.canEditAddress,permissionsFlags:s,customerRole:r,customerStatus:t==null?void 0:t.status};if(s.canViewAccount){if(!o.id)throw new Error("Company ID is required");if(!o.name)throw new Error("Company name is required");if(!o.email)throw new Error("Company email is required")}return o},S=e=>{var n,r,s,o,d;if(!((r=(n=e==null?void 0:e.data)==null?void 0:n.createCompany)!=null&&r.company))throw new Error("Invalid createCompany response: missing company data");const a=e.data.createCompany.company;if(!a.legal_address)throw new Error("Legal address is required for company registration");if(!a.company_admin)throw new Error("Company admin is required for company registration");return{id:a.id,name:a.name,email:a.email,legalName:a.legal_name,vatTaxId:a.vat_tax_id,resellerId:a.reseller_id,legalAddress:{street:a.legal_address.street||[],city:a.legal_address.city||"",region:{regionCode:((s=a.legal_address.region)==null?void 0:s.region_code)||"",region:(o=a.legal_address.region)==null?void 0:o.region,regionId:(d=a.legal_address.region)==null?void 0:d.region_id},countryCode:a.legal_address.country_code||"",postcode:a.legal_address.postcode||"",telephone:a.legal_address.telephone},companyAdmin:{id:a.company_admin.id,firstname:a.company_admin.firstname,lastname:a.company_admin.lastname,email:a.company_admin.email,jobTitle:a.company_admin.job_title,telephone:a.company_admin.telephone}}},f=e=>{throw e instanceof DOMException&&e.name==="AbortError"||p.emit("error",{source:"company",type:"network",error:e}),e},v=e=>{const a=e.map(t=>t.message).join(" ");throw Error(a)},C=e=>{var o,d;if(!((d=(o=e==null?void 0:e.data)==null?void 0:o.countries)!=null&&d.length))return{availableCountries:[],countriesWithRequiredRegion:[],optionalZipCountries:[]};const{countries:a,storeConfig:t}=e.data,n=t==null?void 0:t.countries_with_required_region.split(","),r=t==null?void 0:t.optional_zip_countries.split(",");return{availableCountries:a.filter(({two_letter_abbreviation:i,full_name_locale:l})=>!!(i&&l)).map(i=>{const{two_letter_abbreviation:l,full_name_locale:_,available_regions:m}=i,g=Array.isArray(m)&&m.length>0;return{value:l,text:_,availableRegions:g?m:void 0}}).sort((i,l)=>i.text.localeCompare(l.text)),countriesWithRequiredRegion:n,optionalZipCountries:r}},w=`
  query validateCompanyEmail($email: String!) {
    isCompanyEmailAvailable(email: $email) {
      is_email_available
    }
  }
`,M=async e=>{try{const a=await c(w,{variables:{email:e}});return a.errors?{isValid:!1,error:"Unable to validate email"}:{isValid:a.data.isCompanyEmailAvailable.is_email_available,error:a.data.isCompanyEmailAvailable.is_email_available?void 0:"This email is already used by another company"}}catch{return{isValid:!1,error:"Unable to validate email"}}},b=`
  query getCountries {
    countries {
      id
      two_letter_abbreviation
      three_letter_abbreviation
      full_name_locale
      full_name_english
      available_regions {
        id
        code
        name
      }
    }
    storeConfig {
      countries_with_required_region
      optional_zip_countries
    }
  }
`,R=async()=>{const e="_company_countries",a=sessionStorage.getItem(e);return a?JSON.parse(a):await c(b,{method:"GET"}).then(t=>{var r;if((r=t.errors)!=null&&r.length)return v(t.errors);const n=C(t);return sessionStorage.setItem(e,JSON.stringify(n)),n}).catch(f)};export{f as a,I as b,y as f,R as g,v as h,u as i,S as t,M as v};
//# sourceMappingURL=getCountries.js.map
