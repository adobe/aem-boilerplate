/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as R,Fragment as de}from"@dropins/tools/preact-jsx-runtime.js";import{useCallback as $,useMemo as ge,useState as b,useRef as ie,useEffect as Y}from"@dropins/tools/preact-hooks.js";import{classes as he}from"@dropins/tools/lib.js";import{Button as T,Picker as Te,Card as ae,Header as W,InLineAlert as ee,Field as _e,Input as Ee,ProgressSpinner as ce,Modal as Pe,IllustratedMessage as me}from"@dropins/tools/components.js";import{D as se,u as we}from"../chunks/useCompanyRoles.js";import{T as xe,u as Se}from"../chunks/useUserPermissions.js";import{u as Ie}from"../chunks/useInLineAlert.js";import{u as ke}from"../chunks/useCompanyContextListener.js";import{T as Me}from"../chunks/Tree.js";import{f as ue}from"../chunks/company-permissions.js";import{i as De}from"../chunks/isCompanyRoleNameAvailable.js";import{useText as ne}from"@dropins/tools/i18n.js";import"@dropins/tools/preact.js";import"../chunks/fetchUserPermissions.js";import"../chunks/fetch-error.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/preact-compat.js";const Fe=d=>{try{if(/^\d+$/.test(d))return d;const t=atob(d).match(/(\d+)$/);return t?t[1]:d}catch(r){return console.warn("Failed to decode role ID:",d,r),d}},Le=({className:d,roles:r,isLoading:t,canManageRoles:c=!1,onShowCreateForm:n,onShowEditForm:y,onDuplicateRole:w,onDeleteRole:C,totalCount:x=r.length,currentPage:m=1,pageSize:o=se,onPageChange:h,onPageSizeChange:k,children:F,...L})=>{const N=ne({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),S=[{key:"id",label:N.columnId||"ID"},{key:"name",label:N.columnRole||"Role"},{key:"usersCount",label:N.columnUsers||"Users"},{key:"actions",label:N.columnActions||"Actions"}],X=$(s=>c&&s.id!=="0",[c]),q=$(s=>c&&s.id!=="0",[c]),_=$(s=>c&&s.id!=="0"&&x>1,[c,x]),M=$(s=>{const v=[];return X(s)&&v.push(e(T,{variant:"tertiary",size:"medium",onClick:()=>y(s.id),className:"role-action-button",children:N.editButton||"Edit"},"edit")),q(s)&&w&&v.push(e(T,{variant:"tertiary",size:"medium",onClick:()=>w(s.id),className:"role-action-button",children:N.duplicateButton||"Duplicate"},"duplicate")),_(s)&&C&&v.push(e(T,{variant:"tertiary",size:"medium",onClick:()=>C(s.id),className:"role-action-button",children:N.deleteButton||"Delete"},"delete")),v.length===0?c?e("span",{className:"no-actions",children:N.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:v.map((u,g)=>R("span",{className:"role-action-wrapper",children:[g>0&&e("span",{className:"separator",children:"|"}),u]},g))})},[X,q,_,y,w,C,N,c]),O=ge(()=>r.map(s=>({id:Fe(s.id),name:s.name,usersCount:s.usersCount,actions:e("div",{className:"roles-actions",children:M(s)})})),[r,M]),D=[se,30,50,100,200].map(s=>({value:s.toString(),label:s.toString(),text:s.toString()})),f=Math.ceil(x/o),I=m<f,U=m>1,E=(m-1)*o,A=E+o,H=$(()=>{const s=[];if(f<=7)for(let u=1;u<=f;u++)s.push(u);else if(s.push(1),m<=3){for(let u=2;u<=5;u++)s.push(u);s.push("ellipsis-end"),s.push(f)}else if(m>=f-2){s.push("ellipsis-start");for(let u=f-4;u<=f;u++)s.push(u)}else{s.push("ellipsis-start");for(let u=m-1;u<=m+1;u++)s.push(u);s.push("ellipsis-end"),s.push(f)}return s},[m,f]);return R("div",{...L,className:he(["company-management-role-and-permission-table",d]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e(xe,{columns:S,rowData:O,mobileLayout:"stacked",loading:t,skeletonRowCount:10})}),R("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:R("span",{className:"item-count",children:["Items ",E+1," to ",Math.min(A,x)," of ",x," total"]})}),f>1&&e("div",{className:"table-footer-center",children:R("div",{className:"page-navigation",children:[e(T,{variant:"tertiary",size:"medium",onClick:()=>h==null?void 0:h(m-1),disabled:!U,className:"page-nav-button",children:"<"}),H().map(s=>typeof s=="string"?e("span",{className:"page-ellipsis",children:"..."},s):e(T,{variant:"tertiary",size:"medium",onClick:()=>h==null?void 0:h(s),disabled:s===m,className:s===m?"page-num-button active":"page-num-button",children:s},s)),e(T,{variant:"tertiary",size:"medium",onClick:()=>h==null?void 0:h(m+1),disabled:!I,className:"page-nav-button",children:">"})]})}),e("div",{className:"table-footer-right",children:R("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:N.show||"Show"}),e(Te,{value:o.toString(),onChange:s=>{const v=s.target;k==null||k(parseInt(v.value,10))},options:D,className:"page-size-picker"}),e("span",{className:"pagination-label",children:N.perPage||"per page"})]})})]}),c&&e("div",{className:"add-role-section",children:e(T,{variant:"primary",onClick:n,children:N.addNewRole||"Add New Role"})}),F]})},Oe={MAX_LENGTH:40},oe=d=>(typeof d=="string"?d:String(d||"")).trim().slice(0,Oe.MAX_LENGTH),pe=({mode:d,role:r,aclResources:t,existingRoleNames:c=[],loading:n=!1,onSubmit:y,onCancel:w,inLineAlertProps:C,prefillName:x,prefillPermissions:m})=>{const o=ne({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[h,k]=b({name:(r==null?void 0:r.name)||""}),[F,L]=b({}),[N,S]=b({}),[X,q]=b(!1),[_,M]=b(!1),[O,D]=b([]),[f,I]=b(new Set),[U,E]=b(new Set),A=ie(null),H=ie(""),s=ie(!1);Y(()=>{if(!s.current){if(s.current=!0,d==="edit"&&r){if(k({name:r.name}),r.permissions&&r.permissions.length>0){const i=ue(r.permissions);E(new Set(i))}}else if(d==="create")if(k({name:x??""}),m&&m.length>0){const a=ue(m);E(new Set(a))}else E(new Set)}},[d,r,x,m]),Y(()=>{if(t.length>0){const i=Ue(t);D(i);const a=i.filter(p=>!p.parentId).map(p=>p.id);I(new Set(a))}},[t]),Y(()=>()=>{A.current&&clearTimeout(A.current)},[]);const v=$(i=>{const a=oe(i);return a?(d==="edit"&&r?c.filter(z=>z!==r.name):c).includes(a)?o.roleNameExists:null:o.roleNameRequired||"This is a required field."},[d,r,c,o.roleNameRequired,o.roleNameExists]),u=$(async i=>{const a=oe(i),p=v(a);if(p)return p;if(d==="edit"&&r&&a===r.name)return null;try{return q(!0),await De({name:a})?null:o.roleNameExists}catch(z){return console.error("Role name validation failed:",z),null}finally{q(!1)}},[d,r,o.roleNameExists,v]),g=$(i=>{A.current!==null&&clearTimeout(A.current),i!==H.current&&(A.current=window.setTimeout(async()=>{const a=await u(i);L(a?p=>({...p,name:a}):p=>({...p,name:""})),H.current=i},500))},[u]),G=()=>{const i={};let a=!0;const p=v(h.name);return p&&(i.name=p,a=!1),L(i),a},B=i=>{const a=typeof i=="string"?i:i.target.value;k(p=>({...p,name:a})),F.name&&L(p=>({...p,name:""})),g(a)},V=()=>{S(i=>({...i,name:!0})),A.current&&(clearTimeout(A.current),A.current=null)},Z=()=>{const i=new Set(O.map(a=>a.id));I(i)},te=()=>{I(new Set)},re=async i=>{if(i.preventDefault(),!_&&(S({name:!0}),!!G()&&!F.name)){M(!0);try{const a={name:oe(h.name),permissions:Array.from(U)};y&&await y(a)}catch(a){console.error("Form submission failed:",a)}finally{M(!1)}}},J=d==="create"?o.createTitle:o.editTitle;return R(ae,{variant:"secondary",className:"edit-role-and-permission",children:[e(W,{level:2,size:"large",title:J,divider:!1,className:"edit-role-and-permission__title"}),(C==null?void 0:C.text)&&e(ee,{className:"edit-role-and-permission__notification",type:C.type,variant:"secondary",heading:C.text,"data-testid":"editRoleInLineAlert"}),R("form",{className:"edit-role-and-permission-form",onSubmit:re,children:[R("div",{className:"edit-role-and-permission__section",children:[e(W,{level:3,size:"medium",title:o.roleInformation||"Role Information",divider:!1,className:"edit-role-and-permission__section-title"}),e(_e,{label:o.roleName||"Role Name",required:!0,error:N.name&&F.name?F.name:void 0,children:e(Ee,{type:"text",name:"roleName",value:h.name,onChange:B,onBlur:V,disabled:n||_,"data-testid":"roleNameInput",placeholder:o.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),X&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(ce,{size:"medium"})})]}),R("div",{className:"edit-role-and-permission__section",children:[e(W,{level:3,size:"medium",title:o.rolePermissions,divider:!1,className:"edit-role-and-permission__section-title"}),e(ee,{type:"info",variant:"secondary",heading:o.permissionsDescription,className:"edit-role-and-permission__permissions-description"}),R("div",{className:"edit-role-and-permission__tree-controls",children:[e(T,{type:"button",variant:"tertiary",onClick:Z,disabled:n||_,children:o.expandAll}),e(T,{type:"button",variant:"tertiary",onClick:te,disabled:n||_,children:o.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":o.rolePermissions,children:O.length>0?e(Me,{items:O,expandedIds:f,onExpandedChange:I,checkedIds:U,onCheckedChange:E,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:i,expanded:a,hasChildren:p,toggle:z,checkbox:Q})=>R("div",{className:"edit-role-and-permission__tree-node",children:[p?e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:K=>{K.preventDefault(),K.stopPropagation(),z()},"aria-label":a?`Collapse ${i.label}`:`Expand ${i.label}`,children:a?"âˆ’":"+"}):e("span",{className:"edit-role-and-permission__tree-spacer"}),Q&&Q(),e("span",{className:"edit-role-and-permission__tree-label",children:i.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),R("div",{className:"edit-role-and-permission__actions",children:[e(T,{type:"button",variant:"secondary",onClick:w,disabled:n||_,children:o.cancel}),e(T,{type:"submit",variant:"primary",disabled:n||_,children:n||_?o.saving:o.saveRole})]})]}),(n||_)&&R("div",{className:"edit-role-and-permission__loading-overlay",children:[e(ce,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:o.saving})]})]})},Ue=d=>{const r=[],t=(n,y)=>{r.push({id:n.id,parentId:y||null,label:n.text}),n.children&&[...n.children].sort((C,x)=>C.sortOrder-x.sortOrder).forEach(C=>{t(C,n.id)})};return[...d].sort((n,y)=>n.sortOrder-y.sortOrder).forEach(n=>t(n)),r},Be=({isOpen:d,hasUsers:r=!1,onConfirm:t,onCancel:c})=>{const n=ne({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!d)return null;const y=r?n.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":n.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return R(Pe,{open:!0,onClose:c,title:e(de,{children:r?n.cannotDeleteModalTitle||"Cannot Delete Role":n.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:y})}),e("div",{className:"delete-role-modal__actions",children:r?e(T,{variant:"primary",onClick:t,className:"delete-role-modal__ok-btn",children:n.cannotDeleteModalOk||"OK"}):R(de,{children:[e(T,{variant:"secondary",onClick:c,className:"delete-role-modal__cancel-btn",children:n.deleteModalCancel||"Cancel"}),e(T,{variant:"primary",onClick:t,className:"delete-role-modal__confirm-btn",children:n.deleteModalConfirm||"Delete"})]})})]})},is=({className:d,withHeader:r=!1})=>{const t=ne({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:c,handleSetInLineAlert:n}=Ie(),{permissions:y,loading:w,error:C}=Se(),x=(y==null?void 0:y.canViewRoles)??!1,m=(y==null?void 0:y.canManageRoles)??!1,o=x||m,{roles:h,aclResources:k,isLoading:F,isCreating:L,isUpdating:N,error:S,createRole:X,updateRole:q,deleteRole:_,clearError:M,refresh:O}=we(se,o,!0),[D,f]=b(!1),[I,U]=b(!1),[E,A]=b(null),[H,s]=b(1),[v,u]=b(se),[g,G]=b(null),[B,V]=b(null);Y(()=>()=>{S&&M(),V(null)},[S,M]);const[Z,te]=b(0);ke(()=>{s(1),I&&(U(!1),A(null)),G(null),M(),te(l=>l+1)},{eager:!0}),Y(()=>{D&&!w&&!m&&(f(!1),V(null))},[D,w,m]),Y(()=>{Z!==0&&(w||o&&O())},[Z,o,O,w]);const re=h.length,J=(H-1)*v,i=J+v,a=h.slice(J,i);if(w&&!D&&!I)return e("div",{className:"roles-and-permissions-container","data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(C&&!D&&!I)return e("div",{className:"roles-and-permissions-container",children:e(ae,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(me,{heading:t.errorTitle||"Error Loading Permissions",message:e("p",{children:t.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})})});if(!o&&!D&&!I)return e("div",{className:"roles-and-permissions-container",children:e(ae,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(me,{heading:t.noAccessTitle||"Access Restricted",message:e("p",{children:t.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})})});const p=l=>{s(l)},z=l=>{u(l),s(1)},Q=()=>{V(null),f(!0)},K=()=>{V(null),f(!1)},ye=l=>{A(l),U(!0)},le=()=>{U(!1),A(null)},fe=l=>{const P=h.find(j=>j.id===l);P&&(V({name:`${P.name} - Duplicated`,permissions:P.permissions||[]}),f(!0))},Re=async l=>{try{if(await X({name:l.name,permissions:l.permissions})){const j=t.createSuccess?t.createSuccess.replace("{roleName}",l.name):`Role "${l.name}" created successfully!`;n({type:"success",text:j}),K()}else n({type:"error",text:t.createError||"Failed to create role. Please try again."})}catch{n({type:"error",text:t.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},Ne=async l=>{if(E)try{if(await q({id:E,name:l.name,permissions:l.permissions})){const j=t.updateSuccess?t.updateSuccess.replace("{roleName}",l.name):`Role "${l.name}" updated successfully!`;n({type:"success",text:j}),le()}else n({type:"error",text:t.updateError||"Failed to update role. Please try again."})}catch{n({type:"error",text:t.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},ve=l=>{const P=h.find(Ae=>Ae.id===l);if(!P)return;const j=P.usersCount>0;G({id:l,name:P.name,hasUsers:j})},be=async()=>{if(g){if(g.hasUsers){G(null);return}try{if(await _(g.id)){const P=t.deleteRoleSuccess?t.deleteRoleSuccess.replace("{roleName}",g.name||"Unknown Role"):`You have deleted role "${g.name||"Unknown Role"}".`;n({type:"success",text:P})}else n({type:"error",text:t.deleteError||"Failed to delete role. Please try again."})}catch{n({type:"error",text:t.deleteError||"Failed to delete role. Please try again."})}finally{G(null)}}},Ce=()=>G(null);return e("div",{className:"roles-and-permissions-container",children:R("div",{className:he(["roles-and-permissions",d]),children:[r?e(W,{title:t.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,S&&e(ee,{type:"error",heading:t.errorTitle||"Error",description:t.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:M}),c&&c.text&&e(ee,{type:c.type||"success",heading:c.text,icon:c.icon}),D?e(pe,{mode:"create",aclResources:k,existingRoleNames:h.map(l=>l.name),loading:L,onSubmit:Re,onCancel:()=>{V(null),K()},inLineAlertProps:S?{type:"error",text:S}:void 0,prefillName:B==null?void 0:B.name,prefillPermissions:B==null?void 0:B.permissions},"create-role-form"):I&&E?e(pe,{mode:"edit",role:h.find(l=>l.id===E),aclResources:k,existingRoleNames:h.map(l=>l.name),loading:N,onSubmit:Ne,onCancel:le,inLineAlertProps:S?{type:"error",text:S}:void 0},`edit-role-form-${E}`):e(Le,{roles:a,isLoading:F,canManageRoles:m,onShowCreateForm:Q,onShowEditForm:ye,onDuplicateRole:fe,onDeleteRole:ve,totalCount:re,currentPage:H,pageSize:v,onPageChange:p,onPageSizeChange:z}),e(Be,{isOpen:!!g,hasUsers:g==null?void 0:g.hasUsers,onConfirm:be,onCancel:Ce})]})})};export{is as RolesAndPermissions,is as default};
//# sourceMappingURL=RolesAndPermissions.js.map
