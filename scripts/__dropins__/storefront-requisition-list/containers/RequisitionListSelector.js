/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as s,jsxs as q,Fragment as x}from"@dropins/tools/preact-jsx-runtime.js";import*as k from"@dropins/tools/preact-compat.js";import{useState as p,useEffect as v,useCallback as m,useMemo as D}from"@dropins/tools/preact-compat.js";import{Card as y,Icon as E,Button as F,InLineAlert as V}from"@dropins/tools/components.js";import{c as H,R as J,f as K,h as X,t as Y}from"../chunks/updateRequisitionList.js";import{events as A}from"@dropins/tools/event-bus.js";import"@dropins/tools/preact-hooks.js";import"@dropins/tools/lib.js";import"../chunks/RequisitionListForm.js";import{R as Z}from"../chunks/RequisitionListForm2.js";import{u as ii,a as ti,S as $,E as si}from"../chunks/RequisitionListView.js";import"@dropins/tools/preact.js";import{s as l,a as P,b as N,u as ei}from"../chunks/state.js";import{g as oi}from"../chunks/getRequisitionLists.js";import{R as ni}from"../chunks/RequisitionListActions.js";import{R as ri}from"../chunks/RequisitionListModal.js";import{useText as ai}from"@dropins/tools/i18n.js";import"@dropins/tools/fetch-graphql.js";const li=`
  mutation ADD_PRODUCTS_TO_REQUISITION_LIST_MUTATION(
      $requisitionListUid: ID!, 
      $requisitionListItems: [RequisitionListItemsInput!]!
    ) {
    addProductsToRequisitionList(
      requisitionListUid: $requisitionListUid
      requisitionListItems: $requisitionListItems
    ) {
      requisition_list {
        ...REQUISITION_LIST_FRAGMENT
        items {
          ...REQUISITION_LIST_ITEMS_FRAGMENT
        }
      }
    }
  }
${H}
${J}
`,di=async(L,n)=>{var e;const u=n.map(i=>{const t={sku:i.sku,quantity:i.quantity};return i.parent_sku&&(t.parent_sku=i.parent_sku),i.selected_options&&i.selected_options.length>0&&(t.selected_options=i.selected_options),i.entered_options&&i.entered_options.length>0&&(t.entered_options=i.entered_options),t}),{errors:d,data:a}=await K(li,{variables:{requisitionListUid:L,requisitionListItems:u}});if(d)return X(d);if(!((e=a==null?void 0:a.addProductsToRequisitionList)!=null&&e.requisition_list))return null;const r=Y(a.addProductsToRequisitionList.requisition_list);return A.emit("requisitionList/data",r),r},ci=L=>k.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...L},k.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M7.74512 9.87701L12.0001 14.132L16.2551 9.87701",stroke:"currentColor",strokeWidth:1,strokeLinecap:"square",strokeLinejoin:"round"}));let c=0;const ui=()=>{const[L,n]=p(l.requisitionLists),[u,d]=p(l.requisitionListsLoading),[a,r]=p(c);return v(()=>{l.requisitionLists.length===0&&!l.requisitionListsLoading&&(P(!0),oi(1,100).then(e=>{const i=(e==null?void 0:e.items)||[];N(i),c++}).catch(e=>{console.error("Error fetching requisition lists:",e),N([]),c++}).finally(()=>{P(!1)}))},[]),v(()=>{const e=A.on("requisitionLists/data",t=>{t&&(N(t),c++,r(c),n(l.requisitionLists),d(l.requisitionListsLoading))}),i=A.on("requisitionList/data",t=>{t&&(ei(t),c++,r(c),n([...l.requisitionLists]),d(l.requisitionListsLoading))});return()=>{e==null||e.off(),i==null||i.off()}},[]),v(()=>{a!==c&&(n(l.requisitionLists),d(l.requisitionListsLoading),r(c))},[a]),{lists:L,loading:u}},Oi=({canCreate:L=!0,sku:n,selectedOptions:u,quantity:d=1,beforeAddProdToReqList:a})=>{const r=ai({createTitle:"RequisitionList.RequisitionListForm.createTitle",addToRequisitionList:"RequisitionList.RequisitionListForm.addToRequisitionList",emptyList:"RequisitionList.RequisitionListWrapper.emptyList",addToNewRequisitionList:"RequisitionList.RequisitionListSelector.addToNewRequisitionList",addToSelected:"RequisitionList.RequisitionListSelector.addToSelected"}),[e,i]=p(!1),[t,O]=p(null),{lists:R}=ui(),{isEnabled:w}=ii(),{alert:_,setAlert:U,handleRequisitionListAlert:f}=ti(),[b,M]=p({isOpen:!1,isLoading:!1}),T=m(()=>{M({isOpen:!0,isLoading:!1})},[]),I=m(()=>{M({isOpen:!1,isLoading:!1}),O(null),i(!1),U(null)},[U]),C=m(async o=>{try{const h={sku:n,quantity:d,...u&&u.length>0?{selected_options:u}:{}};await di(o,[h])}catch(h){throw console.error("Error adding product to list:",h),h}},[n,d,u]),S=m(async o=>{try{await C(o),f({action:"add",type:"success",context:"product",skus:[n]})}catch{f({action:"add",type:"error",context:"product",skus:[n]})}finally{setTimeout(()=>{I()},2e3)}},[n,C,I,f]),Q=m(o=>{o.preventDefault(),t&&S(t)},[t,S]),G=m(()=>{if(!a){T();return}Promise.resolve(a()).then(()=>{T()}).catch(()=>{})},[a,T]),g=D(()=>[...(R==null?void 0:R.map(o=>({value:o.uid,text:o.name})))??[]],[R]),j=D(()=>s("div",{className:"requisition-list-selector__available-lists",children:g.map(o=>q(y,{variant:t===o.value?"primary":"secondary",onClick:()=>{O(o.value)},children:[s(E,{source:$}),s("span",{children:o.text})]},o.value))}),[g,t]),W=g.length>0?e?q("button",{type:"button","aria-label":"Select a requisition list",role:"button",className:"requisition-list-actions","data-testid":"requisition-list-actions-button",onClick:()=>i(!1),children:[s("span",{className:"requisition-list-actions__title","data-testid":"requisition-list-actions-button-text",children:r.addToRequisitionList}),s(E,{source:ci,size:"32"})]}):s(y,{variant:"secondary",children:q("form",{onSubmit:Q,className:"requisition-list-selector__form",children:[j,s("div",{className:"requisition-list-form__actions",children:s(F,{type:"submit",disabled:!t,children:r.addToSelected})})]})}):s(si,{textContent:r.emptyList}),z=e?s(y,{variant:"secondary",children:s(Z,{mode:"create",onSuccess:async o=>{await S(o.uid)},onError:()=>{f({action:"add",type:"error",context:"product",skus:[n]})},onCancel:()=>{i(!1)}})}):s(ni,{onAddNew:()=>{i(!0)}}),B=q(x,{children:[_&&s("div",{className:"requisition-list__alert-wrapper",children:s(V,{id:`requisition-list-selector__alert__${n}`,heading:_.description,type:_.type,variant:"primary",className:"requisition-list-selector__alert"},`requisition-list-selector__alert__${n}`)}),!_&&q(x,{children:[W,L&&z]})]});return w===null||!w?null:q("div",{className:"requisition-list-selector",children:[s(F,{"aria-label":r.addToRequisitionList,"data-testid":"requisition-list-selector",size:"medium",variant:"tertiary",icon:s(E,{source:$}),onClick:G}),b.isOpen&&s(ri,{isOpen:!0,isLoading:b.isLoading,title:r.addToRequisitionList,modalContent:B,handleModalOnClose:I})]})};export{Oi as RequisitionListSelector,Oi as default};
//# sourceMappingURL=RequisitionListSelector.js.map
