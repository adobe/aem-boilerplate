/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as n,jsxs as p,Fragment as x}from"@dropins/tools/preact-jsx-runtime.js";import*as k from"@dropins/tools/preact-compat.js";import{useState as m,useEffect as f,useCallback as _,useMemo as D}from"@dropins/tools/preact-compat.js";import{Card as v,Icon as E,Button as F,InLineAlert as V}from"@dropins/tools/components.js";import{c as H,R as J,f as K,h as X,t as Y}from"../chunks/updateRequisitionList.js";import{events as q}from"@dropins/tools/event-bus.js";import"@dropins/tools/preact-hooks.js";import"@dropins/tools/lib.js";import"../chunks/RequisitionListForm.js";import{R as Z}from"../chunks/RequisitionListForm2.js";import{s as l,a as $,b as N,u as ii}from"../chunks/state.js";import{g as ti}from"../chunks/getRequisitionLists.js";import{u as si,S as P,E as ei}from"../chunks/RequisitionListView.js";import"@dropins/tools/preact.js";import{R as oi}from"../chunks/RequisitionListActions.js";import{R as ni}from"../chunks/RequisitionListModal.js";import{useText as ri}from"@dropins/tools/i18n.js";import"@dropins/tools/fetch-graphql.js";let L=0;const ai=()=>{const[d,o]=m(l.requisitionLists),[c,u]=m(l.requisitionListsLoading),[r,a]=m(L);return f(()=>{l.requisitionLists.length===0&&!l.requisitionListsLoading&&($(!0),ti(1,100).then(s=>{const i=(s==null?void 0:s.items)||[];N(i),L++}).catch(s=>{console.error("Error fetching requisition lists:",s),N([]),L++}).finally(()=>{$(!1)}))},[]),f(()=>{const s=q.on("requisitionLists/data",e=>{e&&(N(e),L++,a(L),o(l.requisitionLists),u(l.requisitionListsLoading))}),i=q.on("requisitionList/data",e=>{e&&(ii(e),L++,a(L),o([...l.requisitionLists]),u(l.requisitionListsLoading))});return()=>{s==null||s.off(),i==null||i.off()}},[]),f(()=>{r!==L&&(o(l.requisitionLists),u(l.requisitionListsLoading),a(L))},[r]),{lists:d,loading:c}},li=()=>{var c,u;const[d,o]=m(((c=l.config)==null?void 0:c.is_requisition_list_active)==="1"&&((u=l.config)==null?void 0:u.company_enabled)===!0);return f(()=>{const r=q.on("requisitionList/initialized",()=>{var a,s;o(((a=l.config)==null?void 0:a.is_requisition_list_active)==="1"&&((s=l.config)==null?void 0:s.company_enabled)===!0)});return()=>r==null?void 0:r.off()},[]),{isEnabled:d}},ui=`
  mutation ADD_PRODUCTS_TO_REQUISITION_LIST_MUTATION(
      $requisitionListUid: ID!, 
      $requisitionListItems: [RequisitionListItemsInput!]!
    ) {
    addProductsToRequisitionList(
      requisitionListUid: $requisitionListUid
      requisitionListItems: $requisitionListItems
    ) {
      requisition_list {
        ...REQUISITION_LIST_FRAGMENT
        items {
          ...REQUISITION_LIST_ITEMS_FRAGMENT
        }
      }
    }
  }
${H}
${J}
`,ci=async(d,o)=>{var s;const c=o.map(i=>{const e={sku:i.sku,quantity:i.quantity};return i.parent_sku&&(e.parent_sku=i.parent_sku),i.selected_options&&i.selected_options.length>0&&(e.selected_options=i.selected_options),i.entered_options&&i.entered_options.length>0&&(e.entered_options=i.entered_options),e}),{errors:u,data:r}=await K(ui,{variables:{requisitionListUid:d,requisitionListItems:c}});if(u)return X(u);if(!((s=r==null?void 0:r.addProductsToRequisitionList)!=null&&s.requisition_list))return null;const a=Y(r.addProductsToRequisitionList.requisition_list);return q.emit("requisitionList/data",a),a},di=d=>k.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...d},k.createElement("path",{d:"M7.74512 9.87701L12.0001 14.132L16.2551 9.87701",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"square",strokeLinejoin:"round"})),Ai=({canCreate:d=!0,sku:o,selectedOptions:c,quantity:u=1,beforeAddProdToReqList:r})=>{const a=ri({createTitle:"RequisitionList.RequisitionListForm.createTitle",addToRequisitionList:"RequisitionList.RequisitionListForm.addToRequisitionList",emptyList:"RequisitionList.RequisitionListWrapper.emptyList",addToNewRequisitionList:"RequisitionList.RequisitionListSelector.addToNewRequisitionList",addToSelected:"RequisitionList.RequisitionListSelector.addToSelected"}),[s,i]=m(!1),[e,b]=m(null),{lists:R}=ai(),{isEnabled:A}=li(),{alert:h,setAlert:O,handleRequisitionListAlert:U}=si(),[w,M]=m({isOpen:!1,isLoading:!1});f(()=>{const t=q.on("requisitionList/alert",U);return()=>{t==null||t.off()}},[U]);const I=_(()=>{M({isOpen:!0,isLoading:!1})},[]),g=_(()=>{M({isOpen:!1,isLoading:!1}),b(null),i(!1),O(null)},[O]),C=_(async t=>{try{const T={sku:o,quantity:u,...c&&c.length>0?{selected_options:c}:{}};await ci(t,[T])}catch(T){throw console.error("Error adding product to list:",T),T}},[o,u,c]),S=_(async t=>{try{await C(t),q.emit("requisitionList/alert",{action:"add",type:"success",context:"product",skus:[o]})}catch{q.emit("requisitionList/alert",{action:"add",type:"error",context:"product",skus:[o]})}finally{setTimeout(()=>{g()},2e3)}},[o,C,g]),Q=_(t=>{t.preventDefault(),e&&S(e)},[e,S]),G=_(()=>{if(!r){I();return}Promise.resolve(r()).then(()=>{I()}).catch(()=>{})},[r,I]),y=D(()=>[...(R==null?void 0:R.map(t=>({value:t.uid,text:t.name})))??[]],[R]),j=D(()=>n("div",{className:"requisition-list-selector__available-lists",children:y.map(t=>p(v,{variant:e===t.value?"primary":"secondary",onClick:()=>{b(t.value)},children:[n(E,{source:P}),n("span",{children:t.text})]},t.value))}),[y,e]),z=y.length>0?s?p("button",{type:"button","aria-label":"Select a requisition list",role:"button",className:"requisition-list-actions","data-testid":"requisition-list-actions-button",onClick:()=>i(!1),children:[n("span",{className:"requisition-list-actions__title","data-testid":"requisition-list-actions-button-text",children:a.addToRequisitionList}),n(E,{source:di,size:"32"})]}):n(v,{variant:"secondary",children:p("form",{onSubmit:Q,className:"requisition-list-selector__form",children:[j,n("div",{className:"requisition-list-form__actions",children:n(F,{type:"submit",disabled:!e,children:a.addToSelected})})]})}):n(ei,{textContent:a.emptyList}),W=s?n(v,{variant:"secondary",children:n(Z,{mode:"create",onSuccess:async t=>{await S(t.uid)},onError:()=>{q.emit("requisitionList/alert",{action:"add",type:"error",context:"product",skus:[o]})},onCancel:()=>{i(!1)}})}):n(oi,{onAddNew:()=>{i(!0)}}),B=p(x,{children:[h&&n(V,{id:`requisition-list-selector__alert__${o}`,className:"requisition-list-selector__alert",heading:h.description,type:h.type,variant:"primary"},`requisition-list-selector__alert__${o}`),!h&&p(x,{children:[z,d&&W]})]});return A===null||!A?null:p("div",{className:"requisition-list-selector",children:[n(F,{"aria-label":a.addToRequisitionList,"data-testid":"requisition-list-selector",size:"medium",variant:"tertiary",icon:n(E,{source:P}),onClick:G}),w.isOpen&&n(ni,{isOpen:!0,isLoading:w.isLoading,title:a.addToRequisitionList,modalContent:B,handleModalOnClose:g})]})};export{Ai as RequisitionListSelector,Ai as default};
//# sourceMappingURL=RequisitionListSelector.js.map
